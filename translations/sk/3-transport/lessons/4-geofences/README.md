<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "078ae664c7b686bf069545e9a5fc95b2",
  "translation_date": "2025-08-28T09:41:24+00:00",
  "source_file": "3-transport/lessons/4-geofences/README.md",
  "language_code": "sk"
}
-->
# Geofences

![Prehƒæad lekcie v sketchnote](../../../../../translated_images/lesson-14.63980c5150ae3c153e770fb71d044c1845dce79248d86bed9fc525adf3ede73c.sk.jpg)

> Sketchnote od [Nitya Narasimhan](https://github.com/nitya). Kliknite na obr√°zok pre v√§ƒç≈°iu verziu.

Toto video poskytuje prehƒæad o geofencoch a ich pou≈æit√≠ v Azure Maps, ƒço s√∫ t√©my, ktor√© bud√∫ pokryt√© v tejto lekcii:

[![Geofencing s Azure Maps z rel√°cie Microsoft Developer IoT](https://img.youtube.com/vi/nsrgYhaYNVY/0.jpg)](https://www.youtube.com/watch?v=nsrgYhaYNVY)

> üé• Kliknite na obr√°zok vy≈°≈°ie a pozrite si video

## Kv√≠z pred lekciou

[Kv√≠z pred lekciou](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/27)

## √övod

V posledn√Ωch troch lekci√°ch ste pou≈æili IoT na lokaliz√°ciu kami√≥nov, ktor√© prepravuj√∫ va≈°e produkty z farmy do spracovateƒæsk√©ho centra. Zaznamenali ste GPS √∫daje, poslali ich do cloudu na ulo≈æenie a vizualizovali ich na mape. ƒéal≈°√≠m krokom na zv√Ω≈°enie efektivity v√°≈°ho dod√°vateƒæsk√©ho re≈•azca je z√≠skanie upozornenia, keƒè sa kami√≥n bl√≠≈æi k spracovateƒæsk√©mu centru, aby t√≠m, ktor√Ω ho m√° vylo≈æi≈•, mohol by≈• pripraven√Ω s vysokozdvi≈æn√Ωmi voz√≠kmi a ƒèal≈°√≠m vybaven√≠m hneƒè po pr√≠chode vozidla. T√Ωmto sp√¥sobom m√¥≈æu r√Ωchlo vylo≈æi≈• n√°klad a vy neplat√≠te za ƒçakaj√∫ci kami√≥n a vodiƒça.

V tejto lekcii sa nauƒç√≠te o geofencoch - definovan√Ωch geospace√°lnych oblastiach, ako je napr√≠klad oblas≈• v dosahu 2 km jazdy od spracovateƒæsk√©ho centra, a ako testova≈•, ƒçi GPS s√∫radnice s√∫ vo vn√∫tri alebo mimo geofence, aby ste mohli zisti≈•, ƒçi v√°≈° GPS senzor dorazil alebo opustil oblas≈•.

V tejto lekcii sa budeme venova≈•:

* [ƒåo s√∫ geofences](../../../../../3-transport/lessons/4-geofences)
* [Definovanie geofence](../../../../../3-transport/lessons/4-geofences)
* [Testovanie bodov voƒçi geofence](../../../../../3-transport/lessons/4-geofences)
* [Pou≈æitie geofencov zo serverless k√≥du](../../../../../3-transport/lessons/4-geofences)

> üóë Toto je posledn√° lekcia v tomto projekte, tak≈æe po dokonƒçen√≠ tejto lekcie a zadania nezabudnite vyƒçisti≈• svoje cloudov√© slu≈æby. Budete ich potrebova≈• na dokonƒçenie zadania, tak≈æe sa uistite, ≈æe ho najsk√¥r dokonƒç√≠te.
>
> Ak je to potrebn√©, pozrite si [pr√≠ruƒçku na vyƒçistenie projektu](../../../clean-up.md) pre pokyny, ako to urobi≈•.

## ƒåo s√∫ geofences

Geofence je virtu√°lny obvod pre geografick√∫ oblas≈• v re√°lnom svete. Geofences m√¥≈æu by≈• kruhy definovan√© ako bod a polomer (napr√≠klad kruh s priemerom 100m okolo budovy) alebo polyg√≥ny pokr√Ωvaj√∫ce oblas≈•, ako je ≈°kolsk√° z√≥na, mestsk√© hranice alebo univerzitn√Ω ƒçi kancel√°rsky kampus.

![Pr√≠klady geofencov zobrazuj√∫ce kruhov√Ω geofence okolo obchodu Microsoft a polygonov√Ω geofence okolo z√°padn√©ho kampusu Microsoft](../../../../../translated_images/geofence-examples.172fbc534665769f6e1a1ddcf75e3b25183cd10354c80cc603ba44b635390e1a.sk.png)

> üíÅ Mo≈æno ste u≈æ pou≈æ√≠vali geofences bez toho, aby ste o tom vedeli. Ak ste nastavili pripomienku pomocou aplik√°cie iOS Reminders alebo Google Keep na z√°klade polohy, pou≈æili ste geofence. Tieto aplik√°cie nastavia geofence na z√°klade zadanej polohy a upozornia v√°s, keƒè v√°≈° telef√≥n vst√∫pi do geofence.

Existuje mnoho d√¥vodov, preƒço by ste chceli vedie≈•, ≈æe vozidlo je vo vn√∫tri alebo mimo geofence:

* Pr√≠prava na vykladanie - z√≠skanie upozornenia, ≈æe vozidlo dorazilo na miesto, umo≈æ≈àuje t√≠mu pripravi≈• sa na vylo≈æenie vozidla, ƒç√≠m sa zni≈æuje ƒças ƒçakania vozidla. To m√¥≈æe vodiƒçovi umo≈æni≈• vykona≈• viac dod√°vok za de≈à s men≈°√≠m ƒçasom ƒçakania.
* Da≈àov√° zhoda - niektor√© krajiny, ako napr√≠klad Nov√Ω Z√©land, √∫ƒçtuj√∫ cestn√© dane za dieselov√© vozidl√° na z√°klade hmotnosti vozidla pri jazde iba na verejn√Ωch cest√°ch. Pou≈æitie geofencov umo≈æ≈àuje sledova≈• najazden√© kilometre na verejn√Ωch cest√°ch oproti s√∫kromn√Ωm cest√°m na miestach, ako s√∫ farmy alebo oblasti ≈•a≈æby dreva.
* Monitorovanie kr√°de≈æe - ak by vozidlo malo zosta≈• iba v urƒçitej oblasti, napr√≠klad na farme, a opust√≠ geofence, mohlo by≈• ukradnut√©.
* Zhoda s polohou - niektor√© ƒçasti pracoviska, farmy alebo tov√°rne m√¥≈æu by≈• zak√°zan√© pre urƒçit√© vozidl√°, napr√≠klad udr≈æiavanie vozidiel, ktor√© prepravuj√∫ umel√© hnojiv√° a pestic√≠dy, mimo pol√≠ s organick√Ωmi produktmi. Ak sa geofence vst√∫pi, vozidlo je mimo zhody a vodiƒç m√¥≈æe by≈• upozornen√Ω.

‚úÖ Dok√°≈æete si predstavi≈• ƒèal≈°ie vyu≈æitia geofencov?

Azure Maps, slu≈æba, ktor√∫ ste pou≈æili v poslednej lekcii na vizualiz√°ciu GPS √∫dajov, v√°m umo≈æ≈àuje definova≈• geofences a testova≈•, ƒçi je bod vo vn√∫tri alebo mimo geofence.

## Definovanie geofence

Geofences s√∫ definovan√© pomocou GeoJSON, rovnako ako body, ktor√© boli pridan√© na mapu v predch√°dzaj√∫cej lekcii. V tomto pr√≠pade, namiesto `FeatureCollection` bodov, ide o `FeatureCollection` obsahuj√∫ce `Polygon`.

```json
{
   "type": "FeatureCollection",
   "features": [
     {
       "type": "Feature",
       "geometry": {
         "type": "Polygon",
         "coordinates": [
           [
             [
               -122.13393688201903,
               47.63829579223815
             ],
             [
               -122.13389128446579,
               47.63782047131512
             ],
             [
               -122.13240802288054,
               47.63783312249837
             ],
             [
               -122.13238388299942,
               47.63829037035086
             ],
             [
               -122.13393688201903,
               47.63829579223815
             ]
           ]
         ]
       },
       "properties": {
         "geometryId": "1"
       }
     }
   ]
}
```

Ka≈æd√Ω bod na polyg√≥ne je definovan√Ω ako dvojica zemepisnej dƒ∫≈æky a ≈°√≠rky v poli, a tieto body s√∫ v poli, ktor√© je nastaven√© ako `coordinates`. V `Point` v predch√°dzaj√∫cej lekcii bolo `coordinates` pole obsahuj√∫ce 2 hodnoty, zemepisn√∫ ≈°√≠rku a dƒ∫≈æku, pre `Polygon` je to pole pol√≠ obsahuj√∫ce 2 hodnoty, zemepisn√∫ dƒ∫≈æku a ≈°√≠rku.

> üíÅ Pam√§tajte, GeoJSON pou≈æ√≠va `zemepisn√∫ dƒ∫≈æku, zemepisn√∫ ≈°√≠rku` pre body, nie `zemepisn√∫ ≈°√≠rku, zemepisn√∫ dƒ∫≈æku`

Pole s√∫radn√≠c polyg√≥nu m√° v≈ædy o 1 z√°znam viac ako poƒçet bodov na polyg√≥ne, priƒçom posledn√Ω z√°znam je rovnak√Ω ako prv√Ω, ƒç√≠m sa polyg√≥n uzavrie. Napr√≠klad pre obdƒ∫≈ænik by tam bolo 5 bodov.

![Obdƒ∫≈ænik so s√∫radnicami](../../../../../translated_images/polygon-points.302193da381cb415f46c2c7a98496ee4be05d6c73d21238a89721ad93e121233.sk.png)

Na obr√°zku vy≈°≈°ie je obdƒ∫≈ænik. S√∫radnice polyg√≥nu zaƒç√≠naj√∫ v ƒæavom hornom rohu na 47,-122, potom sa pos√∫vaj√∫ doprava na 47,-121, potom dole na 46,-121, potom doprava na 46,-122, a nakoniec sp√§≈• hore na poƒçiatoƒçn√Ω bod na 47,-122. To d√°va polyg√≥nu 5 bodov - ƒæav√Ω horn√Ω, prav√Ω horn√Ω, prav√Ω doln√Ω, ƒæav√Ω doln√Ω a nakoniec ƒæav√Ω horn√Ω na uzavretie.

‚úÖ Sk√∫ste vytvori≈• GeoJSON polyg√≥n okolo v√°≈°ho domova alebo ≈°koly. Pou≈æite n√°stroj ako [GeoJSON.io](https://geojson.io/).

### √öloha - definovanie geofence

Na pou≈æitie geofence v Azure Maps ho najsk√¥r mus√≠te nahra≈• do svojho √∫ƒçtu Azure Maps. Po nahran√≠ z√≠skate jedineƒçn√© ID, ktor√© m√¥≈æete pou≈æi≈• na testovanie bodu voƒçi geofence. Na nahranie geofencov do Azure Maps mus√≠te pou≈æi≈• webov√© API mapy. M√¥≈æete zavola≈• webov√© API Azure Maps pomocou n√°stroja [curl](https://curl.se).

> üéì Curl je n√°stroj pr√≠kazov√©ho riadku na vykon√°vanie po≈æiadaviek na webov√© koncov√© body

1. Ak pou≈æ√≠vate Linux, macOS alebo nov≈°iu verziu Windows 10, pravdepodobne u≈æ m√°te curl nain≈°talovan√Ω. Spustite nasleduj√∫ci pr√≠kaz z termin√°lu alebo pr√≠kazov√©ho riadku na kontrolu:

    ```sh
    curl --version
    ```

    Ak nevid√≠te inform√°cie o verzii curl, budete ho musie≈• nain≈°talova≈• zo [str√°nky na stiahnutie curl](https://curl.se/download.html).

    > üíÅ Ak m√°te sk√∫senosti s Postmanom, m√¥≈æete ho pou≈æi≈• namiesto curl, ak preferujete.

1. Vytvorte GeoJSON s√∫bor obsahuj√∫ci polyg√≥n. Budete ho testova≈• pomocou v√°≈°ho GPS senzora, tak≈æe vytvorte polyg√≥n okolo va≈°ej aktu√°lnej polohy. M√¥≈æete ho vytvori≈• manu√°lne √∫pravou GeoJSON pr√≠kladu uveden√©ho vy≈°≈°ie alebo pou≈æi≈• n√°stroj ako [GeoJSON.io](https://geojson.io).

    GeoJSON mus√≠ obsahova≈• `FeatureCollection`, obsahuj√∫ce `Feature` s `geometry` typu `Polygon`.

    Mus√≠te tie≈æ prida≈• prvok `properties` na rovnakej √∫rovni ako prvok `geometry`, a tento mus√≠ obsahova≈• `geometryId`:

    ```json
    "properties": {
        "geometryId": "1"
    }
    ```

    Ak pou≈æijete [GeoJSON.io](https://geojson.io), budete musie≈• manu√°lne prida≈• tento prvok do pr√°zdneho `properties` prvku, buƒè po stiahnut√≠ JSON s√∫boru, alebo v JSON editore v aplik√°cii.

    Tento `geometryId` mus√≠ by≈• jedineƒçn√Ω v tomto s√∫bore. M√¥≈æete nahra≈• viacero geofencov ako viacero `Features` v `FeatureCollection` v tom istom GeoJSON s√∫bore, pokiaƒæ m√° ka≈æd√Ω z nich in√Ω `geometryId`. Polyg√≥ny m√¥≈æu ma≈• rovnak√Ω `geometryId`, ak s√∫ nahran√© z in√©ho s√∫boru v inom ƒçase.

1. Ulo≈æte tento s√∫bor ako `geofence.json` a prejdite do miesta, kde je ulo≈æen√Ω, vo va≈°om termin√°li alebo konzole.

1. Spustite nasleduj√∫ci curl pr√≠kaz na vytvorenie GeoFence:

    ```sh
    curl --request POST 'https://atlas.microsoft.com/mapData/upload?api-version=1.0&dataFormat=geojson&subscription-key=<subscription_key>' \
         --header 'Content-Type: application/json' \
         --include \
         --data @geofence.json
    ```

    Nahraƒète `<subscription_key>` v URL API kƒæ√∫ƒçom v√°≈°ho √∫ƒçtu Azure Maps.

    URL sa pou≈æ√≠va na nahranie mapov√Ωch √∫dajov cez API `https://atlas.microsoft.com/mapData/upload`. Po≈æiadavka obsahuje parameter `api-version` na ≈°pecifik√°ciu, ktor√∫ verziu API Azure Maps pou≈æi≈•, aby sa API mohlo ƒçasom meni≈•, ale zachova≈• sp√§tn√∫ kompatibilitu. Form√°t √∫dajov, ktor√Ω sa nahr√°va, je nastaven√Ω na `geojson`.

    Tento pr√≠kaz vykon√° POST po≈æiadavku na API nahr√°vania a vr√°ti zoznam hlaviƒçiek odpovede, ktor√Ω obsahuje hlaviƒçku nazvan√∫ `location`.

    ```output
    content-type: application/json
    location: https://us.atlas.microsoft.com/mapData/operations/1560ced6-3a80-46f2-84b2-5b1531820eab?api-version=1.0
    x-ms-azuremaps-region: West US 2
    x-content-type-options: nosniff
    strict-transport-security: max-age=31536000; includeSubDomains
    x-cache: CONFIG_NOCACHE
    date: Sat, 22 May 2021 21:34:57 GMT
    content-length: 0
    ```

    > üéì Pri volan√≠ webov√©ho koncov√©ho bodu m√¥≈æete odovzda≈• parametre po≈æiadavky pridan√≠m `?` nasledovan√©ho dvojicami kƒæ√∫ƒç-hodnota ako `key=value`, oddelen√Ωmi `&`.

1. Azure Maps nespracov√°va t√∫to po≈æiadavku okam≈æite, tak≈æe budete musie≈• skontrolova≈•, ƒçi po≈æiadavka na nahranie bola dokonƒçen√°, pomocou URL uveden√©ho v hlaviƒçke `location`. Vykonajte GET po≈æiadavku na t√∫to URL na kontrolu stavu. Mus√≠te prida≈• v√°≈° API kƒæ√∫ƒç na koniec URL `location` pridan√≠m `&subscription-key=<subscription_key>` na koniec, priƒçom `<subscription_key>` nahrad√≠te API kƒæ√∫ƒçom v√°≈°ho √∫ƒçtu Azure Maps. Spustite nasleduj√∫ci pr√≠kaz:

    ```sh
    curl --request GET '<location>&subscription-key=<subscription_key>'
    ```

    Nahraƒète `<location>` hodnotou hlaviƒçky `location` a `<subscription_key>` API kƒæ√∫ƒçom v√°≈°ho √∫ƒçtu Azure Maps.

1. Skontrolujte hodnotu `status` v odpovedi. Ak nie je `Succeeded`, poƒçkajte min√∫tu a sk√∫ste znova.

1. Keƒè sa stav vr√°ti ako `Succeeded`, pozrite sa na `resourceLocation` z odpovede. Obsahuje podrobnosti o jedineƒçnom ID (zn√°mom ako UDID) pre GeoJSON objekt. UDID je hodnota po `metadata/`, bez zahrnutia `api-version`. Napr√≠klad, ak `resourceLocation` bolo:

    ```json
    {
      "resourceLocation": "https://us.atlas.microsoft.com/mapData/metadata/7c3776eb-da87-4c52-ae83-caadf980323a?api-version=1.0"
    }
    ```

    Potom UDID by bolo `7c3776eb-da87-4c52-ae83-caadf980323a`.

    Uchovajte si k√≥piu tohto UDID, preto≈æe ho budete potrebova≈• na testovanie geofence.

## Testovanie bodov voƒçi geofence

Keƒè je polyg√≥n nahran√Ω do Azure Maps, m√¥≈æete testova≈• bod, ƒçi je vo vn√∫tri alebo mimo geofence. Urob√≠te to vykonan√≠m po≈æiadavky na webov√© API, priƒçom odovzd√°te UDID geofence a zemepisn√∫ ≈°√≠rku a dƒ∫≈æku bodu na testovanie.

Pri vykon√°van√≠ tejto po≈æiadavky m√¥≈æete tie≈æ odovzda≈• hodnotu nazvan√∫ `searchBuffer`. T√°to hodnota urƒçuje, ak√∫ presnos≈• m√° API pri vracan√≠ v√Ωsledkov. D√¥vodom je, ≈æe GPS nie je dokonale presn√© a niekedy m√¥≈æu by≈• polohy nepresn√© o niekoƒæko metrov alebo viac. Predvolen√° hodnota pre `searchBuffer` je 50m, ale m√¥≈æete nastavi≈• hodnoty od 0m do 500m.

Keƒè API vr√°ti v√Ωsledky, jedna z ƒçast√≠ v√Ωsledku je `distance`, meran√° k najbli≈æ≈°iemu bodu na okraji geofence, s kladnou hodnotou, ak je bod mimo geofence, a z√°pornou hodnotou, ak je vo vn√∫tri geofence. Ak je t√°to vzdialenos≈• men≈°ia ako `searchBuffer`, skutoƒçn√° vzdialenos≈• sa vr√°ti v metroch, inak je hodnota 999 alebo -999. 999 znamen√°, ≈æe bod je mimo geofence o viac ako `searchBuffer`, -999 znamen√°, ≈æe je vo vn√∫tri geofence o viac ako `searchBuffer`.

![Geofence s 50m vyhƒæad√°vac√≠m bufferom okolo neho](../../../../../translated_images/search-buffer-and-distance.e6a79af3898183c7b2ef6fbf12271b8b34afd23969bb946962b1b18d3d2635e8.sk.png)

Na obr√°zku vy≈°≈°ie m√° geofence 50m vyhƒæad√°vac√≠ buffer.

* Bod v strede geofence, dobre vo vn√∫tri vyhƒæad√°vacieho bufferu, m√° vzdialenos≈• **-999**
* Bod dobre mimo vyhƒæad√°vacieho bufferu m√° vzdialenos≈• **999**
* Bod vo vn√∫tri geofence a vo vn√∫tri vyhƒæad√°vacieho bufferu, 6m od geofence, m√° vzdialenos≈• **6m**
* Bod mimo geofence a vo vn√∫tri vyhƒæad√°vacieho bufferu, 39m od geofence, m√° vzdialenos≈• **39m**

Je d√¥le≈æit√© pozna≈• vzdialenos≈• k okraju geofence a kombinova≈• ju s ƒèal≈°√≠mi inform√°ciami, ako s√∫ in√© GPS hodnoty, r√Ωchlos≈• a √∫daje o cest√°ch, pri rozhodovan√≠ na z√°klade polohy vozidla.

Napr√≠klad si predstavte GPS hodnoty ukazuj√∫ce, ≈æe vozidlo jazdilo po ceste, ktor√° vedie vedƒæa geofence. Ak jedna GPS hodnota je nepresn√° a umiestni vozidlo vo vn√∫tri geofence, napriek tomu, ≈æe tam nie je pr√≠stup pre vozidl√°, m√¥≈æe by≈• ignorovan√°.

![GPS trasa ukazuj√∫ca vozidlo prech√°dzaj√∫ce okolo kampusu Microsoft na 520, s GPS hodnotami pozdƒ∫≈æ cesty okrem jednej na kampuse, vo vn√∫tri geofence](../../../../../translated_images/geofence-crossing-inaccurate-gps.6a3ed911202ad9cabb66d3964888cec03a42c61d5b8f536ad5bdc99716b370f5.sk.png)
Na vy≈°≈°ie uvedenom obr√°zku je geofence nad ƒças≈•ou kampusu Microsoft. ƒåerven√° ƒçiara ukazuje n√°kladn√© auto jazdiace po 520, priƒçom kruhy oznaƒçuj√∫ GPS √∫daje. V√§ƒç≈°ina z nich je presn√° a nach√°dza sa na 520, s jedn√Ωm nepresn√Ωm √∫dajom vo vn√∫tri geofence. Tento √∫daj nem√¥≈æe by≈• spr√°vny ‚Äì neexistuj√∫ ≈æiadne cesty, po ktor√Ωch by sa n√°kladn√© auto mohlo n√°hle odkloni≈• z 520 na kampus a potom sp√§≈• na 520. K√≥d, ktor√Ω kontroluje tento geofence, bude musie≈• zohƒæadni≈• predch√°dzaj√∫ce √∫daje predt√Ωm, ne≈æ bude kona≈• na z√°klade v√Ωsledkov testu geofence.

‚úÖ Ak√© ƒèal≈°ie √∫daje by ste potrebovali skontrolova≈•, aby ste zistili, ƒçi GPS √∫daj m√¥≈æe by≈• pova≈æovan√Ω za spr√°vny?

### √öloha - testovanie bodov voƒçi geofence

1. Zaƒçnite vytvoren√≠m URL pre dotaz na webov√© API. Form√°t je:

    ```output
    https://atlas.microsoft.com/spatial/geofence/json?api-version=1.0&deviceId=gps-sensor&subscription-key=<subscription-key>&udid=<UDID>&lat=<lat>&lon=<lon>
    ```

    Nahraƒète `<subscription_key>` API kƒæ√∫ƒçom pre v√°≈° √∫ƒçet Azure Maps.

    Nahraƒète `<UDID>` UDID geofence z predch√°dzaj√∫cej √∫lohy.

    Nahraƒète `<lat>` a `<lon>` zemepisnou ≈°√≠rkou a dƒ∫≈ækou, ktor√© chcete testova≈•.

    T√°to URL pou≈æ√≠va API `https://atlas.microsoft.com/spatial/geofence/json` na dotazovanie geofence definovan√©ho pomocou GeoJSON. Cieli na verziu API `1.0`. Parameter `deviceId` je povinn√Ω a mal by by≈• n√°zvom zariadenia, z ktor√©ho poch√°dzaj√∫ zemepisn√° ≈°√≠rka a dƒ∫≈æka.

    Predvolen√Ω vyhƒæad√°vac√≠ buffer je 50m, a m√¥≈æete ho zmeni≈• pridan√≠m ƒèal≈°ieho parametra `searchBuffer=<distance>`, kde `<distance>` je vzdialenos≈• vyhƒæad√°vacieho bufferu v metroch, od 0 do 500.

1. Pou≈æite curl na vykonanie GET po≈æiadavky na t√∫to URL:

    ```sh
    curl --request GET '<URL>'
    ```

    > üíÅ Ak dostanete odpoveƒèov√Ω k√≥d `BadRequest` s chybou:
    >
    > ```output
    > Invalid GeoJSON: All feature properties should contain a geometryId, which is used for identifying the geofence.
    > ```
    >
    > potom v√°≈° GeoJSON ch√Ωba sekcia `properties` s `geometryId`. Budete musie≈• opravi≈• v√°≈° GeoJSON, potom zopakova≈• vy≈°≈°ie uveden√© kroky na op√§tovn√© nahranie a z√≠skanie nov√©ho UDID.

1. Odpoveƒè bude obsahova≈• zoznam `geometries`, jeden pre ka≈æd√Ω polygon definovan√Ω v GeoJSON pou≈æitom na vytvorenie geofence. Ka≈æd√° geometria m√° 3 zauj√≠mav√© polia: `distance`, `nearestLat` a `nearestLon`.

    ```output
    {
        "geometries": [
            {
                "deviceId": "gps-sensor",
                "udId": "7c3776eb-da87-4c52-ae83-caadf980323a",
                "geometryId": "1",
                "distance": 999.0,
                "nearestLat": 47.645875,
                "nearestLon": -122.142713
            }
        ],
        "expiredGeofenceGeometryId": [],
        "invalidPeriodGeofenceGeometryId": []
    }
    ```

    * `nearestLat` a `nearestLon` s√∫ zemepisn√° ≈°√≠rka a dƒ∫≈æka bodu na okraji geofence, ktor√Ω je najbli≈æ≈°ie k testovanej lokalite.

    * `distance` je vzdialenos≈• od testovanej lokality k najbli≈æ≈°iemu bodu na okraji geofence. Z√°porn√© ƒç√≠sla znamenaj√∫, ≈æe bod je vo vn√∫tri geofence, kladn√© mimo. T√°to hodnota bude men≈°ia ako 50 (predvolen√Ω vyhƒæad√°vac√≠ buffer) alebo 999.

1. Opakujte tento proces viackr√°t s lokalitami vo vn√∫tri a mimo geofence.

## Pou≈æitie geofence zo serverless k√≥du

Teraz m√¥≈æete prida≈• nov√Ω trigger do va≈°ej Functions aplik√°cie na testovanie GPS √∫dajov z IoT Hub voƒçi geofence.

### Consumer groups

Ako si pam√§t√°te z predch√°dzaj√∫cich lekci√≠, IoT Hub umo≈æ≈àuje prehr√°va≈• udalosti, ktor√© boli prijat√© hubom, ale neboli spracovan√©. Ale ƒço sa stane, ak sa pripoj√≠ viacero triggerov? Ako bude vedie≈•, ktor√Ω spracoval ktor√© udalosti?

Odpoveƒè je, ≈æe to nevie! Namiesto toho m√¥≈æete definova≈• viacero samostatn√Ωch pripojen√≠ na ƒç√≠tanie udalost√≠, priƒçom ka≈æd√© z nich m√¥≈æe spravova≈• prehr√°vanie nepreƒç√≠tan√Ωch spr√°v. Tieto sa naz√Ωvaj√∫ *consumer groups*. Keƒè sa pripoj√≠te k endpointu, m√¥≈æete ≈°pecifikova≈•, ku ktor√©mu consumer group sa chcete pripoji≈•. Ka≈æd√° s√∫ƒças≈• va≈°ej aplik√°cie sa pripoj√≠ k in√©mu consumer group.

![Jeden IoT Hub s 3 consumer groups distribuuj√∫cimi rovnak√© spr√°vy do 3 r√¥znych Functions aplik√°ci√≠](../../../../../translated_images/consumer-groups.a3262e26fc27ba2092863678ad57af15c7223416e388a23f330c058cf4358630.sk.png)

Teoreticky sa m√¥≈æe k ka≈æd√©mu consumer group pripoji≈• a≈æ 5 aplik√°ci√≠, a v≈°etky dostan√∫ spr√°vy, keƒè pr√≠du. Najlep≈°ou praxou je ma≈• iba jednu aplik√°ciu pr√≠stupn√∫ k ka≈æd√©mu consumer group, aby sa zabr√°nilo duplicitn√©mu spracovaniu spr√°v a zabezpeƒçilo, ≈æe pri re≈°tarte bud√∫ v≈°etky ƒçakaj√∫ce spr√°vy spr√°vne spracovan√©. Napr√≠klad, ak spust√≠te svoju Functions aplik√°ciu lok√°lne, ako aj v cloude, obe by spracov√°vali spr√°vy, ƒço by viedlo k duplicitn√Ωm blobom ulo≈æen√Ωm v √∫lo≈ænom √∫ƒçte.

Ak si prezriete s√∫bor `function.json` pre IoT Hub trigger, ktor√Ω ste vytvorili v predch√°dzaj√∫cej lekcii, uvid√≠te consumer group v sekcii event hub trigger binding:

```json
"consumerGroup": "$Default"
```

Keƒè vytvor√≠te IoT Hub, predvolene sa vytvor√≠ consumer group `$Default`. Ak chcete prida≈• ƒèal≈°√≠ trigger, m√¥≈æete ho prida≈• pomocou nov√©ho consumer group.

> üíÅ V tejto lekcii pou≈æijete in√∫ funkciu na testovanie geofence ako t√∫, ktor√° sa pou≈æ√≠va na ukladanie GPS √∫dajov. Toto je na uk√°≈æku pou≈æitia consumer groups a oddelenia k√≥du, aby bol ƒæah≈°ie ƒçitateƒæn√Ω a pochopiteƒæn√Ω. V produkƒçnej aplik√°cii existuje mnoho sp√¥sobov, ako by ste to mohli navrhn√∫≈• ‚Äì umiestnen√≠m oboch do jednej funkcie, pou≈æit√≠m triggeru na √∫lo≈ænom √∫ƒçte na spustenie funkcie na kontrolu geofence, alebo pou≈æit√≠m viacer√Ωch funkci√≠. Neexistuje "spr√°vny sp√¥sob", z√°le≈æ√≠ na zvy≈°ku va≈°ej aplik√°cie a va≈°ich potreb√°ch.

### √öloha - vytvorenie nov√©ho consumer group

1. Spustite nasleduj√∫ci pr√≠kaz na vytvorenie nov√©ho consumer group s n√°zvom `geofence` pre v√°≈° IoT Hub:

    ```sh
    az iot hub consumer-group create --name geofence \
                                     --hub-name <hub_name>
    ```

    Nahraƒète `<hub_name>` n√°zvom, ktor√Ω ste pou≈æili pre v√°≈° IoT Hub.

1. Ak chcete vidie≈• v≈°etky consumer groups pre IoT Hub, spustite nasleduj√∫ci pr√≠kaz:

    ```sh
    az iot hub consumer-group list --output table \
                                   --hub-name <hub_name>
    ```

    Nahraƒète `<hub_name>` n√°zvom, ktor√Ω ste pou≈æili pre v√°≈° IoT Hub. Toto zobraz√≠ v≈°etky consumer groups.

    ```output
    Name      ResourceGroup
    --------  ---------------
    $Default  gps-sensor
    geofence  gps-sensor
    ```

> üíÅ Keƒè ste v predch√°dzaj√∫cej lekcii spustili monitor udalost√≠ IoT Hub, pripojil sa k consumer group `$Default`. Preto nem√¥≈æete spusti≈• monitor udalost√≠ a trigger udalost√≠. Ak chcete spusti≈• oboje, m√¥≈æete pou≈æi≈• in√© consumer groups pre v≈°etky va≈°e Functions aplik√°cie a ponecha≈• `$Default` pre monitor udalost√≠.

### √öloha - vytvorenie nov√©ho IoT Hub triggeru

1. Pridajte nov√Ω IoT Hub event trigger do va≈°ej `gps-trigger` Functions aplik√°cie, ktor√∫ ste vytvorili v predch√°dzaj√∫cej lekcii. Nazvite t√∫to funkciu `geofence-trigger`.

    > ‚ö†Ô∏è M√¥≈æete sa odvola≈• na [pokyny na vytvorenie IoT Hub event triggeru z projektu 2, lekcia 5, ak je to potrebn√©](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#create-an-iot-hub-event-trigger).

1. Nakonfigurujte IoT Hub connection string v s√∫bore `function.json`. S√∫bor `local.settings.json` je zdieƒæan√Ω medzi v≈°etk√Ωmi triggermi v Functions aplik√°cii.

1. Aktualizujte hodnotu `consumerGroup` v s√∫bore `function.json`, aby odkazovala na nov√Ω consumer group `geofence`:

    ```json
    "consumerGroup": "geofence"
    ```

1. Budete potrebova≈• subscription key pre v√°≈° √∫ƒçet Azure Maps v tomto triggeri, tak≈æe pridajte nov√Ω z√°znam do s√∫boru `local.settings.json` s n√°zvom `MAPS_KEY`.

1. Spustite Functions aplik√°ciu, aby ste sa uistili, ≈æe sa prip√°ja a spracov√°va spr√°vy. Trigger `iot-hub-trigger` z predch√°dzaj√∫cej lekcie bude tie≈æ be≈æa≈• a nahr√°va≈• blob do √∫lo≈æiska.

    > Aby ste sa vyhli duplicitn√Ωm GPS √∫dajom v blob √∫lo≈æisku, m√¥≈æete zastavi≈• Functions aplik√°ciu, ktor√∫ m√°te spusten√∫ v cloude. Na to pou≈æite nasleduj√∫ci pr√≠kaz:
    >
    > ```sh
    > az functionapp stop --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Nahraƒète `<functions_app_name>` n√°zvom, ktor√Ω ste pou≈æili pre va≈°u Functions aplik√°ciu.
    >
    > Nesk√¥r ju m√¥≈æete znova spusti≈• nasleduj√∫cim pr√≠kazom:
    >
    > ```sh
    > az functionapp start --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Nahraƒète `<functions_app_name>` n√°zvom, ktor√Ω ste pou≈æili pre va≈°u Functions aplik√°ciu.

### √öloha - testovanie geofence z triggeru

V predch√°dzaj√∫cej ƒçasti tejto lekcie ste pou≈æili curl na dotazovanie geofence, aby ste zistili, ƒçi sa bod nach√°dza vo vn√∫tri alebo mimo. Podobn√∫ webov√∫ po≈æiadavku m√¥≈æete vykona≈• z vn√∫tra v√°≈°ho triggeru.

1. Na dotazovanie geofence potrebujete jeho UDID. Pridajte nov√Ω z√°znam do s√∫boru `local.settings.json` s n√°zvom `GEOFENCE_UDID` s touto hodnotou.

1. Otvorte s√∫bor `__init__.py` z nov√©ho triggeru `geofence-trigger`.

1. Pridajte nasleduj√∫ci import na zaƒçiatok s√∫boru:

    ```python
    import json
    import os
    import requests
    ```

    Bal√≠k `requests` umo≈æ≈àuje vykon√°va≈• webov√© API po≈æiadavky. Azure Maps nem√° Python SDK, mus√≠te vykon√°va≈• webov√© API po≈æiadavky na jeho pou≈æitie z Python k√≥du.

1. Pridajte nasleduj√∫ce 2 riadky na zaƒçiatok met√≥dy `main`, aby ste z√≠skali subscription key pre Maps:

    ```python
    maps_key = os.environ['MAPS_KEY']
    geofence_udid = os.environ['GEOFENCE_UDID']    
    ```

1. Vo vn√∫tri cyklu `for event in events` pridajte nasleduj√∫ce na z√≠skanie zemepisnej ≈°√≠rky a dƒ∫≈æky z ka≈æd√©ho eventu:

    ```python
    event_body = json.loads(event.get_body().decode('utf-8'))
    lat = event_body['gps']['lat']
    lon = event_body['gps']['lon']
    ```

    Tento k√≥d konvertuje JSON z tela eventu na slovn√≠k a potom extrahuje `lat` a `lon` z poƒæa `gps`.

1. Pri pou≈æit√≠ `requests`, namiesto vytv√°rania dlhej URL ako ste to robili s curl, m√¥≈æete pou≈æi≈• iba ƒças≈• URL a odovzda≈• parametre ako slovn√≠k. Pridajte nasleduj√∫ci k√≥d na definovanie URL na volanie a konfigur√°ciu parametrov:

    ```python
    url = 'https://atlas.microsoft.com/spatial/geofence/json'

    params = {
        'api-version': 1.0,
        'deviceId': 'gps-sensor',
        'subscription-key': maps_key,
        'udid' : geofence_udid,
        'lat' : lat,
        'lon' : lon
    }
    ```

    Polo≈æky v slovn√≠ku `params` bud√∫ zodpoveda≈• kƒæ√∫ƒçov√Ωm hodnot√°m, ktor√© ste pou≈æili pri volan√≠ webov√©ho API cez curl.

1. Pridajte nasleduj√∫ce riadky k√≥du na volanie webov√©ho API:

    ```python
    response = requests.get(url, params=params)
    response_body = json.loads(response.text)
    ```

    Toto vol√° URL s parametrami a z√≠skava sp√§≈• objekt odpovede.

1. Pridajte nasleduj√∫ci k√≥d pod toto:

    ```python
    distance = response_body['geometries'][0]['distance']

    if distance == 999:
        logging.info('Point is outside geofence')
    elif distance > 0:
        logging.info(f'Point is just outside geofence by a distance of {distance}m')
    elif distance == -999:
        logging.info(f'Point is inside geofence')
    else:
        logging.info(f'Point is just inside geofence by a distance of {distance}m')
    ```

    Tento k√≥d predpoklad√° 1 geometriu a extrahuje vzdialenos≈• z tejto jednej geometrie. Potom zapisuje r√¥zne spr√°vy na z√°klade vzdialenosti.

1. Spustite tento k√≥d. V logovacom v√Ωstupe uvid√≠te, ƒçi GPS s√∫radnice s√∫ vo vn√∫tri alebo mimo geofence, s vzdialenos≈•ou, ak je bod do 50m. Vysk√∫≈°ajte tento k√≥d s r√¥znymi geofence na z√°klade polohy v√°≈°ho GPS senzora, sk√∫ste presun√∫≈• senzor (napr√≠klad pripojen√Ω k WiFi z mobiln√©ho telef√≥nu alebo s r√¥znymi s√∫radnicami na virtu√°lnom IoT zariaden√≠), aby ste videli t√∫to zmenu.

1. Keƒè budete pripraven√≠, nasadte tento k√≥d do va≈°ej Functions aplik√°cie v cloude. Nezabudnite nasadi≈• nov√© Application Settings.

    > ‚ö†Ô∏è M√¥≈æete sa odvola≈• na [pokyny na nahranie Application Settings z projektu 2, lekcia 5, ak je to potrebn√©](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---upload-your-application-settings).

    > ‚ö†Ô∏è M√¥≈æete sa odvola≈• na [pokyny na nasadenie va≈°ej Functions aplik√°cie z projektu 2, lekcia 5, ak je to potrebn√©](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---deploy-your-functions-app-to-the-cloud).

> üíÅ Tento k√≥d n√°jdete v prieƒçinku [code/functions](../../../../../3-transport/lessons/4-geofences/code/functions).

---

## üöÄ V√Ωzva

V tejto lekcii ste pridali jeden geofence pomocou GeoJSON s√∫boru s jedn√Ωm polygon. M√¥≈æete nahra≈• viacero polygonov naraz, pokiaƒæ maj√∫ r√¥zne hodnoty `geometryId` v sekcii `properties`.

Vysk√∫≈°ajte nahra≈• GeoJSON s√∫bor s viacer√Ωmi polygonmi a upravte v√°≈° k√≥d tak, aby na≈°iel, ku ktor√©mu polygonu s√∫ GPS s√∫radnice najbli≈æ≈°ie alebo v ktorom sa nach√°dzaj√∫.

## Kv√≠z po predn√°≈°ke

[Kv√≠z po predn√°≈°ke](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/28)

## Prehƒæad & Samo≈°t√∫dium

* Preƒç√≠tajte si viac o geofence a niektor√Ωch ich pou≈æitiach na [str√°nke Geofencing na Wikip√©dii](https://en.wikipedia.org/wiki/Geo-fence).
* Preƒç√≠tajte si viac o Azure Maps geofencing API na [dokument√°cii Microsoft Azure Maps Spatial - Get Geofence](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence?WT.mc_id=academic-17441-jabenn).
* Preƒç√≠tajte si viac o consumer groups v [dokument√°cii Microsoft docs o funkci√°ch a terminol√≥gii v Azure Event Hubs - Event consumers](https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=academic-17441-jabenn#event-consumers).

## Zadanie

[Posielanie notifik√°ci√≠ pomocou Twilio](assignment.md)

---

**Upozornenie**:  
Tento dokument bol prelo≈æen√Ω pomocou slu≈æby AI prekladu [Co-op Translator](https://github.com/Azure/co-op-translator). Hoci sa sna≈æ√≠me o presnos≈•, pros√≠m, berte na vedomie, ≈æe automatizovan√© preklady m√¥≈æu obsahova≈• chyby alebo nepresnosti. P√¥vodn√Ω dokument v jeho p√¥vodnom jazyku by mal by≈• pova≈æovan√Ω za autoritat√≠vny zdroj. Pre kritick√© inform√°cie sa odpor√∫ƒça profesion√°lny ƒæudsk√Ω preklad. Nie sme zodpovedn√≠ za ak√©koƒævek nedorozumenia alebo nespr√°vne interpret√°cie vypl√Ωvaj√∫ce z pou≈æitia tohto prekladu.