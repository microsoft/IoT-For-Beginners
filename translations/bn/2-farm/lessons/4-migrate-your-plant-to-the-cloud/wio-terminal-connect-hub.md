<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-27T12:03:52+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "bn"
}
-->
# ржЖржкржирж╛рж░ IoT ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ ржХрзНрж▓рж╛ржЙржбрзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рзБржи - Wio Terminal

ржПржЗ ржкрж╛ржарзЗрж░ ржПржЗ ржЕржВрж╢рзЗ, ржЖржкржирж┐ ржЖржкржирж╛рж░ Wio Terminal-ржХрзЗ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░ржмрзЗржи, ржЯрзЗрж▓рж┐ржорзЗржЯрзНрж░рж┐ ржкрж╛ржарж╛ржирзЛрж░ ржПржмржВ ржХржорж╛ржирзНржб ржЧрзНрж░рж╣ржг ржХрж░рж╛рж░ ржЬржирзНржпред

## ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рзБржи

ржкрж░ржмрж░рзНрждрзА ржзрж╛ржкржЯрж┐ рж╣рж▓рзЛ ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рж╛ред

### ржХрж╛ржЬ - IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рзБржи

1. VS Code-ржП `soil-moisture-sensor` ржкрзНрж░ржХрж▓рзНржкржЯрж┐ ржЦрзБрж▓рзБржиред

1. `platformio.ini` ржлрж╛ржЗрж▓ржЯрж┐ ржЦрзБрж▓рзБржиред `knolleary/PubSubClient` рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржбрж┐ржкрзЗржиржбрзЗржирзНрж╕рж┐ рж╕рж░рж┐рзЯрзЗ ржлрзЗрж▓рзБржиред ржПржЯрж┐ ржкрж╛ржмрж▓рж┐ржХ MQTT ржмрзНрж░рзЛржХрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧ ржХрж░рж╛рж░ ржЬржирзНржп ржмрзНржпржмрж╣рзГржд рж╣рзЯрзЗржЫрж┐рж▓, ржПржмржВ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧ ржХрж░рж╛рж░ ржЬржирзНржп ржПржЯрж┐ ржкрзНрж░рзЯрзЛржЬржи ржирзЗржЗред

1. ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржбрж┐ржкрзЗржиржбрзЗржирзНрж╕рж┐ ржпрзЛржЧ ржХрж░рзБржи:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    `Seeed Arduino RTC` рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ Wio Terminal-ржП ржПржХржЯрж┐ рж░рж┐рзЯрзЗрж▓-ржЯрж╛ржЗржо ржХрзНрж▓ржХрзЗрж░ рж╕рж╛ржерзЗ ржЗржирзНржЯрж╛рж░ржЕрзНржпрж╛ржХрзНржЯ ржХрж░рж╛рж░ ржХрзЛржб ржкрзНрж░ржжрж╛ржи ржХрж░рзЗ, ржпрж╛ рж╕ржорзЯ ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рж╛рж░ ржЬржирзНржп ржмрзНржпржмрж╣рзГржд рж╣рзЯред ржмрж╛ржХрж┐ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ржЧрзБрж▓рж┐ ржЖржкржирж╛рж░ IoT ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗред

1. `platformio.ini` ржлрж╛ржЗрж▓рзЗрж░ ржирж┐ржЪрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржпрзЛржЧ ржХрж░рзБржи:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    ржПржЯрж┐ ржПржХржЯрж┐ ржХржорзНржкрж╛ржЗрж▓рж╛рж░ ржлрзНрж▓рзНржпрж╛ржЧ рж╕рзЗржЯ ржХрж░рзЗ ржпрж╛ Arduino IoT Hub ржХрзЛржб ржХржорзНржкрж╛ржЗрж▓ ржХрж░рж╛рж░ рж╕ржорзЯ ржкрзНрж░рзЯрзЛржЬржиред

1. `config.h` рж╣рзЗржбрж╛рж░ ржлрж╛ржЗрж▓ржЯрж┐ ржЦрзБрж▓рзБржиред рж╕ржорж╕рзНржд MQTT рж╕рзЗржЯрж┐ржВрж╕ рж╕рж░рж┐рзЯрзЗ ржлрзЗрж▓рзБржи ржПржмржВ ржбрж┐ржнрж╛ржЗрж╕ рж╕ржВржпрзЛржЧ рж╕рзНржЯрзНрж░рж┐ржВ-ржПрж░ ржЬржирзНржп ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХржирж╕рзНржЯрзНржпрж╛ржирзНржЯ ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    `<connection string>`-ржПрж░ ржЬрж╛рзЯржЧрж╛рзЯ ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕рзЗрж░ рж╕ржВржпрзЛржЧ рж╕рзНржЯрзНрж░рж┐ржВржЯрж┐ ржмрж╕рж╛ржи ржпрж╛ ржЖржкржирж┐ ржЖржЧрзЗ ржХржкрж┐ ржХрж░рзЗржЫрж┐рж▓рзЗржиред

1. IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧ ржПржХржЯрж┐ рж╕ржорзЯ-ржнрж┐рждрзНрждрж┐ржХ ржЯрзЛржХрзЗржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред ржПрж░ ржорж╛ржирзЗ рж╣рж▓рзЛ IoT ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ ржЬрж╛ржирждрзЗ рж╣ржмрзЗред Windows, macOS ржмрж╛ Linux-ржПрж░ ржорждрзЛ ржЕржкрж╛рж░рзЗржЯрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ ржмрж┐ржкрж░рзАрждрзЗ, ржорж╛ржЗржХрзНрж░рзЛржХржирзНржЯрзНрж░рзЛрж▓рж╛рж░ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛ржЗржЬ ржХрж░рзЗ ржирж╛ред ржПрж░ ржорж╛ржирзЗ рж╣рж▓рзЛ ржЖржкржирж╛ржХрзЗ ржПржХржЯрж┐ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ ржкрж╛ржУрзЯрж╛рж░ ржЬржирзНржп ржХрзЛржб ржпрзЛржЧ ржХрж░рждрзЗ рж╣ржмрзЗред ржПржХржмрж╛рж░ рж╕ржорзЯ ржкрж╛ржУрзЯрж╛ ржЧрзЗрж▓рзЗ, ржПржЯрж┐ Wio Terminal-ржПрж░ рж░рж┐рзЯрзЗрж▓-ржЯрж╛ржЗржо ржХрзНрж▓ржХрзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ, ржпрж╛ ржбрж┐ржнрж╛ржЗрж╕ ржкрж╛ржУрзЯрж╛рж░ рж╣рж╛рж░рж╛рж▓рзЗ рж╕ржарж┐ржХ рж╕ржорзЯ ржкрзБржирж░рж╛рзЯ ржЕржирзБрж░рзЛржз ржХрж░рж╛рж░ ржЕржирзБржорждрж┐ ржжрзЗрзЯред `ntp.h` ржирж╛ржорзЗ ржПржХржЯрж┐ ржирждрзБржи ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзБржи ржПржмржВ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржб ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    ржПржЗ ржХрзЛржбрзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржПржЗ ржкрж╛ржарзЗрж░ ржЖржУрждрж╛рж░ ржмрж╛ржЗрж░рзЗред ржПржЯрж┐ ржПржХржЯрж┐ `initTime` ржирж╛ржоржХ ржлрж╛ржВрж╢ржи рж╕ржВржЬрзНржЮрж╛рзЯрж┐ржд ржХрж░рзЗ ржпрж╛ ржПржХржЯрж┐ NTP рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ ржкрж╛рзЯ ржПржмржВ Wio Terminal-ржПрж░ ржХрзНрж▓ржХ рж╕рзЗржЯ ржХрж░рждрзЗ ржПржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред

1. `main.cpp` ржлрж╛ржЗрж▓ржЯрж┐ ржЦрзБрж▓рзБржи ржПржмржВ рж╕ржорж╕рзНржд MQTT ржХрзЛржб рж╕рж░рж┐рзЯрзЗ ржлрзЗрж▓рзБржи, ржпрж╛рж░ ржоржзрзНржпрзЗ рж░рзЯрзЗржЫрзЗ `PubSubClient.h` рж╣рзЗржбрж╛рж░ ржлрж╛ржЗрж▓, `PubSubClient` ржнрзЗрж░рж┐рзЯрзЗржмрж▓ ржбрж┐ржХрзНрж▓рж╛рж░рзЗрж╢ржи, `reconnectMQTTClient` ржПржмржВ `createMQTTClient` ржорзЗржержб, ржПржмржВ ржПржЗ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ ржПржмржВ ржорзЗржержбржЧрзБрж▓рж┐рж░ ржХрзЛржирзЛ ржХрж▓ред ржПржЗ ржлрж╛ржЗрж▓ржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ WiFi-рждрзЗ рж╕ржВржпрзЛржЧ ржХрж░рж╛рж░, ржорж╛ржЯрж┐ ржЖрж░рзНржжрзНрж░рждрж╛ ржкрж╛ржУрзЯрж╛рж░ ржПржмржВ ржПржЯрж┐ ржПржХржЯрж┐ JSON ржбржХрзБржорзЗржирзНржЯрзЗ рждрзИрж░рж┐ ржХрж░рж╛рж░ ржХрзЛржб ржзрж╛рж░ржг ржХрж░ржмрзЗред

1. `main.cpp` ржлрж╛ржЗрж▓рзЗрж░ рж╢рзАрж░рзНрж╖рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд `#include` ржбрж┐рж░рзЗржХрзНржЯрж┐ржн ржпрзЛржЧ ржХрж░рзБржи IoT Hub рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржПржмржВ рж╕ржорзЯ рж╕рзЗржЯ ржХрж░рж╛рж░ ржЬржирзНржп рж╣рзЗржбрж╛рж░ ржлрж╛ржЗрж▓ ржЕржирзНрждрж░рзНржнрзБржХрзНржд ржХрж░рждрзЗ:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. `setup` ржлрж╛ржВрж╢ржирзЗрж░ рж╢рзЗрж╖рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрж▓ ржпрзЛржЧ ржХрж░рзБржи ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ рж╕рзЗржЯ ржХрж░рж╛рж░ ржЬржирзНржп:

    ```cpp
    initTime();
    ```

1. ржлрж╛ржЗрж▓рзЗрж░ рж╢рзАрж░рзНрж╖рзЗ, ржЕржирзНрждрж░рзНржнрзБржХрзНржд ржбрж┐рж░рзЗржХрзНржЯрж┐ржнржЧрзБрж▓рж┐рж░ ржарж┐ржХ ржирж┐ржЪрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржнрзЗрж░рж┐рзЯрзЗржмрж▓ ржбрж┐ржХрзНрж▓рж╛рж░рзЗрж╢ржи ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    ржПржЯрж┐ ржПржХржЯрж┐ `IOTHUB_DEVICE_CLIENT_LL_HANDLE` ржШрзЛрж╖ржгрж╛ ржХрж░рзЗ, ржпрж╛ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧрзЗрж░ ржПржХржЯрж┐ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ред

1. ржПрж░ ржирж┐ржЪрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржб ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    ржПржЯрж┐ ржПржХржЯрж┐ ржХрж▓ржмрзНржпрж╛ржХ ржлрж╛ржВрж╢ржи ржШрзЛрж╖ржгрж╛ ржХрж░рзЗ ржпрж╛ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧрзЗрж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржкрж░рж┐ржмрж░рзНрждржи рж╣рж▓рзЗ, ржпрзЗржоржи рж╕ржВржпрзЛржЧ ржмрж╛ рж╕ржВржпрзЛржЧ ржмрж┐ржЪрзНржЫрж┐ржирзНржи рж╣рж▓рзЗ, ржХрж▓ ржХрж░рж╛ рж╣ржмрзЗред рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ржЯрж┐ рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржкрзЛрж░рзНржЯрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯред

1. ржПрж░ ржирж┐ржЪрзЗ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧ ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржлрж╛ржВрж╢ржи ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    ржПржЗ ржХрзЛржбржЯрж┐ IoT Hub рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржХрзЛржб ржЗржирж┐рж╢рж┐рзЯрж╛рж▓рж╛ржЗржЬ ржХрж░рзЗ, рждрж╛рж░ржкрж░ `config.h` рж╣рзЗржбрж╛рж░ ржлрж╛ржЗрж▓рзЗрж░ рж╕ржВржпрзЛржЧ рж╕рзНржЯрзНрж░рж┐ржВ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХржЯрж┐ рж╕ржВржпрзЛржЧ рждрзИрж░рж┐ ржХрж░рзЗред ржПржЗ рж╕ржВржпрзЛржЧржЯрж┐ MQTT-ржПрж░ ржЙржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗред ржпржжрж┐ рж╕ржВржпрзЛржЧ ржмрзНржпрж░рзНрже рж╣рзЯ, ржПржЯрж┐ рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржкрзЛрж░рзНржЯрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯ - ржпржжрж┐ ржЖржкржирж┐ ржЖржЙржЯржкрзБржЯрзЗ ржПржЯрж┐ ржжрзЗржЦрзЗржи, рж╕ржВржпрзЛржЧ рж╕рзНржЯрзНрж░рж┐ржВржЯрж┐ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзБржиред ржЕржмрж╢рзЗрж╖рзЗ рж╕ржВржпрзЛржЧ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржХрж▓ржмрзНржпрж╛ржХ рж╕рзЗржЯ ржЖржк ржХрж░рж╛ рж╣рзЯред

1. `setup` ржлрж╛ржВрж╢ржирзЗ `initTime` ржХрж▓рзЗрж░ ржирж┐ржЪрзЗ ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рзБржи:

    ```cpp
    connectIoTHub();
    ```

1. MQTT ржХрзНрж▓рж╛рзЯрзЗржирзНржЯрзЗрж░ ржорждрзЛ, ржПржЗ ржХрзЛржбржЯрж┐ ржПржХржЯрж┐ ржПржХржХ ржерзНрж░рзЗржбрзЗ ржЪрж▓рзЗ, рждрж╛ржЗ рж╣рж╛ржм ржжрзНржмрж╛рж░рж╛ ржкрж╛ржарж╛ржирзЛ ржПржмржВ рж╣рж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ ржмрж╛рж░рзНрждрж╛ржЧрзБрж▓рж┐ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ ржХрж░рж╛рж░ ржЬржирзНржп рж╕ржорзЯ ржкрзНрж░рзЯрзЛржЬржиред `loop` ржлрж╛ржВрж╢ржирзЗрж░ рж╢рзАрж░рзНрж╖рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржпрзЛржЧ ржХрж░рзБржи ржПржЯрж┐ ржХрж░рж╛рж░ ржЬржирзНржп:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. ржПржЗ ржХрзЛржбржЯрж┐ ржмрж┐рж▓рзНржб ржПржмржВ ржЖржкрж▓рзЛржб ржХрж░рзБржиред ржЖржкржирж┐ рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржоржирж┐ржЯрж░рзЗ рж╕ржВржпрзЛржЧ ржжрзЗржЦрждрзЗ ржкрж╛ржмрзЗржи:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    ржЖржЙржЯржкрзБржЯрзЗ ржЖржкржирж┐ NTP рж╕ржорзЯ ржлрзЗржЪ ржХрж░рж╛ ржПржмржВ рждрж╛рж░ржкрж░ ржбрж┐ржнрж╛ржЗрж╕ ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ рж╕ржВржпрзЛржЧ ржХрж░рждрзЗ ржжрзЗржЦрждрзЗ ржкрж╛ржмрзЗржиред рж╕ржВржпрзЛржЧ ржХрж░рждрзЗ ржХрзЯрзЗржХ рж╕рзЗржХрзЗржирзНржб рж╕ржорзЯ рж▓рж╛ржЧрждрзЗ ржкрж╛рж░рзЗ, рждрж╛ржЗ ржбрж┐ржнрж╛ржЗрж╕ рж╕ржВржпрзЛржЧ ржХрж░рж╛рж░ рж╕ржорзЯ ржЖржкржирж┐ ржЖржЙржЯржкрзБржЯрзЗ ржорж╛ржЯрж┐ ржЖрж░рзНржжрзНрж░рждрж╛ ржжрзЗржЦрждрзЗ ржкрж╛рж░рзЗржиред

    > ЁЯТБ ржЖржкржирж┐ NTP-ржПрж░ UNIX рж╕ржорзЯржХрзЗ ржПржХржЯрж┐ ржЖрж░ржУ ржкрж╛ржаржпрзЛржЧрзНржп рж╕ржВрж╕рзНржХрж░ржгрзЗ рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи [unixtimestamp.com](https://www.unixtimestamp.com)-ржПрж░ ржорждрзЛ ржПржХржЯрж┐ ржУрзЯрзЗржмрж╕рж╛ржЗржЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред

## ржЯрзЗрж▓рж┐ржорзЗржЯрзНрж░рж┐ ржкрж╛ржарж╛ржи

ржПржЦржи ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕ рж╕ржВржпрзБржХрзНржд рж╣рзЯрзЗржЫрзЗ, ржЖржкржирж┐ MQTT ржмрзНрж░рзЛржХрж╛рж░рзЗрж░ ржкрж░рж┐ржмрж░рзНрждрзЗ IoT Hub-ржП ржЯрзЗрж▓рж┐ржорзЗржЯрзНрж░рж┐ ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗржиред

### ржХрж╛ржЬ - ржЯрзЗрж▓рж┐ржорзЗржЯрзНрж░рж┐ ржкрж╛ржарж╛ржи

1. `setup` ржлрж╛ржВрж╢ржирзЗрж░ ржЙржкрж░рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржлрж╛ржВрж╢ржи ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    ржПржЗ ржХрзЛржбржЯрж┐ ржПржХржЯрж┐ IoT Hub ржмрж╛рж░рзНрждрж╛ рждрзИрж░рж┐ ржХрж░рзЗ ржПржХржЯрж┐ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛рж╕ ржХрж░рж╛ рж╕рзНржЯрзНрж░рж┐ржВ ржерзЗржХрзЗ, ржПржЯрж┐ рж╣рж╛ржмрзЗ ржкрж╛ржарж╛рзЯ, рждрж╛рж░ржкрж░ ржмрж╛рж░рзНрждрж╛ ржЕржмржЬрзЗржХрзНржЯржЯрж┐ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рзЗред

1. `loop` ржлрж╛ржВрж╢ржирзЗ ржПржЗ ржХрзЛржбржЯрж┐ ржХрж▓ ржХрж░рзБржи, ржЯрзЗрж▓рж┐ржорзЗржЯрзНрж░рж┐ рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржкрзЛрж░рзНржЯрзЗ ржкрж╛ржарж╛ржирзЛрж░ рж▓рж╛ржЗржирзЗрж░ ржарж┐ржХ ржкрж░рзЗ:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## ржХржорж╛ржирзНржб рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рзБржи

ржЖржкржирж╛рж░ ржбрж┐ржнрж╛ржЗрж╕ржХрзЗ рж╕рж╛рж░рзНржнрж╛рж░ ржХрзЛржб ржерзЗржХрзЗ ржПржХржЯрж┐ ржХржорж╛ржирзНржб рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рждрзЗ рж╣ржмрзЗ рж░рж┐рж▓рзЗ ржирж┐рзЯржирзНрждрзНрж░ржг ржХрж░рж╛рж░ ржЬржирзНржпред ржПржЯрж┐ ржПржХржЯрж┐ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржз рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯред

### ржХрж╛ржЬ - ржПржХржЯрж┐ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржз рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рзБржи

1. `connectIoTHub` ржлрж╛ржВрж╢ржирзЗрж░ ржЖржЧрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржб ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    ржПржЗ ржХрзЛржбржЯрж┐ ржПржХржЯрж┐ ржХрж▓ржмрзНржпрж╛ржХ ржорзЗржержб рж╕ржВржЬрзНржЮрж╛рзЯрж┐ржд ржХрж░рзЗ ржпрж╛ IoT Hub рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржПржХржЯрж┐ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржз ржкрж╛ржУрзЯрж╛рж░ рж╕ржорзЯ ржХрж▓ ржХрж░рждрзЗ ржкрж╛рж░рзЗред ржЕржирзБрж░рзЛржз ржХрж░рж╛ ржорзЗржержбржЯрж┐ `method_name` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯред ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐ рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржкрзЛрж░рзНржЯрзЗ ржХрж▓ ржХрж░рж╛ ржорзЗржержбржЯрж┐ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзЗ, рждрж╛рж░ржкрж░ ржорзЗржержб ржирж╛ржорзЗрж░ ржЙржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗ рж░рж┐рж▓рзЗ ржЪрж╛рж▓рзБ ржмрж╛ ржмржирзНржз ржХрж░рзЗред

    > ЁЯТБ ржПржЯрж┐ ржПржХржЯрж┐ ржПржХржХ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржзрзЗ ржмрж╛рж╕рзНрждржмрж╛рзЯрж┐ржд рж╣рждрзЗ ржкрж╛рж░рзЗ, ржпрзЗржЦрж╛ржирзЗ рж░рж┐рж▓рзЗрж░ ржХрж╛ржЩрзНржХрзНрж╖рж┐ржд ржЕржмрж╕рзНржерж╛ржЯрж┐ ржПржХржЯрж┐ ржкрзЗ-рж▓рзЛржбрзЗ ржкрж╛рж╕ ржХрж░рж╛ рж╣рзЯ ржпрж╛ ржорзЗржержб ржЕржирзБрж░рзЛржзрзЗрж░ рж╕рж╛ржерзЗ ржкрж╛рж╕ ржХрж░рж╛ ржпрж╛рзЯ ржПржмржВ `payload` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржерзЗржХрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯред

1. `directMethodCallback` ржлрж╛ржВрж╢ржирзЗрж░ рж╢рзЗрж╖рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржб ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржзржЧрзБрж▓рж┐рж░ ржПржХржЯрж┐ ржкрзНрж░рждрж┐ржХрзНрж░рж┐рзЯрж╛ ржкрзНрж░рзЯрзЛржЬржи, ржПржмржВ ржкрзНрж░рждрж┐ржХрзНрж░рж┐рзЯрж╛ ржжрзБржЯрж┐ ржЕржВрж╢рзЗ ржерж╛ржХрзЗ - ржПржХржЯрж┐ ржЯрзЗржХрзНрж╕ржЯ рж╣рж┐рж╕рзЗржмрзЗ ржкрзНрж░рждрж┐ржХрзНрж░рж┐рзЯрж╛ ржПржмржВ ржПржХржЯрж┐ рж░рж┐ржЯрж╛рж░рзНржи ржХрзЛржбред ржПржЗ ржХрзЛржбржЯрж┐ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд JSON ржбржХрзБржорзЗржирзНржЯ рж╣рж┐рж╕рзЗржмрзЗ ржПржХржЯрж┐ рж░рзЗржЬрж╛рж▓рзНржЯ рждрзИрж░рж┐ ржХрж░ржмрзЗ:

    ```JSON
    {
        "Result": ""
    }
    ```

    ржПржЯрж┐ рждрж╛рж░ржкрж░ `response` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рзЗ ржХржкрж┐ ржХрж░рж╛ рж╣рзЯ, ржПржмржВ ржПржЗ ржкрзНрж░рждрж┐ржХрзНрж░рж┐рзЯрж╛рж░ ржЖржХрж╛рж░ `response_size` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рзЗ рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯред ржПржЗ ржХрзЛржбржЯрж┐ рждрж╛рж░ржкрж░ `IOTHUB_CLIENT_OK` рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ ржжрзЗржЦрж╛ржирзЛрж░ ржЬржирзНржп ржпрзЗ ржорзЗржержбржЯрж┐ рж╕ржарж┐ржХржнрж╛ржмрзЗ рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред

1. ржХрж▓ржмрзНржпрж╛ржХржЯрж┐ рж╕ржВржпрзБржХрзНржд ржХрж░рждрзЗ `connectIoTHub` ржлрж╛ржВрж╢ржирзЗрж░ рж╢рзЗрж╖рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. `loop` ржлрж╛ржВрж╢ржиржЯрж┐ `IoTHubDeviceClient_LL_DoWork` ржлрж╛ржВрж╢ржи ржХрж▓ ржХрж░ржмрзЗ IoT Hub ржжрзНржмрж╛рж░рж╛ ржкрж╛ржарж╛ржирзЛ ржЗржнрзЗржирзНржЯржЧрзБрж▓рж┐ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ ржХрж░рж╛рж░ ржЬржирзНржпред ржПржЯрж┐ `delay` ржПрж░ ржХрж╛рж░ржгрзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржкрзНрж░рждрж┐ 10 рж╕рзЗржХрзЗржирзНржбрзЗ ржХрж▓ ржХрж░рж╛ рж╣рзЯ, ржпрж╛рж░ ржорж╛ржирзЗ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержбржЧрзБрж▓рж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржкрзНрж░рждрж┐ 10 рж╕рзЗржХрзЗржирзНржбрзЗ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ ржХрж░рж╛ рж╣рзЯред ржПржЯрж┐ ржЖрж░ржУ ржХрж╛рж░рзНржпржХрж░ ржХрж░рждрзЗ, 10 рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржмрж┐рж▓ржорзНржмржЯрж┐ ржЕржирзЗржХ ржЫрзЛржЯ ржмрж┐рж▓ржорзНржмрзЗ ржмрж╛рж╕рзНрждржмрж╛рзЯрж┐ржд рж╣рждрзЗ ржкрж╛рж░рзЗ, ржкрзНрж░рждрж┐ржмрж╛рж░ `IoTHubDeviceClient_LL_DoWork` ржХрж▓ ржХрж░рзЗред ржПржЯрж┐ ржХрж░рждрзЗ, `loop` ржлрж╛ржВрж╢ржирзЗрж░ ржЙржкрж░рзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржб ржпрзЛржЧ ржХрж░рзБржи:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    ржПржЗ ржХрзЛржбржЯрж┐ ржмрж╛рж░ржмрж╛рж░ рж▓рзБржк ржХрж░ржмрзЗ, `IoTHubDeviceClient_LL_DoWork` ржХрж▓ ржХрж░ржмрзЗ ржПржмржВ ржкрзНрж░рждрж┐ржмрж╛рж░ 100ms ржмрж┐рж▓ржорзНржм ржХрж░ржмрзЗред ржПржЯрж┐ ржпрждржмрж╛рж░ ржкрзНрж░рзЯрзЛржЬржи рждрждржмрж╛рж░ ржХрж░ржмрзЗ `delay_time` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рзЗ ржжрзЗржУрзЯрж╛ рж╕ржорзЯ ржмрж┐рж▓ржорзНржм ржХрж░рж╛рж░ ржЬржирзНржпред ржПрж░ ржорж╛ржирзЗ рж╣рж▓рзЛ ржбрж┐ржнрж╛ржЗрж╕ржЯрж┐ ржбрж┐рж░рзЗржХрзНржЯ ржорзЗржержб ржЕржирзБрж░рзЛржз ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ ржХрж░рж╛рж░ ржЬржирзНржп рж╕рж░рзНржмрж╛ржзрж┐ржХ 100ms ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░ржЫрзЗред

1. `loop` ржлрж╛ржВрж╢ржирзЗ `IoTHubDeviceClient_LL_DoWork` ржХрж▓ржЯрж┐ рж╕рж░рж┐рзЯрзЗ ржлрзЗрж▓рзБржи ржПржмржВ `delay(10000)` ржХрж▓ржЯрж┐ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржжрж┐рзЯрзЗ ржкрзНрж░рждрж┐рж╕рзНржерж╛ржкржи ржХрж░рзБржи ржПржЗ ржирждрзБржи ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рждрзЗ:

    ```cpp
    work_delay(10000);
    ```

> ЁЯТБ ржЖржкржирж┐ ржПржЗ ржХрзЛржбржЯрж┐ [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) ржлрзЛрж▓рзНржбрж╛рж░рзЗ ржЦрзБржБржЬрзЗ ржкрзЗрждрзЗ ржкрж╛рж░рзЗржиред

ЁЯША ржЖржкржирж╛рж░ ржорж╛ржЯрж┐ ржЖрж░рзНржжрзНрж░рждрж╛ рж╕рзЗржирзНрж╕рж░ ржкрзНрж░рзЛржЧрзНрж░рж╛ржоржЯрж┐ IoT Hub-ржПрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд рж╣рзЯрзЗржЫрзЗ!

---

**ржЕрж╕рзНржмрзАржХрзГрждрж┐**:  
ржПржЗ ржиржерж┐ржЯрж┐ AI ржЕржирзБржмрж╛ржж ржкрж░рж┐рж╖рзЗржмрж╛ [Co-op Translator](https://github.com/Azure/co-op-translator) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЕржирзБржмрж╛ржж ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред ржЖржорж░рж╛ ржпржерж╛рж╕ржорзНржнржм рж╕ржарж┐ржХрждрж╛рж░ ржЬржирзНржп ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж┐, рждржмрзЗ ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржоржирзЗ рж░рж╛ржЦржмрзЗржи ржпрзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ ржЕржирзБржмрж╛ржжрзЗ рждрзНрж░рзБржЯрж┐ ржмрж╛ ржЕрж╕ржЩрзНржЧрждрж┐ ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗред ржорзВрж▓ ржнрж╛рж╖рж╛ржпрж╝ ржерж╛ржХрж╛ ржиржерж┐ржЯрж┐ржХрзЗ ржкрзНрж░рж╛ржорж╛ржгрж┐ржХ ржЙрзОрж╕ рж╣рж┐рж╕рзЗржмрзЗ ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рж╛ ржЙржЪрж┐рждред ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рждржерзНржпрзЗрж░ ржЬржирзНржп, ржкрзЗрж╢рж╛ржжрж╛рж░ ржорж╛ржиржм ржЕржирзБржмрж╛ржж рж╕рзБржкрж╛рж░рж┐рж╢ ржХрж░рж╛ рж╣ржпрж╝ред ржПржЗ ржЕржирзБржмрж╛ржж ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржлрж▓рзЗ ржХрзЛржирзЛ ржнрзБрж▓ ржмрзЛржЭрж╛ржмрзБржЭрж┐ ржмрж╛ ржнрзБрж▓ ржмрзНржпрж╛ржЦрзНржпрж╛ рж╣рж▓рзЗ ржЖржорж░рж╛ ржжрж╛ржпрж╝ржмржжрзНржз ржерж╛ржХржм ржирж╛ред