<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "f7bb24ba53fb627ddb38a8b24a05e594",
  "translation_date": "2025-08-27T22:55:22+00:00",
  "source_file": "2-farm/lessons/3-automated-plant-watering/README.md",
  "language_code": "no"
}
-->
# Automatisk plantevanning

![En sketchnote-oversikt over denne leksjonen](../../../../../translated_images/lesson-7.30b5f577d3cb8e031238751475cb519c7d6dbaea261b5df4643d086ffb2a03bb.no.jpg)

> Sketchnote av [Nitya Narasimhan](https://github.com/nitya). Klikk p√• bildet for en st√∏rre versjon.

Denne leksjonen ble undervist som en del av [IoT for Beginners Prosjekt 2 - Digital Agriculture-serien](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) fra [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn).

[![IoT-drevet automatisk plantevanning](https://img.youtube.com/vi/g9FfZwv9R58/0.jpg)](https://youtu.be/g9FfZwv9R58)

## Quiz f√∏r leksjonen

[Quiz f√∏r leksjonen](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/13)

## Introduksjon

I forrige leksjon l√¶rte du hvordan du overv√•ker jordfuktighet. I denne leksjonen vil du l√¶re hvordan du bygger de grunnleggende komponentene i et automatisk vanningssystem som reagerer p√• jordfuktighet. Du vil ogs√• l√¶re om timing ‚Äì hvordan sensorer kan bruke tid p√• √• reagere p√• endringer, og hvordan aktuatorer kan bruke tid p√• √• endre egenskapene som m√•les av sensorer.

I denne leksjonen dekker vi:

* [Kontrollere h√∏ystr√∏msenheter fra en lavstr√∏ms IoT-enhet](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Kontrollere et rel√©](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Kontrollere planten din via MQTT](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Sensor- og aktuator-timing](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Legge til timing i plantekontrollserveren din](../../../../../2-farm/lessons/3-automated-plant-watering)

## Kontrollere h√∏ystr√∏msenheter fra en lavstr√∏ms IoT-enhet

IoT-enheter bruker lav spenning. Selv om dette er nok for sensorer og lavstr√∏msaktuatorer som LED-lys, er det for lavt til √• kontrollere st√∏rre maskinvare, som en vannpumpe brukt til vanning. Selv sm√• pumper som kan brukes til potteplanter trekker for mye str√∏m for et IoT-utviklingskort og kan skade kortet.

> üéì Str√∏m, m√•lt i ampere (A), er mengden elektrisitet som beveger seg gjennom en krets. Spenning gir "dyttet", mens str√∏m er hvor mye som blir dyttet. Du kan lese mer om str√∏m p√• [Wikipedia-siden om elektrisk str√∏m](https://wikipedia.org/wiki/Electric_current).

L√∏sningen p√• dette er √• ha en pumpe koblet til en ekstern str√∏mkilde og bruke en aktuator til √• sl√• p√• pumpen, p√• samme m√•te som du ville sl√•tt p√• et lys. Det krever en liten mengde energi (i form av energi i kroppen din) for fingeren din √• trykke p√• en bryter, og dette kobler lyset til str√∏mnettet som kj√∏rer p√• 110v/240v.

![En lysbryter sl√•r p√• str√∏mmen til et lys](../../../../../translated_images/light-switch.760317ad6ab8bd6d611da5352dfe9c73a94a0822ccec7df3c8bae35da18e1658.no.png)

> üéì [Str√∏mnett](https://wikipedia.org/wiki/Mains_electricity) refererer til elektrisiteten som leveres til hjem og bedrifter gjennom nasjonal infrastruktur i mange deler av verden.

‚úÖ IoT-enheter kan vanligvis levere 3,3V eller 5V, med mindre enn 1 ampere (1A) str√∏m. Sammenlign dette med str√∏mnettet som oftest er p√• 230V (120V i Nord-Amerika og 100V i Japan), og kan levere str√∏m til enheter som trekker 30A.

Det finnes en rekke aktuatorer som kan gj√∏re dette, inkludert mekaniske enheter som kan festes til eksisterende brytere og etterligne en finger som sl√•r dem p√•. Den mest popul√¶re er et rel√©.

### Rel√©er

Et rel√© er en elektromekanisk bryter som konverterer et elektrisk signal til en mekanisk bevegelse som sl√•r p√• en bryter. Kjernen i et rel√© er en elektromagnet.

> üéì [Elektromagneter](https://wikipedia.org/wiki/Electromagnet) er magneter som skapes ved √• sende elektrisitet gjennom en spole av ledning. N√•r elektrisiteten er sl√•tt p√•, blir spolen magnetisert. N√•r elektrisiteten er sl√•tt av, mister spolen magnetismen.

![N√•r p√•, skaper elektromagneten et magnetfelt som sl√•r p√• bryteren for utgangskretsen](../../../../../translated_images/relay-on.4db16a0fd6b669262fd6699aff3fbcd31b6057c06d90411b6bddc06326d1cf75.no.png)

I et rel√© driver en kontrollkrets elektromagneten. N√•r elektromagneten er p√•, trekker den en spak som beveger en bryter, lukker et par kontakter og fullf√∏rer en utgangskrets.

![N√•r av, skaper ikke elektromagneten et magnetfelt, og bryteren for utgangskretsen er sl√•tt av](../../../../../translated_images/relay-off.c34a178a2960fecdc3c6400d43e633ed11c6746cd653cfb4a768fa097c40394c.no.png)

N√•r kontrollkretsen er av, sl√•r elektromagneten seg av, slipper spaken og √•pner kontaktene, og sl√•r av utgangskretsen. Rel√©er er digitale aktuatorer ‚Äì et h√∏yt signal til rel√©et sl√•r det p√•, et lavt signal sl√•r det av.

Utgangskretsen kan brukes til √• drive ekstra maskinvare, som et vanningssystem. IoT-enheten kan sl√• rel√©et p√•, fullf√∏re utgangskretsen som driver vanningssystemet, og plantene f√•r vann. IoT-enheten kan deretter sl√• rel√©et av, kutte str√∏mmen til vanningssystemet og sl√• av vannet.

![Et rel√© som sl√•r p√•, sl√•r p√• en pumpe som sender vann til en plante](../../../../../images/strawberry-pump.gif)

I videoen ovenfor blir et rel√© sl√•tt p√•. En LED p√• rel√©et lyser opp for √• indikere at det er p√• (noen rel√©kort har LED-lys for √• indikere om rel√©et er p√• eller av), og str√∏m sendes til pumpen, som sl√•r seg p√• og pumper vann til en plante.

> üíÅ Rel√©er kan ogs√• brukes til √• bytte mellom to utgangskretser i stedet for √• sl√• √©n av og p√•. N√•r spaken beveger seg, flytter den en bryter fra √• fullf√∏re √©n utgangskrets til √• fullf√∏re en annen utgangskrets, vanligvis med en felles str√∏mtilkobling eller felles jordtilkobling.

‚úÖ Gj√∏r litt research: Det finnes flere typer rel√©er, med forskjeller som om kontrollkretsen sl√•r rel√©et p√• eller av n√•r str√∏m tilf√∏res, eller flere utgangskretser. Finn ut mer om disse forskjellige typene.

N√•r spaken beveger seg, kan du vanligvis h√∏re den lage kontakt med elektromagneten med et tydelig klikk.

> üíÅ Et rel√© kan kobles slik at det √• lage forbindelsen faktisk bryter str√∏mmen til rel√©et, sl√•r rel√©et av, som deretter sender str√∏m til rel√©et og sl√•r det p√• igjen, og s√• videre. Dette betyr at rel√©et vil klikke utrolig raskt og lage en summende lyd. Dette er hvordan noen av de f√∏rste summerne brukt i elektriske d√∏rklokker fungerte.

### Rel√©str√∏m

Elektromagneten trenger ikke mye str√∏m for √• aktivere og trekke spaken, den kan kontrolleres med 3,3V eller 5V utgang fra et IoT-utviklingskort. Utgangskretsen kan b√¶re mye mer str√∏m, avhengig av rel√©et, inkludert str√∏mnettspenning eller enda h√∏yere str√∏mniv√•er for industriell bruk. P√• denne m√•ten kan et IoT-utviklingskort kontrollere et vanningssystem, fra en liten pumpe for en enkelt plante, til et massivt industrielt system for en hel kommersiell g√•rd.

![Et Grove-rel√© med kontrollkrets, utgangskrets og rel√© merket](../../../../../translated_images/grove-relay-labelled.293e068f5c3c2a199bd7892f2661fdc9e10c920b535cfed317fbd6d1d4ae1168.no.png)

Bildet ovenfor viser et Grove-rel√©. Kontrollkretsen kobles til en IoT-enhet og sl√•r rel√©et av eller p√• med 3,3V eller 5V. Utgangskretsen har to terminaler, hvorav en kan v√¶re str√∏m eller jord. Utgangskretsen kan h√•ndtere opptil 250V ved 10A, nok for en rekke enheter som drives av str√∏mnettet. Du kan f√• rel√©er som kan h√•ndtere enda h√∏yere str√∏mniv√•er.

![En pumpe koblet via et rel√©](../../../../../translated_images/pump-wired-to-relay.66c5cfc0d89189900cd601777f5caeb39ee35c6250f6c86bf38feaceedb21fe9.no.png)

I bildet ovenfor leveres str√∏m til en pumpe via et rel√©. Det er en r√∏d ledning som kobler +5V-terminalen p√• en USB-str√∏mkilde til √©n terminal p√• utgangskretsen til rel√©et, og en annen r√∏d ledning som kobler den andre terminalen p√• utgangskretsen til pumpen. En svart ledning kobler pumpen til jord p√• USB-str√∏mkilden. N√•r rel√©et sl√•r seg p√•, fullf√∏rer det kretsen, sender 5V til pumpen og sl√•r pumpen p√•.

## Kontrollere et rel√©

Du kan kontrollere et rel√© fra IoT-utviklingskortet ditt.

### Oppgave - kontrollere et rel√©

F√∏lg den relevante veiledningen for √• kontrollere et rel√© med IoT-enheten din:

* [Arduino - Wio Terminal](wio-terminal-relay.md)
* [Enkeltkortdatamaskin - Raspberry Pi](pi-relay.md)
* [Enkeltkortdatamaskin - Virtuell enhet](virtual-device-relay.md)

## Kontrollere planten din via MQTT

S√• langt har rel√©et ditt blitt kontrollert direkte av IoT-enheten basert p√• √©n enkelt jordfuktighetsm√•ling. I et kommersielt vanningssystem vil kontrolllogikken v√¶re sentralisert, slik at den kan ta beslutninger om vanning basert p√• data fra flere sensorer, og tillate at eventuelle konfigurasjoner endres p√• ett sted. For √• simulere dette kan du kontrollere rel√©et via MQTT.

### Oppgave - kontrollere rel√©et via MQTT

1. Legg til de relevante MQTT-bibliotekene/pip-pakkene og kode til `soil-moisture-sensor`-prosjektet ditt for √• koble til MQTT. Navngi klient-ID-en som `soilmoisturesensor_client` med ID-en din som prefiks.

    > ‚ö†Ô∏è Du kan referere til [instruksjonene for √• koble til MQTT i prosjekt 1, leksjon 4 hvis n√∏dvendig](../../../1-getting-started/lessons/4-connect-internet/README.md#connect-your-iot-device-to-mqtt).

1. Legg til den relevante enhetskoden for √• sende telemetri med jordfuktighetsinnstillingene. For telemetrimeldingen, navngi egenskapen `soil_moisture`.

    > ‚ö†Ô∏è Du kan referere til [instruksjonene for √• sende telemetri til MQTT i prosjekt 1, leksjon 4 hvis n√∏dvendig](../../../1-getting-started/lessons/4-connect-internet/README.md#send-telemetry-from-your-iot-device).

1. Lag lokal serverkode for √• abonnere p√• telemetri og sende en kommando for √• kontrollere rel√©et i en mappe kalt `soil-moisture-sensor-server`. Navngi egenskapen i kommandomeldingen `relay_on`, og sett klient-ID-en som `soilmoisturesensor_server` med ID-en din som prefiks. Hold samme struktur som serverkoden du skrev for prosjekt 1, leksjon 4, da du vil legge til denne koden senere i denne leksjonen.

    > ‚ö†Ô∏è Du kan referere til [instruksjonene for √• sende telemetri til MQTT](../../../1-getting-started/lessons/4-connect-internet/README.md#write-the-server-code) og [sende kommandoer via MQTT](../../../1-getting-started/lessons/4-connect-internet/README.md#send-commands-to-the-mqtt-broker) i prosjekt 1, leksjon 4 hvis n√∏dvendig.

1. Legg til den relevante enhetskoden for √• kontrollere rel√©et fra mottatte kommandoer, ved √• bruke `relay_on`-egenskapen fra meldingen. Send true for `relay_on` hvis `soil_moisture` er st√∏rre enn 450, ellers send false, samme som logikken du la til for IoT-enheten tidligere.

    > ‚ö†Ô∏è Du kan referere til [instruksjonene for √• h√•ndtere kommandoer fra MQTT i prosjekt 1, leksjon 4 hvis n√∏dvendig](../../../1-getting-started/lessons/4-connect-internet/README.md#handle-commands-on-the-iot-device).

> üíÅ Du finner denne koden i [code-mqtt](../../../../../2-farm/lessons/3-automated-plant-watering/code-mqtt)-mappen.

S√∏rg for at koden kj√∏rer p√• enheten din og lokal server, og test den ved √• endre jordfuktighetsniv√•er, enten ved √• endre verdiene sendt av den virtuelle sensoren, eller ved √• endre fuktighetsniv√•et i jorden ved √• tilsette vann eller fjerne sensoren fra jorden.

## Sensor- og aktuator-timing

Tilbake i leksjon 3 bygde du en nattlampe ‚Äì en LED som sl√•r seg p√• s√• snart et lavt lysniv√• ble oppdaget av en lyssensor. Lyssensoren oppdaget en endring i lysniv√•er umiddelbart, og enheten kunne reagere raskt, kun begrenset av lengden p√• forsinkelsen i `loop`-funksjonen eller `while True:`-l√∏kken. Som IoT-utvikler kan du ikke alltid stole p√• en s√• rask tilbakemeldingssl√∏yfe.

### Timing for jordfuktighet

Hvis du gjorde forrige leksjon om jordfuktighet med en fysisk sensor, ville du ha lagt merke til at det tok noen sekunder f√∏r jordfuktighetsm√•lingen sank etter at du vannet planten din. Dette er ikke fordi sensoren er treg, men fordi det tar tid for vannet √• trekke gjennom jorden.
üíÅ Hvis du vannet for n√¶r sensoren, kan du ha sett at m√•lingen falt raskt og deretter steg igjen ‚Äì dette skyldes at vannet n√¶r sensoren sprer seg gjennom resten av jorden, noe som reduserer jordfuktigheten ved sensoren.
![En m√•ling av jordfuktighet p√• 658 endrer seg ikke under vanning, den faller f√∏rst til 320 etter vanning n√•r vannet har trukket gjennom jorden](../../../../../translated_images/soil-moisture-travel.a0e31af222cf14385de5380dfc32c7b8213960965228b8e4f7b7ab7f73b310a3.no.png)

I diagrammet ovenfor viser en m√•ling av jordfuktighet 658. Planten blir vannet, men denne m√•lingen endrer seg ikke umiddelbart, siden vannet enn√• ikke har n√•dd sensoren. Vanningen kan til og med v√¶re ferdig f√∏r vannet n√•r sensoren og verdien faller for √• reflektere det nye fuktighetsniv√•et.

Hvis du skulle skrive kode for √• kontrollere et vanningssystem via et rel√© basert p√• jordfuktighetsniv√•er, m√• du ta denne forsinkelsen i betraktning og bygge smartere timing inn i IoT-enheten din.

‚úÖ Ta et √∏yeblikk til √• tenke p√• hvordan du kan gj√∏re dette.

### Kontrollere sensor- og aktuator-timing

Tenk deg at du har f√•tt i oppgave √• bygge et vanningssystem for en g√•rd. Basert p√• jordtypen har det ideelle jordfuktighetsniv√•et for plantene blitt funnet √• tilsvare en analog spenning p√• 400-450.

Du kunne programmert enheten p√• samme m√•te som nattlampen ‚Äì s√• lenge sensoren leser over 450, sl√• p√• et rel√© for √• aktivere en pumpe. Problemet er at det tar tid for vannet √• komme fra pumpen, gjennom jorden og til sensoren. Sensoren vil stoppe vannet n√•r den registrerer et niv√• p√• 450, men vannniv√•et vil fortsette √• synke ettersom det pumpede vannet fortsetter √• trekke gjennom jorden. Resultatet er bortkastet vann og risiko for rotskader.

‚úÖ Husk ‚Äì for mye vann kan v√¶re like skadelig for planter som for lite, og det sl√∏ser med en verdifull ressurs.

Den bedre l√∏sningen er √• forst√• at det er en forsinkelse mellom at aktuatoren sl√•r seg p√• og egenskapen som sensoren leser endrer seg. Dette betyr at ikke bare b√∏r sensoren vente en stund f√∏r den m√•ler verdien igjen, men aktuatoren m√• ogs√• sl√• seg av en stund f√∏r neste sensorm√•ling tas.

Hvor lenge b√∏r rel√©et v√¶re p√• hver gang? Det er bedre √• v√¶re forsiktig og bare sl√• rel√©et p√• i kort tid, deretter vente til vannet har trukket gjennom, og s√• sjekke fuktighetsniv√•ene p√• nytt. Tross alt kan du alltid sl√• det p√• igjen for √• tilf√∏re mer vann, men du kan ikke fjerne vann fra jorden.

> üíÅ Denne typen timingkontroll er veldig spesifikk for IoT-enheten du bygger, egenskapen du m√•ler og sensorene og aktuatorene som brukes.

![En jordb√¶rplante koblet til vann via en pumpe, med pumpen koblet til et rel√©. Rel√©et og en jordfuktighetssensor i planten er begge koblet til en Raspberry Pi](../../../../../translated_images/strawberry-with-pump.b410fc72ac6aabad3e28de9775bf2393ead73dcfec6fd8c9bc01cf107ecd171a.no.png)

For eksempel har jeg en jordb√¶rplante med en jordfuktighetssensor og en pumpe kontrollert av et rel√©. Jeg har observert at n√•r jeg tilf√∏rer vann, tar det omtrent 20 sekunder f√∏r m√•lingen av jordfuktighet stabiliserer seg. Dette betyr at jeg m√• sl√• av rel√©et og vente 20 sekunder f√∏r jeg sjekker fuktighetsniv√•ene. Jeg foretrekker √• ha for lite vann enn for mye ‚Äì jeg kan alltid sl√• p√• pumpen igjen, men jeg kan ikke fjerne vann fra planten.

![Steg 1, ta m√•ling. Steg 2, tilf√∏re vann. Steg 3, vent til vannet har trukket gjennom jorden. Steg 4, ta ny m√•ling](../../../../../translated_images/soil-moisture-delay.865f3fae206db01d5f8f100f4f44040215d44a0412dd3450aef7ff7b93b6d273.no.png)

Dette betyr at den beste prosessen vil v√¶re en vanningssyklus som ser slik ut:

* Sl√• p√• pumpen i 5 sekunder
* Vent 20 sekunder
* Sjekk jordfuktigheten
* Hvis niv√•et fortsatt er over det jeg trenger, gjenta trinnene ovenfor

5 sekunder kan v√¶re for lenge for pumpen, spesielt hvis fuktighetsniv√•ene bare er litt over det n√∏dvendige niv√•et. Den beste m√•ten √• vite hvilken timing som skal brukes, er √• pr√∏ve det, og deretter justere n√•r du har sensordata, med en konstant tilbakemeldingssl√∏yfe. Dette kan til og med f√∏re til mer granul√¶r timing, som √• sl√• p√• pumpen i 1 sekund for hver 100 over det n√∏dvendige jordfuktighetsniv√•et, i stedet for faste 5 sekunder.

‚úÖ Gj√∏r litt research: Finnes det andre timinghensyn? Kan planten vannes n√•r som helst n√•r jordfuktigheten er for lav, eller er det spesifikke tider p√• dagen som er gode og d√•rlige for vanning av planter?

> üíÅ V√¶rprognoser kan ogs√• tas i betraktning n√•r man kontrollerer automatiske vanningssystemer for utend√∏rs dyrking. Hvis det er ventet regn, kan vanningen settes p√• pause til etter regnet er ferdig. P√• det tidspunktet kan jorden v√¶re fuktig nok til at den ikke trenger vanning, noe som er mye mer effektivt enn √• sl√∏se vann ved √• vanne rett f√∏r regnet.

## Legg til timing i serveren for plantekontroll

Serverkoden kan modifiseres for √• legge til kontroll rundt timingen av vanningssyklusen og venting p√• at jordfuktighetsniv√•ene skal endre seg. Serverlogikken for √• kontrollere rel√©timing er:

1. Telemetrimelding mottatt
1. Sjekk jordfuktighetsniv√•et
1. Hvis det er ok, gj√∏r ingenting. Hvis m√•lingen er for h√∏y (som betyr at jordfuktigheten er for lav), s√•:
    1. Send en kommando for √• sl√• p√• rel√©et
    1. Vent i 5 sekunder
    1. Send en kommando for √• sl√• av rel√©et
    1. Vent i 20 sekunder for at jordfuktighetsniv√•ene skal stabilisere seg

Vanningssyklusen, prosessen fra mottak av telemetrimelding til √• v√¶re klar til √• prosessere jordfuktighetsniv√•er igjen, tar omtrent 25 sekunder. Vi sender jordfuktighetsniv√•er hvert 10. sekund, s√• det er en overlapping der en melding mottas mens serveren venter p√• at jordfuktighetsniv√•ene skal stabilisere seg, noe som kan starte en ny vanningssyklus.

Det finnes to alternativer for √• h√•ndtere dette:

* Endre IoT-enhetskoden til √• bare sende telemetri hvert minutt, slik at vanningssyklusen fullf√∏res f√∏r neste melding sendes
* Avslutte abonnementet p√• telemetri under vanningssyklusen

Det f√∏rste alternativet er ikke alltid en god l√∏sning for store g√•rder. Bonden kan √∏nske √• fange jordfuktighetsniv√•ene mens jorden vannes for senere analyse, for eksempel for √• v√¶re klar over vannstr√∏mmen i forskjellige omr√•der p√• g√•rden for √• veilede mer m√•lrettet vanning. Det andre alternativet er bedre ‚Äì koden ignorerer bare telemetri n√•r den ikke kan bruke den, men telemetrien er fortsatt tilgjengelig for andre tjenester som kan abonnere p√• den.

> üíÅ IoT-data sendes ikke fra bare √©n enhet til bare √©n tjeneste, i stedet kan mange enheter sende data til en broker, og mange tjenester kan lytte til dataene fra broker. For eksempel kan √©n tjeneste lytte til jordfuktighetsdata og lagre det i en database for analyse senere. En annen tjeneste kan ogs√• lytte til den samme telemetrien for √• kontrollere et vanningssystem.

### Oppgave - legg til timing i serveren for plantekontroll

Oppdater serverkoden din for √• kj√∏re rel√©et i 5 sekunder, deretter vente i 20 sekunder.

1. √Öpne `soil-moisture-sensor-server`-mappen i VS Code hvis den ikke allerede er √•pen. S√∏rg for at det virtuelle milj√∏et er aktivert.

1. √Öpne `app.py`-filen

1. Legg til f√∏lgende kode i `app.py`-filen under de eksisterende importene:

    ```python
    import threading
    ```

    Denne uttalelsen importerer `threading` fra Python-bibliotekene. Threading lar Python utf√∏re annen kode mens den venter.

1. Legg til f√∏lgende kode f√∏r `handle_telemetry`-funksjonen som h√•ndterer telemetrimeldinger mottatt av serverkoden:

    ```python
    water_time = 5
    wait_time = 20
    ```

    Dette definerer hvor lenge rel√©et skal v√¶re p√• (`water_time`), og hvor lenge det skal vente etterp√• for √• sjekke jordfuktigheten (`wait_time`).

1. Under denne koden, legg til f√∏lgende:

    ```python
    def send_relay_command(client, state):
        command = { 'relay_on' : state }
        print("Sending message:", command)
        client.publish(server_command_topic, json.dumps(command))
    ```

    Denne koden definerer en funksjon kalt `send_relay_command` som sender en kommando over MQTT for √• kontrollere rel√©et. Telemetrien opprettes som et ordbokobjekt, og konverteres deretter til en JSON-streng. Verdien som sendes inn i `state` bestemmer om rel√©et skal v√¶re p√• eller av.

1. Etter `send_relay_code`-funksjonen, legg til f√∏lgende kode:

    ```python
    def control_relay(client):
        print("Unsubscribing from telemetry")
        mqtt_client.unsubscribe(client_telemetry_topic)
    
        send_relay_command(client, True)
        time.sleep(water_time)
        send_relay_command(client, False)
    
        time.sleep(wait_time)
    
        print("Subscribing to telemetry")
        mqtt_client.subscribe(client_telemetry_topic)
    ```

    Dette definerer en funksjon for √• kontrollere rel√©et basert p√• n√∏dvendig timing. Den starter med √• avslutte abonnementet p√• telemetri slik at jordfuktighetsmeldinger ikke behandles mens vanningen p√•g√•r. Deretter sender den en kommando for √• sl√• p√• rel√©et. Den venter deretter i `water_time` f√∏r den sender en kommando for √• sl√• av rel√©et. Til slutt venter den i `wait_time` sekunder for at jordfuktighetsniv√•ene skal stabilisere seg. Den abonnerer deretter p√• telemetri igjen.

1. Endre `handle_telemetry`-funksjonen til f√∏lgende:

    ```python
    def handle_telemetry(client, userdata, message):
        payload = json.loads(message.payload.decode())
        print("Message received:", payload)
    
        if payload['soil_moisture'] > 450:
            threading.Thread(target=control_relay, args=(client,)).start()
    ```

    Denne koden sjekker jordfuktighetsniv√•et. Hvis det er st√∏rre enn 450, trenger jorden vanning, s√• den kaller `control_relay`-funksjonen. Denne funksjonen kj√∏res p√• en separat tr√•d, som kj√∏rer i bakgrunnen.

1. S√∏rg for at IoT-enheten din kj√∏rer, og kj√∏r deretter denne koden. Endre jordfuktighetsniv√•ene og observer hva som skjer med rel√©et ‚Äì det skal sl√• seg p√• i 5 sekunder og deretter forbli av i minst 20 sekunder, og bare sl√• seg p√• hvis jordfuktighetsniv√•ene ikke er tilstrekkelige.

    ```output
    (.venv) ‚ûú  soil-moisture-sensor-server ‚úó python app.py
    Message received: {'soil_moisture': 457}
    Unsubscribing from telemetry
    Sending message: {'relay_on': True}
    Sending message: {'relay_on': False}
    Subscribing to telemetry
    Message received: {'soil_moisture': 302}
    ```

    En god m√•te √• teste dette i et simulert vanningssystem er √• bruke t√∏rr jord, og deretter helle vann manuelt mens rel√©et er p√•, og stoppe n√•r rel√©et sl√•r seg av.

> üíÅ Du finner denne koden i [code-timing](../../../../../2-farm/lessons/3-automated-plant-watering/code-timing)-mappen.

> üíÅ Hvis du vil bruke en pumpe for √• bygge et ekte vanningssystem, kan du bruke en [6V vannpumpe](https://www.seeedstudio.com/6V-Mini-Water-Pump-p-1945.html) med en [USB-terminal str√∏mforsyning](https://www.adafruit.com/product/3628). S√∏rg for at str√∏mmen til eller fra pumpen er koblet via rel√©et.

---

## üöÄ Utfordring

Kan du tenke p√• andre IoT- eller elektriske enheter som har et lignende problem der det tar tid f√∏r resultatene fra aktuatoren n√•r sensoren? Du har sannsynligvis et par i huset eller p√• skolen.

* Hvilke egenskaper m√•ler de?
* Hvor lang tid tar det f√∏r egenskapen endrer seg etter at aktuatoren er brukt?
* Er det greit at egenskapen endrer seg forbi det n√∏dvendige niv√•et?
* Hvordan kan den returneres til det n√∏dvendige niv√•et hvis det trengs?

## Quiz etter forelesning

[Quiz etter forelesning](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/14)

## Gjennomgang og selvstudie

* Les mer om rel√©er, inkludert deres historiske bruk i telefonsentraler, p√• [rel√© Wikipedia-siden](https://wikipedia.org/wiki/Relay).

## Oppgave

[Bygg en mer effektiv vanningssyklus](assignment.md)

---

**Ansvarsfraskrivelse**:  
Dette dokumentet er oversatt ved hjelp av AI-oversettelsestjenesten [Co-op Translator](https://github.com/Azure/co-op-translator). Selv om vi streber etter n√∏yaktighet, v√¶r oppmerksom p√• at automatiserte oversettelser kan inneholde feil eller un√∏yaktigheter. Det originale dokumentet p√• sitt opprinnelige spr√•k b√∏r anses som den autoritative kilden. For kritisk informasjon anbefales profesjonell menneskelig oversettelse. Vi er ikke ansvarlige for eventuelle misforst√•elser eller feiltolkninger som oppst√•r ved bruk av denne oversettelsen.