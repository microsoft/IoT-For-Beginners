<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "5f2d2f4a5a023c93ab34a0cc5b47c0c4",
  "translation_date": "2025-08-27T21:39:44+00:00",
  "source_file": "2-farm/lessons/5-migrate-application-to-the-cloud/README.md",
  "language_code": "vi"
}
-->
# Di chuy·ªÉn logic ·ª©ng d·ª•ng c·ªßa b·∫°n l√™n ƒë√°m m√¢y

![T√≥m t·∫Øt b√†i h·ªçc b·∫±ng h√¨nh v·∫Ω](../../../../../translated_images/lesson-9.dfe99c8e891f48e179724520da9f5794392cf9a625079281ccdcbf09bd85e1b6.vi.jpg)

> H√¨nh v·∫Ω minh h·ªça b·ªüi [Nitya Narasimhan](https://github.com/nitya). Nh·∫•p v√†o h√¨nh ƒë·ªÉ xem phi√™n b·∫£n l·ªõn h∆°n.

B√†i h·ªçc n√†y ƒë∆∞·ª£c gi·∫£ng d·∫°y trong [D·ª± √°n IoT cho Ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu - Chu·ªói N√¥ng nghi·ªáp K·ªπ thu·∫≠t s·ªë](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) t·ª´ [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn).

[![ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã IoT c·ªßa b·∫°n b·∫±ng m√£ serverless](https://img.youtube.com/vi/VVZDcs5u1_I/0.jpg)](https://youtu.be/VVZDcs5u1_I)

## C√¢u h·ªèi tr∆∞·ªõc b√†i h·ªçc

[C√¢u h·ªèi tr∆∞·ªõc b√†i h·ªçc](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/17)

## Gi·ªõi thi·ªáu

Trong b√†i h·ªçc tr∆∞·ªõc, b·∫°n ƒë√£ h·ªçc c√°ch k·∫øt n·ªëi h·ªá th·ªëng gi√°m s√°t ƒë·ªô ·∫©m ƒë·∫•t v√† ƒëi·ªÅu khi·ªÉn r∆°-le c·ªßa c√¢y tr·ªìng v·ªõi m·ªôt d·ªãch v·ª• IoT tr√™n ƒë√°m m√¢y. B∆∞·ªõc ti·∫øp theo l√† di chuy·ªÉn m√£ m√°y ch·ªß ƒëi·ªÅu khi·ªÉn th·ªùi gian c·ªßa r∆°-le l√™n ƒë√°m m√¢y. Trong b√†i h·ªçc n√†y, b·∫°n s·∫Ω h·ªçc c√°ch th·ª±c hi·ªán ƒëi·ªÅu n√†y b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c h√†m serverless.

Trong b√†i h·ªçc n√†y, ch√∫ng ta s·∫Ω ƒë·ªÅ c·∫≠p ƒë·∫øn:

* [Serverless l√† g√¨?](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud)
* [T·∫°o m·ªôt ·ª©ng d·ª•ng serverless](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud)
* [T·∫°o m·ªôt trigger s·ª± ki·ªán IoT Hub](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud)
* [G·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp t·ª´ m√£ serverless](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud)
* [Tri·ªÉn khai m√£ serverless c·ªßa b·∫°n l√™n ƒë√°m m√¢y](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud)

## Serverless l√† g√¨?

Serverless, hay ƒëi·ªán to√°n kh√¥ng m√°y ch·ªß, li√™n quan ƒë·∫øn vi·ªác t·∫°o c√°c kh·ªëi m√£ nh·ªè ƒë∆∞·ª£c ch·∫°y tr√™n ƒë√°m m√¢y ƒë·ªÉ ph·∫£n h·ªìi c√°c lo·∫°i s·ª± ki·ªán kh√°c nhau. Khi s·ª± ki·ªán x·∫£y ra, m√£ c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ch·∫°y v√† nh·∫≠n d·ªØ li·ªáu v·ªÅ s·ª± ki·ªán ƒë√≥. C√°c s·ª± ki·ªán n√†y c√≥ th·ªÉ ƒë·∫øn t·ª´ nhi·ªÅu ngu·ªìn kh√°c nhau, bao g·ªìm y√™u c·∫ßu web, tin nh·∫Øn ƒë∆∞·ª£c ƒë·∫∑t trong h√†ng ƒë·ª£i, thay ƒë·ªïi d·ªØ li·ªáu trong c∆° s·ªü d·ªØ li·ªáu, ho·∫∑c tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i ƒë·∫øn m·ªôt d·ªãch v·ª• IoT b·ªüi c√°c thi·∫øt b·ªã IoT.

![C√°c s·ª± ki·ªán ƒë∆∞·ª£c g·ª≠i t·ª´ m·ªôt d·ªãch v·ª• IoT ƒë·∫øn m·ªôt d·ªãch v·ª• serverless, t·∫•t c·∫£ ƒë∆∞·ª£c x·ª≠ l√Ω ƒë·ªìng th·ªùi b·ªüi nhi·ªÅu h√†m ƒëang ch·∫°y](../../../../../translated_images/iot-messages-to-serverless.0194da1cc0732bb7d0f823aed3fce54735c6b1ad3bf36089804d8aaefc0a774f.vi.png)

> üíÅ N·∫øu b·∫°n ƒë√£ t·ª´ng s·ª≠ d·ª•ng trigger c∆° s·ªü d·ªØ li·ªáu tr∆∞·ªõc ƒë√¢y, b·∫°n c√≥ th·ªÉ nghƒ© ƒëi·ªÅu n√†y t∆∞∆°ng t·ª± nh∆∞ v·∫≠y, m√£ ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi m·ªôt s·ª± ki·ªán nh∆∞ ch√®n m·ªôt h√†ng.

![Khi nhi·ªÅu s·ª± ki·ªán ƒë∆∞·ª£c g·ª≠i c√πng l√∫c, d·ªãch v·ª• serverless s·∫Ω m·ªü r·ªông ƒë·ªÉ ch·∫°y t·∫•t c·∫£ ch√∫ng ƒë·ªìng th·ªùi](../../../../../translated_images/serverless-scaling.f8c769adf0413fd17be1af4f07ff63016b347e2ff869be6c4abb211f9e93909d.vi.png)

M√£ c·ªßa b·∫°n ch·ªâ ƒë∆∞·ª£c ch·∫°y khi s·ª± ki·ªán x·∫£y ra, kh√¥ng c√≥ g√¨ gi·ªØ m√£ c·ªßa b·∫°n ho·∫°t ƒë·ªông v√†o c√°c th·ªùi ƒëi·ªÉm kh√°c. Khi s·ª± ki·ªán x·∫£y ra, m√£ c·ªßa b·∫°n ƒë∆∞·ª£c t·∫£i v√† ch·∫°y. ƒêi·ªÅu n√†y l√†m cho serverless r·∫•t d·ªÖ m·ªü r·ªông - n·∫øu nhi·ªÅu s·ª± ki·ªán x·∫£y ra c√πng l√∫c, nh√† cung c·∫•p ƒë√°m m√¢y c√≥ th·ªÉ ch·∫°y h√†m c·ªßa b·∫°n nhi·ªÅu l·∫ßn nh∆∞ b·∫°n c·∫ßn ƒë·ªìng th·ªùi tr√™n c√°c m√°y ch·ªß m√† h·ªç c√≥ s·∫µn. Nh∆∞·ª£c ƒëi·ªÉm c·ªßa ƒëi·ªÅu n√†y l√† n·∫øu b·∫°n c·∫ßn chia s·∫ª th√¥ng tin gi·ªØa c√°c s·ª± ki·ªán, b·∫°n c·∫ßn l∆∞u tr·ªØ n√≥ ·ªü ƒë√¢u ƒë√≥ nh∆∞ c∆° s·ªü d·ªØ li·ªáu thay v√¨ l∆∞u tr·ªØ trong b·ªô nh·ªõ.

M√£ c·ªßa b·∫°n ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng m·ªôt h√†m nh·∫≠n th√¥ng tin chi ti·∫øt v·ªÅ s·ª± ki·ªán l√†m tham s·ªë. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng nhi·ªÅu ng√¥n ng·ªØ l·∫≠p tr√¨nh kh√°c nhau ƒë·ªÉ vi·∫øt c√°c h√†m serverless n√†y.

> üéì Serverless c≈©ng ƒë∆∞·ª£c g·ªçi l√† Functions as a Service (FaaS) v√¨ m·ªói trigger s·ª± ki·ªán ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng m·ªôt h√†m trong m√£.

M·∫∑c d√π t√™n g·ªçi l√† serverless, th·ª±c t·∫ø v·∫´n s·ª≠ d·ª•ng m√°y ch·ªß. T√™n g·ªçi n√†y xu·∫•t ph√°t t·ª´ vi·ªác b·∫°n, v·ªõi t∆∞ c√°ch l√† nh√† ph√°t tri·ªÉn, kh√¥ng c·∫ßn quan t√¢m ƒë·∫øn c√°c m√°y ch·ªß c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y m√£ c·ªßa m√¨nh, t·∫•t c·∫£ nh·ªØng g√¨ b·∫°n quan t√¢m l√† m√£ c·ªßa b·∫°n ƒë∆∞·ª£c ch·∫°y ƒë·ªÉ ph·∫£n h·ªìi m·ªôt s·ª± ki·ªán. Nh√† cung c·∫•p ƒë√°m m√¢y c√≥ m·ªôt *runtime* serverless qu·∫£n l√Ω vi·ªác ph√¢n b·ªï m√°y ch·ªß, m·∫°ng, l∆∞u tr·ªØ, CPU, b·ªô nh·ªõ v√† m·ªçi th·ª© kh√°c c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y m√£ c·ªßa b·∫°n. M√¥ h√¨nh n√†y c√≥ nghƒ©a l√† b·∫°n kh√¥ng tr·∫£ ti·ªÅn theo m√°y ch·ªß, v√¨ kh√¥ng c√≥ m√°y ch·ªß c·ª• th·ªÉ. Thay v√†o ƒë√≥, b·∫°n tr·∫£ ti·ªÅn cho th·ªùi gian m√£ c·ªßa b·∫°n ch·∫°y v√† l∆∞·ª£ng b·ªô nh·ªõ ƒë∆∞·ª£c s·ª≠ d·ª•ng.

> üí∞ Serverless l√† m·ªôt trong nh·ªØng c√°ch r·∫ª nh·∫•t ƒë·ªÉ ch·∫°y m√£ tr√™n ƒë√°m m√¢y. V√≠ d·ª•, t·∫°i th·ªùi ƒëi·ªÉm vi·∫øt b√†i, m·ªôt nh√† cung c·∫•p ƒë√°m m√¢y cho ph√©p t·∫•t c·∫£ c√°c h√†m serverless c·ªßa b·∫°n th·ª±c thi t·ªïng c·ªông 1.000.000 l·∫ßn m·ªói th√°ng tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu t√≠nh ph√≠, v√† sau ƒë√≥ h·ªç t√≠nh ph√≠ 0,20 USD cho m·ªói 1.000.000 l·∫ßn th·ª±c thi. Khi m√£ c·ªßa b·∫°n kh√¥ng ch·∫°y, b·∫°n kh√¥ng ph·∫£i tr·∫£ ti·ªÅn.

L√† m·ªôt nh√† ph√°t tri·ªÉn IoT, m√¥ h√¨nh serverless l√† l√Ω t∆∞·ªüng. B·∫°n c√≥ th·ªÉ vi·∫øt m·ªôt h√†m ƒë∆∞·ª£c g·ªçi ƒë·ªÉ ph·∫£n h·ªìi c√°c tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i t·ª´ b·∫•t k·ª≥ thi·∫øt b·ªã IoT n√†o ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi d·ªãch v·ª• IoT ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n ƒë√°m m√¢y c·ªßa b·∫°n. M√£ c·ªßa b·∫°n s·∫Ω x·ª≠ l√Ω t·∫•t c·∫£ c√°c tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i, nh∆∞ng ch·ªâ ch·∫°y khi c·∫ßn thi·∫øt.

‚úÖ H√£y xem l·∫°i m√£ b·∫°n ƒë√£ vi·∫øt d∆∞·ªõi d·∫°ng m√£ m√°y ch·ªß l·∫Øng nghe tin nh·∫Øn qua MQTT. L√†m th·∫ø n√†o m√£ n√†y c√≥ th·ªÉ ch·∫°y tr√™n ƒë√°m m√¢y b·∫±ng serverless? B·∫°n nghƒ© m√£ c·∫ßn thay ƒë·ªïi nh∆∞ th·∫ø n√†o ƒë·ªÉ h·ªó tr·ª£ ƒëi·ªán to√°n serverless?

> üíÅ M√¥ h√¨nh serverless ƒëang ƒë∆∞·ª£c m·ªü r·ªông sang c√°c d·ªãch v·ª• ƒë√°m m√¢y kh√°c ngo√†i vi·ªác ch·∫°y m√£. V√≠ d·ª•, c∆° s·ªü d·ªØ li·ªáu serverless c√≥ s·∫µn tr√™n ƒë√°m m√¢y s·ª≠ d·ª•ng m√¥ h√¨nh ƒë·ªãnh gi√° serverless, n∆°i b·∫°n tr·∫£ ti·ªÅn cho m·ªói y√™u c·∫ßu th·ª±c hi·ªán ƒë·ªëi v·ªõi c∆° s·ªü d·ªØ li·ªáu, ch·∫≥ng h·∫°n nh∆∞ truy v·∫•n ho·∫∑c ch√®n, th∆∞·ªùng d·ª±a tr√™n l∆∞·ª£ng c√¥ng vi·ªác c·∫ßn thi·∫øt ƒë·ªÉ x·ª≠ l√Ω y√™u c·∫ßu. V√≠ d·ª•, m·ªôt truy v·∫•n ƒë∆°n gi·∫£n ch·ªçn m·ªôt h√†ng theo kh√≥a ch√≠nh s·∫Ω t·ªën √≠t h∆°n m·ªôt thao t√°c ph·ª©c t·∫°p k·∫øt h·ª£p nhi·ªÅu b·∫£ng v√† tr·∫£ v·ªÅ h√†ng ngh√¨n h√†ng.

## T·∫°o m·ªôt ·ª©ng d·ª•ng serverless

D·ªãch v·ª• ƒëi·ªán to√°n serverless t·ª´ Microsoft ƒë∆∞·ª£c g·ªçi l√† Azure Functions.

![Logo Azure Functions](../../../../../translated_images/azure-functions-logo.1cfc8e3204c9c44aaf80fcf406fc8544d80d7f00f8d3e8ed6fed764563e17564.vi.png)

Video ng·∫Øn d∆∞·ªõi ƒë√¢y cung c·∫•p t·ªïng quan v·ªÅ Azure Functions:

[![Video t·ªïng quan v·ªÅ Azure Functions](https://img.youtube.com/vi/8-jz5f_JyEQ/0.jpg)](https://www.youtube.com/watch?v=8-jz5f_JyEQ)

> üé• Nh·∫•p v√†o h√¨nh tr√™n ƒë·ªÉ xem video

‚úÖ D√†nh m·ªôt ch√∫t th·ªùi gian ƒë·ªÉ nghi√™n c·ª©u v√† ƒë·ªçc t·ªïng quan v·ªÅ Azure Functions trong [t√†i li·ªáu Azure Functions c·ªßa Microsoft](https://docs.microsoft.com/azure/azure-functions/functions-overview?WT.mc_id=academic-17441-jabenn).

ƒê·ªÉ vi·∫øt Azure Functions, b·∫°n b·∫Øt ƒë·∫ßu v·ªõi m·ªôt ·ª©ng d·ª•ng Azure Functions b·∫±ng ng√¥n ng·ªØ b·∫°n ch·ªçn. Azure Functions h·ªó tr·ª£ Python, JavaScript, TypeScript, C#, F#, Java v√† Powershell. Trong b√†i h·ªçc n√†y, b·∫°n s·∫Ω h·ªçc c√°ch vi·∫øt m·ªôt ·ª©ng d·ª•ng Azure Functions b·∫±ng Python.

> üíÅ Azure Functions c≈©ng h·ªó tr·ª£ c√°c tr√¨nh x·ª≠ l√Ω t√πy ch·ªânh, v√¨ v·∫≠y b·∫°n c√≥ th·ªÉ vi·∫øt c√°c h√†m c·ªßa m√¨nh b·∫±ng b·∫•t k·ª≥ ng√¥n ng·ªØ n√†o h·ªó tr·ª£ y√™u c·∫ßu HTTP, bao g·ªìm c·∫£ c√°c ng√¥n ng·ªØ c≈© nh∆∞ COBOL.

·ª®ng d·ª•ng Functions bao g·ªìm m·ªôt ho·∫∑c nhi·ªÅu *trigger* - c√°c h√†m ph·∫£n h·ªìi s·ª± ki·ªán. B·∫°n c√≥ th·ªÉ c√≥ nhi·ªÅu trigger trong m·ªôt ·ª©ng d·ª•ng Functions, t·∫•t c·∫£ ƒë·ªÅu chia s·∫ª c·∫•u h√¨nh chung. V√≠ d·ª•, trong t·ªáp c·∫•u h√¨nh cho ·ª©ng d·ª•ng Functions c·ªßa b·∫°n, b·∫°n c√≥ th·ªÉ c√≥ th√¥ng tin k·∫øt n·ªëi c·ªßa IoT Hub, v√† t·∫•t c·∫£ c√°c h√†m trong ·ª©ng d·ª•ng c√≥ th·ªÉ s·ª≠ d·ª•ng th√¥ng tin n√†y ƒë·ªÉ k·∫øt n·ªëi v√† l·∫Øng nghe s·ª± ki·ªán.

### Nhi·ªám v·ª• - c√†i ƒë·∫∑t c√¥ng c·ª• Azure Functions

> T·∫°i th·ªùi ƒëi·ªÉm vi·∫øt b√†i, c√°c c√¥ng c·ª• m√£ Azure Functions ch∆∞a ho√†n to√†n ho·∫°t ƒë·ªông tr√™n Apple Silicon v·ªõi c√°c d·ª± √°n Python. B·∫°n s·∫Ω c·∫ßn s·ª≠ d·ª•ng m√°y Mac d·ª±a tr√™n Intel, PC Windows ho·∫∑c PC Linux.

M·ªôt t√≠nh nƒÉng tuy·ªát v·ªùi c·ªßa Azure Functions l√† b·∫°n c√≥ th·ªÉ ch·∫°y ch√∫ng c·ª•c b·ªô. Runtime gi·ªëng nh∆∞ tr√™n ƒë√°m m√¢y c√≥ th·ªÉ ch·∫°y tr√™n m√°y t√≠nh c·ªßa b·∫°n, cho ph√©p b·∫°n vi·∫øt m√£ ph·∫£n h·ªìi c√°c tin nh·∫Øn IoT v√† ch·∫°y n√≥ c·ª•c b·ªô. B·∫°n th·∫≠m ch√≠ c√≥ th·ªÉ g·ª° l·ªói m√£ c·ªßa m√¨nh khi c√°c s·ª± ki·ªán ƒë∆∞·ª£c x·ª≠ l√Ω. Khi b·∫°n h√†i l√≤ng v·ªõi m√£ c·ªßa m√¨nh, n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c tri·ªÉn khai l√™n ƒë√°m m√¢y.

C√¥ng c·ª• Azure Functions c√≥ s·∫µn d∆∞·ªõi d·∫°ng CLI, ƒë∆∞·ª£c g·ªçi l√† Azure Functions Core Tools.

1. C√†i ƒë·∫∑t c√¥ng c·ª• Azure Functions Core Tools b·∫±ng c√°ch l√†m theo h∆∞·ªõng d·∫´n trong [t√†i li·ªáu Azure Functions Core Tools](https://docs.microsoft.com/azure/azure-functions/functions-run-local?WT.mc_id=academic-17441-jabenn).

1. C√†i ƒë·∫∑t ti·ªán √≠ch m·ªü r·ªông Azure Functions cho VS Code. Ti·ªán √≠ch n√†y cung c·∫•p h·ªó tr·ª£ cho vi·ªác t·∫°o, g·ª° l·ªói v√† tri·ªÉn khai Azure Functions. Tham kh·∫£o [t√†i li·ªáu ti·ªán √≠ch m·ªü r·ªông Azure Functions](https://marketplace.visualstudio.com/items?WT.mc_id=academic-17441-jabenn&itemName=ms-azuretools.vscode-azurefunctions) ƒë·ªÉ bi·∫øt h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t ti·ªán √≠ch n√†y trong VS Code.

Khi b·∫°n tri·ªÉn khai ·ª©ng d·ª•ng Azure Functions c·ªßa m√¨nh l√™n ƒë√°m m√¢y, n√≥ c·∫ßn s·ª≠ d·ª•ng m·ªôt l∆∞·ª£ng nh·ªè l∆∞u tr·ªØ ƒë√°m m√¢y ƒë·ªÉ l∆∞u tr·ªØ c√°c t·ªáp ·ª©ng d·ª•ng v√† t·ªáp nh·∫≠t k√Ω. Khi b·∫°n ch·∫°y ·ª©ng d·ª•ng Functions c·ª•c b·ªô, b·∫°n v·∫´n c·∫ßn k·∫øt n·ªëi v·ªõi l∆∞u tr·ªØ ƒë√°m m√¢y, nh∆∞ng thay v√¨ s·ª≠ d·ª•ng l∆∞u tr·ªØ ƒë√°m m√¢y th·ª±c t·∫ø, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng m·ªôt tr√¨nh gi·∫£ l·∫≠p l∆∞u tr·ªØ g·ªçi l√† [Azurite](https://github.com/Azure/Azurite). Tr√¨nh gi·∫£ l·∫≠p n√†y ch·∫°y c·ª•c b·ªô nh∆∞ng ho·∫°t ƒë·ªông nh∆∞ l∆∞u tr·ªØ ƒë√°m m√¢y.

> üéì Trong Azure, l∆∞u tr·ªØ m√† Azure Functions s·ª≠ d·ª•ng l√† m·ªôt T√†i kho·∫£n L∆∞u tr·ªØ Azure. C√°c t√†i kho·∫£n n√†y c√≥ th·ªÉ l∆∞u tr·ªØ t·ªáp, blob, d·ªØ li·ªáu trong b·∫£ng ho·∫∑c d·ªØ li·ªáu trong h√†ng ƒë·ª£i. B·∫°n c√≥ th·ªÉ chia s·∫ª m·ªôt t√†i kho·∫£n l∆∞u tr·ªØ gi·ªØa nhi·ªÅu ·ª©ng d·ª•ng, ch·∫≥ng h·∫°n nh∆∞ m·ªôt ·ª©ng d·ª•ng Functions v√† m·ªôt ·ª©ng d·ª•ng web.

1. Azurite l√† m·ªôt ·ª©ng d·ª•ng Node.js, v√¨ v·∫≠y b·∫°n s·∫Ω c·∫ßn c√†i ƒë·∫∑t Node.js. B·∫°n c√≥ th·ªÉ t√¨m th·∫•y h∆∞·ªõng d·∫´n t·∫£i xu·ªëng v√† c√†i ƒë·∫∑t tr√™n [trang web Node.js](https://nodejs.org/). N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng Mac, b·∫°n c≈©ng c√≥ th·ªÉ c√†i ƒë·∫∑t n√≥ t·ª´ [Homebrew](https://formulae.brew.sh/formula/node).

1. C√†i ƒë·∫∑t Azurite b·∫±ng l·ªánh sau (`npm` l√† m·ªôt c√¥ng c·ª• ƒë∆∞·ª£c c√†i ƒë·∫∑t khi b·∫°n c√†i ƒë·∫∑t Node.js):

    ```sh
    npm install -g azurite
    ```

1. T·∫°o m·ªôt th∆∞ m·ª•c g·ªçi l√† `azurite` ƒë·ªÉ Azurite s·ª≠ d·ª•ng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu:

    ```sh
    mkdir azurite
    ```

1. Ch·∫°y Azurite, truy·ªÅn cho n√≥ th∆∞ m·ª•c m·ªõi n√†y:

    ```sh
    azurite --location azurite
    ```

    Tr√¨nh gi·∫£ l·∫≠p l∆∞u tr·ªØ Azurite s·∫Ω kh·ªüi ch·∫°y v√† s·∫µn s√†ng ƒë·ªÉ runtime Functions c·ª•c b·ªô k·∫øt n·ªëi.

    ```output
    ‚ûú  ~ azurite --location azurite  
    Azurite Blob service is starting at http://127.0.0.1:10000
    Azurite Blob service is successfully listening at http://127.0.0.1:10000
    Azurite Queue service is starting at http://127.0.0.1:10001
    Azurite Queue service is successfully listening at http://127.0.0.1:10001
    Azurite Table service is starting at http://127.0.0.1:10002
    Azurite Table service is successfully listening at http://127.0.0.1:10002
    ```

### Nhi·ªám v·ª• - t·∫°o m·ªôt d·ª± √°n Azure Functions

CLI Azure Functions c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o m·ªôt ·ª©ng d·ª•ng Functions m·ªõi.

1. T·∫°o m·ªôt th∆∞ m·ª•c cho ·ª©ng d·ª•ng Functions c·ªßa b·∫°n v√† ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn ƒë√≥. G·ªçi n√≥ l√† `soil-moisture-trigger`:

    ```sh
    mkdir soil-moisture-trigger
    cd soil-moisture-trigger
    ```

1. T·∫°o m·ªôt m√¥i tr∆∞·ªùng ·∫£o Python b√™n trong th∆∞ m·ª•c n√†y:

    ```sh
    python3 -m venv .venv
    ```

1. K√≠ch ho·∫°t m√¥i tr∆∞·ªùng ·∫£o:

    * Tr√™n Windows:
        * N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng Command Prompt ho·∫∑c Command Prompt qua Windows Terminal, ch·∫°y:

            ```cmd
            .venv\Scripts\activate.bat
            ```

        * N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng PowerShell, ch·∫°y:

            ```powershell
            .\.venv\Scripts\Activate.ps1
            ```

    * Tr√™n macOS ho·∫∑c Linux, ch·∫°y:

        ```cmd
        source ./.venv/bin/activate
        ```

    > üíÅ C√°c l·ªánh n√†y n√™n ƒë∆∞·ª£c ch·∫°y t·ª´ c√πng v·ªã tr√≠ b·∫°n ƒë√£ ch·∫°y l·ªánh ƒë·ªÉ t·∫°o m√¥i tr∆∞·ªùng ·∫£o. B·∫°n s·∫Ω kh√¥ng bao gi·ªù c·∫ßn ƒëi·ªÅu h∆∞·ªõng v√†o th∆∞ m·ª•c `.venv`, b·∫°n n√™n lu√¥n ch·∫°y l·ªánh k√≠ch ho·∫°t v√† b·∫•t k·ª≥ l·ªánh n√†o ƒë·ªÉ c√†i ƒë·∫∑t g√≥i ho·∫∑c ch·∫°y m√£ t·ª´ th∆∞ m·ª•c b·∫°n ƒë√£ ·ªü khi t·∫°o m√¥i tr∆∞·ªùng ·∫£o.

1. Ch·∫°y l·ªánh sau ƒë·ªÉ t·∫°o m·ªôt ·ª©ng d·ª•ng Functions trong th∆∞ m·ª•c n√†y:

    ```sh
    func init --worker-runtime python soil-moisture-trigger
    ```

    ƒêi·ªÅu n√†y s·∫Ω t·∫°o ba t·ªáp b√™n trong th∆∞ m·ª•c hi·ªán t·∫°i:

    * `host.json` - t√†i li·ªáu JSON n√†y ch·ª©a c√°c c√†i ƒë·∫∑t cho ·ª©ng d·ª•ng Functions c·ªßa b·∫°n. B·∫°n s·∫Ω kh√¥ng c·∫ßn s·ª≠a ƒë·ªïi c√°c c√†i ƒë·∫∑t n√†y.
    * `local.settings.json` - t√†i li·ªáu JSON n√†y ch·ª©a c√°c c√†i ƒë·∫∑t m√† ·ª©ng d·ª•ng c·ªßa b·∫°n s·∫Ω s·ª≠ d·ª•ng khi ch·∫°y c·ª•c b·ªô, ch·∫≥ng h·∫°n nh∆∞ chu·ªói k·∫øt n·ªëi cho IoT Hub. C√°c c√†i ƒë·∫∑t n√†y ch·ªâ d√†nh cho c·ª•c b·ªô v√† kh√¥ng n√™n ƒë∆∞·ª£c th√™m v√†o ki·ªÉm so√°t m√£ ngu·ªìn. Khi b·∫°n tri·ªÉn khai ·ª©ng d·ª•ng l√™n ƒë√°m m√¢y, c√°c c√†i ƒë·∫∑t n√†y kh√¥ng ƒë∆∞·ª£c tri·ªÉn khai, thay v√†o ƒë√≥ c√°c c√†i ƒë·∫∑t c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ c√†i ƒë·∫∑t ·ª©ng d·ª•ng. ƒêi·ªÅu n√†y s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p sau trong b√†i h·ªçc n√†y.
    * `requirements.txt` - ƒë√¢y l√† m·ªôt [t·ªáp y√™u c·∫ßu Pip](https://pip.pypa.io/en/stable/user_guide/#requirements-files) ch·ª©a c√°c g√≥i Pip c·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng Functions c·ªßa b·∫°n.

1. T·ªáp `local.settings.json` c√≥ m·ªôt c√†i ƒë·∫∑t cho t√†i kho·∫£n l∆∞u tr·ªØ m√† ·ª©ng d·ª•ng Functions s·∫Ω s·ª≠ d·ª•ng. M·∫∑c ƒë·ªãnh l√† m·ªôt c√†i ƒë·∫∑t tr·ªëng, v√¨ v·∫≠y c·∫ßn ƒë∆∞·ª£c thi·∫øt l·∫≠p. ƒê·ªÉ k·∫øt n·ªëi v·ªõi tr√¨nh gi·∫£ l·∫≠p l∆∞u tr·ªØ c·ª•c b·ªô Azurite, ƒë·∫∑t gi√° tr·ªã n√†y th√†nh:

    ```json
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    ```

1. C√†i ƒë·∫∑t c√°c g√≥i Pip c·∫ßn thi·∫øt b·∫±ng t·ªáp y√™u c·∫ßu:

    ```sh
    pip install -r requirements.txt
    ```

    > üíÅ C√°c g√≥i Pip c·∫ßn thi·∫øt c·∫ßn c√≥ trong t·ªáp n√†y, ƒë·ªÉ khi ·ª©ng d·ª•ng Functions ƒë∆∞·ª£c tri·ªÉn khai l√™n ƒë√°m m√¢y, runtime c√≥ th·ªÉ ƒë·∫£m b·∫£o c√†i ƒë·∫∑t ƒë√∫ng c√°c g√≥i.

1. ƒê·ªÉ ki·ªÉm tra m·ªçi th·ª© ho·∫°t ƒë·ªông ƒë√∫ng, b·∫°n c√≥ th·ªÉ kh·ªüi ƒë·ªông runtime Functions. Ch·∫°y l·ªánh sau ƒë·ªÉ l√†m ƒëi·ªÅu n√†y:

    ```sh
    func start
    ```

    B·∫°n s·∫Ω th·∫•y runtime kh·ªüi ƒë·ªông v√† b√°o c√°o r·∫±ng n√≥ kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ h√†m c√¥ng vi·ªác n√†o (trigger).

    ```output
    (.venv) ‚ûú  soil-moisture-trigger func start
    Found Python version 3.9.1 (python3).
    
    Azure Functions Core Tools
    Core Tools Version:       3.0.3442 Commit hash: 6bfab24b2743f8421475d996402c398d2fe4a9e0  (64-bit)
    Function Runtime Version: 3.0.15417.0
    
    [2021-05-05T01:24:46.795Z] No job functions found.
    ```
> ‚ö†Ô∏è N·∫øu b·∫°n nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o t∆∞·ªùng l·ª≠a, h√£y c·∫•p quy·ªÅn truy c·∫≠p v√¨ ·ª©ng d·ª•ng `func` c·∫ßn c√≥ kh·∫£ nƒÉng ƒë·ªçc v√† ghi v√†o m·∫°ng c·ªßa b·∫°n.
> ‚ö†Ô∏è N·∫øu b·∫°n ƒëang s·ª≠ d·ª•ng macOS, c√≥ th·ªÉ xu·∫•t hi·ªán c√°c c·∫£nh b√°o trong ƒë·∫ßu ra:
>
> ```output
    > (.venv) ‚ûú  soil-moisture-trigger func start
    > Found Python version 3.9.1 (python3).
    >
    > Azure Functions Core Tools
    > Core Tools Version:       3.0.3442 Commit hash: 6bfab24b2743f8421475d996402c398d2fe4a9e0  (64-bit)
    > Function Runtime Version: 3.0.15417.0
    >
    > [2021-06-16T08:18:28.315Z] Cannot create directory for shared memory usage: /dev/shm/AzureFunctions
    > [2021-06-16T08:18:28.316Z] System.IO.FileSystem: Access to the path '/dev/shm/AzureFunctions' is denied. Operation not permitted.
    > [2021-06-16T08:18:30.361Z] No job functions found.
    > ```
>
> B·∫°n c√≥ th·ªÉ b·ªè qua nh·ªØng c·∫£nh b√°o n√†y mi·ªÖn l√† ·ª©ng d·ª•ng Functions kh·ªüi ƒë·ªông ƒë√∫ng c√°ch v√† li·ªát k√™ c√°c ch·ª©c nƒÉng ƒëang ch·∫°y. Nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p trong [c√¢u h·ªèi n√†y tr√™n Microsoft Docs Q&A](https://docs.microsoft.com/answers/questions/396617/azure-functions-core-tools-error-osx-devshmazurefu.html?WT.mc_id=academic-17441-jabenn), b·∫°n c√≥ th·ªÉ b·ªè qua.

1. D·ª´ng ·ª©ng d·ª•ng Functions b·∫±ng c√°ch nh·∫•n `ctrl+c`.

1. M·ªü th∆∞ m·ª•c hi·ªán t·∫°i trong VS Code, b·∫±ng c√°ch m·ªü VS Code r·ªìi m·ªü th∆∞ m·ª•c n√†y, ho·∫∑c ch·∫°y l·ªánh sau:

    ```sh
    code .
    ```

    VS Code s·∫Ω nh·∫≠n di·ªán d·ª± √°n Functions c·ªßa b·∫°n v√† hi·ªÉn th·ªã th√¥ng b√°o nh∆∞ sau:

    ```output
    Detected an Azure Functions Project in folder "soil-moisture-trigger" that may have been created outside of
    VS Code. Initialize for optimal use with VS Code?
    ```

    ![Th√¥ng b√°o](../../../../../translated_images/vscode-azure-functions-init-notification.bd19b49229963edb5311fb3a79445ea469424759d2917ee2f2eb6f92d65d5086.vi.png)

    Ch·ªçn **Yes** t·ª´ th√¥ng b√°o n√†y.

1. ƒê·∫£m b·∫£o m√¥i tr∆∞·ªùng ·∫£o Python ƒëang ch·∫°y trong terminal c·ªßa VS Code. K·∫øt th√∫c v√† kh·ªüi ƒë·ªông l·∫°i n·∫øu c·∫ßn thi·∫øt.

## T·∫°o trigger s·ª± ki·ªán IoT Hub

·ª®ng d·ª•ng Functions l√† l·ªõp v·ªè cho m√£ serverless c·ªßa b·∫°n. ƒê·ªÉ ph·∫£n h·ªìi c√°c s·ª± ki·ªán t·ª´ IoT Hub, b·∫°n c√≥ th·ªÉ th√™m m·ªôt trigger IoT Hub v√†o ·ª©ng d·ª•ng n√†y. Trigger n√†y c·∫ßn k·∫øt n·ªëi v·ªõi lu·ªìng tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i ƒë·∫øn IoT Hub v√† ph·∫£n h·ªìi ch√∫ng. ƒê·ªÉ nh·∫≠n lu·ªìng tin nh·∫Øn n√†y, trigger c·ªßa b·∫°n c·∫ßn k·∫øt n·ªëi v·ªõi *ƒëi·ªÉm cu·ªëi t∆∞∆°ng th√≠ch s·ª± ki·ªán* c·ªßa IoT Hub.

IoT Hub ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n m·ªôt d·ªãch v·ª• Azure kh√°c g·ªçi l√† Azure Event Hubs. Event Hubs l√† m·ªôt d·ªãch v·ª• cho ph√©p b·∫°n g·ª≠i v√† nh·∫≠n tin nh·∫Øn, IoT Hub m·ªü r·ªông d·ªãch v·ª• n√†y ƒë·ªÉ th√™m c√°c t√≠nh nƒÉng cho thi·∫øt b·ªã IoT. C√°ch b·∫°n k·∫øt n·ªëi ƒë·ªÉ ƒë·ªçc tin nh·∫Øn t·ª´ IoT Hub gi·ªëng nh∆∞ c√°ch b·∫°n s·ª≠ d·ª•ng Event Hubs.

‚úÖ Nghi√™n c·ª©u th√™m: ƒê·ªçc t·ªïng quan v·ªÅ Event Hubs trong [t√†i li·ªáu Azure Event Hubs](https://docs.microsoft.com/azure/event-hubs/event-hubs-about?WT.mc_id=academic-17441-jabenn). C√°c t√≠nh nƒÉng c∆° b·∫£n so v·ªõi IoT Hub nh∆∞ th·∫ø n√†o?

ƒê·ªÉ m·ªôt thi·∫øt b·ªã IoT k·∫øt n·ªëi v·ªõi IoT Hub, n√≥ ph·∫£i s·ª≠ d·ª•ng m·ªôt kh√≥a b√≠ m·∫≠t ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ c√°c thi·∫øt b·ªã ƒë∆∞·ª£c ph√©p m·ªõi c√≥ th·ªÉ k·∫øt n·ªëi. ƒêi·ªÅu n√†y c≈©ng √°p d·ª•ng khi k·∫øt n·ªëi ƒë·ªÉ ƒë·ªçc tin nh·∫Øn, m√£ c·ªßa b·∫°n s·∫Ω c·∫ßn m·ªôt chu·ªói k·∫øt n·ªëi ch·ª©a kh√≥a b√≠ m·∫≠t c√πng v·ªõi th√¥ng tin chi ti·∫øt v·ªÅ IoT Hub.

> üíÅ Chu·ªói k·∫øt n·ªëi m·∫∑c ƒë·ªãnh b·∫°n nh·∫≠n ƒë∆∞·ª£c c√≥ quy·ªÅn **iothubowner**, cho ph√©p b·∫•t k·ª≥ m√£ n√†o s·ª≠ d·ª•ng n√≥ c√≥ to√†n quy·ªÅn tr√™n IoT Hub. T·ªët nh·∫•t b·∫°n n√™n k·∫øt n·ªëi v·ªõi m·ª©c quy·ªÅn th·∫•p nh·∫•t c·∫ßn thi·∫øt. ƒêi·ªÅu n√†y s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p trong b√†i h·ªçc ti·∫øp theo.

Khi trigger c·ªßa b·∫°n ƒë√£ k·∫øt n·ªëi, m√£ b√™n trong h√†m s·∫Ω ƒë∆∞·ª£c g·ªçi cho m·ªói tin nh·∫Øn g·ª≠i ƒë·∫øn IoT Hub, b·∫•t k·ªÉ thi·∫øt b·ªã n√†o g·ª≠i tin nh·∫Øn. Trigger s·∫Ω nh·∫≠n tin nh·∫Øn d∆∞·ªõi d·∫°ng tham s·ªë.

### Nhi·ªám v·ª• - l·∫•y chu·ªói k·∫øt n·ªëi ƒëi·ªÉm cu·ªëi t∆∞∆°ng th√≠ch s·ª± ki·ªán

1. T·ª´ terminal c·ªßa VS Code, ch·∫°y l·ªánh sau ƒë·ªÉ l·∫•y chu·ªói k·∫øt n·ªëi cho ƒëi·ªÉm cu·ªëi t∆∞∆°ng th√≠ch s·ª± ki·ªán c·ªßa IoT Hub:

    ```sh
    az iot hub connection-string show --default-eventhub \
                                      --output table \
                                      --hub-name <hub_name>
    ```

    Thay `<hub_name>` b·∫±ng t√™n b·∫°n ƒë√£ s·ª≠ d·ª•ng cho IoT Hub.

1. Trong VS Code, m·ªü t·ªáp `local.settings.json`. Th√™m gi√° tr·ªã sau v√†o b√™n trong ph·∫ßn `Values`:

    ```json
    "IOT_HUB_CONNECTION_STRING": "<connection string>"
    ```

    Thay `<connection string>` b·∫±ng gi√° tr·ªã t·ª´ b∆∞·ªõc tr∆∞·ªõc. B·∫°n s·∫Ω c·∫ßn th√™m d·∫•u ph·∫©y sau d√≤ng tr√™n ƒë·ªÉ ƒë·∫£m b·∫£o JSON h·ª£p l·ªá.

### Nhi·ªám v·ª• - t·∫°o trigger s·ª± ki·ªán

B√¢y gi·ªù b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ t·∫°o trigger s·ª± ki·ªán.

1. T·ª´ terminal c·ªßa VS Code, ch·∫°y l·ªánh sau t·ª´ b√™n trong th∆∞ m·ª•c `soil-moisture-trigger`:

    ```sh
    func new --name iot-hub-trigger --template "Azure Event Hub trigger"
    ```

    L·ªánh n√†y t·∫°o m·ªôt Function m·ªõi g·ªçi l√† `iot-hub-trigger`. Trigger s·∫Ω k·∫øt n·ªëi v·ªõi ƒëi·ªÉm cu·ªëi t∆∞∆°ng th√≠ch s·ª± ki·ªán tr√™n IoT Hub, v√¨ v·∫≠y b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng trigger s·ª± ki·ªán hub. Kh√¥ng c√≥ trigger c·ª• th·ªÉ cho IoT Hub.

ƒêi·ªÅu n√†y s·∫Ω t·∫°o m·ªôt th∆∞ m·ª•c b√™n trong th∆∞ m·ª•c `soil-moisture-trigger` g·ªçi l√† `iot-hub-trigger` ch·ª©a ch·ª©c nƒÉng n√†y. Th∆∞ m·ª•c n√†y s·∫Ω c√≥ c√°c t·ªáp sau b√™n trong:

* `__init__.py` - ƒë√¢y l√† t·ªáp m√£ Python ch·ª©a trigger, s·ª≠ d·ª•ng quy ∆∞·ªõc ƒë·∫∑t t√™n t·ªáp Python ti√™u chu·∫©n ƒë·ªÉ bi·∫øn th∆∞ m·ª•c n√†y th√†nh m·ªôt module Python.

    T·ªáp n√†y s·∫Ω ch·ª©a m√£ sau:

    ```python
    import logging

    import azure.functions as func


    def main(event: func.EventHubEvent):
        logging.info('Python EventHub trigger processed an event: %s',
                    event.get_body().decode('utf-8'))
    ```

    Ph·∫ßn c·ªët l√µi c·ªßa trigger l√† h√†m `main`. Ch√≠nh h√†m n√†y ƒë∆∞·ª£c g·ªçi v·ªõi c√°c s·ª± ki·ªán t·ª´ IoT Hub. H√†m n√†y c√≥ m·ªôt tham s·ªë g·ªçi l√† `event` ch·ª©a m·ªôt `EventHubEvent`. M·ªói l·∫ßn m·ªôt tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i ƒë·∫øn IoT Hub, h√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi v√† truy·ªÅn tin nh·∫Øn ƒë√≥ d∆∞·ªõi d·∫°ng `event`, c√πng v·ªõi c√°c thu·ªôc t√≠nh gi·ªëng nh∆∞ c√°c ch√∫ th√≠ch b·∫°n ƒë√£ th·∫•y trong b√†i h·ªçc tr∆∞·ªõc.

    Ph·∫ßn c·ªët l√µi c·ªßa h√†m n√†y l√† ghi l·∫°i s·ª± ki·ªán.

* `function.json` - t·ªáp n√†y ch·ª©a c·∫•u h√¨nh cho trigger. C·∫•u h√¨nh ch√≠nh n·∫±m trong m·ªôt ph·∫ßn g·ªçi l√† `bindings`. Binding l√† thu·∫≠t ng·ªØ ƒë·ªÉ ch·ªâ k·∫øt n·ªëi gi·ªØa Azure Functions v√† c√°c d·ªãch v·ª• Azure kh√°c. Ch·ª©c nƒÉng n√†y c√≥ m·ªôt binding ƒë·∫ßu v√†o ƒë·∫øn m·ªôt event hub - n√≥ k·∫øt n·ªëi v·ªõi m·ªôt event hub v√† nh·∫≠n d·ªØ li·ªáu.

    > üíÅ B·∫°n c≈©ng c√≥ th·ªÉ c√≥ c√°c binding ƒë·∫ßu ra ƒë·ªÉ ƒë·∫ßu ra c·ªßa m·ªôt ch·ª©c nƒÉng ƒë∆∞·ª£c g·ª≠i ƒë·∫øn m·ªôt d·ªãch v·ª• kh√°c. V√≠ d·ª•, b·∫°n c√≥ th·ªÉ th√™m m·ªôt binding ƒë·∫ßu ra ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu v√† tr·∫£ l·∫°i s·ª± ki·ªán IoT Hub t·ª´ ch·ª©c nƒÉng, v√† n√≥ s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ch√®n v√†o c∆° s·ªü d·ªØ li·ªáu.

    ‚úÖ Nghi√™n c·ª©u th√™m: ƒê·ªçc v·ªÅ bindings trong [t√†i li·ªáu kh√°i ni·ªám triggers v√† bindings c·ªßa Azure Functions](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings?WT.mc_id=academic-17441-jabenn&tabs=python).

    Ph·∫ßn `bindings` bao g·ªìm c·∫•u h√¨nh cho binding. C√°c gi√° tr·ªã ƒë√°ng ch√∫ √Ω l√†:

  * `"type": "eventHubTrigger"` - ƒëi·ªÅu n√†y cho bi·∫øt ch·ª©c nƒÉng c·∫ßn l·∫Øng nghe c√°c s·ª± ki·ªán t·ª´ Event Hub
  * `"name": "events"` - ƒë√¢y l√† t√™n tham s·ªë ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c s·ª± ki·ªán Event Hub. T√™n n√†y kh·ªõp v·ªõi t√™n tham s·ªë trong h√†m `main` trong m√£ Python.
  * `"direction": "in"` - ƒë√¢y l√† binding ƒë·∫ßu v√†o, d·ªØ li·ªáu t·ª´ event hub ƒëi v√†o ch·ª©c nƒÉng
  * `"connection": ""` - ƒëi·ªÅu n√†y x√°c ƒë·ªãnh t√™n c·ªßa thi·∫øt l·∫≠p ƒë·ªÉ ƒë·ªçc chu·ªói k·∫øt n·ªëi. Khi ch·∫°y c·ª•c b·ªô, ƒëi·ªÅu n√†y s·∫Ω ƒë·ªçc thi·∫øt l·∫≠p n√†y t·ª´ t·ªáp `local.settings.json`.

    > üíÅ Chu·ªói k·∫øt n·ªëi kh√¥ng th·ªÉ ƒë∆∞·ª£c l∆∞u tr·ªØ trong t·ªáp `function.json`, n√≥ ph·∫£i ƒë∆∞·ª£c ƒë·ªçc t·ª´ thi·∫øt l·∫≠p. ƒêi·ªÅu n√†y nh·∫±m ngƒÉn b·∫°n v√¥ t√¨nh l√†m l·ªô chu·ªói k·∫øt n·ªëi.

1. Do [l·ªói trong m·∫´u Azure Functions](https://github.com/Azure/azure-functions-templates/issues/1250), t·ªáp `function.json` c√≥ gi√° tr·ªã kh√¥ng ch√≠nh x√°c cho tr∆∞·ªùng `cardinality`. C·∫≠p nh·∫≠t tr∆∞·ªùng n√†y t·ª´ `many` th√†nh `one`:

    ```json
    "cardinality": "one",
    ```

1. C·∫≠p nh·∫≠t gi√° tr·ªã `"connection"` trong t·ªáp `function.json` ƒë·ªÉ tr·ªè ƒë·∫øn gi√° tr·ªã m·ªõi b·∫°n ƒë√£ th√™m v√†o t·ªáp `local.settings.json`:

    ```json
    "connection": "IOT_HUB_CONNECTION_STRING",
    ```

    > üíÅ Nh·ªõ r·∫±ng - ƒëi·ªÅu n√†y c·∫ßn tr·ªè ƒë·∫øn thi·∫øt l·∫≠p, kh√¥ng ch·ª©a chu·ªói k·∫øt n·ªëi th·ª±c t·∫ø.

1. Chu·ªói k·∫øt n·ªëi ch·ª©a gi√° tr·ªã `eventHubName`, v√¨ v·∫≠y gi√° tr·ªã n√†y trong t·ªáp `function.json` c·∫ßn ƒë∆∞·ª£c x√≥a. C·∫≠p nh·∫≠t gi√° tr·ªã n√†y th√†nh chu·ªói r·ªóng:

    ```json
    "eventHubName": "",
    ```

### Nhi·ªám v·ª• - ch·∫°y trigger s·ª± ki·ªán

1. ƒê·∫£m b·∫£o b·∫°n kh√¥ng ch·∫°y tr√¨nh gi√°m s√°t s·ª± ki·ªán IoT Hub. N·∫øu tr√¨nh n√†y ƒëang ch·∫°y c√πng l√∫c v·ªõi ·ª©ng d·ª•ng Functions, ·ª©ng d·ª•ng Functions s·∫Ω kh√¥ng th·ªÉ k·∫øt n·ªëi v√† ti√™u th·ª• s·ª± ki·ªán.

    > üíÅ Nhi·ªÅu ·ª©ng d·ª•ng c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi c√°c ƒëi·ªÉm cu·ªëi IoT Hub b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c *nh√≥m ng∆∞·ªùi ti√™u d√πng* kh√°c nhau. ƒêi·ªÅu n√†y s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p trong b√†i h·ªçc sau.

1. ƒê·ªÉ ch·∫°y ·ª©ng d·ª•ng Functions, ch·∫°y l·ªánh sau t·ª´ terminal c·ªßa VS Code:

    ```sh
    func start
    ```

    ·ª®ng d·ª•ng Functions s·∫Ω kh·ªüi ƒë·ªông v√† ph√°t hi·ªán ch·ª©c nƒÉng `iot-hub-trigger`. Sau ƒë√≥, n√≥ s·∫Ω x·ª≠ l√Ω b·∫•t k·ª≥ s·ª± ki·ªán n√†o ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn IoT Hub trong ng√†y qua.

    ```output
    (.venv) ‚ûú  soil-moisture-trigger func start
    Found Python version 3.9.1 (python3).
    
    Azure Functions Core Tools
    Core Tools Version:       3.0.3442 Commit hash: 6bfab24b2743f8421475d996402c398d2fe4a9e0  (64-bit)
    Function Runtime Version: 3.0.15417.0
    
    Functions:
    
            iot-hub-trigger: eventHubTrigger
    
    For detailed output, run func with --verbose flag.
    [2021-05-05T02:44:07.517Z] Worker process started and initialized.
    [2021-05-05T02:44:09.202Z] Executing 'Functions.iot-hub-trigger' (Reason='(null)', Id=802803a5-eae9-4401-a1f4-176631456ce4)
    [2021-05-05T02:44:09.205Z] Trigger Details: PartitionId: 0, Offset: 1011240-1011632, EnqueueTimeUtc: 2021-05-04T19:04:04.2030000Z-2021-05-04T19:04:04.3900000Z, SequenceNumber: 2546-2547, Count: 2
    [2021-05-05T02:44:09.352Z] Python EventHub trigger processed an event: {"soil_moisture":628}
    [2021-05-05T02:44:09.354Z] Python EventHub trigger processed an event: {"soil_moisture":624}
    [2021-05-05T02:44:09.395Z] Executed 'Functions.iot-hub-trigger' (Succeeded, Id=802803a5-eae9-4401-a1f4-176631456ce4, Duration=245ms)
    ```

    M·ªói l·∫ßn g·ªçi ch·ª©c nƒÉng s·∫Ω ƒë∆∞·ª£c bao quanh b·ªüi m·ªôt kh·ªëi `Executing 'Functions.iot-hub-trigger'`/`Executed 'Functions.iot-hub-trigger'` trong ƒë·∫ßu ra, v√¨ v·∫≠y b·∫°n c√≥ th·ªÉ th·∫•y c√≥ bao nhi√™u tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong m·ªói l·∫ßn g·ªçi ch·ª©c nƒÉng.

1. ƒê·∫£m b·∫£o thi·∫øt b·ªã IoT c·ªßa b·∫°n ƒëang ch·∫°y. B·∫°n s·∫Ω th·∫•y c√°c tin nh·∫Øn ƒë·ªô ·∫©m ƒë·∫•t m·ªõi xu·∫•t hi·ªán trong ·ª©ng d·ª•ng Functions.

1. D·ª´ng v√† kh·ªüi ƒë·ªông l·∫°i ·ª©ng d·ª•ng Functions. B·∫°n s·∫Ω th·∫•y r·∫±ng n√≥ s·∫Ω kh√¥ng x·ª≠ l√Ω l·∫°i c√°c tin nh·∫Øn tr∆∞·ªõc ƒë√≥, ch·ªâ x·ª≠ l√Ω c√°c tin nh·∫Øn m·ªõi.

> üíÅ VS Code c≈©ng h·ªó tr·ª£ g·ª° l·ªói ·ª©ng d·ª•ng Functions c·ªßa b·∫°n. B·∫°n c√≥ th·ªÉ ƒë·∫∑t ƒëi·ªÉm d·ª´ng b·∫±ng c√°ch nh·∫•p v√†o ƒë∆∞·ªùng vi·ªÅn b√™n c·∫°nh ƒë·∫ßu m·ªói d√≤ng m√£, ho·∫∑c ƒë·∫∑t con tr·ªè tr√™n m·ªôt d√≤ng m√£ v√† ch·ªçn *Run -> Toggle breakpoint*, ho·∫∑c nh·∫•n `F9`. B·∫°n c√≥ th·ªÉ kh·ªüi ch·∫°y tr√¨nh g·ª° l·ªói b·∫±ng c√°ch ch·ªçn *Run -> Start debugging*, nh·∫•n `F5`, ho·∫∑c ch·ªçn b·∫£ng *Run and debug* v√† ch·ªçn n√∫t **Start debugging**. B·∫±ng c√°ch n√†y, b·∫°n c√≥ th·ªÉ xem chi ti·∫øt c√°c s·ª± ki·ªán ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.

#### X·ª≠ l√Ω s·ª± c·ªë

* N·∫øu b·∫°n g·∫∑p l·ªói sau:

    ```output
    The listener for function 'Functions.iot-hub-trigger' was unable to start. Microsoft.WindowsAzure.Storage: Connection refused. System.Net.Http: Connection refused. System.Private.CoreLib: Connection refused.
    ```

    Ki·ªÉm tra Azurite ƒëang ch·∫°y v√† b·∫°n ƒë√£ ƒë·∫∑t `AzureWebJobsStorage` trong t·ªáp `local.settings.json` th√†nh `UseDevelopmentStorage=true`.

* N·∫øu b·∫°n g·∫∑p l·ªói sau:

    ```output
    System.Private.CoreLib: Exception while executing function: Functions.iot-hub-trigger. System.Private.CoreLib: Result: Failure Exception: AttributeError: 'list' object has no attribute 'get_body'
    ```

    Ki·ªÉm tra r·∫±ng b·∫°n ƒë√£ ƒë·∫∑t `cardinality` trong t·ªáp `function.json` th√†nh `one`.

* N·∫øu b·∫°n g·∫∑p l·ªói sau:

    ```output
    Azure.Messaging.EventHubs: The path to an Event Hub may be specified as part of the connection string or as a separate value, but not both.  Please verify that your connection string does not have the `EntityPath` token if you are passing an explicit Event Hub name. (Parameter 'connectionString').
    ```

    Ki·ªÉm tra r·∫±ng b·∫°n ƒë√£ ƒë·∫∑t `eventHubName` trong t·ªáp `function.json` th√†nh chu·ªói r·ªóng.

## G·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp t·ª´ m√£ serverless

Cho ƒë·∫øn nay, ·ª©ng d·ª•ng Functions c·ªßa b·∫°n ƒëang l·∫Øng nghe c√°c tin nh·∫Øn t·ª´ IoT Hub b·∫±ng ƒëi·ªÉm cu·ªëi t∆∞∆°ng th√≠ch Event Hub. B√¢y gi·ªù b·∫°n c·∫ßn g·ª≠i l·ªánh ƒë·∫øn thi·∫øt b·ªã IoT. ƒêi·ªÅu n√†y ƒë∆∞·ª£c th·ª±c hi·ªán b·∫±ng c√°ch s·ª≠ d·ª•ng m·ªôt k·∫øt n·ªëi kh√°c ƒë·∫øn IoT Hub th√¥ng qua *Registry Manager*. Registry Manager l√† m·ªôt c√¥ng c·ª• cho ph√©p b·∫°n xem c√°c thi·∫øt b·ªã n√†o ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω v·ªõi IoT Hub, v√† giao ti·∫øp v·ªõi c√°c thi·∫øt b·ªã ƒë√≥ b·∫±ng c√°ch g·ª≠i tin nh·∫Øn t·ª´ ƒë√°m m√¢y ƒë·∫øn thi·∫øt b·ªã, y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp ho·∫∑c c·∫≠p nh·∫≠t device twin. B·∫°n c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng n√≥ ƒë·ªÉ ƒëƒÉng k√Ω, c·∫≠p nh·∫≠t ho·∫∑c x√≥a thi·∫øt b·ªã IoT kh·ªèi IoT Hub.

ƒê·ªÉ k·∫øt n·ªëi v·ªõi Registry Manager, b·∫°n c·∫ßn m·ªôt chu·ªói k·∫øt n·ªëi.

### Nhi·ªám v·ª• - l·∫•y chu·ªói k·∫øt n·ªëi Registry Manager

1. ƒê·ªÉ l·∫•y chu·ªói k·∫øt n·ªëi, ch·∫°y l·ªánh sau:

    ```sh
    az iot hub connection-string show --policy-name service \
                                      --output table \
                                      --hub-name <hub_name>
    ```

    Thay `<hub_name>` b·∫±ng t√™n b·∫°n ƒë√£ s·ª≠ d·ª•ng cho IoT Hub.

    Chu·ªói k·∫øt n·ªëi ƒë∆∞·ª£c y√™u c·∫ßu cho ch√≠nh s√°ch *ServiceConnect* b·∫±ng c√°ch s·ª≠ d·ª•ng tham s·ªë `--policy-name service`. Khi b·∫°n y√™u c·∫ßu m·ªôt chu·ªói k·∫øt n·ªëi, b·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh quy·ªÅn m√† chu·ªói k·∫øt n·ªëi ƒë√≥ s·∫Ω cho ph√©p. Ch√≠nh s√°ch ServiceConnect cho ph√©p m√£ c·ªßa b·∫°n k·∫øt n·ªëi v√† g·ª≠i tin nh·∫Øn ƒë·∫øn c√°c thi·∫øt b·ªã IoT.

    ‚úÖ Nghi√™n c·ª©u th√™m: ƒê·ªçc v·ªÅ c√°c ch√≠nh s√°ch kh√°c nhau trong [t√†i li·ªáu quy·ªÅn IoT Hub](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-security#iot-hub-permissions?WT.mc_id=academic-17441-jabenn)

1. Trong VS Code, m·ªü t·ªáp `local.settings.json`. Th√™m gi√° tr·ªã sau v√†o b√™n trong ph·∫ßn `Values`:

    ```json
    "REGISTRY_MANAGER_CONNECTION_STRING": "<connection string>"
    ```

    Thay `<connection string>` b·∫±ng gi√° tr·ªã t·ª´ b∆∞·ªõc tr∆∞·ªõc. B·∫°n s·∫Ω c·∫ßn th√™m d·∫•u ph·∫©y sau d√≤ng tr√™n ƒë·ªÉ ƒë·∫£m b·∫£o JSON h·ª£p l·ªá.

### Nhi·ªám v·ª• - g·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp ƒë·∫øn thi·∫øt b·ªã

1. SDK cho Registry Manager c√≥ s·∫µn th√¥ng qua g√≥i Pip. Th√™m d√≤ng sau v√†o t·ªáp `requirements.txt` ƒë·ªÉ th√™m ph·ª• thu·ªôc v√†o g√≥i n√†y:

    ```sh
    azure-iot-hub
    ```

1. ƒê·∫£m b·∫£o terminal c·ªßa VS Code ƒë√£ k√≠ch ho·∫°t m√¥i tr∆∞·ªùng ·∫£o, v√† ch·∫°y l·ªánh sau ƒë·ªÉ c√†i ƒë·∫∑t c√°c g√≥i Pip:

    ```sh
    pip install -r requirements.txt
    ```

1. Th√™m c√°c import sau v√†o t·ªáp `__init__.py`:

    ```python
    import json
    import os
    from azure.iot.hub import IoTHubRegistryManager
    from azure.iot.hub.models import CloudToDeviceMethod
    ```

    ƒêi·ªÅu n√†y import m·ªôt s·ªë th∆∞ vi·ªán h·ªá th·ªëng, c≈©ng nh∆∞ c√°c th∆∞ vi·ªán ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi Registry Manager v√† g·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp.

1. X√≥a m√£ b√™n trong ph∆∞∆°ng th·ª©c `main`, nh∆∞ng gi·ªØ l·∫°i ph∆∞∆°ng th·ª©c n√†y.

1. Trong ph∆∞∆°ng th·ª©c `main`, th√™m m√£ sau:

    ```python
    body = json.loads(event.get_body().decode('utf-8'))
    device_id = event.iothub_metadata['connection-device-id']

    logging.info(f'Received message: {body} from {device_id}')
    ```

    M√£ n√†y tr√≠ch xu·∫•t n·ªôi dung c·ªßa s·ª± ki·ªán ch·ª©a tin nh·∫Øn JSON ƒë∆∞·ª£c g·ª≠i b·ªüi thi·∫øt b·ªã IoT.

    Sau ƒë√≥, n√≥ l·∫•y ID thi·∫øt b·ªã t·ª´ c√°c ch√∫ th√≠ch ƒë∆∞·ª£c truy·ªÅn c√πng v·ªõi tin nh·∫Øn. N·ªôi dung c·ªßa s·ª± ki·ªán ch·ª©a tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i d∆∞·ªõi d·∫°ng telemetry, dictionary `iothub_metadata` ch·ª©a c√°c thu·ªôc t√≠nh ƒë∆∞·ª£c ƒë·∫∑t b·ªüi IoT Hub nh∆∞ ID thi·∫øt b·ªã c·ªßa ng∆∞·ªùi g·ª≠i v√† th·ªùi gian tin nh·∫Øn ƒë∆∞·ª£c g·ª≠i.

    Th√¥ng tin n√†y sau ƒë√≥ ƒë∆∞·ª£c ghi l·∫°i. B·∫°n s·∫Ω th·∫•y vi·ªác ghi n√†y trong terminal khi ch·∫°y ·ª©ng d·ª•ng Function c·ª•c b·ªô.

1. B√™n d∆∞·ªõi ƒëo·∫°n m√£ n√†y, th√™m m√£ sau:

    ```python
    soil_moisture = body['soil_moisture']

    if soil_moisture > 450:
        direct_method = CloudToDeviceMethod(method_name='relay_on', payload='{}')
    else:
        direct_method = CloudToDeviceMethod(method_name='relay_off', payload='{}')
    ```

    M√£ n√†y l·∫•y ƒë·ªô ·∫©m ƒë·∫•t t·ª´ tin nh·∫Øn. Sau ƒë√≥, n√≥ ki·ªÉm tra ƒë·ªô ·∫©m ƒë·∫•t, v√† t√πy thu·ªôc v√†o gi√° tr·ªã, t·∫°o m·ªôt l·ªõp tr·ª£ gi√∫p cho y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp cho ph∆∞∆°ng th·ª©c `relay_on` ho·∫∑c `relay_off`. Y√™u c·∫ßu ph∆∞∆°ng th·ª©c kh√¥ng c·∫ßn payload, v√¨ v·∫≠y m·ªôt t√†i li·ªáu JSON r·ªóng ƒë∆∞·ª£c g·ª≠i.

1. B√™n d∆∞·ªõi ƒëo·∫°n m√£ n√†y, th√™m m√£ sau:

    ```python
    logging.info(f'Sending direct method request for {direct_method.method_name} for device {device_id}')

    registry_manager_connection_string = os.environ['REGISTRY_MANAGER_CONNECTION_STRING']
    registry_manager = IoTHubRegistryManager(registry_manager_connection_string)
    ```
ƒêo·∫°n m√£ n√†y t·∫£i `REGISTRY_MANAGER_CONNECTION_STRING` t·ª´ t·ªáp `local.settings.json`. C√°c gi√° tr·ªã trong t·ªáp n√†y ƒë∆∞·ª£c cung c·∫•p d∆∞·ªõi d·∫°ng bi·∫øn m√¥i tr∆∞·ªùng v√† c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªçc b·∫±ng h√†m `os.environ`, m·ªôt h√†m tr·∫£ v·ªÅ m·ªôt t·ª´ ƒëi·ªÉn ch·ª©a t·∫•t c·∫£ c√°c bi·∫øn m√¥i tr∆∞·ªùng.

> üíÅ Khi ƒëo·∫°n m√£ n√†y ƒë∆∞·ª£c tri·ªÉn khai l√™n ƒë√°m m√¢y, c√°c gi√° tr·ªã trong t·ªáp `local.settings.json` s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p th√†nh *Application Settings* v√† c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªçc t·ª´ c√°c bi·∫øn m√¥i tr∆∞·ªùng.

ƒêo·∫°n m√£ sau ƒë√≥ t·∫°o m·ªôt th·ªÉ hi·ªán c·ªßa l·ªõp h·ªó tr·ª£ Registry Manager b·∫±ng chu·ªói k·∫øt n·ªëi.

1. Th√™m ƒëo·∫°n m√£ sau v√†o b√™n d∆∞·ªõi:

    ```python
    registry_manager.invoke_device_method(device_id, direct_method)

    logging.info('Direct method request sent!')
    ```

    ƒêo·∫°n m√£ n√†y y√™u c·∫ßu registry manager g·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp ƒë·∫øn thi·∫øt b·ªã ƒë√£ g·ª≠i d·ªØ li·ªáu telemetry.

    > üíÅ Trong c√°c phi√™n b·∫£n ·ª©ng d·ª•ng b·∫°n ƒë√£ t·∫°o ·ªü c√°c b√†i h·ªçc tr∆∞·ªõc s·ª≠ d·ª•ng MQTT, c√°c l·ªánh ƒëi·ªÅu khi·ªÉn relay ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t·∫•t c·∫£ c√°c thi·∫øt b·ªã. ƒêo·∫°n m√£ gi·∫£ ƒë·ªãnh r·∫±ng b·∫°n ch·ªâ c√≥ m·ªôt thi·∫øt b·ªã. Phi√™n b·∫£n m√£ n√†y g·ª≠i y√™u c·∫ßu ph∆∞∆°ng th·ª©c ƒë·∫øn m·ªôt thi·∫øt b·ªã duy nh·∫•t, v√¨ v·∫≠y n√≥ s·∫Ω ho·∫°t ƒë·ªông n·∫øu b·∫°n c√≥ nhi·ªÅu thi·∫øt l·∫≠p c·∫£m bi·∫øn ƒë·ªô ·∫©m v√† relay, g·ª≠i ƒë√∫ng y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp ƒë·∫øn ƒë√∫ng thi·∫øt b·ªã.

1. Ch·∫°y ·ª©ng d·ª•ng Functions v√† ƒë·∫£m b·∫£o thi·∫øt b·ªã IoT c·ªßa b·∫°n ƒëang g·ª≠i d·ªØ li·ªáu. B·∫°n s·∫Ω th·∫•y c√°c tin nh·∫Øn ƒë∆∞·ª£c x·ª≠ l√Ω v√† c√°c y√™u c·∫ßu ph∆∞∆°ng th·ª©c tr·ª±c ti·∫øp ƒë∆∞·ª£c g·ª≠i ƒëi. Di chuy·ªÉn c·∫£m bi·∫øn ƒë·ªô ·∫©m ƒë·∫•t v√†o v√† ra kh·ªèi ƒë·∫•t ƒë·ªÉ th·∫•y gi√° tr·ªã thay ƒë·ªïi v√† relay b·∫≠t/t·∫Øt.

> üíÅ B·∫°n c√≥ th·ªÉ t√¨m th·∫•y ƒëo·∫°n m√£ n√†y trong th∆∞ m·ª•c [code/functions](../../../../../2-farm/lessons/5-migrate-application-to-the-cloud/code/functions).

## Tri·ªÉn khai m√£ serverless c·ªßa b·∫°n l√™n ƒë√°m m√¢y

M√£ c·ªßa b·∫°n hi·ªán ƒëang ho·∫°t ƒë·ªông c·ª•c b·ªô, v√¨ v·∫≠y b∆∞·ªõc ti·∫øp theo l√† tri·ªÉn khai ·ª©ng d·ª•ng Functions l√™n ƒë√°m m√¢y.

### Nhi·ªám v·ª• - t·∫°o t√†i nguy√™n tr√™n ƒë√°m m√¢y

·ª®ng d·ª•ng Functions c·ªßa b·∫°n c·∫ßn ƒë∆∞·ª£c tri·ªÉn khai v√†o m·ªôt t√†i nguy√™n Functions App trong Azure, n·∫±m trong Resource Group m√† b·∫°n ƒë√£ t·∫°o cho IoT Hub. B·∫°n c≈©ng s·∫Ω c·∫ßn m·ªôt Storage Account ƒë∆∞·ª£c t·∫°o trong Azure ƒë·ªÉ thay th·∫ø tr√¨nh gi·∫£ l·∫≠p ƒëang ch·∫°y c·ª•c b·ªô.

1. Ch·∫°y l·ªánh sau ƒë·ªÉ t·∫°o m·ªôt storage account:

    ```sh
    az storage account create --resource-group soil-moisture-sensor \
                              --sku Standard_LRS \
                              --name <storage_name> 
    ```

    Thay th·∫ø `<storage_name>` b·∫±ng m·ªôt t√™n cho storage account c·ªßa b·∫°n. T√™n n√†y c·∫ßn ph·∫£i l√† duy nh·∫•t tr√™n to√†n c·∫ßu v√¨ n√≥ l√† m·ªôt ph·∫ßn c·ªßa URL ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ truy c·∫≠p storage account. B·∫°n ch·ªâ c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c ch·ªØ c√°i th∆∞·ªùng v√† s·ªë cho t√™n n√†y, kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng k√Ω t·ª± kh√°c, v√† n√≥ b·ªã gi·ªõi h·∫°n ·ªü 24 k√Ω t·ª±. S·ª≠ d·ª•ng m·ªôt c√°i g√¨ ƒë√≥ nh∆∞ `sms` v√† th√™m m·ªôt ƒë·ªãnh danh duy nh·∫•t ·ªü cu·ªëi, nh∆∞ m·ªôt v√†i t·ª´ ng·∫´u nhi√™n ho·∫∑c t√™n c·ªßa b·∫°n.

    T√πy ch·ªçn `--sku Standard_LRS` ch·ªçn c·∫•p gi√°, ch·ªçn t√†i kho·∫£n ƒëa nƒÉng c√≥ chi ph√≠ th·∫•p nh·∫•t. Kh√¥ng c√≥ c·∫•p mi·ªÖn ph√≠ cho storage, v√† b·∫°n tr·∫£ ti·ªÅn cho nh·ªØng g√¨ b·∫°n s·ª≠ d·ª•ng. Chi ph√≠ t∆∞∆°ng ƒë·ªëi th·∫•p, v·ªõi lo·∫°i storage ƒë·∫Øt nh·∫•t d∆∞·ªõi 0,05 USD m·ªói th√°ng cho m·ªói gigabyte ƒë∆∞·ª£c l∆∞u tr·ªØ.

    ‚úÖ T√¨m hi·ªÉu th√™m v·ªÅ gi√° c·∫£ tr√™n [trang gi√° Azure Storage Account](https://azure.microsoft.com/pricing/details/storage/?WT.mc_id=academic-17441-jabenn)

1. Ch·∫°y l·ªánh sau ƒë·ªÉ t·∫°o m·ªôt Function App:

    ```sh
    az functionapp create --resource-group soil-moisture-sensor \
                          --runtime python \
                          --functions-version 3 \
                          --os-type Linux \
                          --consumption-plan-location <location> \
                          --storage-account <storage_name> \
                          --name <functions_app_name>
    ```

    Thay th·∫ø `<location>` b·∫±ng v·ªã tr√≠ b·∫°n ƒë√£ s·ª≠ d·ª•ng khi t·∫°o Resource Group trong b√†i h·ªçc tr∆∞·ªõc.

    Thay th·∫ø `<storage_name>` b·∫±ng t√™n c·ªßa storage account b·∫°n ƒë√£ t·∫°o ·ªü b∆∞·ªõc tr∆∞·ªõc.

    Thay th·∫ø `<functions_app_name>` b·∫±ng m·ªôt t√™n duy nh·∫•t cho Functions App c·ªßa b·∫°n. T√™n n√†y c·∫ßn ph·∫£i l√† duy nh·∫•t tr√™n to√†n c·∫ßu v√¨ n√≥ l√† m·ªôt ph·∫ßn c·ªßa URL ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ truy c·∫≠p Functions App. S·ª≠ d·ª•ng m·ªôt c√°i g√¨ ƒë√≥ nh∆∞ `soil-moisture-sensor-` v√† th√™m m·ªôt ƒë·ªãnh danh duy nh·∫•t ·ªü cu·ªëi, nh∆∞ m·ªôt v√†i t·ª´ ng·∫´u nhi√™n ho·∫∑c t√™n c·ªßa b·∫°n.

    T√πy ch·ªçn `--functions-version 3` thi·∫øt l·∫≠p phi√™n b·∫£n Azure Functions ƒë·ªÉ s·ª≠ d·ª•ng. Phi√™n b·∫£n 3 l√† phi√™n b·∫£n m·ªõi nh·∫•t.

    T√πy ch·ªçn `--os-type Linux` y√™u c·∫ßu runtime Functions s·ª≠ d·ª•ng Linux l√†m h·ªá ƒëi·ªÅu h√†nh ƒë·ªÉ l∆∞u tr·ªØ c√°c ch·ª©c nƒÉng n√†y. Functions c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n Linux ho·∫∑c Windows, t√πy thu·ªôc v√†o ng√¥n ng·ªØ l·∫≠p tr√¨nh ƒë∆∞·ª£c s·ª≠ d·ª•ng. C√°c ·ª©ng d·ª•ng Python ch·ªâ ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n Linux.

### Nhi·ªám v·ª• - t·∫£i l√™n Application Settings c·ªßa b·∫°n

Khi b·∫°n ph√°t tri·ªÉn ·ª©ng d·ª•ng Functions, b·∫°n ƒë√£ l∆∞u m·ªôt s·ªë c√†i ƒë·∫∑t trong t·ªáp `local.settings.json` cho c√°c chu·ªói k·∫øt n·ªëi c·ªßa IoT Hub. Nh·ªØng c√†i ƒë·∫∑t n√†y c·∫ßn ƒë∆∞·ª£c ghi v√†o Application Settings trong Function App c·ªßa b·∫°n tr√™n Azure ƒë·ªÉ ch√∫ng c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi m√£ c·ªßa b·∫°n.

> üéì T·ªáp `local.settings.json` ch·ªâ d√†nh cho c√°c c√†i ƒë·∫∑t ph√°t tri·ªÉn c·ª•c b·ªô v√† kh√¥ng n√™n ƒë∆∞·ª£c ki·ªÉm tra v√†o h·ªá th·ªëng ki·ªÉm so√°t m√£ ngu·ªìn, ch·∫≥ng h·∫°n nh∆∞ GitHub. Khi ƒë∆∞·ª£c tri·ªÉn khai l√™n ƒë√°m m√¢y, Application Settings s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng. Application Settings l√† c√°c c·∫∑p key/value ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n ƒë√°m m√¢y v√† ƒë∆∞·ª£c ƒë·ªçc t·ª´ c√°c bi·∫øn m√¥i tr∆∞·ªùng trong m√£ c·ªßa b·∫°n ho·∫∑c b·ªüi runtime khi k·∫øt n·ªëi m√£ c·ªßa b·∫°n v·ªõi IoT Hub.

1. Ch·∫°y l·ªánh sau ƒë·ªÉ thi·∫øt l·∫≠p c√†i ƒë·∫∑t `IOT_HUB_CONNECTION_STRING` trong Application Settings c·ªßa Functions App:

    ```sh
    az functionapp config appsettings set --resource-group soil-moisture-sensor \
                                          --name <functions_app_name> \
                                          --settings "IOT_HUB_CONNECTION_STRING=<connection string>"
    ```

    Thay th·∫ø `<functions_app_name>` b·∫±ng t√™n b·∫°n ƒë√£ s·ª≠ d·ª•ng cho Functions App c·ªßa m√¨nh.

    Thay th·∫ø `<connection string>` b·∫±ng gi√° tr·ªã c·ªßa `IOT_HUB_CONNECTION_STRING` t·ª´ t·ªáp `local.settings.json` c·ªßa b·∫°n.

1. L·∫∑p l·∫°i b∆∞·ªõc tr√™n, nh∆∞ng thi·∫øt l·∫≠p gi√° tr·ªã c·ªßa `REGISTRY_MANAGER_CONNECTION_STRING` th√†nh gi√° tr·ªã t∆∞∆°ng ·ª©ng t·ª´ t·ªáp `local.settings.json` c·ªßa b·∫°n.

Khi b·∫°n ch·∫°y c√°c l·ªánh n√†y, ch√∫ng c≈©ng s·∫Ω xu·∫•t ra danh s√°ch t·∫•t c·∫£ Application Settings cho Functions App. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng danh s√°ch n√†y ƒë·ªÉ ki·ªÉm tra r·∫±ng c√°c gi√° tr·ªã c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ch√≠nh x√°c.

> üíÅ B·∫°n s·∫Ω th·∫•y m·ªôt gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p cho `AzureWebJobsStorage`. Trong t·ªáp `local.settings.json` c·ªßa b·∫°n, gi√° tr·ªã n√†y ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng tr√¨nh gi·∫£ l·∫≠p storage c·ª•c b·ªô. Khi b·∫°n t·∫°o Functions App, b·∫°n truy·ªÅn storage account l√†m tham s·ªë, v√† gi√° tr·ªã n√†y ƒë∆∞·ª£c thi·∫øt l·∫≠p t·ª± ƒë·ªông trong c√†i ƒë·∫∑t n√†y.

### Nhi·ªám v·ª• - tri·ªÉn khai Functions App c·ªßa b·∫°n l√™n ƒë√°m m√¢y

B√¢y gi·ªù Functions App ƒë√£ s·∫µn s√†ng, m√£ c·ªßa b·∫°n c√≥ th·ªÉ ƒë∆∞·ª£c tri·ªÉn khai.

1. Ch·∫°y l·ªánh sau t·ª´ terminal c·ªßa VS Code ƒë·ªÉ xu·∫•t b·∫£n Functions App c·ªßa b·∫°n:

    ```sh
    func azure functionapp publish <functions_app_name>
    ```

    Thay th·∫ø `<functions_app_name>` b·∫±ng t√™n b·∫°n ƒë√£ s·ª≠ d·ª•ng cho Functions App c·ªßa m√¨nh.

M√£ s·∫Ω ƒë∆∞·ª£c ƒë√≥ng g√≥i v√† g·ª≠i ƒë·∫øn Functions App, n∆°i n√≥ s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai v√† kh·ªüi ƒë·ªông. S·∫Ω c√≥ r·∫•t nhi·ªÅu ƒë·∫ßu ra tr√™n console, k·∫øt th√∫c b·∫±ng x√°c nh·∫≠n tri·ªÉn khai v√† danh s√°ch c√°c ch·ª©c nƒÉng ƒë√£ tri·ªÉn khai. Trong tr∆∞·ªùng h·ª£p n√†y, danh s√°ch s·∫Ω ch·ªâ ch·ª©a trigger.

```output
Deployment successful.
Remote build succeeded!
Syncing triggers...
Functions in soil-moisture-sensor:
    iot-hub-trigger - [eventHubTrigger]
```

ƒê·∫£m b·∫£o thi·∫øt b·ªã IoT c·ªßa b·∫°n ƒëang ch·∫°y. Thay ƒë·ªïi m·ª©c ƒë·ªô ·∫©m b·∫±ng c√°ch ƒëi·ªÅu ch·ªânh ƒë·ªô ·∫©m ƒë·∫•t ho·∫∑c di chuy·ªÉn c·∫£m bi·∫øn v√†o v√† ra kh·ªèi ƒë·∫•t. B·∫°n s·∫Ω th·∫•y relay b·∫≠t v√† t·∫Øt khi ƒë·ªô ·∫©m ƒë·∫•t thay ƒë·ªïi.

---

## üöÄ Th·ª≠ th√°ch

Trong b√†i h·ªçc tr∆∞·ªõc, b·∫°n ƒë√£ qu·∫£n l√Ω th·ªùi gian cho relay b·∫±ng c√°ch h·ªßy ƒëƒÉng k√Ω nh·∫≠n tin nh·∫Øn MQTT trong khi relay ƒëang b·∫≠t v√† trong m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn sau khi n√≥ t·∫Øt. B·∫°n kh√¥ng th·ªÉ s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p n√†y ·ªü ƒë√¢y - b·∫°n kh√¥ng th·ªÉ h·ªßy ƒëƒÉng k√Ω trigger IoT Hub c·ªßa m√¨nh.

H√£y suy nghƒ© v·ªÅ c√°c c√°ch kh√°c nhau m√† b·∫°n c√≥ th·ªÉ x·ª≠ l√Ω ƒëi·ªÅu n√†y trong Functions App c·ªßa m√¨nh.

## C√¢u h·ªèi sau b√†i gi·∫£ng

[C√¢u h·ªèi sau b√†i gi·∫£ng](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/18)

## √în t·∫≠p & T·ª± h·ªçc

* T√¨m hi·ªÉu v·ªÅ ƒëi·ªán to√°n serverless tr√™n [trang Wikipedia v·ªÅ Serverless Computing](https://wikipedia.org/wiki/Serverless_computing)
* ƒê·ªçc v·ªÅ vi·ªác s·ª≠ d·ª•ng serverless trong Azure bao g·ªìm m·ªôt s·ªë v√≠ d·ª• kh√°c tr√™n [b√†i vi·∫øt blog Azure "Go serverless for your IoT needs"](https://azure.microsoft.com/blog/go-serverless-for-your-iot-needs/?WT.mc_id=academic-17441-jabenn)
* T√¨m hi·ªÉu th√™m v·ªÅ Azure Functions tr√™n [k√™nh YouTube Azure Functions](https://www.youtube.com/c/AzureFunctions)

## B√†i t·∫≠p

[Th√™m ƒëi·ªÅu khi·ªÉn relay th·ªß c√¥ng](assignment.md)

---

**Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám**:  
T√†i li·ªáu n√†y ƒë√£ ƒë∆∞·ª£c d·ªãch b·∫±ng d·ªãch v·ª• d·ªãch thu·∫≠t AI [Co-op Translator](https://github.com/Azure/co-op-translator). M·∫∑c d√π ch√∫ng t√¥i c·ªë g·∫Øng ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c, xin l∆∞u √Ω r·∫±ng c√°c b·∫£n d·ªãch t·ª± ƒë·ªông c√≥ th·ªÉ ch·ª©a l·ªói ho·∫∑c kh√¥ng ch√≠nh x√°c. T√†i li·ªáu g·ªëc b·∫±ng ng√¥n ng·ªØ b·∫£n ƒë·ªãa n√™n ƒë∆∞·ª£c coi l√† ngu·ªìn th√¥ng tin ch√≠nh th·ª©c. ƒê·ªëi v·ªõi c√°c th√¥ng tin quan tr·ªçng, n√™n s·ª≠ d·ª•ng d·ªãch v·ª• d·ªãch thu·∫≠t chuy√™n nghi·ªáp t·ª´ con ng∆∞·ªùi. Ch√∫ng t√¥i kh√¥ng ch·ªãu tr√°ch nhi·ªám v·ªÅ b·∫•t k·ª≥ s·ª± hi·ªÉu l·∫ßm ho·∫∑c di·ªÖn gi·∫£i sai n√†o ph√°t sinh t·ª´ vi·ªác s·ª≠ d·ª•ng b·∫£n d·ªãch n√†y.