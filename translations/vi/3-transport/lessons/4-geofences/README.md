<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "078ae664c7b686bf069545e9a5fc95b2",
  "translation_date": "2025-08-27T23:54:27+00:00",
  "source_file": "3-transport/lessons/4-geofences/README.md",
  "language_code": "vi"
}
-->
# HÃ ng rÃ o Ä‘á»‹a lÃ½

![Tá»•ng quan bÃ i há»c dÆ°á»›i dáº¡ng sketchnote](../../../../../translated_images/lesson-14.63980c5150ae3c153e770fb71d044c1845dce79248d86bed9fc525adf3ede73c.vi.jpg)

> Sketchnote bá»Ÿi [Nitya Narasimhan](https://github.com/nitya). Nháº¥n vÃ o hÃ¬nh áº£nh Ä‘á»ƒ xem phiÃªn báº£n lá»›n hÆ¡n.

Video nÃ y cung cáº¥p tá»•ng quan vá» hÃ ng rÃ o Ä‘á»‹a lÃ½ vÃ  cÃ¡ch sá»­ dá»¥ng chÃºng trong Azure Maps, cÃ¡c chá»§ Ä‘á» sáº½ Ä‘Æ°á»£c Ä‘á» cáº­p trong bÃ i há»c nÃ y:

[![HÃ ng rÃ o Ä‘á»‹a lÃ½ vá»›i Azure Maps tá»« chÆ°Æ¡ng trÃ¬nh Microsoft Developer IoT](https://img.youtube.com/vi/nsrgYhaYNVY/0.jpg)](https://www.youtube.com/watch?v=nsrgYhaYNVY)

> ğŸ¥ Nháº¥n vÃ o hÃ¬nh áº£nh trÃªn Ä‘á»ƒ xem video

## CÃ¢u há»i trÆ°á»›c bÃ i há»c

[CÃ¢u há»i trÆ°á»›c bÃ i há»c](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/27)

## Giá»›i thiá»‡u

Trong 3 bÃ i há»c trÆ°á»›c, báº¡n Ä‘Ã£ sá»­ dá»¥ng IoT Ä‘á»ƒ Ä‘á»‹nh vá»‹ cÃ¡c xe táº£i chá»Ÿ nÃ´ng sáº£n tá»« trang tráº¡i cá»§a báº¡n Ä‘áº¿n trung tÃ¢m xá»­ lÃ½. Báº¡n Ä‘Ã£ thu tháº­p dá»¯ liá»‡u GPS, gá»­i lÃªn Ä‘Ã¡m mÃ¢y Ä‘á»ƒ lÆ°u trá»¯ vÃ  hiá»ƒn thá»‹ trÃªn báº£n Ä‘á»“. BÆ°á»›c tiáº¿p theo Ä‘á»ƒ tÄƒng hiá»‡u quáº£ chuá»—i cung á»©ng cá»§a báº¡n lÃ  nháº­n thÃ´ng bÃ¡o khi má»™t xe táº£i sáº¯p Ä‘áº¿n trung tÃ¢m xá»­ lÃ½, Ä‘á»ƒ Ä‘á»™i ngÅ© cáº§n thiáº¿t cÃ³ thá»ƒ sáºµn sÃ ng vá»›i xe nÃ¢ng vÃ  cÃ¡c thiáº¿t bá»‹ khÃ¡c ngay khi xe Ä‘áº¿n. Báº±ng cÃ¡ch nÃ y, há» cÃ³ thá»ƒ dá»¡ hÃ ng nhanh chÃ³ng vÃ  báº¡n khÃ´ng pháº£i tráº£ tiá»n cho xe táº£i vÃ  tÃ i xáº¿ Ä‘á»ƒ chá» Ä‘á»£i.

Trong bÃ i há»c nÃ y, báº¡n sáº½ tÃ¬m hiá»ƒu vá» hÃ ng rÃ o Ä‘á»‹a lÃ½ - cÃ¡c khu vá»±c Ä‘á»‹a lÃ½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh nhÆ° má»™t khu vá»±c trong pháº¡m vi lÃ¡i xe 2km tá»« trung tÃ¢m xá»­ lÃ½, vÃ  cÃ¡ch kiá»ƒm tra xem tá»a Ä‘á»™ GPS cÃ³ náº±m trong hay ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½, Ä‘á»ƒ báº¡n cÃ³ thá»ƒ biáº¿t cáº£m biáº¿n GPS cá»§a mÃ¬nh Ä‘Ã£ Ä‘áº¿n hay rá»i khá»i khu vá»±c.

Trong bÃ i há»c nÃ y, chÃºng ta sáº½ Ä‘á» cáº­p Ä‘áº¿n:

* [HÃ ng rÃ o Ä‘á»‹a lÃ½ lÃ  gÃ¬](../../../../../3-transport/lessons/4-geofences)
* [Äá»‹nh nghÄ©a hÃ ng rÃ o Ä‘á»‹a lÃ½](../../../../../3-transport/lessons/4-geofences)
* [Kiá»ƒm tra Ä‘iá»ƒm so vá»›i hÃ ng rÃ o Ä‘á»‹a lÃ½](../../../../../3-transport/lessons/4-geofences)
* [Sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½ tá»« mÃ£ serverless](../../../../../3-transport/lessons/4-geofences)

> ğŸ—‘ ÄÃ¢y lÃ  bÃ i há»c cuá»‘i cÃ¹ng trong dá»± Ã¡n nÃ y, vÃ¬ váº­y sau khi hoÃ n thÃ nh bÃ i há»c vÃ  bÃ i táº­p, Ä‘á»«ng quÃªn dá»n dáº¹p cÃ¡c dá»‹ch vá»¥ Ä‘Ã¡m mÃ¢y cá»§a báº¡n. Báº¡n sáº½ cáº§n cÃ¡c dá»‹ch vá»¥ nÃ y Ä‘á»ƒ hoÃ n thÃ nh bÃ i táº­p, vÃ¬ váº­y hÃ£y Ä‘áº£m báº£o hoÃ n thÃ nh trÆ°á»›c.
>
> Tham kháº£o [hÆ°á»›ng dáº«n dá»n dáº¹p dá»± Ã¡n cá»§a báº¡n](../../../clean-up.md) náº¿u cáº§n hÆ°á»›ng dáº«n cÃ¡ch thá»±c hiá»‡n.

## HÃ ng rÃ o Ä‘á»‹a lÃ½ lÃ  gÃ¬

HÃ ng rÃ o Ä‘á»‹a lÃ½ lÃ  má»™t ranh giá»›i áº£o cho má»™t khu vá»±c Ä‘á»‹a lÃ½ thá»±c táº¿. HÃ ng rÃ o Ä‘á»‹a lÃ½ cÃ³ thá»ƒ lÃ  cÃ¡c vÃ²ng trÃ²n Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi má»™t Ä‘iá»ƒm vÃ  bÃ¡n kÃ­nh (vÃ­ dá»¥: má»™t vÃ²ng trÃ²n rá»™ng 100m xung quanh má»™t tÃ²a nhÃ ), hoáº·c má»™t Ä‘a giÃ¡c bao phá»§ má»™t khu vá»±c nhÆ° khu vá»±c trÆ°á»ng há»c, ranh giá»›i thÃ nh phá»‘, hoáº·c khuÃ´n viÃªn trÆ°á»ng Ä‘áº¡i há»c hoáº·c vÄƒn phÃ²ng.

![Má»™t sá»‘ vÃ­ dá»¥ vá» hÃ ng rÃ o Ä‘á»‹a lÃ½ hiá»ƒn thá»‹ hÃ ng rÃ o hÃ¬nh trÃ²n xung quanh cá»­a hÃ ng cÃ´ng ty Microsoft vÃ  hÃ ng rÃ o hÃ¬nh Ä‘a giÃ¡c xung quanh khuÃ´n viÃªn phÃ­a tÃ¢y cá»§a Microsoft](../../../../../translated_images/geofence-examples.172fbc534665769f6e1a1ddcf75e3b25183cd10354c80cc603ba44b635390e1a.vi.png)

> ğŸ’ Báº¡n cÃ³ thá»ƒ Ä‘Ã£ sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½ mÃ  khÃ´ng biáº¿t. Náº¿u báº¡n Ä‘Ã£ Ä‘áº·t lá»i nháº¯c báº±ng á»©ng dá»¥ng nháº¯c nhá»Ÿ iOS hoáº·c Google Keep dá»±a trÃªn vá»‹ trÃ­, báº¡n Ä‘Ã£ sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½. CÃ¡c á»©ng dá»¥ng nÃ y sáº½ thiáº¿t láº­p má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ dá»±a trÃªn vá»‹ trÃ­ Ä‘Æ°á»£c cung cáº¥p vÃ  thÃ´ng bÃ¡o cho báº¡n khi Ä‘iá»‡n thoáº¡i cá»§a báº¡n Ä‘i vÃ o hÃ ng rÃ o Ä‘á»‹a lÃ½.

CÃ³ nhiá»u lÃ½ do táº¡i sao báº¡n muá»‘n biáº¿t má»™t phÆ°Æ¡ng tiá»‡n Ä‘ang á»Ÿ trong hay ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½:

* Chuáº©n bá»‹ dá»¡ hÃ ng - nháº­n thÃ´ng bÃ¡o ráº±ng má»™t phÆ°Æ¡ng tiá»‡n Ä‘Ã£ Ä‘áº¿n nÆ¡i cho phÃ©p Ä‘á»™i ngÅ© sáºµn sÃ ng dá»¡ hÃ ng, giáº£m thá»i gian chá» cá»§a phÆ°Æ¡ng tiá»‡n. Äiá»u nÃ y cÃ³ thá»ƒ cho phÃ©p tÃ i xáº¿ thá»±c hiá»‡n nhiá»u chuyáº¿n giao hÃ ng hÆ¡n trong má»™t ngÃ y vá»›i Ã­t thá»i gian chá» hÆ¡n.
* TuÃ¢n thá»§ thuáº¿ - má»™t sá»‘ quá»‘c gia, cháº³ng háº¡n nhÆ° New Zealand, tÃ­nh thuáº¿ Ä‘Æ°á»ng bá»™ cho cÃ¡c phÆ°Æ¡ng tiá»‡n cháº¡y dáº§u diesel dá»±a trÃªn trá»ng lÆ°á»£ng phÆ°Æ¡ng tiá»‡n khi lÃ¡i trÃªn Ä‘Æ°á»ng cÃ´ng cá»™ng. Sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½ cho phÃ©p báº¡n theo dÃµi quÃ£ng Ä‘Æ°á»ng Ä‘i trÃªn Ä‘Æ°á»ng cÃ´ng cá»™ng so vá»›i Ä‘Æ°á»ng tÆ° nhÃ¢n táº¡i cÃ¡c khu vá»±c nhÆ° trang tráº¡i hoáº·c khu vá»±c khai thÃ¡c gá»—.
* GiÃ¡m sÃ¡t trá»™m cáº¯p - náº¿u má»™t phÆ°Æ¡ng tiá»‡n chá»‰ nÃªn á»Ÿ trong má»™t khu vá»±c nháº¥t Ä‘á»‹nh nhÆ° trÃªn má»™t trang tráº¡i, vÃ  nÃ³ rá»i khá»i hÃ ng rÃ o Ä‘á»‹a lÃ½, cÃ³ thá»ƒ phÆ°Æ¡ng tiá»‡n Ä‘Ã£ bá»‹ Ä‘Ã¡nh cáº¯p.
* TuÃ¢n thá»§ vá»‹ trÃ­ - má»™t sá»‘ khu vá»±c cá»§a cÃ´ng trÆ°á»ng, trang tráº¡i hoáº·c nhÃ  mÃ¡y cÃ³ thá»ƒ bá»‹ cáº¥m Ä‘á»‘i vá»›i má»™t sá»‘ phÆ°Æ¡ng tiá»‡n, cháº³ng háº¡n nhÆ° giá»¯ cÃ¡c phÆ°Æ¡ng tiá»‡n chá»Ÿ phÃ¢n bÃ³n vÃ  thuá»‘c trá»« sÃ¢u nhÃ¢n táº¡o trÃ¡nh xa cÃ¡c cÃ¡nh Ä‘á»“ng trá»“ng sáº£n pháº©m há»¯u cÆ¡. Náº¿u má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ bá»‹ xÃ¢m nháº­p, thÃ¬ phÆ°Æ¡ng tiá»‡n Ä‘ang vi pháº¡m vÃ  tÃ i xáº¿ cÃ³ thá»ƒ Ä‘Æ°á»£c thÃ´ng bÃ¡o.

âœ… Báº¡n cÃ³ thá»ƒ nghÄ© ra cÃ¡c á»©ng dá»¥ng khÃ¡c cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½ khÃ´ng?

Azure Maps, dá»‹ch vá»¥ báº¡n Ä‘Ã£ sá»­ dá»¥ng trong bÃ i há»c trÆ°á»›c Ä‘á»ƒ hiá»ƒn thá»‹ dá»¯ liá»‡u GPS, cho phÃ©p báº¡n Ä‘á»‹nh nghÄ©a hÃ ng rÃ o Ä‘á»‹a lÃ½, sau Ä‘Ã³ kiá»ƒm tra xem má»™t Ä‘iá»ƒm cÃ³ náº±m trong hay ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½.

## Äá»‹nh nghÄ©a hÃ ng rÃ o Ä‘á»‹a lÃ½

HÃ ng rÃ o Ä‘á»‹a lÃ½ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng cÃ¡ch sá»­ dá»¥ng GeoJSON, giá»‘ng nhÆ° cÃ¡c Ä‘iá»ƒm Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o báº£n Ä‘á»“ trong bÃ i há»c trÆ°á»›c. Trong trÆ°á»ng há»£p nÃ y, thay vÃ¬ lÃ  má»™t `FeatureCollection` cá»§a cÃ¡c giÃ¡ trá»‹ `Point`, nÃ³ lÃ  má»™t `FeatureCollection` chá»©a má»™t `Polygon`.

```json
{
   "type": "FeatureCollection",
   "features": [
     {
       "type": "Feature",
       "geometry": {
         "type": "Polygon",
         "coordinates": [
           [
             [
               -122.13393688201903,
               47.63829579223815
             ],
             [
               -122.13389128446579,
               47.63782047131512
             ],
             [
               -122.13240802288054,
               47.63783312249837
             ],
             [
               -122.13238388299942,
               47.63829037035086
             ],
             [
               -122.13393688201903,
               47.63829579223815
             ]
           ]
         ]
       },
       "properties": {
         "geometryId": "1"
       }
     }
   ]
}
```

Má»—i Ä‘iá»ƒm trÃªn Ä‘a giÃ¡c Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  má»™t cáº·p kinh Ä‘á»™, vÄ© Ä‘á»™ trong má»™t máº£ng, vÃ  cÃ¡c Ä‘iá»ƒm nÃ y náº±m trong má»™t máº£ng Ä‘Æ°á»£c Ä‘áº·t lÃ m `coordinates`. Trong má»™t `Point` á»Ÿ bÃ i há»c trÆ°á»›c, `coordinates` lÃ  má»™t máº£ng chá»©a 2 giÃ¡ trá»‹, vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™, Ä‘á»‘i vá»›i `Polygon` nÃ³ lÃ  má»™t máº£ng cÃ¡c máº£ng chá»©a 2 giÃ¡ trá»‹, kinh Ä‘á»™, vÄ© Ä‘á»™.

> ğŸ’ HÃ£y nhá»› ráº±ng, GeoJSON sá»­ dá»¥ng `kinh Ä‘á»™, vÄ© Ä‘á»™` cho cÃ¡c Ä‘iá»ƒm, khÃ´ng pháº£i `vÄ© Ä‘á»™, kinh Ä‘á»™`

Máº£ng tá»a Ä‘á»™ cá»§a Ä‘a giÃ¡c luÃ´n cÃ³ thÃªm 1 má»¥c so vá»›i sá»‘ Ä‘iá»ƒm trÃªn Ä‘a giÃ¡c, vá»›i má»¥c cuá»‘i cÃ¹ng giá»‘ng vá»›i má»¥c Ä‘áº§u tiÃªn, Ä‘Ã³ng Ä‘a giÃ¡c. VÃ­ dá»¥, Ä‘á»‘i vá»›i má»™t hÃ¬nh chá»¯ nháº­t sáº½ cÃ³ 5 Ä‘iá»ƒm.

![Má»™t hÃ¬nh chá»¯ nháº­t vá»›i cÃ¡c tá»a Ä‘á»™](../../../../../translated_images/polygon-points.302193da381cb415f46c2c7a98496ee4be05d6c73d21238a89721ad93e121233.vi.png)

Trong hÃ¬nh trÃªn, cÃ³ má»™t hÃ¬nh chá»¯ nháº­t. Tá»a Ä‘á»™ cá»§a Ä‘a giÃ¡c báº¯t Ä‘áº§u tá»« gÃ³c trÃªn bÃªn trÃ¡i táº¡i 47,-122, sau Ä‘Ã³ di chuyá»ƒn sang pháº£i Ä‘áº¿n 47,-121, sau Ä‘Ã³ xuá»‘ng dÆ°á»›i Ä‘áº¿n 46,-121, sau Ä‘Ã³ sang trÃ¡i Ä‘áº¿n 46,-122, sau Ä‘Ã³ quay láº¡i Ä‘iá»ƒm báº¯t Ä‘áº§u táº¡i 47,-122. Äiá»u nÃ y táº¡o ra Ä‘a giÃ¡c vá»›i 5 Ä‘iá»ƒm - gÃ³c trÃªn bÃªn trÃ¡i, gÃ³c trÃªn bÃªn pháº£i, gÃ³c dÆ°á»›i bÃªn pháº£i, gÃ³c dÆ°á»›i bÃªn trÃ¡i, sau Ä‘Ã³ quay láº¡i gÃ³c trÃªn bÃªn trÃ¡i Ä‘á»ƒ Ä‘Ã³ng láº¡i.

âœ… HÃ£y thá»­ táº¡o má»™t Ä‘a giÃ¡c GeoJSON xung quanh nhÃ  hoáº·c trÆ°á»ng há»c cá»§a báº¡n. Sá»­ dá»¥ng má»™t cÃ´ng cá»¥ nhÆ° [GeoJSON.io](https://geojson.io/).

### Nhiá»‡m vá»¥ - Ä‘á»‹nh nghÄ©a má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½

Äá»ƒ sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½ trong Azure Maps, trÆ°á»›c tiÃªn nÃ³ pháº£i Ä‘Æ°á»£c táº£i lÃªn tÃ i khoáº£n Azure Maps cá»§a báº¡n. Sau khi táº£i lÃªn, báº¡n sáº½ nháº­n Ä‘Æ°á»£c má»™t ID duy nháº¥t mÃ  báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ kiá»ƒm tra má»™t Ä‘iá»ƒm so vá»›i hÃ ng rÃ o Ä‘á»‹a lÃ½. Äá»ƒ táº£i lÃªn hÃ ng rÃ o Ä‘á»‹a lÃ½ vÃ o Azure Maps, báº¡n cáº§n sá»­ dá»¥ng API web cá»§a Azure Maps. Báº¡n cÃ³ thá»ƒ gá»i API web Azure Maps báº±ng má»™t cÃ´ng cá»¥ gá»i lÃ  [curl](https://curl.se).

> ğŸ“ Curl lÃ  má»™t cÃ´ng cá»¥ dÃ²ng lá»‡nh Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c yÃªu cáº§u Ä‘áº¿n cÃ¡c Ä‘iá»ƒm cuá»‘i web

1. Náº¿u báº¡n Ä‘ang sá»­ dá»¥ng Linux, macOS, hoáº·c phiÃªn báº£n Windows 10 gáº§n Ä‘Ã¢y, cÃ³ thá»ƒ báº¡n Ä‘Ã£ cÃ i Ä‘áº·t curl. Cháº¡y lá»‡nh sau tá»« terminal hoáº·c dÃ²ng lá»‡nh Ä‘á»ƒ kiá»ƒm tra:

    ```sh
    curl --version
    ```

    Náº¿u báº¡n khÃ´ng tháº¥y thÃ´ng tin phiÃªn báº£n cá»§a curl, báº¡n sáº½ cáº§n cÃ i Ä‘áº·t nÃ³ tá»« [trang táº£i xuá»‘ng curl](https://curl.se/download.html).

    > ğŸ’ Náº¿u báº¡n quen thuá»™c vá»›i Postman, báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ thay tháº¿ náº¿u muá»‘n.

1. Táº¡o má»™t tá»‡p GeoJSON chá»©a má»™t Ä‘a giÃ¡c. Báº¡n sáº½ kiá»ƒm tra Ä‘iá»u nÃ y báº±ng cáº£m biáº¿n GPS cá»§a mÃ¬nh, vÃ¬ váº­y hÃ£y táº¡o má»™t Ä‘a giÃ¡c xung quanh vá»‹ trÃ­ hiá»‡n táº¡i cá»§a báº¡n. Báº¡n cÃ³ thá»ƒ táº¡o thá»§ cÃ´ng báº±ng cÃ¡ch chá»‰nh sá»­a vÃ­ dá»¥ GeoJSON Ä‘Æ°á»£c cung cáº¥p á»Ÿ trÃªn, hoáº·c sá»­ dá»¥ng má»™t cÃ´ng cá»¥ nhÆ° [GeoJSON.io](https://geojson.io/).

    GeoJSON cáº§n chá»©a má»™t `FeatureCollection`, chá»©a má»™t `Feature` vá»›i `geometry` kiá»ƒu `Polygon`.

    Báº¡n **PHáº¢I** thÃªm má»™t pháº§n tá»­ `properties` á»Ÿ cÃ¹ng cáº¥p vá»›i pháº§n tá»­ `geometry`, vÃ  pháº§n tá»­ nÃ y pháº£i chá»©a má»™t `geometryId`:

    ```json
    "properties": {
        "geometryId": "1"
    }
    ```

    Náº¿u báº¡n sá»­ dá»¥ng [GeoJSON.io](https://geojson.io/), báº¡n sáº½ pháº£i thÃªm má»¥c nÃ y vÃ o pháº§n tá»­ `properties` trá»‘ng, hoáº·c sau khi táº£i xuá»‘ng tá»‡p JSON, hoáº·c trong trÃ¬nh chá»‰nh sá»­a JSON trong á»©ng dá»¥ng.

    `geometryId` nÃ y pháº£i lÃ  duy nháº¥t trong tá»‡p nÃ y. Báº¡n cÃ³ thá»ƒ táº£i lÃªn nhiá»u hÃ ng rÃ o Ä‘á»‹a lÃ½ dÆ°á»›i dáº¡ng nhiá»u `Feature` trong `FeatureCollection` trong cÃ¹ng má»™t tá»‡p GeoJSON, miá»…n lÃ  má»—i cÃ¡i cÃ³ má»™t `geometryId` khÃ¡c nhau. CÃ¡c Ä‘a giÃ¡c cÃ³ thá»ƒ cÃ³ cÃ¹ng `geometryId` náº¿u chÃºng Ä‘Æ°á»£c táº£i lÃªn tá»« má»™t tá»‡p khÃ¡c vÃ o má»™t thá»i Ä‘iá»ƒm khÃ¡c.

1. LÆ°u tá»‡p nÃ y dÆ°á»›i tÃªn `geofence.json`, vÃ  Ä‘iá»u hÆ°á»›ng Ä‘áº¿n nÆ¡i nÃ³ Ä‘Æ°á»£c lÆ°u trong terminal hoáº·c console cá»§a báº¡n.

1. Cháº¡y lá»‡nh curl sau Ä‘á»ƒ táº¡o GeoFence:

    ```sh
    curl --request POST 'https://atlas.microsoft.com/mapData/upload?api-version=1.0&dataFormat=geojson&subscription-key=<subscription_key>' \
         --header 'Content-Type: application/json' \
         --include \
         --data @geofence.json
    ```

    Thay `<subscription_key>` trong URL báº±ng khÃ³a API cho tÃ i khoáº£n Azure Maps cá»§a báº¡n.

    URL Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº£i dá»¯ liá»‡u báº£n Ä‘á»“ qua API `https://atlas.microsoft.com/mapData/upload`. Lá»‡nh gá»i bao gá»“m má»™t tham sá»‘ `api-version` Ä‘á»ƒ chá»‰ Ä‘á»‹nh API Azure Maps nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng, Ä‘iá»u nÃ y cho phÃ©p API thay Ä‘á»•i theo thá»i gian nhÆ°ng váº«n duy trÃ¬ kháº£ nÄƒng tÆ°Æ¡ng thÃ­ch ngÆ°á»£c. Äá»‹nh dáº¡ng dá»¯ liá»‡u Ä‘Æ°á»£c táº£i lÃªn Ä‘Æ°á»£c Ä‘áº·t lÃ  `geojson`.

    Äiá»u nÃ y sáº½ cháº¡y yÃªu cáº§u POST Ä‘áº¿n API táº£i lÃªn vÃ  tráº£ vá» danh sÃ¡ch cÃ¡c tiÃªu Ä‘á» pháº£n há»“i bao gá»“m má»™t tiÃªu Ä‘á» gá»i lÃ  `location`.

    ```output
    content-type: application/json
    location: https://us.atlas.microsoft.com/mapData/operations/1560ced6-3a80-46f2-84b2-5b1531820eab?api-version=1.0
    x-ms-azuremaps-region: West US 2
    x-content-type-options: nosniff
    strict-transport-security: max-age=31536000; includeSubDomains
    x-cache: CONFIG_NOCACHE
    date: Sat, 22 May 2021 21:34:57 GMT
    content-length: 0
    ```

    > ğŸ“ Khi gá»i má»™t Ä‘iá»ƒm cuá»‘i web, báº¡n cÃ³ thá»ƒ truyá»n cÃ¡c tham sá»‘ vÃ o lá»‡nh gá»i báº±ng cÃ¡ch thÃªm `?` theo sau lÃ  cÃ¡c cáº·p khÃ³a giÃ¡ trá»‹ dÆ°á»›i dáº¡ng `key=value`, ngÄƒn cÃ¡ch cÃ¡c cáº·p khÃ³a giÃ¡ trá»‹ báº±ng `&`.

1. Azure Maps khÃ´ng xá»­ lÃ½ Ä‘iá»u nÃ y ngay láº­p tá»©c, vÃ¬ váº­y báº¡n sáº½ cáº§n kiá»ƒm tra xem yÃªu cáº§u táº£i lÃªn Ä‘Ã£ hoÃ n thÃ nh chÆ°a báº±ng cÃ¡ch sá»­ dá»¥ng URL Ä‘Æ°á»£c cung cáº¥p trong tiÃªu Ä‘á» `location`. Thá»±c hiá»‡n má»™t yÃªu cáº§u GET Ä‘áº¿n vá»‹ trÃ­ nÃ y Ä‘á»ƒ xem tráº¡ng thÃ¡i. Báº¡n sáº½ cáº§n thÃªm khÃ³a Ä‘Äƒng kÃ½ cá»§a mÃ¬nh vÃ o cuá»‘i URL `location` báº±ng cÃ¡ch thÃªm `&subscription-key=<subscription_key>` vÃ o cuá»‘i, thay `<subscription_key>` báº±ng khÃ³a API cho tÃ i khoáº£n Azure Maps cá»§a báº¡n. Cháº¡y lá»‡nh sau:

    ```sh
    curl --request GET '<location>&subscription-key=<subscription_key>'
    ```

    Thay `<location>` báº±ng giÃ¡ trá»‹ cá»§a tiÃªu Ä‘á» `location`, vÃ  `<subscription_key>` báº±ng khÃ³a API cho tÃ i khoáº£n Azure Maps cá»§a báº¡n.

1. Kiá»ƒm tra giÃ¡ trá»‹ cá»§a `status` trong pháº£n há»“i. Náº¿u nÃ³ khÃ´ng pháº£i lÃ  `Succeeded`, hÃ£y Ä‘á»£i má»™t phÃºt vÃ  thá»­ láº¡i.

1. Khi tráº¡ng thÃ¡i tráº£ vá» lÃ  `Succeeded`, hÃ£y xem `resourceLocation` tá»« pháº£n há»“i. Äiá»u nÃ y chá»©a thÃ´ng tin chi tiáº¿t vá» ID duy nháº¥t (Ä‘Æ°á»£c gá»i lÃ  UDID) cho Ä‘á»‘i tÆ°á»£ng GeoJSON. UDID lÃ  giÃ¡ trá»‹ sau `metadata/`, vÃ  khÃ´ng bao gá»“m `api-version`. VÃ­ dá»¥, náº¿u `resourceLocation` lÃ :

    ```json
    {
      "resourceLocation": "https://us.atlas.microsoft.com/mapData/metadata/7c3776eb-da87-4c52-ae83-caadf980323a?api-version=1.0"
    }
    ```

    ThÃ¬ UDID sáº½ lÃ  `7c3776eb-da87-4c52-ae83-caadf980323a`.

    LÆ°u láº¡i UDID nÃ y vÃ¬ báº¡n sáº½ cáº§n nÃ³ Ä‘á»ƒ kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½.

## Kiá»ƒm tra Ä‘iá»ƒm so vá»›i hÃ ng rÃ o Ä‘á»‹a lÃ½

Khi Ä‘a giÃ¡c Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn Azure Maps, báº¡n cÃ³ thá»ƒ kiá»ƒm tra má»™t Ä‘iá»ƒm Ä‘á»ƒ xem nÃ³ cÃ³ náº±m trong hay ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½. Báº¡n thá»±c hiá»‡n Ä‘iá»u nÃ y báº±ng cÃ¡ch thá»±c hiá»‡n má»™t yÃªu cáº§u API web, truyá»n vÃ o UDID cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½, vÃ  vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™ cá»§a Ä‘iá»ƒm cáº§n kiá»ƒm tra.

Khi báº¡n thá»±c hiá»‡n yÃªu cáº§u nÃ y, báº¡n cÅ©ng cÃ³ thá»ƒ truyá»n má»™t giÃ¡ trá»‹ gá»i lÃ  `searchBuffer`. GiÃ¡ trá»‹ nÃ y cho API Maps biáº¿t má»©c Ä‘á»™ chÃ­nh xÃ¡c khi tráº£ vá» káº¿t quáº£. LÃ½ do lÃ  GPS khÃ´ng hoÃ n toÃ n chÃ­nh xÃ¡c, vÃ  Ä‘Ã´i khi vá»‹ trÃ­ cÃ³ thá»ƒ sai lá»‡ch vÃ i mÃ©t hoáº·c hÆ¡n. GiÃ¡ trá»‹ máº·c Ä‘á»‹nh cho search buffer lÃ  50m, nhÆ°ng báº¡n cÃ³ thá»ƒ Ä‘áº·t giÃ¡ trá»‹ tá»« 0m Ä‘áº¿n 500m.

Khi káº¿t quáº£ Ä‘Æ°á»£c tráº£ vá» tá»« lá»‡nh gá»i API, má»™t trong nhá»¯ng pháº§n cá»§a káº¿t quáº£ lÃ  `distance` Ä‘Æ°á»£c Ä‘o Ä‘áº¿n Ä‘iá»ƒm gáº§n nháº¥t trÃªn cáº¡nh cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½, vá»›i giÃ¡ trá»‹ dÆ°Æ¡ng náº¿u Ä‘iá»ƒm náº±m ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½, giÃ¡ trá»‹ Ã¢m náº¿u Ä‘iá»ƒm náº±m trong hÃ ng rÃ o Ä‘á»‹a lÃ½. Náº¿u khoáº£ng cÃ¡ch nÃ y nhá» hÆ¡n search buffer, khoáº£ng cÃ¡ch thá»±c táº¿ sáº½ Ä‘Æ°á»£c tráº£ vá» báº±ng mÃ©t, náº¿u khÃ´ng giÃ¡ trá»‹ sáº½ lÃ  999 hoáº·c -999. 999 cÃ³ nghÄ©a lÃ  Ä‘iá»ƒm náº±m ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½ hÆ¡n search buffer, -999 cÃ³ nghÄ©a lÃ  Ä‘iá»ƒm náº±m trong hÃ ng rÃ o Ä‘á»‹a lÃ½ hÆ¡n search buffer.

![Má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ vá»›i search buffer 50m xung quanh](../../../../../translated_images/search-buffer-and-distance.e6a79af3898183c7b2ef6fbf12271b8b34afd23969bb946962b1b18d3d2635e8.vi.png)

Trong hÃ¬nh trÃªn, hÃ ng rÃ o Ä‘á»‹a lÃ½ cÃ³ search buffer 50m.

* Má»™t Ä‘iá»ƒm á»Ÿ trung tÃ¢m hÃ ng rÃ o Ä‘á»‹a lÃ½, náº±m sÃ¢u trong search buffer cÃ³ khoáº£ng cÃ¡ch lÃ  **-999**
* Má»™t Ä‘iá»ƒm náº±m ngoÃ i search buffer cÃ³ khoáº£ng cÃ¡ch lÃ  **999**
* Má»™t Ä‘iá»ƒm náº±m trong hÃ ng rÃ o Ä‘á»‹a lÃ½ vÃ  trong search buffer, cÃ¡ch hÃ ng rÃ o Ä‘á»‹a lÃ½ 6m, cÃ³ khoáº£ng cÃ¡ch lÃ  **6m**
* Má»™t Ä‘iá»ƒm náº±m ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½ vÃ  trong search buffer, cÃ¡ch hÃ ng rÃ o Ä‘á»‹a lÃ½ 39m, cÃ³ khoáº£ng cÃ¡ch lÃ  **39m**

Viá»‡c biáº¿t khoáº£ng cÃ¡ch Ä‘áº¿n cáº¡nh cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½ lÃ  ráº¥t quan trá»ng, vÃ  káº¿t há»£p Ä‘iá»u nÃ y vá»›i cÃ¡c thÃ´ng tin khÃ¡c nhÆ° cÃ¡c láº§n Ä‘á»c GPS khÃ¡c, tá»‘c Ä‘á»™ vÃ  dá»¯ liá»‡u Ä‘Æ°á»ng khi Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh dá»±a trÃªn vá»‹ trÃ­ cá»§a phÆ°Æ¡ng tiá»‡n.

VÃ­ dá»¥, hÃ£y tÆ°á»Ÿng tÆ°á»£ng cÃ¡c láº§n Ä‘á»c GPS cho tháº¥y má»™t phÆ°Æ¡ng tiá»‡n Ä‘ang lÃ¡i trÃªn má»™t con Ä‘Æ°á»ng cháº¡y dá»c theo hÃ ng rÃ o Ä‘á»‹a lÃ½. Náº¿u má»™t giÃ¡ trá»‹ GPS khÃ´ng chÃ­nh xÃ¡c vÃ  Ä‘áº·t phÆ°Æ¡ng tiá»‡n bÃªn trong hÃ ng rÃ o Ä‘á»‹a lÃ½, máº·c dÃ¹ khÃ´ng cÃ³ lá»‘i vÃ o cho phÆ°Æ¡ng tiá»‡n, thÃ¬ giÃ¡ trá»‹ Ä‘Ã³ cÃ³ thá»ƒ bá»‹ bá» qua.

![Má»™t Ä‘Æ°á»ng GPS cho tháº¥y má»™t phÆ°Æ¡ng tiá»‡n Ä‘i qua khuÃ´n viÃªn Microsoft trÃªn Ä‘Æ°á»ng 520, vá»›i cÃ¡c láº§n Ä‘á»c GPS dá»c theo con Ä‘Æ°á»ng ngoáº¡i trá»« má»™t láº§n bÃªn trong khuÃ´n viÃªn, náº±m trong hÃ ng rÃ o Ä‘á»‹a lÃ½](../../../../../translated_images/geofence-crossing-inaccurate-gps.6a3ed911202ad9cabb66d3964888cec03a42c61d5b8f536ad5bdc99716b370f5.vi.png)
Trong hÃ¬nh trÃªn, cÃ³ má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ bao phá»§ má»™t pháº§n khuÃ´n viÃªn Microsoft. ÄÆ°á»ng mÃ u Ä‘á» cho tháº¥y má»™t chiáº¿c xe táº£i Ä‘ang di chuyá»ƒn dá»c theo Ä‘Æ°á»ng 520, vá»›i cÃ¡c vÃ²ng trÃ²n biá»ƒu thá»‹ cÃ¡c láº§n Ä‘á»c GPS. Háº§u háº¿t cÃ¡c láº§n Ä‘á»c nÃ y Ä‘á»u chÃ­nh xÃ¡c vÃ  náº±m dá»c theo Ä‘Æ°á»ng 520, ngoáº¡i trá»« má»™t láº§n Ä‘á»c khÃ´ng chÃ­nh xÃ¡c náº±m trong hÃ ng rÃ o Ä‘á»‹a lÃ½. KhÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ láº§n Ä‘á»c Ä‘Ã³ cÃ³ thá»ƒ Ä‘Ãºng - khÃ´ng cÃ³ con Ä‘Æ°á»ng nÃ o Ä‘á»ƒ xe táº£i Ä‘á»™t ngá»™t ráº½ tá»« Ä‘Æ°á»ng 520 vÃ o khuÃ´n viÃªn, rá»“i quay láº¡i Ä‘Æ°á»ng 520. MÃ£ kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½ nÃ y sáº½ cáº§n xem xÃ©t cÃ¡c láº§n Ä‘á»c trÆ°á»›c Ä‘Ã³ trÆ°á»›c khi hÃ nh Ä‘á»™ng dá»±a trÃªn káº¿t quáº£ kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½.

âœ… Báº¡n cáº§n thÃªm dá»¯ liá»‡u nÃ o Ä‘á»ƒ kiá»ƒm tra xem má»™t láº§n Ä‘á»c GPS cÃ³ thá»ƒ Ä‘Æ°á»£c coi lÃ  chÃ­nh xÃ¡c hay khÃ´ng?

### Nhiá»‡m vá»¥ - kiá»ƒm tra Ä‘iá»ƒm so vá»›i hÃ ng rÃ o Ä‘á»‹a lÃ½

1. Báº¯t Ä‘áº§u báº±ng cÃ¡ch xÃ¢y dá»±ng URL cho truy váº¥n API web. Äá»‹nh dáº¡ng lÃ :

    ```output
    https://atlas.microsoft.com/spatial/geofence/json?api-version=1.0&deviceId=gps-sensor&subscription-key=<subscription-key>&udid=<UDID>&lat=<lat>&lon=<lon>
    ```

    Thay tháº¿ `<subscription_key>` báº±ng khÃ³a API cho tÃ i khoáº£n Azure Maps cá»§a báº¡n.

    Thay tháº¿ `<UDID>` báº±ng UDID cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½ tá»« nhiá»‡m vá»¥ trÆ°á»›c.

    Thay tháº¿ `<lat>` vÃ  `<lon>` báº±ng vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™ mÃ  báº¡n muá»‘n kiá»ƒm tra.

    URL nÃ y sá»­ dá»¥ng API `https://atlas.microsoft.com/spatial/geofence/json` Ä‘á»ƒ truy váº¥n má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng GeoJSON. NÃ³ nháº¯m Ä‘áº¿n phiÃªn báº£n API `1.0`. Tham sá»‘ `deviceId` lÃ  báº¯t buá»™c vÃ  nÃªn lÃ  tÃªn cá»§a thiáº¿t bá»‹ mÃ  vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™ Ä‘Æ°á»£c láº¥y tá»«.

    Bá»™ Ä‘á»‡m tÃ¬m kiáº¿m máº·c Ä‘á»‹nh lÃ  50m, vÃ  báº¡n cÃ³ thá»ƒ thay Ä‘á»•i Ä‘iá»u nÃ y báº±ng cÃ¡ch truyá»n thÃªm tham sá»‘ `searchBuffer=<distance>`, Ä‘áº·t `<distance>` lÃ  khoáº£ng cÃ¡ch bá»™ Ä‘á»‡m tÃ¬m kiáº¿m tÃ­nh báº±ng mÃ©t, tá»« 0 Ä‘áº¿n 500.

1. Sá»­ dá»¥ng curl Ä‘á»ƒ thá»±c hiá»‡n yÃªu cáº§u GET Ä‘áº¿n URL nÃ y:

    ```sh
    curl --request GET '<URL>'
    ```

    > ğŸ’ Náº¿u báº¡n nháº­n Ä‘Æ°á»£c mÃ£ pháº£n há»“i `BadRequest`, vá»›i lá»—i:
    >
    > ```output
    > Invalid GeoJSON: All feature properties should contain a geometryId, which is used for identifying the geofence.
    > ```
    >
    > thÃ¬ GeoJSON cá»§a báº¡n Ä‘ang thiáº¿u pháº§n `properties` vá»›i `geometryId`. Báº¡n sáº½ cáº§n sá»­a láº¡i GeoJSON, sau Ä‘Ã³ láº·p láº¡i cÃ¡c bÆ°á»›c trÃªn Ä‘á»ƒ táº£i lÃªn láº¡i vÃ  nháº­n má»™t UDID má»›i.

1. Pháº£n há»“i sáº½ chá»©a danh sÃ¡ch cÃ¡c `geometries`, má»™t cho má»—i Ä‘a giÃ¡c Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong GeoJSON dÃ¹ng Ä‘á»ƒ táº¡o hÃ ng rÃ o Ä‘á»‹a lÃ½. Má»—i geometry cÃ³ 3 trÆ°á»ng quan trá»ng, `distance`, `nearestLat` vÃ  `nearestLon`.

    ```output
    {
        "geometries": [
            {
                "deviceId": "gps-sensor",
                "udId": "7c3776eb-da87-4c52-ae83-caadf980323a",
                "geometryId": "1",
                "distance": 999.0,
                "nearestLat": 47.645875,
                "nearestLon": -122.142713
            }
        ],
        "expiredGeofenceGeometryId": [],
        "invalidPeriodGeofenceGeometryId": []
    }
    ```

    * `nearestLat` vÃ  `nearestLon` lÃ  vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™ cá»§a má»™t Ä‘iá»ƒm trÃªn cáº¡nh cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½ gáº§n nháº¥t vá»›i vá»‹ trÃ­ Ä‘ang Ä‘Æ°á»£c kiá»ƒm tra.

    * `distance` lÃ  khoáº£ng cÃ¡ch tá»« vá»‹ trÃ­ Ä‘ang Ä‘Æ°á»£c kiá»ƒm tra Ä‘áº¿n Ä‘iá»ƒm gáº§n nháº¥t trÃªn cáº¡nh cá»§a hÃ ng rÃ o Ä‘á»‹a lÃ½. Sá»‘ Ã¢m nghÄ©a lÃ  bÃªn trong hÃ ng rÃ o Ä‘á»‹a lÃ½, sá»‘ dÆ°Æ¡ng lÃ  bÃªn ngoÃ i. GiÃ¡ trá»‹ nÃ y sáº½ nhá» hÆ¡n 50 (bá»™ Ä‘á»‡m tÃ¬m kiáº¿m máº·c Ä‘á»‹nh), hoáº·c 999.

1. Láº·p láº¡i Ä‘iá»u nÃ y nhiá»u láº§n vá»›i cÃ¡c vá»‹ trÃ­ bÃªn trong vÃ  bÃªn ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½.

## Sá»­ dá»¥ng hÃ ng rÃ o Ä‘á»‹a lÃ½ tá»« mÃ£ serverless

BÃ¢y giá» báº¡n cÃ³ thá»ƒ thÃªm má»™t trigger má»›i vÃ o á»©ng dá»¥ng Functions cá»§a mÃ¬nh Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u sá»± kiá»‡n GPS tá»« IoT Hub so vá»›i hÃ ng rÃ o Ä‘á»‹a lÃ½.

### NhÃ³m ngÆ°á»i tiÃªu dÃ¹ng

NhÆ° báº¡n Ä‘Ã£ nhá»› tá»« cÃ¡c bÃ i há»c trÆ°á»›c, IoT Hub sáº½ cho phÃ©p báº¡n phÃ¡t láº¡i cÃ¡c sá»± kiá»‡n Ä‘Ã£ Ä‘Æ°á»£c nháº­n bá»Ÿi hub nhÆ°ng chÆ°a Ä‘Æ°á»£c xá»­ lÃ½. NhÆ°ng Ä‘iá»u gÃ¬ sáº½ xáº£y ra náº¿u nhiá»u trigger Ä‘Æ°á»£c káº¿t ná»‘i? LÃ m tháº¿ nÃ o nÃ³ biáº¿t trigger nÃ o Ä‘Ã£ xá»­ lÃ½ sá»± kiá»‡n nÃ o.

CÃ¢u tráº£ lá»i lÃ  nÃ³ khÃ´ng thá»ƒ! Thay vÃ o Ä‘Ã³, báº¡n cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a nhiá»u káº¿t ná»‘i riÃªng biá»‡t Ä‘á»ƒ Ä‘á»c cÃ¡c sá»± kiá»‡n, vÃ  má»—i káº¿t ná»‘i cÃ³ thá»ƒ quáº£n lÃ½ viá»‡c phÃ¡t láº¡i cÃ¡c tin nháº¯n chÆ°a Ä‘á»c. Nhá»¯ng káº¿t ná»‘i nÃ y Ä‘Æ°á»£c gá»i lÃ  *nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng*. Khi báº¡n káº¿t ná»‘i Ä‘áº¿n endpoint, báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng mÃ  báº¡n muá»‘n káº¿t ná»‘i. Má»—i thÃ nh pháº§n cá»§a á»©ng dá»¥ng cá»§a báº¡n sáº½ káº¿t ná»‘i Ä‘áº¿n má»™t nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng khÃ¡c nhau.

![Má»™t IoT Hub vá»›i 3 nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng phÃ¢n phá»‘i cÃ¹ng má»™t tin nháº¯n Ä‘áº¿n 3 á»©ng dá»¥ng Functions khÃ¡c nhau](../../../../../translated_images/consumer-groups.a3262e26fc27ba2092863678ad57af15c7223416e388a23f330c058cf4358630.vi.png)

Theo lÃ½ thuyáº¿t, tá»‘i Ä‘a 5 á»©ng dá»¥ng cÃ³ thá»ƒ káº¿t ná»‘i Ä‘áº¿n má»—i nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng, vÃ  táº¥t cáº£ sáº½ nháº­n Ä‘Æ°á»£c tin nháº¯n khi chÃºng Ä‘áº¿n. Thá»±c hÃ nh tá»‘t nháº¥t lÃ  chá»‰ cÃ³ má»™t á»©ng dá»¥ng truy cáº­p má»—i nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng Ä‘á»ƒ trÃ¡nh xá»­ lÃ½ tin nháº¯n trÃ¹ng láº·p, vÃ  Ä‘áº£m báº£o khi khá»Ÿi Ä‘á»™ng láº¡i táº¥t cáº£ cÃ¡c tin nháº¯n xáº¿p hÃ ng Ä‘Æ°á»£c xá»­ lÃ½ Ä‘Ãºng cÃ¡ch. VÃ­ dá»¥, náº¿u báº¡n khá»Ÿi cháº¡y á»©ng dá»¥ng Functions cá»§a mÃ¬nh cá»¥c bá»™ cÅ©ng nhÆ° cháº¡y nÃ³ trÃªn Ä‘Ã¡m mÃ¢y, cáº£ hai sáº½ xá»­ lÃ½ tin nháº¯n, dáº«n Ä‘áº¿n cÃ¡c blob trÃ¹ng láº·p Ä‘Æ°á»£c lÆ°u trá»¯ trong tÃ i khoáº£n lÆ°u trá»¯.

Náº¿u báº¡n xem láº¡i tá»‡p `function.json` cho trigger IoT Hub mÃ  báº¡n Ä‘Ã£ táº¡o trong bÃ i há»c trÆ°á»›c, báº¡n sáº½ tháº¥y nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng trong pháº§n rÃ ng buá»™c trigger event hub:

```json
"consumerGroup": "$Default"
```

Khi báº¡n táº¡o má»™t IoT Hub, báº¡n sáº½ nháº­n Ä‘Æ°á»£c nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng `$Default` Ä‘Æ°á»£c táº¡o máº·c Ä‘á»‹nh. Náº¿u báº¡n muá»‘n thÃªm má»™t trigger bá»• sung, báº¡n cÃ³ thá»ƒ thÃªm Ä‘iá»u nÃ y báº±ng cÃ¡ch sá»­ dá»¥ng má»™t nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng má»›i.

> ğŸ’ Trong bÃ i há»c nÃ y, báº¡n sáº½ sá»­ dá»¥ng má»™t function khÃ¡c Ä‘á»ƒ kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½ so vá»›i function Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u GPS. Äiá»u nÃ y nháº±m minh há»a cÃ¡ch sá»­ dá»¥ng nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng vÃ  tÃ¡ch mÃ£ Ä‘á»ƒ dá»… Ä‘á»c vÃ  hiá»ƒu hÆ¡n. Trong má»™t á»©ng dá»¥ng sáº£n xuáº¥t, cÃ³ nhiá»u cÃ¡ch báº¡n cÃ³ thá»ƒ kiáº¿n trÃºc Ä‘iá»u nÃ y - Ä‘áº·t cáº£ hai vÃ o má»™t function, sá»­ dá»¥ng trigger trÃªn tÃ i khoáº£n lÆ°u trá»¯ Ä‘á»ƒ cháº¡y má»™t function kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½, hoáº·c sá»­ dá»¥ng nhiá»u function. KhÃ´ng cÃ³ 'cÃ¡ch Ä‘Ãºng', nÃ³ phá»¥ thuá»™c vÃ o pháº§n cÃ²n láº¡i cá»§a á»©ng dá»¥ng cá»§a báº¡n vÃ  nhu cáº§u cá»§a báº¡n.

### Nhiá»‡m vá»¥ - táº¡o má»™t nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng má»›i

1. Cháº¡y lá»‡nh sau Ä‘á»ƒ táº¡o má»™t nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng má»›i cÃ³ tÃªn `geofence` cho IoT Hub cá»§a báº¡n:

    ```sh
    az iot hub consumer-group create --name geofence \
                                     --hub-name <hub_name>
    ```

    Thay tháº¿ `<hub_name>` báº±ng tÃªn báº¡n Ä‘Ã£ sá»­ dá»¥ng cho IoT Hub cá»§a mÃ¬nh.

1. Náº¿u báº¡n muá»‘n xem táº¥t cáº£ cÃ¡c nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng cho má»™t IoT Hub, cháº¡y lá»‡nh sau:

    ```sh
    az iot hub consumer-group list --output table \
                                   --hub-name <hub_name>
    ```

    Thay tháº¿ `<hub_name>` báº±ng tÃªn báº¡n Ä‘Ã£ sá»­ dá»¥ng cho IoT Hub cá»§a mÃ¬nh. Äiá»u nÃ y sáº½ liá»‡t kÃª táº¥t cáº£ cÃ¡c nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng.

    ```output
    Name      ResourceGroup
    --------  ---------------
    $Default  gps-sensor
    geofence  gps-sensor
    ```

> ğŸ’ Khi báº¡n cháº¡y trÃ¬nh giÃ¡m sÃ¡t sá»± kiá»‡n IoT Hub trong bÃ i há»c trÆ°á»›c, nÃ³ Ä‘Ã£ káº¿t ná»‘i Ä‘áº¿n nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng `$Default`. ÄÃ¢y lÃ  lÃ½ do táº¡i sao báº¡n khÃ´ng thá»ƒ cháº¡y trÃ¬nh giÃ¡m sÃ¡t sá»± kiá»‡n vÃ  má»™t trigger sá»± kiá»‡n. Náº¿u báº¡n muá»‘n cháº¡y cáº£ hai, thÃ¬ báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng khÃ¡c cho táº¥t cáº£ cÃ¡c á»©ng dá»¥ng Functions cá»§a mÃ¬nh, vÃ  giá»¯ `$Default` cho trÃ¬nh giÃ¡m sÃ¡t sá»± kiá»‡n.

### Nhiá»‡m vá»¥ - táº¡o má»™t trigger IoT Hub má»›i

1. ThÃªm má»™t trigger sá»± kiá»‡n IoT Hub má»›i vÃ o á»©ng dá»¥ng `gps-trigger` function mÃ  báº¡n Ä‘Ã£ táº¡o trong bÃ i há»c trÆ°á»›c. Gá»i function nÃ y lÃ  `geofence-trigger`.

    > âš ï¸ Báº¡n cÃ³ thá»ƒ tham kháº£o [hÆ°á»›ng dáº«n táº¡o trigger sá»± kiá»‡n IoT Hub tá»« dá»± Ã¡n 2, bÃ i há»c 5 náº¿u cáº§n](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#create-an-iot-hub-event-trigger).

1. Cáº¥u hÃ¬nh chuá»—i káº¿t ná»‘i IoT Hub trong tá»‡p `function.json`. Tá»‡p `local.settings.json` Ä‘Æ°á»£c chia sáº» giá»¯a táº¥t cáº£ cÃ¡c trigger trong á»©ng dá»¥ng Function.

1. Cáº­p nháº­t giÃ¡ trá»‹ cá»§a `consumerGroup` trong tá»‡p `function.json` Ä‘á»ƒ tham chiáº¿u Ä‘áº¿n nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng `geofence` má»›i:

    ```json
    "consumerGroup": "geofence"
    ```

1. Báº¡n sáº½ cáº§n sá»­ dá»¥ng khÃ³a Ä‘Äƒng kÃ½ cho tÃ i khoáº£n Azure Maps cá»§a mÃ¬nh trong trigger nÃ y, vÃ¬ váº­y hÃ£y thÃªm má»™t má»¥c má»›i vÃ o tá»‡p `local.settings.json` cÃ³ tÃªn `MAPS_KEY`.

1. Cháº¡y á»©ng dá»¥ng Functions Ä‘á»ƒ Ä‘áº£m báº£o nÃ³ Ä‘ang káº¿t ná»‘i vÃ  xá»­ lÃ½ tin nháº¯n. Trigger `iot-hub-trigger` tá»« bÃ i há»c trÆ°á»›c cÅ©ng sáº½ cháº¡y vÃ  táº£i blob lÃªn lÆ°u trá»¯.

    > Äá»ƒ trÃ¡nh cÃ¡c láº§n Ä‘á»c GPS trÃ¹ng láº·p trong lÆ°u trá»¯ blob, báº¡n cÃ³ thá»ƒ dá»«ng á»©ng dá»¥ng Functions mÃ  báº¡n Ä‘ang cháº¡y trÃªn Ä‘Ã¡m mÃ¢y. Äá»ƒ lÃ m Ä‘iá»u nÃ y, sá»­ dá»¥ng lá»‡nh sau:
    >
    > ```sh
    > az functionapp stop --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Thay tháº¿ `<functions_app_name>` báº±ng tÃªn báº¡n Ä‘Ã£ sá»­ dá»¥ng cho á»©ng dá»¥ng Functions cá»§a mÃ¬nh.
    >
    > Báº¡n cÃ³ thá»ƒ khá»Ÿi Ä‘á»™ng láº¡i nÃ³ sau báº±ng lá»‡nh sau:
    >
    > ```sh
    > az functionapp start --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Thay tháº¿ `<functions_app_name>` báº±ng tÃªn báº¡n Ä‘Ã£ sá»­ dá»¥ng cho á»©ng dá»¥ng Functions cá»§a mÃ¬nh.

### Nhiá»‡m vá»¥ - kiá»ƒm tra hÃ ng rÃ o Ä‘á»‹a lÃ½ tá»« trigger

TrÆ°á»›c Ä‘Ã³ trong bÃ i há»c nÃ y, báº¡n Ä‘Ã£ sá»­ dá»¥ng curl Ä‘á»ƒ truy váº¥n má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ Ä‘á»ƒ xem liá»‡u má»™t Ä‘iá»ƒm cÃ³ náº±m bÃªn trong hay bÃªn ngoÃ i. Báº¡n cÃ³ thá»ƒ thá»±c hiá»‡n má»™t yÃªu cáº§u web tÆ°Æ¡ng tá»± tá»« bÃªn trong trigger cá»§a mÃ¬nh.

1. Äá»ƒ truy váº¥n hÃ ng rÃ o Ä‘á»‹a lÃ½, báº¡n cáº§n UDID cá»§a nÃ³. ThÃªm má»™t má»¥c má»›i vÃ o tá»‡p `local.settings.json` cÃ³ tÃªn `GEOFENCE_UDID` vá»›i giÃ¡ trá»‹ nÃ y.

1. Má»Ÿ tá»‡p `__init__.py` tá»« trigger `geofence-trigger` má»›i.

1. ThÃªm import sau vÃ o Ä‘áº§u tá»‡p:

    ```python
    import json
    import os
    import requests
    ```

    GÃ³i `requests` cho phÃ©p báº¡n thá»±c hiá»‡n cÃ¡c cuá»™c gá»i API web. Azure Maps khÃ´ng cÃ³ SDK Python, báº¡n cáº§n thá»±c hiá»‡n cÃ¡c cuá»™c gá»i API web Ä‘á»ƒ sá»­ dá»¥ng nÃ³ tá»« mÃ£ Python.

1. ThÃªm 2 dÃ²ng sau vÃ o Ä‘áº§u phÆ°Æ¡ng thá»©c `main` Ä‘á»ƒ láº¥y khÃ³a Ä‘Äƒng kÃ½ Maps:

    ```python
    maps_key = os.environ['MAPS_KEY']
    geofence_udid = os.environ['GEOFENCE_UDID']    
    ```

1. BÃªn trong vÃ²ng láº·p `for event in events`, thÃªm Ä‘oáº¡n mÃ£ sau Ä‘á»ƒ láº¥y vÄ© Ä‘á»™ vÃ  kinh Ä‘á»™ tá»« má»—i sá»± kiá»‡n:

    ```python
    event_body = json.loads(event.get_body().decode('utf-8'))
    lat = event_body['gps']['lat']
    lon = event_body['gps']['lon']
    ```

    Äoáº¡n mÃ£ nÃ y chuyá»ƒn Ä‘á»•i JSON tá»« ná»™i dung sá»± kiá»‡n thÃ nh má»™t tá»« Ä‘iá»ƒn, sau Ä‘Ã³ trÃ­ch xuáº¥t `lat` vÃ  `lon` tá»« trÆ°á»ng `gps`.

1. Khi sá»­ dá»¥ng `requests`, thay vÃ¬ xÃ¢y dá»±ng má»™t URL dÃ i nhÆ° báº¡n Ä‘Ã£ lÃ m vá»›i curl, báº¡n cÃ³ thá»ƒ chá»‰ sá»­ dá»¥ng pháº§n URL vÃ  truyá»n cÃ¡c tham sá»‘ dÆ°á»›i dáº¡ng tá»« Ä‘iá»ƒn. ThÃªm Ä‘oáº¡n mÃ£ sau Ä‘á»ƒ Ä‘á»‹nh nghÄ©a URL Ä‘á»ƒ gá»i vÃ  cáº¥u hÃ¬nh cÃ¡c tham sá»‘:

    ```python
    url = 'https://atlas.microsoft.com/spatial/geofence/json'

    params = {
        'api-version': 1.0,
        'deviceId': 'gps-sensor',
        'subscription-key': maps_key,
        'udid' : geofence_udid,
        'lat' : lat,
        'lon' : lon
    }
    ```

    CÃ¡c má»¥c trong tá»« Ä‘iá»ƒn `params` sáº½ khá»›p vá»›i cÃ¡c cáº·p khÃ³a giÃ¡ trá»‹ báº¡n Ä‘Ã£ sá»­ dá»¥ng khi gá»i API web qua curl.

1. ThÃªm cÃ¡c dÃ²ng mÃ£ sau Ä‘á»ƒ gá»i API web:

    ```python
    response = requests.get(url, params=params)
    response_body = json.loads(response.text)
    ```

    Äiá»u nÃ y gá»i URL vá»›i cÃ¡c tham sá»‘, vÃ  nháº­n láº¡i má»™t Ä‘á»‘i tÆ°á»£ng pháº£n há»“i.

1. ThÃªm Ä‘oáº¡n mÃ£ sau bÃªn dÆ°á»›i:

    ```python
    distance = response_body['geometries'][0]['distance']

    if distance == 999:
        logging.info('Point is outside geofence')
    elif distance > 0:
        logging.info(f'Point is just outside geofence by a distance of {distance}m')
    elif distance == -999:
        logging.info(f'Point is inside geofence')
    else:
        logging.info(f'Point is just inside geofence by a distance of {distance}m')
    ```

    Äoáº¡n mÃ£ nÃ y giáº£ Ä‘á»‹nh cÃ³ 1 geometry, vÃ  trÃ­ch xuáº¥t khoáº£ng cÃ¡ch tá»« geometry Ä‘Ã³. Sau Ä‘Ã³, nÃ³ ghi nháº­t kÃ½ cÃ¡c tin nháº¯n khÃ¡c nhau dá»±a trÃªn khoáº£ng cÃ¡ch.

1. Cháº¡y Ä‘oáº¡n mÃ£ nÃ y. Báº¡n sáº½ tháº¥y trong nháº­t kÃ½ Ä‘áº§u ra náº¿u tá»a Ä‘á»™ GPS náº±m bÃªn trong hoáº·c bÃªn ngoÃ i hÃ ng rÃ o Ä‘á»‹a lÃ½, vá»›i khoáº£ng cÃ¡ch náº¿u Ä‘iá»ƒm náº±m trong pháº¡m vi 50m. Thá»­ Ä‘oáº¡n mÃ£ nÃ y vá»›i cÃ¡c hÃ ng rÃ o Ä‘á»‹a lÃ½ khÃ¡c nhau dá»±a trÃªn vá»‹ trÃ­ cá»§a cáº£m biáº¿n GPS cá»§a báº¡n, thá»­ di chuyá»ƒn cáº£m biáº¿n (vÃ­ dá»¥ káº¿t ná»‘i WiFi tá»« Ä‘iá»‡n thoáº¡i di Ä‘á»™ng, hoáº·c vá»›i cÃ¡c tá»a Ä‘á»™ khÃ¡c trÃªn thiáº¿t bá»‹ IoT áº£o) Ä‘á»ƒ xem sá»± thay Ä‘á»•i nÃ y.

1. Khi báº¡n Ä‘Ã£ sáºµn sÃ ng, triá»ƒn khai Ä‘oáº¡n mÃ£ nÃ y lÃªn á»©ng dá»¥ng Functions cá»§a báº¡n trÃªn Ä‘Ã¡m mÃ¢y. Äá»«ng quÃªn triá»ƒn khai cÃ¡c Application Settings má»›i.

    > âš ï¸ Báº¡n cÃ³ thá»ƒ tham kháº£o [hÆ°á»›ng dáº«n táº£i lÃªn Application Settings tá»« dá»± Ã¡n 2, bÃ i há»c 5 náº¿u cáº§n](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---upload-your-application-settings).

    > âš ï¸ Báº¡n cÃ³ thá»ƒ tham kháº£o [hÆ°á»›ng dáº«n triá»ƒn khai á»©ng dá»¥ng Functions cá»§a báº¡n tá»« dá»± Ã¡n 2, bÃ i há»c 5 náº¿u cáº§n](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---deploy-your-functions-app-to-the-cloud).

> ğŸ’ Báº¡n cÃ³ thá»ƒ tÃ¬m tháº¥y Ä‘oáº¡n mÃ£ nÃ y trong thÆ° má»¥c [code/functions](../../../../../3-transport/lessons/4-geofences/code/functions).

---

## ğŸš€ Thá»­ thÃ¡ch

Trong bÃ i há»c nÃ y, báº¡n Ä‘Ã£ thÃªm má»™t hÃ ng rÃ o Ä‘á»‹a lÃ½ báº±ng tá»‡p GeoJSON vá»›i má»™t Ä‘a giÃ¡c duy nháº¥t. Báº¡n cÃ³ thá»ƒ táº£i lÃªn nhiá»u Ä‘a giÃ¡c cÃ¹ng má»™t lÃºc, miá»…n lÃ  chÃºng cÃ³ cÃ¡c giÃ¡ trá»‹ `geometryId` khÃ¡c nhau trong pháº§n `properties`.

HÃ£y thá»­ táº£i lÃªn má»™t tá»‡p GeoJSON vá»›i nhiá»u Ä‘a giÃ¡c vÃ  Ä‘iá»u chá»‰nh Ä‘oáº¡n mÃ£ cá»§a báº¡n Ä‘á»ƒ tÃ¬m xem tá»a Ä‘á»™ GPS gáº§n nháº¥t hoáº·c náº±m trong Ä‘a giÃ¡c nÃ o.

## CÃ¢u há»i sau bÃ i giáº£ng

[CÃ¢u há»i sau bÃ i giáº£ng](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/28)

## Ã”n táº­p & Tá»± há»c

* Äá»c thÃªm vá» hÃ ng rÃ o Ä‘á»‹a lÃ½ vÃ  má»™t sá»‘ trÆ°á»ng há»£p sá»­ dá»¥ng cá»§a chÃºng trÃªn [trang Geofencing trÃªn Wikipedia](https://en.wikipedia.org/wiki/Geo-fence).
* Äá»c thÃªm vá» API hÃ ng rÃ o Ä‘á»‹a lÃ½ cá»§a Azure Maps trÃªn [tÃ i liá»‡u Microsoft Azure Maps Spatial - Get Geofence](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence?WT.mc_id=academic-17441-jabenn).
* Äá»c thÃªm vá» nhÃ³m ngÆ°á»i tiÃªu dÃ¹ng trong [TÃ­nh nÄƒng vÃ  thuáº­t ngá»¯ trong Azure Event Hubs - TÃ i liá»‡u ngÆ°á»i tiÃªu dÃ¹ng sá»± kiá»‡n trÃªn Microsoft docs](https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=academic-17441-jabenn#event-consumers).

## BÃ i táº­p

[Gá»­i thÃ´ng bÃ¡o báº±ng Twilio](assignment.md)

---

**TuyÃªn bá»‘ miá»…n trá»« trÃ¡ch nhiá»‡m**:  
TÃ i liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c dá»‹ch báº±ng dá»‹ch vá»¥ dá»‹ch thuáº­t AI [Co-op Translator](https://github.com/Azure/co-op-translator). Máº·c dÃ¹ chÃºng tÃ´i cá»‘ gáº¯ng Ä‘áº£m báº£o Ä‘á»™ chÃ­nh xÃ¡c, xin lÆ°u Ã½ ráº±ng cÃ¡c báº£n dá»‹ch tá»± Ä‘á»™ng cÃ³ thá»ƒ chá»©a lá»—i hoáº·c khÃ´ng chÃ­nh xÃ¡c. TÃ i liá»‡u gá»‘c báº±ng ngÃ´n ngá»¯ báº£n Ä‘á»‹a nÃªn Ä‘Æ°á»£c coi lÃ  nguá»“n thÃ´ng tin chÃ­nh thá»©c. Äá»‘i vá»›i cÃ¡c thÃ´ng tin quan trá»ng, khuyáº¿n nghá»‹ sá»­ dá»¥ng dá»‹ch vá»¥ dá»‹ch thuáº­t chuyÃªn nghiá»‡p bá»Ÿi con ngÆ°á»i. ChÃºng tÃ´i khÃ´ng chá»‹u trÃ¡ch nhiá»‡m cho báº¥t ká»³ sá»± hiá»ƒu láº§m hoáº·c diá»…n giáº£i sai nÃ o phÃ¡t sinh tá»« viá»‡c sá»­ dá»¥ng báº£n dá»‹ch nÃ y.