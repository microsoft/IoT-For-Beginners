<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "f7bb24ba53fb627ddb38a8b24a05e594",
  "translation_date": "2025-10-11T12:45:45+00:00",
  "source_file": "2-farm/lessons/3-automated-plant-watering/README.md",
  "language_code": "et"
}
-->
# Automaatne taimede kastmine

![Selle √µppetunni visuaalne √ºlevaade](../../../../../translated_images/lesson-7.30b5f577d3cb8e031238751475cb519c7d6dbaea261b5df4643d086ffb2a03bb.et.jpg)

> Visuaalne √ºlevaade: [Nitya Narasimhan](https://github.com/nitya). Kl√µpsa pildil, et n√§ha suuremat versiooni.

See √µppetund oli osa [IoT algajatele: Projekt 2 - Digitaalne p√µllumajandus](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) sarjast, mida korraldas [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn).

[![IoT-p√µhine automaatne taimede kastmine](https://img.youtube.com/vi/g9FfZwv9R58/0.jpg)](https://youtu.be/g9FfZwv9R58)

## Eel-loengu viktoriin

[Eel-loengu viktoriin](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/13)

## Sissejuhatus

Eelmises √µppetunnis √µppisite, kuidas j√§lgida mulla niiskust. Selles √µppetunnis √µpite, kuidas ehitada automaatse kastmiss√ºsteemi p√µhikomponente, mis reageerivad mulla niiskusele. Samuti saate teada ajastuse kohta ‚Äì kuidas sensorid vajavad aega muutustele reageerimiseks ja kuidas aktuaatorid vajavad aega, et muuta sensori poolt m√µ√µdetavaid omadusi.

Selles √µppetunnis k√§sitleme:

* [Kuidas juhtida suure v√µimsusega seadmeid madala v√µimsusega IoT-seadmest](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Kuidas juhtida releed](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Kuidas juhtida oma taime MQTT kaudu](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Sensori ja aktuaatori ajastus](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Ajastuse lisamine taime juhtimiserverisse](../../../../../2-farm/lessons/3-automated-plant-watering)

## Kuidas juhtida suure v√µimsusega seadmeid madala v√µimsusega IoT-seadmest

IoT-seadmed kasutavad madalat pinget. Kuigi see on piisav sensorite ja madala v√µimsusega aktuaatorite, nagu LED-id, jaoks, on see liiga madal suuremate seadmete, n√§iteks kastmispumba, juhtimiseks. Isegi v√§ikesed pumbad, mida saaksite kasutada toataimede jaoks, tarbivad liiga palju voolu IoT arenduskomplekti jaoks ja v√µivad plaadi l√§bi p√µletada.

> üéì Vool, mida m√µ√µdetakse amprites (A), n√§itab elektri hulka, mis liigub l√§bi vooluringi. Pinge annab t√µuke, vool n√§itab, kui palju t√µugatakse. Lisateavet voolu kohta leiate [Wikipedia elektrivoolu lehelt](https://wikipedia.org/wiki/Electric_current).

Lahendus sellele probleemile on √ºhendada pump v√§lise toiteallikaga ja kasutada aktuaatorit pumba sisse l√ºlitamiseks, sarnaselt sellele, kuidas l√ºlitate valguse sisse. V√§ike kogus energiat (n√§iteks teie keha energia) on piisav, et s√µrm l√ºlitaks l√ºliti sisse, mis √ºhendab valguse koduse elektriv√µrguga, mis t√∂√∂tab 110v/240v pingel.

![Valgusel√ºliti l√ºlitab valguse sisse](../../../../../translated_images/light-switch.760317ad6ab8bd6d611da5352dfe9c73a94a0822ccec7df3c8bae35da18e1658.et.png)

> üéì [Kodune elektriv√µrk](https://wikipedia.org/wiki/Mains_electricity) viitab elektrile, mida tarnitakse kodudesse ja ettev√µtetesse riikliku infrastruktuuri kaudu paljudes maailma osades.

‚úÖ IoT-seadmed suudavad tavaliselt pakkuda 3.3V v√µi 5V pinget, v√§hem kui 1 amprit (1A) voolu. V√µrdluseks, kodune elektriv√µrk t√∂√∂tab enamasti 230V pingel (120V P√µhja-Ameerikas ja 100V Jaapanis) ning suudab toita seadmeid, mis tarbivad kuni 30A voolu.

Selleks on mitmeid aktuaatoreid, sealhulgas mehaanilised seadmed, mida saab kinnitada olemasolevatele l√ºlititele, et j√§ljendada s√µrme nende sisse l√ºlitamisel. K√µige populaarsem neist on relee.

### Releed

Relee on elektromehhaaniline l√ºliti, mis muudab elektrilise signaali mehaaniliseks liikumiseks, mis l√ºlitab l√ºliti sisse. Relee tuumaks on elektromagnet.

> üéì [Elektromagnetid](https://wikipedia.org/wiki/Electromagnet) on magnetid, mis luuakse elektri juhtimisega l√§bi traadi m√§hise. Kui elekter on sisse l√ºlitatud, muutub m√§his magnetiliseks. Kui elekter on v√§lja l√ºlitatud, kaotab m√§his oma magnetismi.

![Kui relee on sisse l√ºlitatud, loob elektromagnet magnetv√§lja, mis l√ºlitab v√§ljundvooluringi sisse](../../../../../translated_images/relay-on.4db16a0fd6b669262fd6699aff3fbcd31b6057c06d90411b6bddc06326d1cf75.et.png)

Relees juhib juhtimisahel elektromagneti. Kui elektromagnet on sisse l√ºlitatud, t√µmbab see kangi, mis liigutab l√ºlitit, sulgedes kontaktid ja l√µpetades v√§ljundvooluringi.

![Kui relee on v√§lja l√ºlitatud, ei loo elektromagnet magnetv√§lja, mis l√ºlitab v√§ljundvooluringi v√§lja](../../../../../translated_images/relay-off.c34a178a2960fecdc3c6400d43e633ed11c6746cd653cfb4a768fa097c40394c.et.png)

Kui juhtimisahel on v√§lja l√ºlitatud, l√ºlitub elektromagnet v√§lja, vabastades kangi ja avades kontaktid, l√ºlitades v√§ljundvooluringi v√§lja. Releed on digitaalsed aktuaatorid ‚Äì k√µrge signaal l√ºlitab relee sisse, madal signaal l√ºlitab selle v√§lja.

V√§ljundvooluringi saab kasutada t√§iendava riistvara, n√§iteks kastmiss√ºsteemi, toiteks. IoT-seade saab relee sisse l√ºlitada, l√µpetades v√§ljundvooluringi, mis toidab kastmiss√ºsteemi, ja taimed saavad vett. IoT-seade saab seej√§rel relee v√§lja l√ºlitada, katkestades kastmiss√ºsteemi toite ja l√ºlitades vee v√§lja.

![Relee l√ºlitub sisse, l√ºlitades sisse pumba, mis saadab vett taimele](../../../../../images/strawberry-pump.gif)

√úlaltoodud videos l√ºlitatakse relee sisse. Relee LED s√ºttib, et n√§idata, et see on sisse l√ºlitatud (m√µnel releeplaadil on LED-id, mis n√§itavad, kas relee on sisse v√µi v√§lja l√ºlitatud), ja vool suunatakse pumbale, mis l√ºlitub sisse ja pumpab vett taimele.

> üíÅ Releed saab kasutada ka kahe v√§ljundvooluringi vahel vahetamiseks, mitte √ºhe sisse ja v√§lja l√ºlitamiseks. Kui kang liigub, liigutab see l√ºlitit √ºhe v√§ljundvooluringi l√µpetamisest teise l√µpetamiseni, jagades tavaliselt √ºhise toite√ºhenduse v√µi √ºhise maandus√ºhenduse.

‚úÖ Uurige: Releesid on mitut t√º√ºpi, erinevustega, n√§iteks kas juhtimisahel l√ºlitab relee sisse v√µi v√§lja, kui vool on rakendatud, v√µi mitme v√§ljundvooluringiga. Uurige nende erinevate t√º√ºpide kohta.

Kui kang liigub, kuulete tavaliselt, kuidas see elektromagnetiga kontakti teeb, tehes selge kl√µpsu.

> üíÅ Relee saab juhtida nii, et √ºhenduse loomine katkestab tegelikult relee toite, l√ºlitades relee v√§lja, mis seej√§rel saadab releele toite, l√ºlitades selle uuesti sisse ja nii edasi. See t√§hendab, et relee kl√µpsab v√§ga kiiresti, tekitades sumisevat heli. Nii t√∂√∂tasid m√µned esimesed elektrilised uksekellad.

### Relee toide

Elektromagnet ei vaja palju energiat, et aktiveeruda ja kangi t√µmmata, seda saab juhtida 3.3V v√µi 5V v√§ljundiga IoT arenduskomplektist. V√§ljundvooluring suudab kanda palju rohkem energiat, s√µltuvalt releest, sealhulgas koduv√µrgu pinget v√µi isegi k√µrgemaid energiatasemeid t√∂√∂stuslikuks kasutamiseks. Nii saab IoT arenduskomplekt juhtida kastmiss√ºsteemi, alates v√§ikesest pumbast √ºhe taime jaoks kuni massiivse t√∂√∂stusliku s√ºsteemini terve kommertsfarmi jaoks.

![Grove relee, millel on m√§rgitud juhtimisahel, v√§ljundvooluring ja relee](../../../../../translated_images/grove-relay-labelled.293e068f5c3c2a199bd7892f2661fdc9e10c920b535cfed317fbd6d1d4ae1168.et.png)

√úlaltoodud pildil on Grove relee. Juhtimisahel √ºhendub IoT-seadmega ja l√ºlitab relee sisse v√µi v√§lja, kasutades 3.3V v√µi 5V. V√§ljundvooluringil on kaks terminali, millest kumbki v√µib olla toide v√µi maandus. V√§ljundvooluring suudab k√§sitleda kuni 250V pinget ja 10A voolu, mis on piisav mitmesuguste koduv√µrgu seadmete jaoks. Saadaval on releed, mis suudavad k√§sitleda veelgi k√µrgemaid energiatasemeid.

![Pump √ºhendatud relee kaudu](../../../../../translated_images/pump-wired-to-relay.66c5cfc0d89189900cd601777f5caeb39ee35c6250f6c86bf38feaceedb21fe9.et.png)

√úlaltoodud pildil tarnitakse pumpa relee kaudu. Punane juhe √ºhendab USB toiteallika +5V terminali relee v√§ljundvooluringi √ºhe terminaliga ja teine punane juhe √ºhendab v√§ljundvooluringi teise terminali pumbaga. Must juhe √ºhendab pumba USB toiteallika maandusega. Kui relee l√ºlitub sisse, l√µpetab see vooluringi, saates pumbale 5V ja l√ºlitades pumba sisse.

## Kuidas juhtida releed

Releed saab juhtida oma IoT arenduskomplektist.

### √úlesanne - relee juhtimine

T√∂√∂tage l√§bi vastav juhend, et juhtida releed oma IoT-seadme abil:

* [Arduino - Wio Terminal](wio-terminal-relay.md)
* [√úheplaadiarvuti - Raspberry Pi](pi-relay.md)
* [√úheplaadiarvuti - Virtuaalne seade](virtual-device-relay.md)

## Kuidas juhtida oma taime MQTT kaudu

Praegu juhib releed IoT-seade otse √ºhe mulla niiskuse m√µ√µtmise p√µhjal. Kommertskastmiss√ºsteemis on juhtimisloogika tsentraliseeritud, v√µimaldades teha kastmisotsuseid mitme sensori andmete p√µhjal ja v√µimaldades konfiguratsiooni muuta √ºhes kohas. Selle simuleerimiseks saate releed juhtida MQTT kaudu.

### √úlesanne - relee juhtimine MQTT kaudu

1. Lisage vastavad MQTT teegid/pip-paketid ja kood oma `soil-moisture-sensor` projekti, et √ºhenduda MQTT-ga. Nimetage kliendi ID `soilmoisturesensor_client`, lisades sellele oma ID.

    > ‚ö†Ô∏è Vajadusel saate viidata [√ºhenduse loomise juhistele MQTT-ga projektis 1, √µppetund 4](../../../1-getting-started/lessons/4-connect-internet/README.md#connect-your-iot-device-to-mqtt).

1. Lisage vastav seadmekood, et saata telemeetriat mulla niiskuse seadistustega. Telemeetria s√µnumi jaoks nimetage omadus `soil_moisture`.

    > ‚ö†Ô∏è Vajadusel saate viidata [telemeetria saatmise juhistele MQTT-sse projektis 1, √µppetund 4](../../../1-getting-started/lessons/4-connect-internet/README.md#send-telemetry-from-your-iot-device).

1. Looge kohalik serverikood, mis tellib telemeetriat ja saadab k√§su relee juhtimiseks kaustas `soil-moisture-sensor-server`. Nimetage k√§sus√µnumi omadus `relay_on` ja seadke kliendi ID `soilmoisturesensor_server`, lisades sellele oma ID. Hoidke sama struktuuri, mis serverikoodil, mille kirjutasite projektis 1, √µppetund 4, kuna lisate sellele koodile hiljem selles √µppetunnis.

    > ‚ö†Ô∏è Vajadusel saate viidata [telemeetria saatmise juhistele MQTT-sse](../../../1-getting-started/lessons/4-connect-internet/README.md#write-the-server-code) ja [k√§skude saatmise juhistele MQTT kaudu](../../../1-getting-started/lessons/4-connect-internet/README.md#send-commands-to-the-mqtt-broker) projektis 1, √µppetund 4.

1. Lisage vastav seadmekood, et juhtida releed saadud k√§skude p√µhjal, kasutades s√µnumi omadust `relay_on`. Saatke `relay_on` jaoks true, kui `soil_moisture` on suurem kui 450, vastasel juhul saatke false, sama loogika, mille lisasite IoT-seadmele varem.

    > ‚ö†Ô∏è Vajadusel saate viidata [k√§skudele MQTT-st reageerimise juhistele projektis 1, √µppetund 4](../../../1-getting-started/lessons/4-connect-internet/README.md#handle-commands-on-the-iot-device).

> üíÅ Selle koodi leiate kaustast [code-mqtt](../../../../../2-farm/lessons/3-automated-plant-watering/code-mqtt).

Veenduge, et kood t√∂√∂tab teie seadmes ja kohalikus serveris, ning testige seda, muutes mulla niiskuse taset, kas virtuaalse sensori saadetud v√§√§rtusi muutes v√µi mulla niiskustaset muutes, lisades vett v√µi eemaldades sensori mullast.

## Sensori ja aktuaatori ajastus

Tagasi √µppetunnis 3 ehitasite √∂√∂lambi ‚Äì LED-i, mis l√ºlitub sisse kohe, kui valguse tase langeb madalale, mida tuvastab valgussensor. Valgussensor tuvastas valguse taseme muutuse koheselt ja seade suutis kiiresti reageerida, piiratud ainult `loop` funktsiooni v√µi `while True:` ts√ºkli viivituse pikkusega. IoT arendajana ei saa te alati sellisele kiirele tagasiside ts√ºklile loota.

### Mulla niiskuse ajastus

Kui tegite eelmise √µppetunni mulla niiskuse kohta f√º√ºsilise sensoriga, m√§rkasite, et mulla niiskuse n√§it langes alles m√µne sekundi p√§rast, kui kastsite oma taime. See ei ole tingitud sensori aeglusest, vaid sellest, et vesi vajab aega, et imbuda l√§bi mulla.

> üíÅ Kui kastsite sensori l√§hedal, v√µisite n√§ha, et n√§it langes kiiresti ja siis t√µusis tagasi ‚Äì see on p√µhjustatud vee levimisest sensori l√§hedalt √ºlej√§√§nud mulda, v√§hendades sensori juures mulla niiskust.

![Mulla niiskuse m√µ√µtmine 658 ei muutu kastmise ajal, langeb alles p√§rast kastmist, kui vesi on imbunud l√§bi mulla](../../../../../translated_images/soil-moisture-travel.a0e31af222cf14385de5380dfc32c7b8213960965228b8e4f7b7ab7f73b310a3.et.png)

√úlaltoodud diagrammil n√§itab mulla niiskuse n√§it 658. Taim kastetakse, kuid see n√§it ei muutu kohe, kuna vesi pole veel sensorini j√µudnud. Kastmine v√µib isegi l√µppeda enne, kui vesi j√µuab sensorini ja v√§√§rtus langeb, kajastades uut niiskustaset.

Kui kirjutaksite koodi kastmiss√ºsteemi juhtimiseks relee kaudu mulla niiskuse taseme p√µhjal, peaksite seda viivitust arvesse v√µtma ja ehitama oma IoT-seadmesse targema ajastuse.

‚úÖ M√µelge hetkeks, kuidas te seda teeksite.

### Sensori ja aktuaatori ajastuse juhtimine
Kujutle, et sul on √ºlesanne ehitada niisutuss√ºsteem farmi jaoks. Pinnase t√º√ºbi p√µhjal on leitud, et taimede ideaalne pinnase niiskustase vastab analoogpingele 400‚Äì450.

Seadme v√µiks programmeerida samamoodi nagu √∂√∂lambi ‚Äì kogu aeg, kui sensor loeb √ºle 450, l√ºlitatakse relee sisse, et pump t√∂√∂le panna. Probleem on aga selles, et vesi vajab aega, et pumbast pinnasesse ja sensorini j√µuda. Sensor peatab vee, kui tuvastab taseme 450, kuid veetase j√§tkab langemist, kuna pumbatud vesi imbub edasi pinnasesse. L√µpptulemuseks on vee raiskamine ja juurte kahjustamise oht.

‚úÖ Pea meeles ‚Äì liiga palju vett v√µib olla taimedele sama kahjulik kui liiga v√§he ning raiskab v√§√§rtuslikku ressurssi.

Parem lahendus on m√µista, et aktuaatori sissel√ºlitamise ja sensori loetava omaduse muutumise vahel on viivitus. See t√§hendab, et sensor peaks mitte ainult ootama enne v√§√§rtuse uuesti m√µ√µtmist, vaid ka aktuaator peaks olema m√µnda aega v√§lja l√ºlitatud enne j√§rgmist sensori m√µ√µtmist.

Kui kaua peaks relee iga kord sees olema? Parem on olla ettevaatlik ja l√ºlitada relee sisse ainult l√ºhikeseks ajaks, seej√§rel oodata, kuni vesi imbub pinnasesse, ja siis uuesti niiskustaset kontrollida. L√µppude l√µpuks saab alati pumpa uuesti sisse l√ºlitada, et vett lisada, kuid pinnasest vett eemaldada ei saa.

> üíÅ Selline ajastuse kontroll on v√§ga spetsiifiline IoT-seadme, m√µ√µdetava omaduse ning kasutatavate sensorite ja aktuaatorite jaoks.

![Maasikataim, mis on √ºhendatud veepumbaga, pump on √ºhendatud releega. Relee ja pinnase niiskuse sensor on m√µlemad √ºhendatud Raspberry Pi-ga](../../../../../translated_images/strawberry-with-pump.b410fc72ac6aabad3e28de9775bf2393ead73dcfec6fd8c9bc01cf107ecd171a.et.png)

N√§iteks mul on maasikataim, millel on pinnase niiskuse sensor ja pump, mida juhib relee. Olen t√§heldanud, et kui vett lisada, kulub umbes 20 sekundit, enne kui pinnase niiskuse n√§it stabiliseerub. See t√§hendab, et pean relee v√§lja l√ºlitama ja ootama 20 sekundit enne niiskustaseme kontrollimist. Pigem liiga v√§he vett kui liiga palju ‚Äì pumpa saab alati uuesti sisse l√ºlitada, kuid taimest vett v√§lja v√µtta ei saa.

![1. samm: m√µ√µda v√§√§rtus. 2. samm: lisa vett. 3. samm: oota, kuni vesi imbub pinnasesse. 4. samm: m√µ√µda uuesti](../../../../../translated_images/soil-moisture-delay.865f3fae206db01d5f8f100f4f44040215d44a0412dd3450aef7ff7b93b6d273.et.png)

See t√§hendab, et parim protsess oleks niisutusts√ºkkel, mis n√§eb v√§lja umbes selline:

* L√ºlita pump sisse 5 sekundiks
* Oota 20 sekundit
* Kontrolli pinnase niiskust
* Kui tase on endiselt √ºle vajaliku, korda √ºlaltoodud samme

5 sekundit v√µib pumba jaoks olla liiga pikk aeg, eriti kui niiskustase on vaid veidi √ºle vajaliku taseme. Parim viis ajastuse m√§√§ramiseks on proovida ja seej√§rel kohandada, kui sensori andmed on saadaval, pideva tagasiside ts√ºkliga. See v√µib viia isegi t√§psema ajastamiseni, n√§iteks pumba sissel√ºlitamine 1 sekundiks iga 100 √ºle vajaliku pinnase niiskuse taseme asemel, mitte fikseeritud 5 sekundiks.

‚úÖ Tee veidi uurimist√∂√∂d: Kas on veel muid ajastuse kaalutlusi? Kas taimi saab kasta igal ajal, kui pinnase niiskus on liiga madal, v√µi on olemas kindlad kellaajad, mis on kastmiseks head ja halvad?

> üíÅ Ilmaennustusi saab samuti arvesse v√µtta, kui kontrollida automaatseid niisutuss√ºsteeme v√§litingimustes kasvatamiseks. Kui on oodata vihma, siis kastmist saab edasi l√ºkata, kuni vihm on l√µppenud. Sel hetkel v√µib pinnas olla piisavalt niiske, et kastmist pole vaja, mis on palju t√µhusam kui vee raiskamine vahetult enne vihma.

## Lisa ajastus oma taimekontrolliserverisse

Serveri koodi saab muuta, et lisada kontroll niisutusts√ºkli ajastuse ja pinnase niiskustaseme muutumise ootamise √ºle. Serveri loogika relee ajastuse kontrollimiseks on j√§rgmine:

1. Telemeetria s√µnum vastu v√µetud
1. Kontrolli pinnase niiskustaset
1. Kui tase on korras, √§ra tee midagi. Kui n√§it on liiga k√µrge (mis t√§hendab, et pinnase niiskus on liiga madal), siis:
    1. Saada k√§sk relee sissel√ºlitamiseks
    1. Oota 5 sekundit
    1. Saada k√§sk relee v√§ljal√ºlitamiseks
    1. Oota 20 sekundit, et pinnase niiskustase stabiliseeruks

Niisutusts√ºkkel, protsess telemeetria s√µnumi vastuv√µtmisest kuni pinnase niiskustaseme uuesti t√∂√∂tlemiseks valmisolekuni, v√µtab umbes 25 sekundit. Me saadame pinnase niiskustaseme andmeid iga 10 sekundi j√§rel, seega on kattuvus, kus s√µnum saadetakse, samal ajal kui server ootab pinnase niiskustaseme stabiliseerumist, mis v√µib k√§ivitada uue niisutusts√ºkli.

Selle lahendamiseks on kaks v√µimalust:

* Muuda IoT-seadme koodi nii, et telemeetria saadetakse ainult iga minut, sel viisil niisutusts√ºkkel l√µppeb enne j√§rgmise s√µnumi saatmist
* T√ºhista telemeetria tellimus niisutusts√ºkli ajal

Esimene v√µimalus ei ole alati hea lahendus suurte farmide jaoks. P√µllumees v√µib soovida salvestada pinnase niiskustaseme andmeid kastmise ajal hilisemaks anal√º√ºsiks, n√§iteks et olla teadlik vee voolust farmi erinevates piirkondades, et suunata sihip√§rasemat kastmist. Teine v√µimalus on parem ‚Äì kood lihtsalt ignoreerib telemeetriat, kui seda ei saa kasutada, kuid telemeetria on endiselt olemas teiste teenuste jaoks, mis v√µivad seda tellida.

> üíÅ IoT-andmeid ei saadeta ainult √ºhest seadmest √ºhele teenusele, vaid paljud seadmed v√µivad saata andmeid vahendajale ja paljud teenused v√µivad neid andmeid vahendajalt kuulata. N√§iteks √ºks teenus v√µib kuulata pinnase niiskuse andmeid ja salvestada need andmebaasi hilisemaks anal√º√ºsiks. Teine teenus v√µib kuulata sama telemeetriat, et juhtida niisutuss√ºsteemi.

### √úlesanne - lisa ajastus oma taimekontrolliserverisse

Uuenda oma serveri koodi, et relee t√∂√∂taks 5 sekundit ja ootaks seej√§rel 20 sekundit.

1. Ava `soil-moisture-sensor-server` kaust VS Code'is, kui see pole juba avatud. Veendu, et virtuaalne keskkond on aktiveeritud.

1. Ava `app.py` fail

1. Lisa j√§rgmine kood `app.py` faili olemasolevate importide alla:

    ```python
    import threading
    ```

    See lause impordib Python'i teegist `threading`, mis v√µimaldab Python'il t√§ita muud koodi ootamise ajal.

1. Lisa j√§rgmine kood enne `handle_telemetry` funktsiooni, mis t√∂√∂tleb serveri koodis vastu v√µetud telemeetria s√µnumeid:

    ```python
    water_time = 5
    wait_time = 20
    ```

    See m√§√§ratleb, kui kaua relee t√∂√∂tab (`water_time`) ja kui kaua p√§rast seda oodatakse, et pinnase niiskust kontrollida (`wait_time`).

1. Lisa selle koodi alla j√§rgmine:

    ```python
    def send_relay_command(client, state):
        command = { 'relay_on' : state }
        print("Sending message:", command)
        client.publish(server_command_topic, json.dumps(command))
    ```

    See kood m√§√§ratleb funktsiooni nimega `send_relay_command`, mis saadab MQTT kaudu k√§su relee juhtimiseks. Telemeetria luuakse s√µnastikuna ja seej√§rel muudetakse JSON-stringiks. `state` v√§√§rtus m√§√§rab, kas relee peaks olema sisse v√µi v√§lja l√ºlitatud.

1. Lisa p√§rast `send_relay_code` funktsiooni j√§rgmine kood:

    ```python
    def control_relay(client):
        print("Unsubscribing from telemetry")
        mqtt_client.unsubscribe(client_telemetry_topic)
    
        send_relay_command(client, True)
        time.sleep(water_time)
        send_relay_command(client, False)
    
        time.sleep(wait_time)
    
        print("Subscribing to telemetry")
        mqtt_client.subscribe(client_telemetry_topic)
    ```

    See m√§√§ratleb funktsiooni relee juhtimiseks vastavalt vajalikele ajastustele. See algab telemeetria tellimuse t√ºhistamisega, et pinnase niiskuse s√µnumeid ei t√∂√∂deldaks kastmise ajal. J√§rgmisena saadab see k√§su relee sissel√ºlitamiseks. Seej√§rel ootab `water_time` enne relee v√§ljal√ºlitamise k√§su saatmist. L√µpuks ootab see `wait_time` sekundeid, et pinnase niiskustase stabiliseeruks. Seej√§rel tellib telemeetria uuesti.

1. Muuda `handle_telemetry` funktsioon j√§rgnevaks:

    ```python
    def handle_telemetry(client, userdata, message):
        payload = json.loads(message.payload.decode())
        print("Message received:", payload)
    
        if payload['soil_moisture'] > 450:
            threading.Thread(target=control_relay, args=(client,)).start()
    ```

    See kood kontrollib pinnase niiskustaset. Kui see on √ºle 450, vajab pinnas kastmist, seega kutsub see `control_relay` funktsiooni. See funktsioon t√∂√∂tab eraldi l√µimes, taustal.

1. Veendu, et sinu IoT-seade t√∂√∂tab, ja k√§ivita see kood. Muuda pinnase niiskustaset ja j√§lgi, mis releega juhtub ‚Äì see peaks t√∂√∂tama 5 sekundit ja j√§√§ma v√§hemalt 20 sekundiks v√§lja, l√ºlitudes sisse ainult siis, kui pinnase niiskustase pole piisav.

    ```output
    (.venv) ‚ûú  soil-moisture-sensor-server ‚úó python app.py
    Message received: {'soil_moisture': 457}
    Unsubscribing from telemetry
    Sending message: {'relay_on': True}
    Sending message: {'relay_on': False}
    Subscribing to telemetry
    Message received: {'soil_moisture': 302}
    ```

    Hea viis seda simuleeritud niisutuss√ºsteemis testida on kasutada kuiva pinnast ja valada vett k√§sitsi, kui relee on sees, peatades valamise, kui relee v√§lja l√ºlitub.

> üíÅ Selle koodi leiad [code-timing](../../../../../2-farm/lessons/3-automated-plant-watering/code-timing) kaustast.

> üíÅ Kui soovid kasutada pumpa, et ehitada p√§ris niisutuss√ºsteem, siis saad kasutada [6V veepumpa](https://www.seeedstudio.com/6V-Mini-Water-Pump-p-1945.html) koos [USB terminali toiteallikaga](https://www.adafruit.com/product/3628). Veendu, et pumba toide oleks relee kaudu √ºhendatud.

---

## üöÄ V√§ljakutse

Kas oskad m√µelda m√µnele teisele IoT- v√µi elektriseadmele, millel on sarnane probleem, kus aktuaatori tulemuste j√µudmine sensorini v√µtab aega? T√µen√§oliselt on sul kodus v√µi koolis paar sellist seadet.

* Milliseid omadusi need m√µ√µdavad?
* Kui kaua v√µtab aega, et omadus muutuks p√§rast aktuaatori kasutamist?
* Kas on okei, kui omadus muutub √ºle vajaliku v√§√§rtuse?
* Kuidas saab vajadusel tagasi viia vajaliku v√§√§rtuse juurde?

## Loengu j√§rgne viktoriin

[Loengu j√§rgne viktoriin](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/14)

## √úlevaade ja iseseisev √µppimine

* Loe rohkem releede kohta, sealhulgas nende ajaloolisest kasutusest telefonikeskjaamades, [relee Wikipedia lehelt](https://wikipedia.org/wiki/Relay).

## √úlesanne

[Ehita t√µhusam kastmists√ºkkel](assignment.md)

---

**Lahti√ºtlus**:  
See dokument on t√µlgitud AI t√µlketeenuse [Co-op Translator](https://github.com/Azure/co-op-translator) abil. Kuigi p√º√ºame tagada t√§psust, palume arvestada, et automaatsed t√µlked v√µivad sisaldada vigu v√µi ebat√§psusi. Algne dokument selle algses keeles tuleks pidada autoriteetseks allikaks. Olulise teabe puhul soovitame kasutada professionaalset inimt√µlget. Me ei vastuta selle t√µlke kasutamisest tulenevate arusaamatuste v√µi valesti t√µlgenduste eest.