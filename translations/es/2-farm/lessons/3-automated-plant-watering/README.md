<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "f7bb24ba53fb627ddb38a8b24a05e594",
  "translation_date": "2025-08-26T14:33:40+00:00",
  "source_file": "2-farm/lessons/3-automated-plant-watering/README.md",
  "language_code": "es"
}
-->
# Riego automatizado de plantas

![Una vista general en sketchnote de esta lecci√≥n](../../../../../translated_images/lesson-7.30b5f577d3cb8e031238751475cb519c7d6dbaea261b5df4643d086ffb2a03bb.es.jpg)

> Sketchnote por [Nitya Narasimhan](https://github.com/nitya). Haz clic en la imagen para una versi√≥n m√°s grande.

Esta lecci√≥n fue impartida como parte de la serie [IoT para principiantes Proyecto 2 - Agricultura digital](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) del [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn).

[![Riego automatizado de plantas impulsado por IoT](https://img.youtube.com/vi/g9FfZwv9R58/0.jpg)](https://youtu.be/g9FfZwv9R58)

## Cuestionario previo a la lecci√≥n

[Cuestionario previo a la lecci√≥n](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/13)

## Introducci√≥n

En la √∫ltima lecci√≥n, aprendiste c√≥mo monitorear la humedad del suelo. En esta lecci√≥n aprender√°s a construir los componentes principales de un sistema de riego automatizado que responde a la humedad del suelo. Tambi√©n aprender√°s sobre el tiempo de respuesta: c√≥mo los sensores pueden tardar en reaccionar a los cambios y c√≥mo los actuadores pueden tardar en modificar las propiedades que los sensores est√°n midiendo.

En esta lecci√≥n cubriremos:

* [Controlar dispositivos de alta potencia desde un dispositivo IoT de baja potencia](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Controlar un rel√©](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Controlar tu planta mediante MQTT](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Tiempo de respuesta de sensores y actuadores](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Agregar temporizaci√≥n al servidor de control de tu planta](../../../../../2-farm/lessons/3-automated-plant-watering)

## Controlar dispositivos de alta potencia desde un dispositivo IoT de baja potencia

Los dispositivos IoT utilizan un voltaje bajo. Aunque esto es suficiente para sensores y actuadores de baja potencia como LEDs, es demasiado bajo para controlar hardware m√°s grande, como una bomba de agua utilizada para riego. Incluso las bombas peque√±as que podr√≠as usar para plantas de interior consumen demasiada corriente para un kit de desarrollo IoT y podr√≠an da√±ar la placa.

> üéì La corriente, medida en amperios (A), es la cantidad de electricidad que fluye a trav√©s de un circuito. El voltaje proporciona el empuje, la corriente es cu√°nto se empuja. Puedes leer m√°s sobre la corriente en la [p√°gina de corriente el√©ctrica en Wikipedia](https://wikipedia.org/wiki/Electric_current).

La soluci√≥n a esto es conectar una bomba a una fuente de alimentaci√≥n externa y usar un actuador para encender la bomba, similar a c√≥mo encender√≠as una luz. Se necesita una peque√±a cantidad de energ√≠a (en forma de energ√≠a en tu cuerpo) para que tu dedo accione un interruptor, y esto conecta la luz a la electricidad de red que funciona a 110v/240v.

![Un interruptor de luz enciende la luz](../../../../../translated_images/light-switch.760317ad6ab8bd6d611da5352dfe9c73a94a0822ccec7df3c8bae35da18e1658.es.png)

> üéì [Electricidad de red](https://wikipedia.org/wiki/Mains_electricity) se refiere a la electricidad entregada a hogares y negocios a trav√©s de infraestructura nacional en muchas partes del mundo.

‚úÖ Los dispositivos IoT generalmente pueden proporcionar 3.3V o 5V, con menos de 1 amperio (1A) de corriente. Comparado con la electricidad de red, que suele ser de 230V (120V en Am√©rica del Norte y 100V en Jap√≥n), y puede proporcionar energ√≠a para dispositivos que consumen hasta 30A.

Existen varios actuadores que pueden hacer esto, incluidos dispositivos mec√°nicos que puedes conectar a interruptores existentes para imitar un dedo encendi√©ndolos. El m√°s popular es un rel√©.

### Rel√©s

Un rel√© es un interruptor electromec√°nico que convierte una se√±al el√©ctrica en un movimiento mec√°nico que enciende un interruptor. El n√∫cleo de un rel√© es un electroim√°n.

> üéì [Electroimanes](https://wikipedia.org/wiki/Electromagnet) son imanes que se crean al pasar electricidad a trav√©s de una bobina de alambre. Cuando la electricidad est√° encendida, la bobina se magnetiza. Cuando la electricidad est√° apagada, la bobina pierde su magnetismo.

![Cuando est√° encendido, el electroim√°n crea un campo magn√©tico, activando el interruptor del circuito de salida](../../../../../translated_images/relay-on.4db16a0fd6b669262fd6699aff3fbcd31b6057c06d90411b6bddc06326d1cf75.es.png)

En un rel√©, un circuito de control alimenta el electroim√°n. Cuando el electroim√°n est√° encendido, tira de una palanca que mueve un interruptor, cerrando un par de contactos y completando un circuito de salida.

![Cuando est√° apagado, el electroim√°n no crea un campo magn√©tico, desactivando el interruptor del circuito de salida](../../../../../translated_images/relay-off.c34a178a2960fecdc3c6400d43e633ed11c6746cd653cfb4a768fa097c40394c.es.png)

Cuando el circuito de control est√° apagado, el electroim√°n se apaga, liberando la palanca y abriendo los contactos, apagando el circuito de salida. Los rel√©s son actuadores digitales: una se√±al alta al rel√© lo enciende, una se√±al baja lo apaga.

El circuito de salida puede usarse para alimentar hardware adicional, como un sistema de riego. El dispositivo IoT puede encender el rel√©, completando el circuito de salida que alimenta el sistema de riego, y las plantas se riegan. Luego, el dispositivo IoT puede apagar el rel√©, cortando la energ√≠a al sistema de riego y deteniendo el agua.

![Un rel√© encendi√©ndose, activando una bomba que env√≠a agua a una planta](../../../../../images/strawberry-pump.gif)

En el video anterior, se enciende un rel√©. Un LED en el rel√© se ilumina para indicar que est√° encendido (algunas placas de rel√© tienen LEDs para indicar si el rel√© est√° encendido o apagado), y se env√≠a energ√≠a a la bomba, activ√°ndola y bombeando agua a una planta.

> üíÅ Los rel√©s tambi√©n pueden usarse para alternar entre dos circuitos de salida en lugar de encender y apagar uno. A medida que la palanca se mueve, cambia un interruptor de completar un circuito de salida a completar un circuito de salida diferente, generalmente compartiendo una conexi√≥n de alimentaci√≥n com√∫n o una conexi√≥n de tierra com√∫n.

‚úÖ Investiga: Hay m√∫ltiples tipos de rel√©s, con diferencias como si el circuito de control enciende o apaga el rel√© cuando se aplica energ√≠a, o m√∫ltiples circuitos de salida. Investiga sobre estos diferentes tipos.

Cuando la palanca se mueve, generalmente puedes escucharla hacer contacto con el electroim√°n con un ruido de clic bien definido.

> üíÅ Un rel√© puede cablearse de manera que al hacer la conexi√≥n realmente interrumpa la energ√≠a al rel√©, apag√°ndolo, lo que luego env√≠a energ√≠a al rel√© encendi√©ndolo nuevamente, y as√≠ sucesivamente. Esto significa que el rel√© har√° clic incre√≠blemente r√°pido, produciendo un ruido de zumbido. As√≠ es como funcionaban algunos de los primeros timbres el√©ctricos utilizados en puertas.

### Energ√≠a del rel√©

El electroim√°n no necesita mucha energ√≠a para activarse y tirar de la palanca, puede controlarse utilizando la salida de 3.3V o 5V de un kit de desarrollo IoT. El circuito de salida puede transportar mucha m√°s energ√≠a, dependiendo del rel√©, incluyendo voltaje de red o incluso niveles de energ√≠a m√°s altos para uso industrial. De esta manera, un kit de desarrollo IoT puede controlar un sistema de riego, desde una peque√±a bomba para una sola planta, hasta un sistema industrial masivo para toda una granja comercial.

![Un rel√© Grove con el circuito de control, circuito de salida y rel√© etiquetados](../../../../../translated_images/grove-relay-labelled.293e068f5c3c2a199bd7892f2661fdc9e10c920b535cfed317fbd6d1d4ae1168.es.png)

La imagen anterior muestra un rel√© Grove. El circuito de control se conecta a un dispositivo IoT y enciende o apaga el rel√© utilizando 3.3V o 5V. El circuito de salida tiene dos terminales, cualquiera de ellos puede ser alimentaci√≥n o tierra. El circuito de salida puede manejar hasta 250V a 10A, suficiente para una variedad de dispositivos alimentados por red. Puedes obtener rel√©s que pueden manejar incluso niveles de energ√≠a m√°s altos.

![Una bomba conectada a trav√©s de un rel√©](../../../../../translated_images/pump-wired-to-relay.66c5cfc0d89189900cd601777f5caeb39ee35c6250f6c86bf38feaceedb21fe9.es.png)

En la imagen anterior, la energ√≠a se suministra a una bomba a trav√©s de un rel√©. Hay un cable rojo que conecta el terminal +5V de una fuente de alimentaci√≥n USB a un terminal del circuito de salida del rel√©, y otro cable rojo que conecta el otro terminal del circuito de salida a la bomba. Un cable negro conecta la bomba a la tierra de la fuente de alimentaci√≥n USB. Cuando el rel√© se enciende, completa el circuito, enviando 5V a la bomba y activ√°ndola.

## Controlar un rel√©

Puedes controlar un rel√© desde tu kit de desarrollo IoT.

### Tarea - controlar un rel√©

Sigue la gu√≠a correspondiente para controlar un rel√© utilizando tu dispositivo IoT:

* [Arduino - Wio Terminal](wio-terminal-relay.md)
* [Computadora de placa √∫nica - Raspberry Pi](pi-relay.md)
* [Computadora de placa √∫nica - Dispositivo virtual](virtual-device-relay.md)

## Controlar tu planta mediante MQTT

Hasta ahora, tu rel√© es controlado directamente por el dispositivo IoT basado en una sola lectura de humedad del suelo. En un sistema de riego comercial, la l√≥gica de control estar√° centralizada, permitiendo tomar decisiones sobre el riego utilizando datos de m√∫ltiples sensores y permitiendo que cualquier configuraci√≥n se cambie en un solo lugar. Para simular esto, puedes controlar el rel√© mediante MQTT.

### Tarea - controlar el rel√© mediante MQTT

1. Agrega las bibliotecas/pip packages y el c√≥digo relevantes de MQTT a tu proyecto `soil-moisture-sensor` para conectarte a MQTT. Nombra el ID del cliente como `soilmoisturesensor_client` precedido por tu ID.

    > ‚ö†Ô∏è Puedes consultar [las instrucciones para conectarte a MQTT en el proyecto 1, lecci√≥n 4 si es necesario](../../../1-getting-started/lessons/4-connect-internet/README.md#connect-your-iot-device-to-mqtt).

1. Agrega el c√≥digo del dispositivo relevante para enviar telemetr√≠a con las configuraciones de humedad del suelo. Para el mensaje de telemetr√≠a, nombra la propiedad `soil_moisture`.

    > ‚ö†Ô∏è Puedes consultar [las instrucciones para enviar telemetr√≠a a MQTT en el proyecto 1, lecci√≥n 4 si es necesario](../../../1-getting-started/lessons/4-connect-internet/README.md#send-telemetry-from-your-iot-device).

1. Crea un c√≥digo de servidor local para suscribirte a la telemetr√≠a y enviar un comando para controlar el rel√© en una carpeta llamada `soil-moisture-sensor-server`. Nombra la propiedad en el mensaje de comando `relay_on`, y establece el ID del cliente como `soilmoisturesensor_server` precedido por tu ID. Mant√©n la misma estructura que el c√≥digo del servidor que escribiste para el proyecto 1, lecci√≥n 4, ya que agregar√°s m√°s c√≥digo a este m√°s adelante en esta lecci√≥n.

    > ‚ö†Ô∏è Puedes consultar [las instrucciones para enviar telemetr√≠a a MQTT](../../../1-getting-started/lessons/4-connect-internet/README.md#write-the-server-code) y [enviar comandos mediante MQTT](../../../1-getting-started/lessons/4-connect-internet/README.md#send-commands-to-the-mqtt-broker) en el proyecto 1, lecci√≥n 4 si es necesario.

1. Agrega el c√≥digo del dispositivo relevante para controlar el rel√© a partir de los comandos recibidos, utilizando la propiedad `relay_on` del mensaje. Env√≠a true para `relay_on` si el `soil_moisture` es mayor que 450, de lo contrario env√≠a false, igual que la l√≥gica que agregaste para el dispositivo IoT anteriormente.

    > ‚ö†Ô∏è Puedes consultar [las instrucciones para responder a comandos de MQTT en el proyecto 1, lecci√≥n 4 si es necesario](../../../1-getting-started/lessons/4-connect-internet/README.md#handle-commands-on-the-iot-device).

> üíÅ Puedes encontrar este c√≥digo en la carpeta [code-mqtt](../../../../../2-farm/lessons/3-automated-plant-watering/code-mqtt).

Aseg√∫rate de que el c√≥digo est√© ejecut√°ndose en tu dispositivo y servidor local, y pru√©balo cambiando los niveles de humedad del suelo, ya sea modificando los valores enviados por el sensor virtual o cambiando los niveles de humedad del suelo agregando agua o retirando el sensor del suelo.

## Tiempo de respuesta de sensores y actuadores

En la lecci√≥n 3 construiste una luz nocturna: un LED que se enciende tan pronto como un nivel bajo de luz es detectado por un sensor de luz. El sensor de luz detect√≥ un cambio en los niveles de luz instant√°neamente, y el dispositivo pudo responder r√°pidamente, limitado solo por la duraci√≥n del retraso en la funci√≥n `loop` o el bucle `while True:`. Como desarrollador de IoT, no siempre puedes confiar en un ciclo de retroalimentaci√≥n tan r√°pido.

### Temporizaci√≥n para la humedad del suelo

Si realizaste la √∫ltima lecci√≥n sobre humedad del suelo utilizando un sensor f√≠sico, habr√°s notado que tom√≥ unos segundos para que la lectura de humedad del suelo bajara despu√©s de regar tu planta. Esto no se debe a que el sensor sea lento, sino a que el agua tarda en filtrarse a trav√©s del suelo.
üíÅ Si regaste demasiado cerca del sensor, es posible que hayas notado que la lectura baj√≥ r√°pidamente y luego volvi√≥ a subir. Esto ocurre porque el agua cerca del sensor se dispersa por el resto del suelo, reduciendo la humedad del suelo alrededor del sensor.
![Una medici√≥n de humedad del suelo de 658 no cambia durante el riego, solo baja a 320 despu√©s de que el agua ha empapado el suelo](../../../../../translated_images/soil-moisture-travel.a0e31af222cf14385de5380dfc32c7b8213960965228b8e4f7b7ab7f73b310a3.es.png)

En el diagrama anterior, una lectura de humedad del suelo muestra 658. La planta es regada, pero esta lectura no cambia inmediatamente, ya que el agua a√∫n no ha llegado al sensor. Incluso el riego puede terminar antes de que el agua alcance el sensor y el valor baje para reflejar el nuevo nivel de humedad.

Si estuvieras escribiendo c√≥digo para controlar un sistema de riego mediante un rel√© basado en los niveles de humedad del suelo, tendr√≠as que tener en cuenta este retraso y construir un sistema de temporizaci√≥n m√°s inteligente en tu dispositivo IoT.

‚úÖ T√≥mate un momento para pensar c√≥mo podr√≠as hacer esto.

### Controlar la temporizaci√≥n del sensor y el actuador

Imagina que te han encargado construir un sistema de riego para una granja. Seg√∫n el tipo de suelo, se ha determinado que el nivel ideal de humedad del suelo para las plantas corresponde a una lectura de voltaje anal√≥gico de 400-450.

Podr√≠as programar el dispositivo de la misma manera que una luz nocturna: todo el tiempo que el sensor lea por encima de 450, encender un rel√© para activar una bomba. El problema es que el agua tarda un tiempo en llegar desde la bomba, atravesar el suelo y alcanzar el sensor. El sensor detendr√° el agua cuando detecte un nivel de 450, pero el nivel de agua seguir√° bajando mientras el agua bombeada sigue empapando el suelo. El resultado final es agua desperdiciada y el riesgo de da√±ar las ra√≠ces.

‚úÖ Recuerda: demasiada agua puede ser tan perjudicial para las plantas como muy poca, y desperdicia un recurso valioso.

La mejor soluci√≥n es entender que hay un retraso entre el momento en que el actuador se activa y el cambio en la propiedad que el sensor mide. Esto significa que no solo el sensor debe esperar un tiempo antes de medir el valor nuevamente, sino que el actuador debe apagarse por un tiempo antes de que se realice la siguiente medici√≥n del sensor.

¬øCu√°nto tiempo debe estar encendido el rel√© cada vez? Es mejor pecar de precavido y encender el rel√© solo por un corto tiempo, luego esperar a que el agua empape el suelo y volver a verificar los niveles de humedad. Despu√©s de todo, siempre puedes encenderlo nuevamente para agregar m√°s agua, pero no puedes quitar agua del suelo.

> üíÅ Este tipo de control de temporizaci√≥n es muy espec√≠fico para el dispositivo IoT que est√°s construyendo, la propiedad que est√°s midiendo y los sensores y actuadores utilizados.

![Una planta de fresa conectada al agua mediante una bomba, con la bomba conectada a un rel√©. El rel√© y un sensor de humedad del suelo en la planta est√°n conectados a un Raspberry Pi](../../../../../translated_images/strawberry-with-pump.b410fc72ac6aabad3e28de9775bf2393ead73dcfec6fd8c9bc01cf107ecd171a.es.png)

Por ejemplo, tengo una planta de fresa con un sensor de humedad del suelo y una bomba controlada por un rel√©. He observado que cuando agrego agua, tarda unos 20 segundos en estabilizarse la lectura de humedad del suelo. Esto significa que necesito apagar el rel√© y esperar 20 segundos antes de verificar los niveles de humedad. Prefiero tener poca agua que demasiada: siempre puedo encender la bomba nuevamente, pero no puedo quitar agua de la planta.

![Paso 1, tomar medici√≥n. Paso 2, agregar agua. Paso 3, esperar a que el agua empape el suelo. Paso 4, volver a tomar medici√≥n](../../../../../translated_images/soil-moisture-delay.865f3fae206db01d5f8f100f4f44040215d44a0412dd3450aef7ff7b93b6d273.es.png)

Esto significa que el mejor proceso ser√≠a un ciclo de riego que sea algo como:

* Encender la bomba durante 5 segundos
* Esperar 20 segundos
* Verificar la humedad del suelo
* Si el nivel sigue siendo superior al necesario, repetir los pasos anteriores

5 segundos podr√≠an ser demasiado tiempo para la bomba, especialmente si los niveles de humedad est√°n solo ligeramente por encima del nivel requerido. La mejor manera de saber qu√© temporizaci√≥n usar es probarla y luego ajustarla cuando tengas datos del sensor, con un bucle de retroalimentaci√≥n constante. Esto incluso puede llevar a una temporizaci√≥n m√°s granular, como encender la bomba durante 1 segundo por cada 100 por encima del nivel de humedad requerido, en lugar de un tiempo fijo de 5 segundos.

‚úÖ Investiga: ¬øExisten otras consideraciones de temporizaci√≥n? ¬øSe puede regar la planta en cualquier momento que la humedad del suelo sea demasiado baja, o hay momentos espec√≠ficos del d√≠a que son buenos y malos para regar las plantas?

> üíÅ Las predicciones meteorol√≥gicas tambi√©n pueden tomarse en cuenta al controlar sistemas de riego automatizados para cultivos al aire libre. Si se espera lluvia, entonces el riego puede posponerse hasta despu√©s de que termine la lluvia. En ese momento, el suelo podr√≠a estar lo suficientemente h√∫medo como para no necesitar riego, mucho m√°s eficiente que desperdiciar agua regando justo antes de la lluvia.

## Agregar temporizaci√≥n a tu servidor de control de plantas

El c√≥digo del servidor puede modificarse para agregar control alrededor de la temporizaci√≥n del ciclo de riego y esperar a que los niveles de humedad del suelo cambien. La l√≥gica del servidor para controlar la temporizaci√≥n del rel√© es:

1. Mensaje de telemetr√≠a recibido
1. Verificar el nivel de humedad del suelo
1. Si est√° bien, no hacer nada. Si la lectura es demasiado alta (lo que significa que la humedad del suelo es demasiado baja), entonces:
    1. Enviar un comando para encender el rel√©
    1. Esperar 5 segundos
    1. Enviar un comando para apagar el rel√©
    1. Esperar 20 segundos para que los niveles de humedad del suelo se estabilicen

El ciclo de riego, el proceso desde recibir el mensaje de telemetr√≠a hasta estar listo para procesar nuevamente los niveles de humedad del suelo, toma aproximadamente 25 segundos. Estamos enviando niveles de humedad del suelo cada 10 segundos, por lo que hay un solapamiento donde se recibe un mensaje mientras el servidor est√° esperando que los niveles de humedad del suelo se estabilicen, lo que podr√≠a iniciar otro ciclo de riego.

Hay dos opciones para solucionar esto:

* Cambiar el c√≥digo del dispositivo IoT para enviar telemetr√≠a solo cada minuto, de esta manera el ciclo de riego se completar√° antes de que se env√≠e el siguiente mensaje
* Cancelar la suscripci√≥n a la telemetr√≠a durante el ciclo de riego

La primera opci√≥n no siempre es una buena soluci√≥n para grandes granjas. El agricultor podr√≠a querer capturar los niveles de humedad del suelo mientras se est√° regando para un an√°lisis posterior, por ejemplo, para estar al tanto del flujo de agua en diferentes √°reas de la granja y guiar un riego m√°s espec√≠fico. La segunda opci√≥n es mejor: el c√≥digo simplemente ignora la telemetr√≠a cuando no puede usarla, pero la telemetr√≠a sigue estando disponible para otros servicios que puedan suscribirse a ella.

> üíÅ Los datos de IoT no se env√≠an desde un solo dispositivo a un solo servicio, en cambio, muchos dispositivos pueden enviar datos a un broker, y muchos servicios pueden escuchar los datos del broker. Por ejemplo, un servicio podr√≠a escuchar los datos de humedad del suelo y almacenarlos en una base de datos para an√°lisis posterior. Otro servicio tambi√©n puede escuchar la misma telemetr√≠a para controlar un sistema de riego.

### Tarea - agregar temporizaci√≥n a tu servidor de control de plantas

Actualiza tu c√≥digo de servidor para ejecutar el rel√© durante 5 segundos y luego esperar 20 segundos.

1. Abre la carpeta `soil-moisture-sensor-server` en VS Code si a√∫n no est√° abierta. Aseg√∫rate de que el entorno virtual est√© activado.

1. Abre el archivo `app.py`

1. Agrega el siguiente c√≥digo al archivo `app.py` debajo de las importaciones existentes:

    ```python
    import threading
    ```

    Esta declaraci√≥n importa `threading` de las bibliotecas de Python. Threading permite que Python ejecute otro c√≥digo mientras espera.

1. Agrega el siguiente c√≥digo antes de la funci√≥n `handle_telemetry` que maneja los mensajes de telemetr√≠a recibidos por el c√≥digo del servidor:

    ```python
    water_time = 5
    wait_time = 20
    ```

    Esto define cu√°nto tiempo ejecutar el rel√© (`water_time`) y cu√°nto tiempo esperar despu√©s para verificar la humedad del suelo (`wait_time`).

1. Debajo de este c√≥digo, agrega lo siguiente:

    ```python
    def send_relay_command(client, state):
        command = { 'relay_on' : state }
        print("Sending message:", command)
        client.publish(server_command_topic, json.dumps(command))
    ```

    Este c√≥digo define una funci√≥n llamada `send_relay_command` que env√≠a un comando a trav√©s de MQTT para controlar el rel√©. La telemetr√≠a se crea como un diccionario y luego se convierte en una cadena JSON. El valor pasado en `state` determina si el rel√© debe estar encendido o apagado.

1. Despu√©s de la funci√≥n `send_relay_code`, agrega el siguiente c√≥digo:

    ```python
    def control_relay(client):
        print("Unsubscribing from telemetry")
        mqtt_client.unsubscribe(client_telemetry_topic)
    
        send_relay_command(client, True)
        time.sleep(water_time)
        send_relay_command(client, False)
    
        time.sleep(wait_time)
    
        print("Subscribing to telemetry")
        mqtt_client.subscribe(client_telemetry_topic)
    ```

    Esto define una funci√≥n para controlar el rel√© seg√∫n la temporizaci√≥n requerida. Comienza cancelando la suscripci√≥n a la telemetr√≠a para que los mensajes de humedad del suelo no se procesen mientras se realiza el riego. Luego env√≠a un comando para encender el rel√©. Despu√©s espera el tiempo definido en `water_time` antes de enviar un comando para apagar el rel√©. Finalmente, espera que los niveles de humedad del suelo se estabilicen durante el tiempo definido en `wait_time`. Luego vuelve a suscribirse a la telemetr√≠a.

1. Cambia la funci√≥n `handle_telemetry` por la siguiente:

    ```python
    def handle_telemetry(client, userdata, message):
        payload = json.loads(message.payload.decode())
        print("Message received:", payload)
    
        if payload['soil_moisture'] > 450:
            threading.Thread(target=control_relay, args=(client,)).start()
    ```

    Este c√≥digo verifica el nivel de humedad del suelo. Si es mayor que 450, el suelo necesita riego, por lo que llama a la funci√≥n `control_relay`. Esta funci√≥n se ejecuta en un hilo separado, funcionando en segundo plano.

1. Aseg√∫rate de que tu dispositivo IoT est√© funcionando, luego ejecuta este c√≥digo. Cambia los niveles de humedad del suelo y observa qu√© sucede con el rel√©: deber√≠a encenderse durante 5 segundos y luego permanecer apagado al menos 20 segundos, encendi√©ndose solo si los niveles de humedad del suelo no son suficientes.

    ```output
    (.venv) ‚ûú  soil-moisture-sensor-server ‚úó python app.py
    Message received: {'soil_moisture': 457}
    Unsubscribing from telemetry
    Sending message: {'relay_on': True}
    Sending message: {'relay_on': False}
    Subscribing to telemetry
    Message received: {'soil_moisture': 302}
    ```

    Una buena manera de probar esto en un sistema de riego simulado es usar suelo seco y luego verter agua manualmente mientras el rel√© est√° encendido, deteniendo el vertido cuando el rel√© se apaga.

> üíÅ Puedes encontrar este c√≥digo en la carpeta [code-timing](../../../../../2-farm/lessons/3-automated-plant-watering/code-timing).

> üíÅ Si deseas usar una bomba para construir un sistema de riego real, puedes usar una [bomba de agua de 6V](https://www.seeedstudio.com/6V-Mini-Water-Pump-p-1945.html) con una [fuente de alimentaci√≥n USB](https://www.adafruit.com/product/3628). Aseg√∫rate de que la alimentaci√≥n hacia o desde la bomba est√© conectada a trav√©s del rel√©.

---

## üöÄ Desaf√≠o

¬øPuedes pensar en otros dispositivos IoT o el√©ctricos que tengan un problema similar donde los resultados del actuador tardan en llegar al sensor? Probablemente tengas algunos en tu casa o escuela.

* ¬øQu√© propiedades miden?
* ¬øCu√°nto tiempo tarda en cambiar la propiedad despu√©s de que se usa un actuador?
* ¬øEst√° bien que la propiedad cambie m√°s all√° del valor requerido?
* ¬øC√≥mo puede volver al valor requerido si es necesario?

## Cuestionario posterior a la clase

[Cuestionario posterior a la clase](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/14)

## Revisi√≥n y autoestudio

* Lee m√°s sobre rel√©s, incluyendo su uso hist√≥rico en centrales telef√≥nicas, en la [p√°gina de Wikipedia sobre rel√©s](https://wikipedia.org/wiki/Relay).

## Asignaci√≥n

[Construir un ciclo de riego m√°s eficiente](assignment.md)

---

**Descargo de responsabilidad**:  
Este documento ha sido traducido utilizando el servicio de traducci√≥n autom√°tica [Co-op Translator](https://github.com/Azure/co-op-translator). Si bien nos esforzamos por garantizar la precisi√≥n, tenga en cuenta que las traducciones automatizadas pueden contener errores o imprecisiones. El documento original en su idioma nativo debe considerarse la fuente autorizada. Para informaci√≥n cr√≠tica, se recomienda una traducci√≥n profesional realizada por humanos. No nos hacemos responsables de malentendidos o interpretaciones err√≥neas que puedan surgir del uso de esta traducci√≥n.