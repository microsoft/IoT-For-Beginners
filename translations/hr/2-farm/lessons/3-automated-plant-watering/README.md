<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "f7bb24ba53fb627ddb38a8b24a05e594",
  "translation_date": "2025-08-28T15:18:54+00:00",
  "source_file": "2-farm/lessons/3-automated-plant-watering/README.md",
  "language_code": "hr"
}
-->
# Automatsko zalijevanje biljaka

![Sketchnote pregled ove lekcije](../../../../../translated_images/lesson-7.30b5f577d3cb8e031238751475cb519c7d6dbaea261b5df4643d086ffb2a03bb.hr.jpg)

> Sketchnote autorice [Nitya Narasimhan](https://github.com/nitya). Kliknite na sliku za veƒáu verziju.

Ova lekcija je dio [IoT za poƒçetnike Projekt 2 - Digitalna poljoprivreda serije](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) iz [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn).

[![IoT pogonjeno automatsko zalijevanje biljaka](https://img.youtube.com/vi/g9FfZwv9R58/0.jpg)](https://youtu.be/g9FfZwv9R58)

## Kviz prije predavanja

[Kviz prije predavanja](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/13)

## Uvod

U prethodnoj lekciji nauƒçili ste kako pratiti vla≈ænost tla. U ovoj lekciji nauƒçit ƒáete kako izraditi osnovne komponente sustava za automatsko zalijevanje koji reagira na vla≈ænost tla. Takoƒëer ƒáete nauƒçiti o vremenskom aspektu - kako senzorima mo≈æe trebati neko vrijeme da reagiraju na promjene i kako aktuatorima mo≈æe trebati vremena da promijene svojstva koja senzori mjere.

U ovoj lekciji obradit ƒáemo:

* [Upravljanje ureƒëajima visoke snage s IoT ureƒëajem niske snage](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Upravljanje relejem](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Upravljanje biljkom putem MQTT-a](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Vremensko usklaƒëivanje senzora i aktuatora](../../../../../2-farm/lessons/3-automated-plant-watering)
* [Dodavanje vremenskog usklaƒëivanja na va≈° poslu≈æitelj za upravljanje biljkama](../../../../../2-farm/lessons/3-automated-plant-watering)

## Upravljanje ureƒëajima visoke snage s IoT ureƒëajem niske snage

IoT ureƒëaji koriste napon niske razine. Iako je to dovoljno za senzore i aktuatora niske snage poput LED-ica, to je premalo za upravljanje veƒáim hardverom, poput pumpe za vodu koja se koristi za navodnjavanje. ƒåak i male pumpe koje biste mogli koristiti za sobne biljke tro≈°e previ≈°e struje za IoT razvojni komplet i mogle bi o≈°tetiti ploƒçu.

> üéì Struja, mjerena u amperima (A), predstavlja koliƒçinu elektriƒçne energije koja prolazi kroz krug. Napon pru≈æa potisak, dok struja pokazuje koliko se energije potiskuje. Vi≈°e o struji mo≈æete proƒçitati na [stranici o elektriƒçnoj struji na Wikipediji](https://wikipedia.org/wiki/Electric_current).

Rje≈°enje za ovo je povezivanje pumpe na vanjski izvor napajanja i kori≈°tenje aktuatora za ukljuƒçivanje pumpe, sliƒçno kao ≈°to biste ukljuƒçili svjetlo. Potrebna je mala koliƒçina energije (u obliku energije va≈°eg tijela) da prstom pritisnete prekidaƒç, ƒçime se svjetlo povezuje s mre≈ænim napajanjem od 110V/240V.

![Prekidaƒç ukljuƒçuje napajanje za svjetlo](../../../../../translated_images/light-switch.760317ad6ab8bd6d611da5352dfe9c73a94a0822ccec7df3c8bae35da18e1658.hr.png)

> üéì [Mre≈æna struja](https://wikipedia.org/wiki/Mains_electricity) odnosi se na elektriƒçnu energiju koja se isporuƒçuje kuƒáama i poslovnim prostorima putem nacionalne infrastrukture u mnogim dijelovima svijeta.

‚úÖ IoT ureƒëaji obiƒçno pru≈æaju 3.3V ili 5V, s manje od 1 ampera (1A) struje. Usporedite to s mre≈ænom strujom koja je najƒçe≈°ƒáe na 230V (120V u Sjevernoj Americi i 100V u Japanu) i mo≈æe napajati ureƒëaje koji tro≈°e 30A.

Postoji niz aktuatora koji to mogu uƒçiniti, ukljuƒçujuƒái mehaniƒçke ureƒëaje koje mo≈æete priƒçvrstiti na postojeƒáe prekidaƒçe i koji opona≈°aju prst koji ih ukljuƒçuje. Najpopularniji je relej.

### Releji

Relej je elektromehaniƒçki prekidaƒç koji pretvara elektriƒçni signal u mehaniƒçki pokret koji ukljuƒçuje prekidaƒç. Osnova releja je elektromagnet.

> üéì [Elektromagneti](https://wikipedia.org/wiki/Electromagnet) su magneti koji se stvaraju prolaskom elektriƒçne struje kroz zavojnicu ≈æice. Kada je struja ukljuƒçena, zavojnica postaje magnetizirana. Kada je struja iskljuƒçena, zavojnica gubi magnetizam.

![Kada je ukljuƒçen, elektromagnet stvara magnetsko polje, ukljuƒçujuƒái prekidaƒç za izlazni krug](../../../../../translated_images/relay-on.4db16a0fd6b669262fd6699aff3fbcd31b6057c06d90411b6bddc06326d1cf75.hr.png)

U releju, kontrolni krug napaja elektromagnet. Kada je elektromagnet ukljuƒçen, povlaƒçi polugu koja pomiƒçe prekidaƒç, zatvarajuƒái par kontakata i dovr≈°avajuƒái izlazni krug.

![Kada je iskljuƒçen, elektromagnet ne stvara magnetsko polje, iskljuƒçujuƒái prekidaƒç za izlazni krug](../../../../../translated_images/relay-off.c34a178a2960fecdc3c6400d43e633ed11c6746cd653cfb4a768fa097c40394c.hr.png)

Kada je kontrolni krug iskljuƒçen, elektromagnet se iskljuƒçuje, oslobaƒëajuƒái polugu i otvarajuƒái kontakte, iskljuƒçujuƒái izlazni krug. Releji su digitalni aktuatori - visoki signal prema releju ga ukljuƒçuje, niski signal ga iskljuƒçuje.

Izlazni krug mo≈æe se koristiti za napajanje dodatnog hardvera, poput sustava za navodnjavanje. IoT ureƒëaj mo≈æe ukljuƒçiti relej, dovr≈°avajuƒái izlazni krug koji napaja sustav za navodnjavanje, i biljke se zalijevaju. IoT ureƒëaj zatim mo≈æe iskljuƒçiti relej, prekidajuƒái napajanje sustava za navodnjavanje, iskljuƒçujuƒái vodu.

![Relej se ukljuƒçuje, ukljuƒçujuƒái pumpu koja ≈°alje vodu biljci](../../../../../images/strawberry-pump.gif)

U videu iznad, relej se ukljuƒçuje. LED na releju svijetli kako bi pokazao da je ukljuƒçen (neke ploƒçe releja imaju LED-ice koje pokazuju je li relej ukljuƒçen ili iskljuƒçen), a napajanje se ≈°alje pumpi, ukljuƒçujuƒái je i pumpajuƒái vodu u biljku.

> üíÅ Releji se takoƒëer mogu koristiti za prebacivanje izmeƒëu dva izlazna kruga umjesto ukljuƒçivanja i iskljuƒçivanja jednog. Kako se poluga pomiƒçe, pomiƒçe prekidaƒç s dovr≈°avanja jednog izlaznog kruga na dovr≈°avanje drugog izlaznog kruga, obiƒçno dijeleƒái zajedniƒçku vezu napajanja ili zajedniƒçku uzemljenje.

‚úÖ Istra≈æite: Postoji vi≈°e vrsta releja, s razlikama poput toga ukljuƒçuje li kontrolni krug relej kada je napajanje primijenjeno ili ga iskljuƒçuje, ili s vi≈°e izlaznih krugova. Saznajte vi≈°e o tim razliƒçitim vrstama.

Kada se poluga pomiƒçe, obiƒçno mo≈æete ƒçuti kako stvara kontakt s elektromagnetom uz jasno definiran zvuk klika.

> üíÅ Relej se mo≈æe spojiti tako da stvaranje veze zapravo prekida napajanje releja, iskljuƒçujuƒái relej, ≈°to zatim ≈°alje napajanje natrag na relej ponovno ga ukljuƒçujuƒái, i tako dalje. To znaƒçi da ƒáe relej klikati nevjerojatno brzo stvarajuƒái zujanje. Ovako su radila neka od prvih zvona na vratima.

### Snaga releja

Elektromagnetu nije potrebno puno energije za aktivaciju i povlaƒçenje poluge, mo≈æe se kontrolirati pomoƒáu 3.3V ili 5V izlaza s IoT razvojnog kompleta. Izlazni krug mo≈æe nositi puno vi≈°e energije, ovisno o releju, ukljuƒçujuƒái mre≈æni napon ili ƒçak veƒáe razine snage za industrijsku upotrebu. Na taj naƒçin IoT razvojni komplet mo≈æe kontrolirati sustav za navodnjavanje, od male pumpe za jednu biljku do masivnog industrijskog sustava za cijelu komercijalnu farmu.

![Grove relej s oznaƒçenim kontrolnim krugom, izlaznim krugom i relejem](../../../../../translated_images/grove-relay-labelled.293e068f5c3c2a199bd7892f2661fdc9e10c920b535cfed317fbd6d1d4ae1168.hr.png)

Slika iznad prikazuje Grove relej. Kontrolni krug povezuje se s IoT ureƒëajem i ukljuƒçuje ili iskljuƒçuje relej koristeƒái 3.3V ili 5V. Izlazni krug ima dva terminala, bilo koji mo≈æe biti napajanje ili uzemljenje. Izlazni krug mo≈æe podnijeti do 250V pri 10A, ≈°to je dovoljno za niz ureƒëaja na mre≈æno napajanje. Mo≈æete nabaviti releje koji mogu podnijeti jo≈° veƒáe razine snage.

![Pumpa spojena preko releja](../../../../../translated_images/pump-wired-to-relay.66c5cfc0d89189900cd601777f5caeb39ee35c6250f6c86bf38feaceedb21fe9.hr.png)

Na slici iznad, napajanje se isporuƒçuje pumpi putem releja. Crvena ≈æica povezuje +5V terminal USB napajanja s jednim terminalom izlaznog kruga releja, a druga crvena ≈æica povezuje drugi terminal izlaznog kruga s pumpom. Crna ≈æica povezuje pumpu s uzemljenjem na USB napajanju. Kada se relej ukljuƒçi, dovr≈°ava krug, ≈°aljuƒái 5V na pumpu, ukljuƒçujuƒái pumpu.

## Upravljanje relejem

Mo≈æete upravljati relejem s va≈°eg IoT razvojnog kompleta.

### Zadatak - upravljanje relejem

Proƒëite kroz odgovarajuƒái vodiƒç za upravljanje relejem pomoƒáu va≈°eg IoT ureƒëaja:

* [Arduino - Wio Terminal](wio-terminal-relay.md)
* [Jednoploƒçno raƒçunalo - Raspberry Pi](pi-relay.md)
* [Jednoploƒçno raƒçunalo - Virtualni ureƒëaj](virtual-device-relay.md)

## Upravljanje biljkom putem MQTT-a

Do sada je va≈° relej kontroliran izravno od strane IoT ureƒëaja na temelju jednog oƒçitanja vla≈ænosti tla. U komercijalnom sustavu za navodnjavanje, logika upravljanja bit ƒáe centralizirana, omoguƒáujuƒái dono≈°enje odluka o zalijevanju koristeƒái podatke s vi≈°e senzora i omoguƒáujuƒái promjene konfiguracije na jednom mjestu. Kako biste to simulirali, mo≈æete upravljati relejem putem MQTT-a.

### Zadatak - upravljanje relejem putem MQTT-a

1. Dodajte odgovarajuƒáe MQTT biblioteke/pip pakete i kod u svoj projekt `soil-moisture-sensor` za povezivanje s MQTT-om. Nazovite ID klijenta kao `soilmoisturesensor_client` s prefiksom va≈°eg ID-a.

    > ‚ö†Ô∏è Mo≈æete se referirati na [upute za povezivanje s MQTT-om u projektu 1, lekcija 4 ako je potrebno](../../../1-getting-started/lessons/4-connect-internet/README.md#connect-your-iot-device-to-mqtt).

1. Dodajte odgovarajuƒái kod ureƒëaja za slanje telemetrije s postavkama vla≈ænosti tla. Za poruku telemetrije, nazovite svojstvo `soil_moisture`.

    > ‚ö†Ô∏è Mo≈æete se referirati na [upute za slanje telemetrije na MQTT u projektu 1, lekcija 4 ako je potrebno](../../../1-getting-started/lessons/4-connect-internet/README.md#send-telemetry-from-your-iot-device).

1. Kreirajte lokalni poslu≈æiteljski kod za pretplatu na telemetriju i slanje naredbe za upravljanje relejem u mapi nazvanoj `soil-moisture-sensor-server`. Nazovite svojstvo u poruci naredbe `relay_on`, i postavite ID klijenta kao `soilmoisturesensor_server` s prefiksom va≈°eg ID-a. Zadr≈æite istu strukturu kao kod poslu≈æitelja koji ste napisali za projekt 1, lekcija 4 jer ƒáete kasnije dodavati ovaj kod.

    > ‚ö†Ô∏è Mo≈æete se referirati na [upute za slanje telemetrije na MQTT](../../../1-getting-started/lessons/4-connect-internet/README.md#write-the-server-code) i [slanje naredbi putem MQTT-a](../../../1-getting-started/lessons/4-connect-internet/README.md#send-commands-to-the-mqtt-broker) u projektu 1, lekcija 4 ako je potrebno.

1. Dodajte odgovarajuƒái kod ureƒëaja za upravljanje relejem iz primljenih naredbi, koristeƒái svojstvo `relay_on` iz poruke. Po≈°aljite true za `relay_on` ako je `soil_moisture` veƒái od 450, inaƒçe po≈°aljite false, isto kao logika koju ste dodali za IoT ureƒëaj ranije.

    > ‚ö†Ô∏è Mo≈æete se referirati na [upute za odgovaranje na naredbe iz MQTT-a u projektu 1, lekcija 4 ako je potrebno](../../../1-getting-started/lessons/4-connect-internet/README.md#handle-commands-on-the-iot-device).

> üíÅ Ovaj kod mo≈æete pronaƒái u mapi [code-mqtt](../../../../../2-farm/lessons/3-automated-plant-watering/code-mqtt).

Provjerite je li kod pokrenut na va≈°em ureƒëaju i lokalnom poslu≈æitelju, i testirajte ga mijenjanjem razine vla≈ænosti tla, bilo promjenom vrijednosti koje ≈°alje virtualni senzor ili promjenom razine vlage tla dodavanjem vode ili uklanjanjem senzora iz tla.

## Vremensko usklaƒëivanje senzora i aktuatora

U lekciji 3 izradili ste noƒáno svjetlo - LED-icu koja se ukljuƒçuje ƒçim senzor svjetla detektira nisku razinu svjetlosti. Senzor svjetla detektirao je promjenu razine svjetlosti trenutno, a ureƒëaj je mogao brzo reagirati, ograniƒçen samo duljinom ka≈°njenja u funkciji `loop` ili `while True:` petlji. Kao IoT programer, ne mo≈æete uvijek raƒçunati na tako brz povratni ciklus.

### Vremensko usklaƒëivanje za vla≈ænost tla

Ako ste radili prethodnu lekciju o vla≈ænosti tla koristeƒái fiziƒçki senzor, mogli ste primijetiti da je trebalo nekoliko sekundi da oƒçitanje vla≈ænosti tla padne nakon ≈°to ste zalili biljku. Ovo nije zato ≈°to je senzor spor, veƒá zato ≈°to vodi treba vremena da se upije kroz tlo.
üíÅ Ako ste zalijevali preblizu senzoru, mo≈æda ste primijetili da je oƒçitanje brzo palo, a zatim se ponovno poveƒáalo - to je uzrokovano time ≈°to se voda blizu senzora ≈°iri kroz ostatak tla, smanjujuƒái vlagu tla u blizini senzora.
![Mjerenje vla≈ænosti tla od 658 ne mijenja se tijekom zalijevanja, veƒá pada na 320 nakon zalijevanja kada voda prodre kroz tlo](../../../../../translated_images/soil-moisture-travel.a0e31af222cf14385de5380dfc32c7b8213960965228b8e4f7b7ab7f73b310a3.hr.png)

Na gornjem dijagramu oƒçitanje vla≈ænosti tla pokazuje 658. Biljka se zalijeva, ali ovo oƒçitanje se ne mijenja odmah jer voda jo≈° nije stigla do senzora. Zalijevanje mo≈æe zavr≈°iti prije nego ≈°to voda stigne do senzora, a vrijednost se smanji kako bi odra≈æavala novu razinu vla≈ænosti.

Ako biste pisali kod za upravljanje sustavom navodnjavanja putem releja na temelju razine vla≈ænosti tla, trebali biste uzeti u obzir ovo ka≈°njenje i implementirati pametnije vremensko upravljanje u svoj IoT ureƒëaj.

‚úÖ Odvojite trenutak da razmislite kako biste to mogli uƒçiniti.

### Upravljanje vremenom senzora i aktuatora

Zamislite da ste dobili zadatak izgraditi sustav navodnjavanja za farmu. Na temelju vrste tla, idealna razina vla≈ænosti tla za uzgojene biljke odgovara analognom oƒçitanju napona od 400-450.

Mogli biste programirati ureƒëaj na isti naƒçin kao noƒáno svjetlo - dok god senzor oƒçitava iznad 450, ukljuƒçite relej kako biste ukljuƒçili pumpu. Problem je ≈°to vodi treba neko vrijeme da stigne od pumpe, kroz tlo, do senzora. Senzor ƒáe zaustaviti vodu kada otkrije razinu od 450, ali razina vode ƒáe nastaviti padati dok se pumpana voda upija kroz tlo. Krajnji rezultat je rasipanje vode i rizik od o≈°teƒáenja korijena.

‚úÖ Zapamtite - previ≈°e vode mo≈æe biti jednako lo≈°e za biljke kao i premalo, a takoƒëer tro≈°i dragocjeni resurs.

Bolje rje≈°enje je razumjeti da postoji ka≈°njenje izmeƒëu ukljuƒçivanja aktuatora i promjene svojstva koje senzor oƒçitava. To znaƒçi da senzor ne samo da treba priƒçekati neko vrijeme prije nego ≈°to ponovno izmjeri vrijednost, veƒá aktuator treba biti iskljuƒçen neko vrijeme prije nego ≈°to se izvr≈°i sljedeƒáe mjerenje senzora.

Koliko dugo relej treba biti ukljuƒçen svaki put? Bolje je biti oprezan i ukljuƒçiti relej na kratko vrijeme, zatim priƒçekati da se voda upije, pa ponovno provjeriti razinu vla≈ænosti. Uostalom, uvijek mo≈æete ponovno ukljuƒçiti pumpu kako biste dodali vi≈°e vode, ali ne mo≈æete ukloniti vodu iz tla.

> üíÅ Ovakva kontrola vremena vrlo je specifiƒçna za IoT ureƒëaj koji gradite, svojstvo koje mjerite te senzore i aktuatore koji se koriste.

![Biljka jagode povezana s vodom putem pumpe, pri ƒçemu je pumpa povezana s relejem. Relej i senzor vla≈ænosti tla u biljci povezani su s Raspberry Pi-jem](../../../../../translated_images/strawberry-with-pump.b410fc72ac6aabad3e28de9775bf2393ead73dcfec6fd8c9bc01cf107ecd171a.hr.png)

Na primjer, imam biljku jagode sa senzorom vla≈ænosti tla i pumpom kojom upravlja relej. Primijetio sam da kada dodam vodu, treba oko 20 sekundi da se oƒçitanje vla≈ænosti tla stabilizira. To znaƒçi da moram iskljuƒçiti relej i priƒçekati 20 sekundi prije nego ≈°to provjerim razinu vla≈ænosti. Radije bih imao premalo vode nego previ≈°e - uvijek mogu ponovno ukljuƒçiti pumpu, ali ne mogu izvaditi vodu iz biljke.

![Korak 1, uzmi mjerenje. Korak 2, dodaj vodu. Korak 3, priƒçekaj da voda prodre kroz tlo. Korak 4, ponovno uzmi mjerenje](../../../../../translated_images/soil-moisture-delay.865f3fae206db01d5f8f100f4f44040215d44a0412dd3450aef7ff7b93b6d273.hr.png)

To znaƒçi da bi najbolji proces bio ciklus zalijevanja koji izgleda ovako:

* Ukljuƒçite pumpu na 5 sekundi
* Priƒçekajte 20 sekundi
* Provjerite vla≈ænost tla
* Ako je razina jo≈° uvijek iznad potrebne, ponovite gore navedene korake

5 sekundi moglo bi biti predugo za pumpu, pogotovo ako su razine vla≈ænosti samo malo iznad potrebne razine. Najbolji naƒçin da saznate koje vrijeme koristiti je isprobati, zatim prilagoditi kada imate podatke senzora, uz stalnu povratnu petlju. To ƒçak mo≈æe dovesti do preciznijeg vremenskog upravljanja, poput ukljuƒçivanja pumpe na 1 sekundu za svakih 100 iznad potrebne vla≈ænosti tla, umjesto fiksnih 5 sekundi.

‚úÖ Istra≈æite: Postoje li drugi vremenski ƒçimbenici koje treba uzeti u obzir? Mo≈æe li se biljka zalijevati bilo kada kada je vla≈ænost tla preniska, ili postoje odreƒëena doba dana koja su dobra i lo≈°a za zalijevanje biljaka?

> üíÅ Prognoze vremena takoƒëer se mogu uzeti u obzir pri upravljanju automatiziranim sustavima zalijevanja za vanjski uzgoj. Ako se oƒçekuje ki≈°a, zalijevanje se mo≈æe odgoditi dok ki≈°a ne zavr≈°i. U tom trenutku tlo mo≈æe biti dovoljno vla≈æno da ne treba zalijevanje, ≈°to je mnogo uƒçinkovitije nego tro≈°iti vodu zalijevanjem neposredno prije ki≈°e.

## Dodajte vremensko upravljanje svom poslu≈æitelju za kontrolu biljaka

Kod poslu≈æitelja mo≈æe se modificirati kako bi se dodala kontrola oko vremena ciklusa zalijevanja i ƒçekanja da se razine vla≈ænosti tla promijene. Logika poslu≈æitelja za upravljanje vremenom releja je:

1. Primljena telemetrijska poruka
1. Provjerite razinu vla≈ænosti tla
1. Ako je u redu, ne radite ni≈°ta. Ako je oƒçitanje previsoko (≈°to znaƒçi da je vla≈ænost tla preniska), onda:
    1. Po≈°aljite naredbu za ukljuƒçivanje releja
    1. Priƒçekajte 5 sekundi
    1. Po≈°aljite naredbu za iskljuƒçivanje releja
    1. Priƒçekajte 20 sekundi da se razine vla≈ænosti tla stabiliziraju

Ciklus zalijevanja, proces od primanja telemetrijske poruke do spremnosti za obradu razina vla≈ænosti tla ponovno, traje oko 25 sekundi. Telemetriju ≈°aljemo svakih 10 sekundi, pa postoji preklapanje gdje se poruka prima dok poslu≈æitelj ƒçeka da se razine vla≈ænosti tla stabiliziraju, ≈°to bi moglo pokrenuti novi ciklus zalijevanja.

Postoje dvije opcije za rje≈°avanje ovog problema:

* Promijenite kod IoT ureƒëaja da ≈°alje telemetriju samo svake minute, na taj naƒçin ciklus zalijevanja ƒáe biti dovr≈°en prije nego ≈°to se po≈°alje sljedeƒáa poruka
* Odjavite se s telemetrije tijekom ciklusa zalijevanja

Prva opcija nije uvijek dobro rje≈°enje za velike farme. Poljoprivrednik mo≈æda ≈æeli zabilje≈æiti razine vla≈ænosti tla dok se tlo zalijeva za kasniju analizu, na primjer kako bi bio svjestan protoka vode u razliƒçitim podruƒçjima na farmi i usmjerio ciljano zalijevanje. Druga opcija je bolja - kod jednostavno ignorira telemetriju kada je ne mo≈æe koristiti, ali telemetrija je i dalje dostupna za druge usluge koje se mogu pretplatiti na nju.

> üíÅ IoT podaci ne ≈°alju se samo s jednog ureƒëaja na jednu uslugu, veƒá mnogi ureƒëaji mogu slati podatke brokeru, a mnoge usluge mogu slu≈°ati podatke s brokera. Na primjer, jedna usluga mo≈æe slu≈°ati podatke o vla≈ænosti tla i pohraniti ih u bazu podataka za kasniju analizu. Druga usluga takoƒëer mo≈æe slu≈°ati istu telemetriju kako bi upravljala sustavom navodnjavanja.

### Zadatak - dodajte vremensko upravljanje svom poslu≈æitelju za kontrolu biljaka

A≈æurirajte kod poslu≈æitelja kako bi relej radio 5 sekundi, a zatim ƒçekao 20 sekundi.

1. Otvorite mapu `soil-moisture-sensor-server` u VS Code-u ako veƒá nije otvorena. Provjerite je li virtualno okru≈æenje aktivirano.

1. Otvorite datoteku `app.py`

1. Dodajte sljedeƒái kod u datoteku `app.py` ispod postojeƒáih uvoza:

    ```python
    import threading
    ```

    Ova naredba uvozi `threading` iz Python biblioteka, ≈°to omoguƒáuje Pythonu da izvr≈°ava drugi kod dok ƒçeka.

1. Dodajte sljedeƒái kod prije funkcije `handle_telemetry` koja obraƒëuje telemetrijske poruke primljene od koda poslu≈æitelja:

    ```python
    water_time = 5
    wait_time = 20
    ```

    Ovo definira koliko dugo treba raditi relej (`water_time`) i koliko dugo treba ƒçekati nakon toga da se provjeri vla≈ænost tla (`wait_time`).

1. Ispod ovog koda dodajte sljedeƒáe:

    ```python
    def send_relay_command(client, state):
        command = { 'relay_on' : state }
        print("Sending message:", command)
        client.publish(server_command_topic, json.dumps(command))
    ```

    Ovaj kod definira funkciju nazvanu `send_relay_command` koja ≈°alje naredbu putem MQTT-a za upravljanje relejem. Telemetrija se stvara kao rjeƒçnik, a zatim se pretvara u JSON string. Vrijednost proslijeƒëena u `state` odreƒëuje treba li relej biti ukljuƒçen ili iskljuƒçen.

1. Nakon funkcije `send_relay_code`, dodajte sljedeƒái kod:

    ```python
    def control_relay(client):
        print("Unsubscribing from telemetry")
        mqtt_client.unsubscribe(client_telemetry_topic)
    
        send_relay_command(client, True)
        time.sleep(water_time)
        send_relay_command(client, False)
    
        time.sleep(wait_time)
    
        print("Subscribing to telemetry")
        mqtt_client.subscribe(client_telemetry_topic)
    ```

    Ovo definira funkciju za upravljanje relejem na temelju potrebnog vremena. Poƒçinje odjavljivanjem s telemetrije kako poruke o vla≈ænosti tla ne bi bile obraƒëene dok se zalijevanje odvija. Zatim ≈°alje naredbu za ukljuƒçivanje releja. Zatim ƒçeka `water_time` prije nego ≈°to po≈°alje naredbu za iskljuƒçivanje releja. Na kraju ƒçeka da se razine vla≈ænosti tla stabiliziraju tijekom `wait_time` sekundi. Zatim se ponovno prijavljuje na telemetriju.

1. Promijenite funkciju `handle_telemetry` u sljedeƒáe:

    ```python
    def handle_telemetry(client, userdata, message):
        payload = json.loads(message.payload.decode())
        print("Message received:", payload)
    
        if payload['soil_moisture'] > 450:
            threading.Thread(target=control_relay, args=(client,)).start()
    ```

    Ovaj kod provjerava razinu vla≈ænosti tla. Ako je veƒáa od 450, tlu je potrebno zalijevanje, pa poziva funkciju `control_relay`. Ova funkcija se pokreƒáe na zasebnom threadu, koji radi u pozadini.

1. Provjerite radi li va≈° IoT ureƒëaj, zatim pokrenite ovaj kod. Promijenite razine vla≈ænosti tla i promatrajte ≈°to se dogaƒëa s relejem - trebao bi se ukljuƒçiti na 5 sekundi, a zatim ostati iskljuƒçen najmanje 20 sekundi, ukljuƒçujuƒái se samo ako razine vla≈ænosti tla nisu dovoljne.

    ```output
    (.venv) ‚ûú  soil-moisture-sensor-server ‚úó python app.py
    Message received: {'soil_moisture': 457}
    Unsubscribing from telemetry
    Sending message: {'relay_on': True}
    Sending message: {'relay_on': False}
    Subscribing to telemetry
    Message received: {'soil_moisture': 302}
    ```

    Dobar naƒçin za testiranje ovoga u simuliranom sustavu navodnjavanja je kori≈°tenje suhog tla, zatim ruƒçno ulijevanje vode dok je relej ukljuƒçen, prestajuƒái ulijevati kada se relej iskljuƒçi.

> üíÅ Ovaj kod mo≈æete pronaƒái u mapi [code-timing](../../../../../2-farm/lessons/3-automated-plant-watering/code-timing).

> üíÅ Ako ≈æelite koristiti pumpu za izgradnju stvarnog sustava navodnjavanja, mo≈æete koristiti [6V vodenu pumpu](https://www.seeedstudio.com/6V-Mini-Water-Pump-p-1945.html) s [USB terminalnim napajanjem](https://www.adafruit.com/product/3628). Provjerite je li napajanje prema ili od pumpe povezano putem releja.

---

## üöÄ Izazov

Mo≈æete li smisliti druge IoT ili elektriƒçne ureƒëaje koji imaju sliƒçan problem gdje treba neko vrijeme da rezultati aktuatora stignu do senzora? Vjerojatno imate nekoliko takvih ureƒëaja u svojoj kuƒái ili ≈°koli.

* Koja svojstva mjere?
* Koliko dugo traje promjena svojstva nakon ≈°to se aktuator koristi?
* Je li u redu da svojstvo promijeni vrijednost izvan potrebne?
* Kako se mo≈æe vratiti na potrebnu vrijednost ako je potrebno?

## Kviz nakon predavanja

[Kviz nakon predavanja](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/14)

## Pregled i samostalno uƒçenje

* Proƒçitajte vi≈°e o relejima, ukljuƒçujuƒái njihovu povijesnu upotrebu u telefonskim centralama, na [Wikipedia stranici o relejima](https://wikipedia.org/wiki/Relay).

## Zadatak

[Izgradite uƒçinkovitiji ciklus zalijevanja](assignment.md)

---

**Odricanje od odgovornosti**:  
Ovaj dokument je preveden pomoƒáu AI usluge za prevoƒëenje [Co-op Translator](https://github.com/Azure/co-op-translator). Iako nastojimo osigurati toƒçnost, imajte na umu da automatski prijevodi mogu sadr≈æavati pogre≈°ke ili netoƒçnosti. Izvorni dokument na izvornom jeziku treba smatrati autoritativnim izvorom. Za kritiƒçne informacije preporuƒçuje se profesionalni prijevod od strane ƒçovjeka. Ne preuzimamo odgovornost za bilo kakva nesporazuma ili pogre≈°na tumaƒçenja koja proizlaze iz kori≈°tenja ovog prijevoda.