<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "078ae664c7b686bf069545e9a5fc95b2",
  "translation_date": "2025-08-27T21:47:19+00:00",
  "source_file": "3-transport/lessons/4-geofences/README.md",
  "language_code": "cs"
}
-->
# Geofencing

![P≈ôehled t√©to lekce ve formƒõ sketchnote](../../../../../translated_images/lesson-14.63980c5150ae3c153e770fb71d044c1845dce79248d86bed9fc525adf3ede73c.cs.jpg)

> Sketchnote od [Nitya Narasimhan](https://github.com/nitya). Kliknƒõte na obr√°zek pro vƒõt≈°√≠ verzi.

Toto video poskytuje p≈ôehled o geofenc√≠ch a jejich vyu≈æit√≠ v Azure Maps, co≈æ jsou t√©mata, kter√° budou pokryta v t√©to lekci:

[![Geofencing s Azure Maps z Microsoft Developer IoT show](https://img.youtube.com/vi/nsrgYhaYNVY/0.jpg)](https://www.youtube.com/watch?v=nsrgYhaYNVY)

> üé• Kliknƒõte na obr√°zek v√Ω≈°e pro zhl√©dnut√≠ videa

## Kv√≠z p≈ôed lekc√≠

[Kv√≠z p≈ôed lekc√≠](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/27)

## √övod

V posledn√≠ch t≈ôech lekc√≠ch jste pou≈æili IoT k lokalizaci n√°kladn√≠ch voz≈Ø p≈ôepravuj√≠c√≠ch va≈°e produkty z farmy do zpracovatelsk√©ho centra. Zaznamenali jste GPS data, odeslali je do cloudu k ulo≈æen√≠ a zobrazili je na mapƒõ. Dal≈°√≠m krokem ke zv√Ω≈°en√≠ efektivity va≈°eho dodavatelsk√©ho ≈ôetƒõzce je z√≠sk√°n√≠ upozornƒõn√≠, kdy≈æ se n√°kladn√≠ v≈Øz bl√≠≈æ√≠ ke zpracovatelsk√©mu centru, aby t√Ωm pot≈ôebn√Ω k vykl√°dce mohl b√Ωt p≈ôipraven s vysokozdvi≈æn√Ωmi voz√≠ky a dal≈°√≠m vybaven√≠m ihned po p≈ô√≠jezdu vozidla. T√≠mto zp≈Øsobem mohou rychle vylo≈æit n√°klad a vy nebudete platit za ƒçek√°n√≠ n√°kladn√≠ho vozu a ≈ôidiƒçe.

V t√©to lekci se nauƒç√≠te o geofenc√≠ch ‚Äì definovan√Ωch geospace√°ln√≠ch oblastech, jako je nap≈ô√≠klad oblast v dosahu 2 km j√≠zdy od zpracovatelsk√©ho centra, a jak testovat, zda GPS sou≈ôadnice jsou uvnit≈ô nebo vnƒõ geofence, abyste mohli zjistit, zda v√°≈° GPS senzor dorazil nebo opustil urƒçitou oblast.

V t√©to lekci se zamƒõ≈ô√≠me na:

* [Co jsou geofences](../../../../../3-transport/lessons/4-geofences)
* [Definov√°n√≠ geofence](../../../../../3-transport/lessons/4-geofences)
* [Testov√°n√≠ bod≈Ø v≈Øƒçi geofence](../../../../../3-transport/lessons/4-geofences)
* [Pou≈æit√≠ geofenc√≠ ze serverless k√≥du](../../../../../3-transport/lessons/4-geofences)

> üóë Toto je posledn√≠ lekce v tomto projektu, tak≈æe po dokonƒçen√≠ t√©to lekce a √∫kolu nezapome≈àte vyƒçistit sv√© cloudov√© slu≈æby. Budete je pot≈ôebovat k dokonƒçen√≠ √∫kolu, tak≈æe se ujistƒõte, ≈æe nejprve √∫kol dokonƒç√≠te.
>
> Pokud pot≈ôebujete, pod√≠vejte se na [pr≈Øvodce vyƒçi≈°tƒõn√≠m projektu](../../../clean-up.md) pro pokyny, jak to udƒõlat.

## Co jsou geofences

Geofence je virtu√°ln√≠ obvod pro geografickou oblast v re√°ln√©m svƒõtƒõ. Geofences mohou b√Ωt kruhy definovan√© jako bod a polomƒõr (nap≈ô√≠klad kruh o pr≈Ømƒõru 100 m kolem budovy) nebo polygon pokr√Ωvaj√≠c√≠ oblast, jako je ≈°koln√≠ z√≥na, hranice mƒõsta nebo univerzitn√≠ ƒçi kancel√°≈ôsk√Ω kampus.

![Nƒõkolik p≈ô√≠klad≈Ø geofenc√≠ ukazuj√≠c√≠ch kruhovou geofence kolem obchodu Microsoft a polygonovou geofence kolem z√°padn√≠ho kampusu Microsoft](../../../../../translated_images/geofence-examples.172fbc534665769f6e1a1ddcf75e3b25183cd10354c80cc603ba44b635390e1a.cs.png)

> üíÅ Mo≈æn√° jste ji≈æ pou≈æ√≠vali geofences, ani≈æ byste o tom vƒõdƒõli. Pokud jste nastavili p≈ôipom√≠nku pomoc√≠ aplikace iOS Reminders nebo Google Keep na z√°kladƒõ polohy, pou≈æili jste geofence. Tyto aplikace nastav√≠ geofence na z√°kladƒõ zadan√© polohy a upozorn√≠ v√°s, kdy≈æ v√°≈° telefon vstoup√≠ do geofence.

Existuje mnoho d≈Øvod≈Ø, proƒç byste chtƒõli vƒõdƒõt, ≈æe vozidlo je uvnit≈ô nebo vnƒõ geofence:

* P≈ô√≠prava na vykl√°dku ‚Äì z√≠sk√°n√≠ ozn√°men√≠, ≈æe vozidlo dorazilo na m√≠sto, umo≈æ≈àuje t√Ωmu b√Ωt p≈ôipraven na vykl√°dku vozidla, ƒç√≠m≈æ se sni≈æuje ƒçekac√≠ doba vozidla. To m≈Ø≈æe umo≈ænit ≈ôidiƒçi prov√©st v√≠ce dod√°vek za den s men≈°√≠ ƒçekac√≠ dobou.
* Da≈àov√° compliance ‚Äì nƒõkter√© zemƒõ, jako nap≈ô√≠klad Nov√Ω Z√©land, √∫ƒçtuj√≠ silniƒçn√≠ danƒõ za dieselov√° vozidla na z√°kladƒõ hmotnosti vozidla p≈ôi j√≠zdƒõ pouze po ve≈ôejn√Ωch komunikac√≠ch. Pou≈æit√≠ geofenc√≠ umo≈æ≈àuje sledovat ujet√© kilometry na ve≈ôejn√Ωch komunikac√≠ch oproti soukrom√Ωm cest√°m na m√≠stech, jako jsou farmy nebo oblasti tƒõ≈æby d≈ôeva.
* Monitorov√°n√≠ kr√°de≈æ√≠ ‚Äì pokud by vozidlo mƒõlo z≈Østat pouze v urƒçit√© oblasti, nap≈ô√≠klad na farmƒõ, a opust√≠ geofence, mohlo b√Ωt ukradeno.
* Compliance s polohou ‚Äì nƒõkter√© ƒç√°sti pracovn√≠ho m√≠sta, farmy nebo tov√°rny mohou b√Ωt nep≈ô√≠stupn√© pro urƒçit√° vozidla, nap≈ô√≠klad udr≈æov√°n√≠ vozidel p≈ôepravuj√≠c√≠ch umƒõl√° hnojiva a pesticidy mimo pole s organick√Ωmi produkty. Pokud je geofence vstoupena, vozidlo je mimo compliance a ≈ôidiƒç m≈Ø≈æe b√Ωt upozornƒõn.

‚úÖ Dok√°≈æete si p≈ôedstavit dal≈°√≠ vyu≈æit√≠ geofenc√≠?

Azure Maps, slu≈æba, kterou jste pou≈æili v p≈ôedchoz√≠ lekci k vizualizaci GPS dat, v√°m umo≈æ≈àuje definovat geofences a pot√© testovat, zda bod je uvnit≈ô nebo vnƒõ geofence.

## Definov√°n√≠ geofence

Geofences jsou definov√°ny pomoc√≠ GeoJSON, stejnƒõ jako body, kter√© byly p≈ôid√°ny na mapu v p≈ôedchoz√≠ lekci. V tomto p≈ô√≠padƒõ m√≠sto `FeatureCollection` bod≈Ø obsahuje `FeatureCollection` s `Polygon`.

```json
{
   "type": "FeatureCollection",
   "features": [
     {
       "type": "Feature",
       "geometry": {
         "type": "Polygon",
         "coordinates": [
           [
             [
               -122.13393688201903,
               47.63829579223815
             ],
             [
               -122.13389128446579,
               47.63782047131512
             ],
             [
               -122.13240802288054,
               47.63783312249837
             ],
             [
               -122.13238388299942,
               47.63829037035086
             ],
             [
               -122.13393688201903,
               47.63829579223815
             ]
           ]
         ]
       },
       "properties": {
         "geometryId": "1"
       }
     }
   ]
}
```

Ka≈æd√Ω bod na polygonu je definov√°n jako dvojice zemƒõpisn√© d√©lky a ≈°√≠≈ôky v poli, a tyto body jsou v poli, kter√© je nastaveno jako `coordinates`. V `Point` v p≈ôedchoz√≠ lekci bylo `coordinates` pole obsahuj√≠c√≠ 2 hodnoty, zemƒõpisnou ≈°√≠≈ôku a d√©lku, pro `Polygon` je to pole pol√≠ obsahuj√≠c√≠ 2 hodnoty, zemƒõpisnou d√©lku a ≈°√≠≈ôku.

> üíÅ Pamatujte, GeoJSON pou≈æ√≠v√° `zemƒõpisn√° d√©lka, zemƒõpisn√° ≈°√≠≈ôka` pro body, nikoli `zemƒõpisn√° ≈°√≠≈ôka, zemƒõpisn√° d√©lka`

Pole sou≈ôadnic polygonu v≈ædy obsahuje o 1 v√≠ce z√°znam≈Ø ne≈æ poƒçet bod≈Ø na polygonu, p≈ôiƒçem≈æ posledn√≠ z√°znam je stejn√Ω jako prvn√≠, ƒç√≠m≈æ se polygon uzav√≠r√°. Nap≈ô√≠klad pro obd√©ln√≠k by bylo 5 bod≈Ø.

![Obd√©ln√≠k se sou≈ôadnicemi](../../../../../translated_images/polygon-points.302193da381cb415f46c2c7a98496ee4be05d6c73d21238a89721ad93e121233.cs.png)

Na obr√°zku v√Ω≈°e je obd√©ln√≠k. Sou≈ôadnice polygonu zaƒç√≠naj√≠ vlevo naho≈ôe na 47,-122, pot√© se posunou doprava na 47,-121, pot√© dol≈Ø na 46,-121, pot√© doleva na 46,-122, a nakonec zpƒõt na v√Ωchoz√≠ bod na 47,-122. To d√°v√° polygonu 5 bod≈Ø ‚Äì vlevo naho≈ôe, vpravo naho≈ôe, vpravo dole, vlevo dole a nakonec vlevo naho≈ôe pro uzav≈ôen√≠.

‚úÖ Zkuste vytvo≈ôit GeoJSON polygon kolem va≈°eho domova nebo ≈°koly. Pou≈æijte n√°stroj jako [GeoJSON.io](https://geojson.io/).

### √ökol ‚Äì definov√°n√≠ geofence

Aby bylo mo≈æn√© pou≈æ√≠t geofence v Azure Maps, mus√≠ b√Ωt nejprve nahr√°na do va≈°eho √∫ƒçtu Azure Maps. Po nahr√°n√≠ z√≠sk√°te jedineƒçn√© ID, kter√© m≈Ø≈æete pou≈æ√≠t k testov√°n√≠ bodu v≈Øƒçi geofence. K nahr√°n√≠ geofenc√≠ do Azure Maps je pot≈ôeba pou≈æ√≠t webov√© API map. M≈Ø≈æete volat webov√© API Azure Maps pomoc√≠ n√°stroje nazvan√©ho [curl](https://curl.se).

> üéì Curl je n√°stroj p≈ô√≠kazov√©ho ≈ô√°dku pro prov√°dƒõn√≠ po≈æadavk≈Ø na webov√© koncov√© body

1. Pokud pou≈æ√≠v√°te Linux, macOS nebo novƒõj≈°√≠ verzi Windows 10, pravdƒõpodobnƒõ ji≈æ m√°te curl nainstalovan√Ω. Spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz z va≈°eho termin√°lu nebo p≈ô√≠kazov√©ho ≈ô√°dku pro ovƒõ≈ôen√≠:

    ```sh
    curl --version
    ```

    Pokud nevid√≠te informace o verzi curl, budete jej muset nainstalovat ze [str√°nky ke sta≈æen√≠ curl](https://curl.se/download.html).

    > üíÅ Pokud m√°te zku≈°enosti s Postmanem, m≈Ø≈æete jej pou≈æ√≠t m√≠sto toho, pokud preferujete.

1. Vytvo≈ôte GeoJSON soubor obsahuj√≠c√≠ polygon. Budete jej testovat pomoc√≠ va≈°eho GPS senzoru, tak≈æe vytvo≈ôte polygon kolem va≈°√≠ aktu√°ln√≠ polohy. M≈Ø≈æete jej vytvo≈ôit ruƒçnƒõ √∫pravou p≈ô√≠kladu GeoJSON uveden√©ho v√Ω≈°e nebo pou≈æ√≠t n√°stroj jako [GeoJSON.io](https://geojson.io/).

    GeoJSON mus√≠ obsahovat `FeatureCollection`, obsahuj√≠c√≠ `Feature` s `geometry` typu `Polygon`.

    Mus√≠te tak√© p≈ôidat prvek `properties` na stejn√© √∫rovni jako prvek `geometry`, a tento mus√≠ obsahovat `geometryId`:

    ```json
    "properties": {
        "geometryId": "1"
    }
    ```

    Pokud pou≈æijete [GeoJSON.io](https://geojson.io/), budete muset tento prvek ruƒçnƒõ p≈ôidat do pr√°zdn√©ho prvku `properties`, buƒè po sta≈æen√≠ JSON souboru, nebo v JSON editoru v aplikaci.

    Tento `geometryId` mus√≠ b√Ωt v tomto souboru jedineƒçn√Ω. M≈Ø≈æete nahr√°t v√≠ce geofenc√≠ jako v√≠ce `Features` v `FeatureCollection` ve stejn√©m GeoJSON souboru, pokud m√° ka≈æd√° z nich jin√Ω `geometryId`. Polygony mohou m√≠t stejn√Ω `geometryId`, pokud jsou nahr√°ny z jin√©ho souboru v jin√©m ƒçase.

1. Ulo≈æte tento soubor jako `geofence.json` a p≈ôejdƒõte do m√≠sta, kde je ulo≈æen, ve va≈°em termin√°lu nebo konzoli.

1. Spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz curl pro vytvo≈ôen√≠ GeoFence:

    ```sh
    curl --request POST 'https://atlas.microsoft.com/mapData/upload?api-version=1.0&dataFormat=geojson&subscription-key=<subscription_key>' \
         --header 'Content-Type: application/json' \
         --include \
         --data @geofence.json
    ```

    Nahraƒète `<subscription_key>` v URL kl√≠ƒçem API pro v√°≈° √∫ƒçet Azure Maps.

    URL se pou≈æ√≠v√° k nahr√°n√≠ mapov√Ωch dat prost≈ôednictv√≠m API `https://atlas.microsoft.com/mapData/upload`. Vol√°n√≠ zahrnuje parametr `api-version` pro specifikaci, kterou verzi API Azure Maps pou≈æ√≠t, co≈æ umo≈æ≈àuje API mƒõnit se v pr≈Øbƒõhu ƒçasu, ale zachovat zpƒõtnou kompatibilitu. Form√°t dat, kter√° jsou nahr√°na, je nastaven na `geojson`.

    Tento p≈ô√≠kaz provede POST po≈æadavek na API pro nahr√°n√≠ a vr√°t√≠ seznam hlaviƒçek odpovƒõdi, kter√Ω zahrnuje hlaviƒçku nazvanou `location`.

    ```output
    content-type: application/json
    location: https://us.atlas.microsoft.com/mapData/operations/1560ced6-3a80-46f2-84b2-5b1531820eab?api-version=1.0
    x-ms-azuremaps-region: West US 2
    x-content-type-options: nosniff
    strict-transport-security: max-age=31536000; includeSubDomains
    x-cache: CONFIG_NOCACHE
    date: Sat, 22 May 2021 21:34:57 GMT
    content-length: 0
    ```

    > üéì P≈ôi vol√°n√≠ webov√©ho koncov√©ho bodu m≈Ø≈æete p≈ôedat parametry vol√°n√≠ p≈ôid√°n√≠m `?` n√°sledovan√©ho dvojicemi kl√≠ƒç-hodnota jako `key=value`, oddƒõlen√Ωmi znakem `&`.

1. Azure Maps tento po≈æadavek nezpracov√°v√° okam≈æitƒõ, tak≈æe budete muset zkontrolovat, zda po≈æadavek na nahr√°n√≠ byl dokonƒçen, pomoc√≠ URL uveden√© v hlaviƒçce `location`. Proveƒète GET po≈æadavek na tuto URL pro zji≈°tƒõn√≠ stavu. Budete muset p≈ôidat v√°≈° kl√≠ƒç p≈ôedplatn√©ho na konec URL `location` p≈ôid√°n√≠m `&subscription-key=<subscription_key>` na konec, nahrazen√≠m `<subscription_key>` kl√≠ƒçem API pro v√°≈° √∫ƒçet Azure Maps. Spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz:

    ```sh
    curl --request GET '<location>&subscription-key=<subscription_key>'
    ```

    Nahraƒète `<location>` hodnotou hlaviƒçky `location` a `<subscription_key>` kl√≠ƒçem API pro v√°≈° √∫ƒçet Azure Maps.

1. Zkontrolujte hodnotu `status` v odpovƒõdi. Pokud nen√≠ `Succeeded`, poƒçkejte minutu a zkuste to znovu.

1. Jakmile se stav vr√°t√≠ jako `Succeeded`, pod√≠vejte se na `resourceLocation` z odpovƒõdi. Tento obsahuje podrobnosti o jedineƒçn√©m ID (zn√°m√©m jako UDID) pro GeoJSON objekt. UDID je hodnota za `metadata/`, a nezahrnuje `api-version`. Nap≈ô√≠klad pokud `resourceLocation` bylo:

    ```json
    {
      "resourceLocation": "https://us.atlas.microsoft.com/mapData/metadata/7c3776eb-da87-4c52-ae83-caadf980323a?api-version=1.0"
    }
    ```

    Pak by UDID bylo `7c3776eb-da87-4c52-ae83-caadf980323a`.

    Uchovejte si kopii tohoto UDID, proto≈æe jej budete pot≈ôebovat k testov√°n√≠ geofence.

## Testov√°n√≠ bod≈Ø v≈Øƒçi geofence

Jakmile byl polygon nahr√°n do Azure Maps, m≈Ø≈æete testovat bod, zda je uvnit≈ô nebo vnƒõ geofence. Udƒõl√°te to proveden√≠m po≈æadavku na webov√© API, p≈ôed√°n√≠m UDID geofence a zemƒõpisn√© ≈°√≠≈ôky a d√©lky bodu k testov√°n√≠.

P≈ôi prov√°dƒõn√≠ tohoto po≈æadavku m≈Ø≈æete tak√© p≈ôedat hodnotu nazvanou `searchBuffer`. Tato hodnota urƒçuje, jak p≈ôesn√© m√° b√Ωt vr√°cen√≠ v√Ωsledk≈Ø. D≈Øvodem je, ≈æe GPS nen√≠ dokonale p≈ôesn√© a nƒõkdy mohou b√Ωt polohy odch√Ωlen√© o metry nebo v√≠ce. V√Ωchoz√≠ hodnota pro search buffer je 50 m, ale m≈Ø≈æete nastavit hodnoty od 0 m do 500 m.

Kdy≈æ jsou v√Ωsledky vr√°ceny z vol√°n√≠ API, jedna z ƒç√°st√≠ v√Ωsledku je `distance`, mƒõ≈ôen√° k nejbli≈æ≈°√≠mu bodu na okraji geofence, s kladnou hodnotou, pokud je bod vnƒõ geofence, a z√°pornou, pokud je uvnit≈ô geofence. Pokud je tato vzd√°lenost men≈°√≠ ne≈æ search buffer, skuteƒçn√° vzd√°lenost je vr√°cena v metrech, jinak je hodnota 999 nebo -999. 999 znamen√°, ≈æe bod je vnƒõ geofence o v√≠ce ne≈æ search buffer, -999 znamen√°, ≈æe je uvnit≈ô geofence o v√≠ce ne≈æ search buffer.

![Geofence s 50m search buffer kolem n√≠](../../../../../translated_images/search-buffer-and-distance.e6a79af3898183c7b2ef6fbf12271b8b34afd23969bb946962b1b18d3d2635e8.cs.png)

Na obr√°zku v√Ω≈°e m√° geofence 50m search buffer.

* Bod uprost≈ôed geofence, dob≈ôe uvnit≈ô search buffer, m√° vzd√°lenost **-999**
* Bod dob≈ôe vnƒõ search buffer m√° vzd√°lenost **999**
* Bod uvnit≈ô geofence a uvnit≈ô search buffer, 6m od geofence, m√° vzd√°lenost **6m**
* Bod vnƒõ geofence a uvnit≈ô search buffer, 39m od geofence, m√° vzd√°lenost **39m**

Je d≈Øle≈æit√© zn√°t vzd√°lenost k okraji geofence a kombinovat ji s dal≈°√≠mi informacemi, jako jsou jin√© GPS z√°znamy, rychlost a silniƒçn√≠ data p≈ôi rozhodov√°n√≠ na z√°kladƒõ polohy vozidla.

Nap≈ô√≠klad si p≈ôedstavte GPS z√°znamy ukazuj√≠c√≠, ≈æe vozidlo jelo po silnici, kter√° konƒç√≠ vedle geofence. Pokud jedin√° GPS hodnota nen√≠ p≈ôesn√° a um√≠st√≠ vozidlo uvnit≈ô geofence, p≈ôesto≈æe tam nen√≠ ≈æ√°dn√Ω p≈ô√≠stup pro vozidla, m≈Ø≈æe b√Ωt ignorov√°na.

![GPS stopa ukazuj√≠c√≠ vozidlo proj√≠≈ædƒõj√≠c√≠ kolem kampusu Microsoft na 520, s GPS z√°znamy pod√©l silnice kromƒõ jednoho na kampusu, uvnit≈ô geofence](../../../../../translated_images/geofence-crossing-inaccurate-gps.6a3ed911202ad9cabb66d3964888cec03a42c61d5b8f536ad5bdc99716b370f5.cs.png)
Na obr√°zku je geofence pokr√Ωvaj√≠c√≠ ƒç√°st kampusu Microsoftu. ƒåerven√° ƒç√°ra ukazuje trasu n√°kladn√≠ho vozu jedouc√≠ho po d√°lnici 520, s kruhy oznaƒçuj√≠c√≠mi GPS z√°znamy. Vƒõt≈°ina z√°znam≈Ø je p≈ôesn√° a odpov√≠d√° trase po d√°lnici 520, ale jeden nep≈ôesn√Ω z√°znam se nach√°z√≠ uvnit≈ô geofence. Tento z√°znam nem≈Ø≈æe b√Ωt spr√°vn√Ω ‚Äì neexistuj√≠ ≈æ√°dn√© silnice, po kter√Ωch by se n√°kladn√≠ v≈Øz mohl n√°hle odch√Ωlit z d√°lnice 520 na kampus a pot√© se vr√°tit zpƒõt na d√°lnici 520. K√≥d, kter√Ω kontroluje tuto geofence, bude muset vz√≠t v √∫vahu p≈ôedchoz√≠ z√°znamy, ne≈æ zaƒçne jednat na z√°kladƒõ v√Ωsledk≈Ø testu geofence.

‚úÖ Jak√© dal≈°√≠ √∫daje byste pot≈ôebovali zkontrolovat, abyste zjistili, zda lze GPS z√°znam pova≈æovat za spr√°vn√Ω?

### √ökol ‚Äì testov√°n√≠ bod≈Ø proti geofence

1. Zaƒçnƒõte vytvo≈ôen√≠m URL pro dotaz na webov√© API. Form√°t je:

    ```output
    https://atlas.microsoft.com/spatial/geofence/json?api-version=1.0&deviceId=gps-sensor&subscription-key=<subscription-key>&udid=<UDID>&lat=<lat>&lon=<lon>
    ```

    Nahraƒète `<subscription_key>` kl√≠ƒçem API pro v√°≈° √∫ƒçet Azure Maps.

    Nahraƒète `<UDID>` UDID geofence z p≈ôedchoz√≠ho √∫kolu.

    Nahraƒète `<lat>` a `<lon>` zemƒõpisnou ≈°√≠≈ôkou a d√©lkou, kter√© chcete otestovat.

    Toto URL pou≈æ√≠v√° API `https://atlas.microsoft.com/spatial/geofence/json` k dotazov√°n√≠ na geofence definovanou pomoc√≠ GeoJSON. C√≠l√≠ na verzi API `1.0`. Parametr `deviceId` je povinn√Ω a mƒõl by b√Ωt n√°zvem za≈ô√≠zen√≠, ze kter√©ho poch√°z√≠ zemƒõpisn√° ≈°√≠≈ôka a d√©lka.

    V√Ωchoz√≠ vyhled√°vac√≠ buffer je 50 m, a m≈Ø≈æete jej zmƒõnit p≈ôid√°n√≠m dal≈°√≠ho parametru `searchBuffer=<distance>`, kde `<distance>` nastav√≠te na vzd√°lenost vyhled√°vac√≠ho bufferu v metrech, od 0 do 500.

1. Pou≈æijte curl k proveden√≠ GET po≈æadavku na toto URL:

    ```sh
    curl --request GET '<URL>'
    ```

    > üíÅ Pokud obdr≈æ√≠te odpovƒõƒè s k√≥dem `BadRequest` a chybou:
    >
    > ```output
    > Invalid GeoJSON: All feature properties should contain a geometryId, which is used for identifying the geofence.
    > ```
    >
    > pak va≈°emu GeoJSON chyb√≠ sekce `properties` s `geometryId`. Budete muset upravit sv≈Øj GeoJSON, pot√© zopakovat v√Ω≈°e uveden√© kroky, znovu nahr√°t a z√≠skat nov√© UDID.

1. Odpovƒõƒè bude obsahovat seznam `geometries`, jednu pro ka≈æd√Ω polygon definovan√Ω v GeoJSON pou≈æit√Ω k vytvo≈ôen√≠ geofence. Ka≈æd√° geometrie m√° 3 zaj√≠mav√° pole: `distance`, `nearestLat` a `nearestLon`.

    ```output
    {
        "geometries": [
            {
                "deviceId": "gps-sensor",
                "udId": "7c3776eb-da87-4c52-ae83-caadf980323a",
                "geometryId": "1",
                "distance": 999.0,
                "nearestLat": 47.645875,
                "nearestLon": -122.142713
            }
        ],
        "expiredGeofenceGeometryId": [],
        "invalidPeriodGeofenceGeometryId": []
    }
    ```

    * `nearestLat` a `nearestLon` jsou zemƒõpisn√° ≈°√≠≈ôka a d√©lka bodu na okraji geofence, kter√Ω je nejbl√≠≈æe testovan√© poloze.

    * `distance` je vzd√°lenost od testovan√© polohy k nejbli≈æ≈°√≠mu bodu na okraji geofence. Z√°porn√° ƒç√≠sla znamenaj√≠ uvnit≈ô geofence, kladn√° venku. Tato hodnota bude men≈°√≠ ne≈æ 50 (v√Ωchoz√≠ vyhled√°vac√≠ buffer) nebo 999.

1. Opakujte tento proces nƒõkolikr√°t s polohami uvnit≈ô i vnƒõ geofence.

## Pou≈æit√≠ geofence ze serverless k√≥du

Nyn√≠ m≈Ø≈æete p≈ôidat nov√Ω trigger do va≈°√≠ Functions aplikace, kter√Ω bude testovat data GPS ud√°lost√≠ z IoT Hub proti geofence.

### Consumer groups

Jak si pamatujete z p≈ôedchoz√≠ch lekc√≠, IoT Hub umo≈æ≈àuje p≈ôehr√°vat ud√°losti, kter√© byly p≈ôijaty hubem, ale nebyly zpracov√°ny. Co se ale stane, pokud se p≈ôipoj√≠ v√≠ce trigger≈Ø? Jak bude vƒõdƒõt, kter√Ω z nich zpracoval kter√© ud√°losti?

Odpovƒõƒè je, ≈æe to nem≈Ø≈æe! M√≠sto toho m≈Ø≈æete definovat v√≠ce samostatn√Ωch p≈ôipojen√≠ pro ƒçten√≠ ud√°lost√≠, a ka≈æd√© z nich m≈Ø≈æe spravovat p≈ôehr√°v√°n√≠ nep≈ôeƒçten√Ωch zpr√°v. Tyto se naz√Ωvaj√≠ *consumer groups*. Kdy≈æ se p≈ôipoj√≠te k endpointu, m≈Ø≈æete specifikovat, ke kter√© consumer group se chcete p≈ôipojit. Ka≈æd√° komponenta va≈°√≠ aplikace se p≈ôipoj√≠ k jin√© consumer group.

![Jeden IoT Hub se 3 consumer groups distribuuj√≠c√≠ stejn√© zpr√°vy do 3 r≈Øzn√Ωch Functions aplikac√≠](../../../../../translated_images/consumer-groups.a3262e26fc27ba2092863678ad57af15c7223416e388a23f330c058cf4358630.cs.png)

Teoreticky se m≈Ø≈æe ke ka≈æd√© consumer group p≈ôipojit a≈æ 5 aplikac√≠, a v≈°echny obdr≈æ√≠ zpr√°vy, kdy≈æ doraz√≠. Nejlep≈°√≠ prax√≠ je m√≠t pouze jednu aplikaci p≈ôistupuj√≠c√≠ ke ka≈æd√© consumer group, aby se zabr√°nilo duplicitn√≠mu zpracov√°n√≠ zpr√°v a zajistilo, ≈æe p≈ôi restartov√°n√≠ budou v≈°echny za≈ôazen√© zpr√°vy spr√°vnƒõ zpracov√°ny. Nap≈ô√≠klad pokud spust√≠te svou Functions aplikaci lok√°lnƒõ i v cloudu, obƒõ budou zpracov√°vat zpr√°vy, co≈æ povede k duplicitn√≠m blob≈Øm ulo≈æen√Ωm v √∫lo≈æi≈°ti.

Pokud zkontrolujete soubor `function.json` pro IoT Hub trigger, kter√Ω jste vytvo≈ôili v d≈ô√≠vƒõj≈°√≠ lekci, uvid√≠te consumer group v sekci vazby triggeru event hubu:

```json
"consumerGroup": "$Default"
```

Kdy≈æ vytvo≈ô√≠te IoT Hub, z√≠sk√°te v√Ωchoz√≠ consumer group `$Default`. Pokud chcete p≈ôidat dal≈°√≠ trigger, m≈Ø≈æete to udƒõlat pomoc√≠ nov√© consumer group.

> üíÅ V t√©to lekci pou≈æijete jinou funkci k testov√°n√≠ geofence ne≈æ tu, kter√° se pou≈æ√≠v√° k ukl√°d√°n√≠ GPS dat. To m√° uk√°zat, jak pou≈æ√≠vat consumer groups a oddƒõlit k√≥d, aby byl snaz≈°√≠ na ƒçten√≠ a pochopen√≠. V produkƒçn√≠ aplikaci existuje mnoho zp≈Øsob≈Ø, jak to m≈Ø≈æete navrhnout ‚Äì um√≠stƒõn√≠ obou do jedn√© funkce, pou≈æit√≠ triggeru na √∫lo≈æi≈°ti k spu≈°tƒõn√≠ funkce pro kontrolu geofence, nebo pou≈æit√≠ v√≠ce funkc√≠. Neexistuje ‚Äûspr√°vn√Ω zp≈Øsob‚Äú, z√°le≈æ√≠ na zbytku va≈°√≠ aplikace a va≈°ich pot≈ôeb√°ch.

### √ökol ‚Äì vytvo≈ôen√≠ nov√© consumer group

1. Spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz k vytvo≈ôen√≠ nov√© consumer group nazvan√© `geofence` pro v√°≈° IoT Hub:

    ```sh
    az iot hub consumer-group create --name geofence \
                                     --hub-name <hub_name>
    ```

    Nahraƒète `<hub_name>` n√°zvem, kter√Ω jste pou≈æili pro sv≈Øj IoT Hub.

1. Pokud chcete vidƒõt v≈°echny consumer groups pro IoT Hub, spus≈•te n√°sleduj√≠c√≠ p≈ô√≠kaz:

    ```sh
    az iot hub consumer-group list --output table \
                                   --hub-name <hub_name>
    ```

    Nahraƒète `<hub_name>` n√°zvem, kter√Ω jste pou≈æili pro sv≈Øj IoT Hub. Tento p≈ô√≠kaz zobraz√≠ v≈°echny consumer groups.

    ```output
    Name      ResourceGroup
    --------  ---------------
    $Default  gps-sensor
    geofence  gps-sensor
    ```

> üíÅ Kdy≈æ jste v d≈ô√≠vƒõj≈°√≠ lekci spustili monitor ud√°lost√≠ IoT Hub, p≈ôipojil se k v√Ωchoz√≠ consumer group `$Default`. Proto nem≈Ø≈æete spustit monitor ud√°lost√≠ a trigger ud√°lost√≠ souƒçasnƒõ. Pokud chcete spustit oboj√≠, m≈Ø≈æete pou≈æ√≠t jin√© consumer groups pro v≈°echny va≈°e Functions aplikace a ponechat `$Default` pro monitor ud√°lost√≠.

### √ökol ‚Äì vytvo≈ôen√≠ nov√©ho IoT Hub triggeru

1. P≈ôidejte nov√Ω trigger ud√°lost√≠ IoT Hub do va≈°√≠ aplikace `gps-trigger`, kterou jste vytvo≈ôili v d≈ô√≠vƒõj≈°√≠ lekci. Nazvƒõte tuto funkci `geofence-trigger`.

    > ‚ö†Ô∏è M≈Ø≈æete se odkazovat na [instrukce pro vytvo≈ôen√≠ triggeru ud√°lost√≠ IoT Hub z projektu 2, lekce 5, pokud je to pot≈ôeba](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#create-an-iot-hub-event-trigger).

1. Nakonfigurujte p≈ôipojovac√≠ ≈ôetƒõzec IoT Hub v souboru `function.json`. Soubor `local.settings.json` je sd√≠len mezi v≈°emi triggery v aplikaci Functions.

1. Aktualizujte hodnotu `consumerGroup` v souboru `function.json`, aby odkazovala na novou consumer group `geofence`:

    ```json
    "consumerGroup": "geofence"
    ```

1. Budete pot≈ôebovat kl√≠ƒç p≈ôedplatn√©ho pro v√°≈° √∫ƒçet Azure Maps v tomto triggeru, tak≈æe p≈ôidejte nov√Ω z√°znam do souboru `local.settings.json` nazvan√Ω `MAPS_KEY`.

1. Spus≈•te aplikaci Functions, abyste se ujistili, ≈æe se p≈ôipojuje a zpracov√°v√° zpr√°vy. Trigger `iot-hub-trigger` z d≈ô√≠vƒõj≈°√≠ lekce bude tak√© bƒõ≈æet a nahr√°vat blob do √∫lo≈æi≈°tƒõ.

    > Aby se zabr√°nilo duplicitn√≠m GPS z√°znam≈Øm v blob √∫lo≈æi≈°ti, m≈Ø≈æete zastavit aplikaci Functions, kterou m√°te spu≈°tƒõnou v cloudu. K tomu pou≈æijte n√°sleduj√≠c√≠ p≈ô√≠kaz:
    >
    > ```sh
    > az functionapp stop --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Nahraƒète `<functions_app_name>` n√°zvem, kter√Ω jste pou≈æili pro svou Functions aplikaci.
    >
    > Pozdƒõji ji m≈Ø≈æete znovu spustit pomoc√≠ n√°sleduj√≠c√≠ho p≈ô√≠kazu:
    >
    > ```sh
    > az functionapp start --resource-group gps-sensor \
    >                     --name <functions_app_name>
    > ```
    >
    > Nahraƒète `<functions_app_name>` n√°zvem, kter√Ω jste pou≈æili pro svou Functions aplikaci.

### √ökol ‚Äì testov√°n√≠ geofence z triggeru

D≈ô√≠ve v t√©to lekci jste pou≈æili curl k dotazov√°n√≠ na geofence, abyste zjistili, zda se bod nach√°z√≠ uvnit≈ô nebo vnƒõ. Podobn√Ω webov√Ω po≈æadavek m≈Ø≈æete prov√©st z va≈°eho triggeru.

1. Pro dotazov√°n√≠ na geofence pot≈ôebujete jej√≠ UDID. P≈ôidejte nov√Ω z√°znam do souboru `local.settings.json` nazvan√Ω `GEOFENCE_UDID` s touto hodnotou.

1. Otev≈ôete soubor `__init__.py` z nov√©ho triggeru `geofence-trigger`.

1. P≈ôidejte n√°sleduj√≠c√≠ import na zaƒç√°tek souboru:

    ```python
    import json
    import os
    import requests
    ```

    Bal√≠ƒçek `requests` umo≈æ≈àuje prov√°dƒõt webov√© API po≈æadavky. Azure Maps nem√° Python SDK, tak≈æe mus√≠te prov√°dƒõt webov√© API po≈æadavky, abyste jej mohli pou≈æ√≠vat z Python k√≥du.

1. P≈ôidejte n√°sleduj√≠c√≠ 2 ≈ô√°dky na zaƒç√°tek metody `main`, abyste z√≠skali kl√≠ƒç p≈ôedplatn√©ho Maps:

    ```python
    maps_key = os.environ['MAPS_KEY']
    geofence_udid = os.environ['GEOFENCE_UDID']    
    ```

1. Uvnit≈ô smyƒçky `for event in events` p≈ôidejte n√°sleduj√≠c√≠ k√≥d pro z√≠sk√°n√≠ zemƒõpisn√© ≈°√≠≈ôky a d√©lky z ka≈æd√© ud√°losti:

    ```python
    event_body = json.loads(event.get_body().decode('utf-8'))
    lat = event_body['gps']['lat']
    lon = event_body['gps']['lon']
    ```

    Tento k√≥d p≈ôev√°d√≠ JSON z tƒõla ud√°losti na slovn√≠k a pot√© extrahuje `lat` a `lon` z pole `gps`.

1. P≈ôi pou≈æit√≠ `requests`, m√≠sto sestavov√°n√≠ dlouh√©ho URL, jak jste to dƒõlali s curl, m≈Ø≈æete pou≈æ√≠t pouze ƒç√°st URL a p≈ôedat parametry jako slovn√≠k. P≈ôidejte n√°sleduj√≠c√≠ k√≥d pro definov√°n√≠ URL k vol√°n√≠ a konfiguraci parametr≈Ø:

    ```python
    url = 'https://atlas.microsoft.com/spatial/geofence/json'

    params = {
        'api-version': 1.0,
        'deviceId': 'gps-sensor',
        'subscription-key': maps_key,
        'udid' : geofence_udid,
        'lat' : lat,
        'lon' : lon
    }
    ```

    Polo≈æky ve slovn√≠ku `params` budou odpov√≠dat kl√≠ƒçov√Ωm hodnot√°m, kter√© jste pou≈æili p≈ôi vol√°n√≠ webov√©ho API p≈ôes curl.

1. P≈ôidejte n√°sleduj√≠c√≠ ≈ô√°dky k√≥du pro vol√°n√≠ webov√©ho API:

    ```python
    response = requests.get(url, params=params)
    response_body = json.loads(response.text)
    ```

    Toto vol√° URL s parametry a z√≠sk√°v√° zpƒõt objekt odpovƒõdi.

1. P≈ôidejte n√°sleduj√≠c√≠ k√≥d pod tento:

    ```python
    distance = response_body['geometries'][0]['distance']

    if distance == 999:
        logging.info('Point is outside geofence')
    elif distance > 0:
        logging.info(f'Point is just outside geofence by a distance of {distance}m')
    elif distance == -999:
        logging.info(f'Point is inside geofence')
    else:
        logging.info(f'Point is just inside geofence by a distance of {distance}m')
    ```

    Tento k√≥d p≈ôedpokl√°d√° jednu geometrickou oblast a extrahuje vzd√°lenost z t√©to jedin√© oblasti. Pot√© zapisuje r≈Øzn√© zpr√°vy na z√°kladƒõ vzd√°lenosti.

1. Spus≈•te tento k√≥d. V logovac√≠m v√Ωstupu uvid√≠te, zda GPS sou≈ôadnice jsou uvnit≈ô nebo vnƒõ geofence, s uveden√≠m vzd√°lenosti, pokud je bod do 50 m. Vyzkou≈°ejte tento k√≥d s r≈Øzn√Ωmi geofence na z√°kladƒõ polohy va≈°eho GPS senzoru, zkuste senzor p≈ôesunout (nap≈ô√≠klad p≈ôipojen√Ω k WiFi z mobiln√≠ho telefonu nebo s r≈Øzn√Ωmi sou≈ôadnicemi na virtu√°ln√≠m IoT za≈ô√≠zen√≠), abyste vidƒõli zmƒõny.

1. A≈æ budete p≈ôipraveni, nasadte tento k√≥d do va≈°√≠ Functions aplikace v cloudu. Nezapome≈àte nasadit nov√© nastaven√≠ aplikace.

    > ‚ö†Ô∏è M≈Ø≈æete se odkazovat na [instrukce pro nahr√°n√≠ nastaven√≠ aplikace z projektu 2, lekce 5, pokud je to pot≈ôeba](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---upload-your-application-settings).

    > ‚ö†Ô∏è M≈Ø≈æete se odkazovat na [instrukce pro nasazen√≠ va≈°√≠ Functions aplikace z projektu 2, lekce 5, pokud je to pot≈ôeba](../../../2-farm/lessons/5-migrate-application-to-the-cloud/README.md#task---deploy-your-functions-app-to-the-cloud).

> üíÅ Tento k√≥d najdete ve slo≈æce [code/functions](../../../../../3-transport/lessons/4-geofences/code/functions).

---

## üöÄ V√Ωzva

V t√©to lekci jste p≈ôidali jednu geofence pomoc√≠ GeoJSON souboru s jedn√≠m polygonem. M≈Ø≈æete nahr√°t v√≠ce polygon≈Ø najednou, pokud maj√≠ r≈Øzn√© hodnoty `geometryId` v sekci `properties`.

Zkuste nahr√°t GeoJSON soubor s v√≠ce polygon≈Ø a upravte sv≈Øj k√≥d tak, aby zjistil, ke kter√©mu polygonu jsou GPS sou≈ôadnice nejbl√≠≈æe nebo uvnit≈ô.

## Kv√≠z po p≈ôedn√°≈°ce

[Kv√≠z po p≈ôedn√°≈°ce](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/28)

## P≈ôehled & Samostudium

* P≈ôeƒçtƒõte si v√≠ce o geofence a nƒõkter√Ωch jejich p≈ô√≠padech pou≈æit√≠ na [str√°nce Geofencing na Wikipedii](https://en.wikipedia.org/wiki/Geo-fence).
* P≈ôeƒçtƒõte si v√≠ce o geofencing API Azure Maps na [dokumentaci Microsoft Azure Maps Spatial - Get Geofence](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence?WT.mc_id=academic-17441-jabenn).
* P≈ôeƒçtƒõte si v√≠ce o consumer groups v [dokumentaci Microsoftu o funkc√≠ch a terminologii v Azure Event Hubs - Event consumers](https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=academic-17441-jabenn#event-consumers).

## Zad√°n√≠

[Pos√≠l√°n√≠ ozn√°men√≠ pomoc√≠ Twilio](assignment.md)

---

**Prohl√°≈°en√≠**:  
Tento dokument byl p≈ôelo≈æen pomoc√≠ slu≈æby pro automatick√Ω p≈ôeklad [Co-op Translator](https://github.com/Azure/co-op-translator). P≈ôesto≈æe se sna≈æ√≠me o p≈ôesnost, mƒõjte na pamƒõti, ≈æe automatick√© p≈ôeklady mohou obsahovat chyby nebo nep≈ôesnosti. P≈Øvodn√≠ dokument v jeho p≈Øvodn√≠m jazyce by mƒõl b√Ωt pova≈æov√°n za autoritativn√≠ zdroj. Pro d≈Øle≈æit√© informace doporuƒçujeme profesion√°ln√≠ lidsk√Ω p≈ôeklad. Neodpov√≠d√°me za ≈æ√°dn√° nedorozumƒõn√≠ nebo nespr√°vn√© interpretace vypl√Ωvaj√≠c√≠ z pou≈æit√≠ tohoto p≈ôekladu.