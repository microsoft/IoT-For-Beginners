<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-27T12:05:15+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "ne"
}
-->
# рдЖрдлреНрдиреЛ IoT рдЙрдкрдХрд░рдгрд▓рд╛рдИ рдХреНрд▓рд╛рдЙрдбрд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрдиреБрд╣реЛрд╕реН - Wio Terminal

рдпрд╕ рдкрд╛рдардХреЛ рдпрд╕ рднрд╛рдЧрдорд╛, рддрдкрд╛рдИрдВ рдЖрдлреНрдиреЛ Wio Terminal рд▓рд╛рдИ IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрдиреБрд╣реБрдиреЗрдЫ, рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрдард╛рдЙрди рд░ рдЖрджреЗрд╢рд╣рд░реВ рдкреНрд░рд╛рдкреНрдд рдЧрд░реНрдиред

## рдЖрдлреНрдиреЛ рдЙрдкрдХрд░рдгрд▓рд╛рдИ IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрдиреБрд╣реЛрд╕реН

рдЕрд░реНрдХреЛ рдЪрд░рдг рднрдиреЗрдХреЛ рдЖрдлреНрдиреЛ рдЙрдкрдХрд░рдгрд▓рд╛рдИ IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрдиреБ рд╣реЛред

### рдХрд╛рд░реНрдп - IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрдиреБрд╣реЛрд╕реН

1. VS Code рдорд╛ `soil-moisture-sensor` рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реНред

1. `platformio.ini` рдлрд╛рдЗрд▓ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реНред `knolleary/PubSubClient` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдирд┐рд░реНрднрд░рддрд╛ рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реНред рдпреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ MQTT рдмреНрд░реЛрдХрд░рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрди рдкреНрд░рдпреЛрдЧ рдЧрд░рд┐рдПрдХреЛ рдерд┐рдпреЛ, рд░ IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрди рдЖрд╡рд╢реНрдпрдХ рдЫреИрдиред

1. рддрд▓рдХрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдирд┐рд░реНрднрд░рддрд╛ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    `Seeed Arduino RTC` рд▓рд╛рдЗрдмреНрд░реЗрд░реАрд▓реЗ Wio Terminal рдорд╛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдШрдбреАрд╕рдБрдЧ рдЕрдиреНрддрд░рдХреНрд░рд┐рдпрд╛ рдЧрд░реНрди рдХреЛрдб рдкреНрд░рджрд╛рди рдЧрд░реНрджрдЫ, рдЬреБрди рд╕рдордп рдЯреНрд░реНрдпрд╛рдХ рдЧрд░реНрди рдкреНрд░рдпреЛрдЧ рдЧрд░рд┐рдиреНрдЫред рдмрд╛рдБрдХреА рд▓рд╛рдЗрдмреНрд░реЗрд░реАрд╣рд░реВрд▓реЗ рддрдкрд╛рдИрдВрдХреЛ IoT рдЙрдкрдХрд░рдгрд▓рд╛рдИ IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрди рдЕрдиреБрдорддрд┐ рджрд┐рдиреНрдЫред

1. `platformio.ini` рдлрд╛рдЗрд▓рдХреЛ рддрд▓рдорд╛ рдирд┐рдореНрди рдердкреНрдиреБрд╣реЛрд╕реН:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    рдпреЛ рдХрдореНрдкрд╛рдЗрд▓рд░ рдлреНрд▓реНрдпрд╛рдЧ рд╕реЗрдЯ рдЧрд░реНрджрдЫ рдЬреБрди Arduino IoT Hub рдХреЛрдб рдХрдореНрдкрд╛рдЗрд▓ рдЧрд░реНрджрд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реБрдиреНрдЫред

1. `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реНред рд╕рдмреИ MQTT рд╕реЗрдЯрд┐рдЩрд╣рд░реВ рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН рд░ рдЙрдкрдХрд░рдг рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдЩрдХреЛ рд▓рд╛рдЧрд┐ рдирд┐рдореНрди рд╕реНрдерд┐рд░рд╛рдВрдХ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    `<connection string>` рд▓рд╛рдИ рддрдкрд╛рдИрдВрд▓реЗ рдкрд╣рд┐рд▓реЗ рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдЧрд░реЗрдХреЛ рдЙрдкрдХрд░рдгрдХреЛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдЩрд▓реЗ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдЧрд░реНрдиреБрд╣реЛрд╕реНред

1. IoT Hub рд╕рдБрдЧрдХреЛ рдЬрдбрд╛рди рд╕рдордп-рдЖрдзрд╛рд░рд┐рдд рдЯреЛрдХрди рдкреНрд░рдпреЛрдЧ рдЧрд░реНрджрдЫред рдпрд╕рдХреЛ рдорддрд▓рдм IoT рдЙрдкрдХрд░рдгрд▓реЗ рд╣рд╛рд▓рдХреЛ рд╕рдордп рдерд╛рд╣рд╛ рдкрд╛рдЙрди рдЖрд╡рд╢реНрдпрдХ рдЫред Windows, macOS рд╡рд╛ Linux рдЬрд╕реНрддрд╛ рдЕрдкрд░реЗрдЯрд┐рдЩ рд╕рд┐рд╕реНрдЯрдорд╣рд░реВ рдЬрд╕реНрддреЛ, рдорд╛рдЗрдХреНрд░реЛрдХрдиреНрдЯреНрд░реЛрд▓рд░рд╣рд░реВрд▓реЗ рдЗрдиреНрдЯрд░рдиреЗрдЯрдорд╛рд░реНрдлрдд рд╕реНрд╡рддрдГ рд╣рд╛рд▓рдХреЛ рд╕рдордп рд╕рдордХреНрд░рдордг рдЧрд░реНрджреИрдирдиреНред рдпрд╕рдХреЛ рдорддрд▓рдм рддрдкрд╛рдИрдВрд▓реЗ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) рд╕рд░реНрднрд░рдмрд╛рдЯ рд╣рд╛рд▓рдХреЛ рд╕рдордп рдкреНрд░рд╛рдкреНрдд рдЧрд░реНрди рдХреЛрдб рдердкреНрди рдЖрд╡рд╢реНрдпрдХ рдЫред рдПрдХрдкрдЯрдХ рд╕рдордп рдкреНрд░рд╛рдкреНрдд рднрдПрдкрдЫрд┐, рдпрд╕рд▓рд╛рдИ Wio Terminal рдорд╛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдШрдбреАрдорд╛ рднрдгреНрдбрд╛рд░рдг рдЧрд░реНрди рд╕рдХрд┐рдиреНрдЫ, рдЬрд╕рд▓реЗ рдЙрдкрдХрд░рдгрд▓реЗ рдкрд╛рд╡рд░ рдЧреБрдорд╛рдПрдХреЛ рдЫреИрди рднрдиреЗ рд╕рд╣реА рд╕рдордп рдкрдЫрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реНрди рдЕрдиреБрдорддрд┐ рджрд┐рдиреНрдЫред `ntp.h` рдирд╛рдордХ рдирдпрд╛рдБ рдлрд╛рдЗрд▓ рдирд┐рдореНрди рдХреЛрдбрд╕рдБрдЧ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    рдпрд╕ рдХреЛрдбрдХреЛ рд╡рд┐рд╡рд░рдг рдпрд╕ рдкрд╛рдардХреЛ рджрд╛рдпрд░рд╛рднрдиреНрджрд╛ рдмрд╛рд╣рд┐рд░ рдЫред рдпрд╕рд▓реЗ `initTime` рдирд╛рдордХ рдПрдХ рдлрдВрдХреНрд╢рди рдкрд░рд┐рднрд╛рд╖рд┐рдд рдЧрд░реНрджрдЫ рдЬрд╕рд▓реЗ NTP рд╕рд░реНрднрд░рдмрд╛рдЯ рд╣рд╛рд▓рдХреЛ рд╕рдордп рдкреНрд░рд╛рдкреНрдд рдЧрд░реНрджрдЫ рд░ Wio Terminal рдорд╛ рдШрдбреА рд╕реЗрдЯ рдЧрд░реНрди рдкреНрд░рдпреЛрдЧ рдЧрд░реНрджрдЫред

1. `main.cpp` рдлрд╛рдЗрд▓ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реН рд░ рд╕рдмреИ MQTT рдХреЛрдб рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН, рдЬрд╕рдорд╛ `PubSubClient.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓, `PubSubClient` рднреЗрд░рд┐рдПрдмрд▓рдХреЛ рдШреЛрд╖рдгрд╛, `reconnectMQTTClient` рд░ `createMQTTClient` рдореЗрдердбрд╣рд░реВ, рд░ рдпреА рднреЗрд░рд┐рдПрдмрд▓рд╣рд░реВ рд░ рдореЗрдердбрд╣рд░реВрдорд╛ рдХреБрдиреИ рдкрдирд┐ рдХрд▓рд╣рд░реВ рд╕рдорд╛рд╡реЗрд╢ рдЫрдиреНред рдпреЛ рдлрд╛рдЗрд▓рдорд╛ рдХреЗрд╡рд▓ WiFi рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрди, рдорд╛рдЯреЛрдХреЛ рдЪрд┐рд╕реЛрдкрди рдкреНрд░рд╛рдкреНрдд рдЧрд░реНрди рд░ рдпрд╕рд╕рдБрдЧ JSON рдбрдХреБрдореЗрдиреНрдЯ рд╕рд┐рд░реНрдЬрдирд╛ рдЧрд░реНрди рдХреЛрдб рд╕рдорд╛рд╡реЗрд╢ рдЧрд░реНрдиреБрдкрд░реНрдЫред

1. IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реАрд╣рд░реВ рд░ рд╕рдордп рд╕реЗрдЯ рдЧрд░реНрди рд╣реЗрдбрд░ рдлрд╛рдЗрд▓рд╣рд░реВ рд╕рдорд╛рд╡реЗрд╢ рдЧрд░реНрди `main.cpp` рдлрд╛рдЗрд▓рдХреЛ рдорд╛рдерд┐ рдирд┐рдореНрди `#include` рдирд┐рд░реНрджреЗрд╢рдирд╣рд░реВ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. рд╣рд╛рд▓рдХреЛ рд╕рдордп рд╕реЗрдЯ рдЧрд░реНрди `setup` рдлрдВрдХреНрд╢рдирдХреЛ рдЕрдиреНрддреНрдпрдорд╛ рдирд┐рдореНрди рдХрд▓ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    initTime();
    ```

1. рдлрд╛рдЗрд▓рдХреЛ рдорд╛рдерд┐, рд╕рдорд╛рд╡реЗрд╢ рдирд┐рд░реНрджреЗрд╢рдирд╣рд░реВрдХреЛ рдареАрдХ рддрд▓, рдирд┐рдореНрди рднреЗрд░рд┐рдПрдмрд▓ рдШреЛрд╖рдгрд╛ рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    рдпрд╕рд▓реЗ `IOTHUB_DEVICE_CLIENT_LL_HANDLE` рдШреЛрд╖рдгрд╛ рдЧрд░реНрджрдЫ, IoT Hub рд╕рдБрдЧрдХреЛ рдЬрдбрд╛рдирдХреЛ рд▓рд╛рдЧрд┐ рд╣реНрдпрд╛рдиреНрдбрд▓ред

1. рдпрд╕рдХреЛ рддрд▓, рдирд┐рдореНрди рдХреЛрдб рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    рдпрд╕рд▓реЗ рдПрдХ рдХреНрдпрд╛рд▓рдмреНрдпрд╛рдХ рдлрдВрдХреНрд╢рди рдШреЛрд╖рдгрд╛ рдЧрд░реНрджрдЫ рдЬреБрди IoT Hub рд╕рдБрдЧрдХреЛ рдЬрдбрд╛рдирдХреЛ рд╕реНрдерд┐рддрд┐ рдкрд░рд┐рд╡рд░реНрддрди рд╣реБрдБрджрд╛, рдЬрд╕реНрддреИ рдЬрдбрд╛рди рд╡рд╛ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рд╣реБрдБрджрд╛, рдХрд▓ рдЧрд░рд┐рдиреНрдЫред рд╕реНрдерд┐рддрд┐ рд╕рд┐рд░рд┐рдпрд▓ рдкреЛрд░реНрдЯрдорд╛ рдкрдард╛рдЗрдиреНрдЫред

1. рдпрд╕рдХреЛ рддрд▓, IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рдЧрд░реНрди рдлрдВрдХреНрд╢рди рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    рдпреЛ рдХреЛрдбрд▓реЗ IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛрдбрд▓рд╛рдИ рдЗрдирд┐рд╕рд┐рдпрд▓рд╛рдЗрдЬ рдЧрд░реНрджрдЫ, рддреНрдпрд╕рдкрдЫрд┐ `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓рдорд╛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдЩ рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ рдЬрдбрд╛рди рд╕рд┐рд░реНрдЬрдирд╛ рдЧрд░реНрджрдЫред рдпреЛ рдЬрдбрд╛рди MQTT рдорд╛ рдЖрдзрд╛рд░рд┐рдд рдЫред рдпрджрд┐ рдЬрдбрд╛рди рдЕрд╕рдлрд▓ рд╣реБрдиреНрдЫ рднрдиреЗ, рдпреЛ рд╕рд┐рд░рд┐рдпрд▓ рдкреЛрд░реНрдЯрдорд╛ рдкрдард╛рдЗрдиреНрдЫ - рдпрджрд┐ рддрдкрд╛рдИрдВрд▓реЗ рдпреЛ рдЖрдЙрдЯрдкреБрдЯрдорд╛ рджреЗрдЦреНрдиреБрднрдпреЛ рднрдиреЗ, рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдЩ рдЬрд╛рдБрдЪ рдЧрд░реНрдиреБрд╣реЛрд╕реНред рдЕрдиреНрддрддрдГ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд┐рддрд┐ рдХреНрдпрд╛рд▓рдмреНрдпрд╛рдХ рд╕реЗрдЯрдЕрдк рдЧрд░рд┐рдиреНрдЫред

1. `setup` рдлрдВрдХреНрд╢рдирдорд╛ `initTime` рдХрд▓рдХреЛ рддрд▓ рдпреЛ рдлрдВрдХреНрд╢рди рдХрд▓ рдЧрд░реНрдиреБрд╣реЛрд╕реН:

    ```cpp
    connectIoTHub();
    ```

1. MQTT рдХреНрд▓рд╛рдЗрдиреНрдЯрдХреЛ рдЬрд╕реНрддреИ, рдпреЛ рдХреЛрдб рдПрдХрд▓ рдереНрд░реЗрдбрдорд╛ рдЪрд▓реНрдЫ рддреНрдпрд╕реИрд▓реЗ рд╣рдмрд▓реЗ рдкрдард╛рдПрдХреЛ рд╕рдиреНрджреЗрд╢рд╣рд░реВ рд░ рд╣рдмрдорд╛ рдкрдард╛рдЗрдПрдХрд╛ рд╕рдиреНрджреЗрд╢рд╣рд░реВ рдкреНрд░рд╢реЛрдзрди рдЧрд░реНрди рд╕рдордп рдЪрд╛рд╣рд┐рдиреНрдЫред `loop` рдлрдВрдХреНрд╢рдирдХреЛ рдорд╛рдерд┐ рдирд┐рдореНрди рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. рдпреЛ рдХреЛрдб рдирд┐рд░реНрдорд╛рдг рд░ рдЕрдкрд▓реЛрдб рдЧрд░реНрдиреБрд╣реЛрд╕реНред рддрдкрд╛рдИрдВ рд╕рд┐рд░рд┐рдпрд▓ рдореЛрдирд┐рдЯрд░рдорд╛ рдЬрдбрд╛рди рджреЗрдЦреНрдиреБрд╣реБрдиреЗрдЫ:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    рдЖрдЙрдЯрдкреБрдЯрдорд╛ рддрдкрд╛рдИрдВрд▓реЗ NTP рд╕рдордп рдкреНрд░рд╛рдкреНрдд рднрдЗрд░рд╣реЗрдХреЛ рджреЗрдЦреНрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫ, рддреНрдпрд╕рдкрдЫрд┐ рдЙрдкрдХрд░рдг рдХреНрд▓рд╛рдЗрдиреНрдЯ рдЬрдбрд╛рди рднрдЗрд░рд╣реЗрдХреЛ рджреЗрдЦреНрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред рдЬрдбрд╛рди рдЧрд░реНрди рдХреЗрд╣реА рд╕реЗрдХреЗрдиреНрдб рд▓рд╛рдЧреНрди рд╕рдХреНрдЫ, рддреНрдпрд╕реИрд▓реЗ рдЙрдкрдХрд░рдг рдЬрдбрд╛рди рднрдЗрд░рд╣реЗрдХреЛ рдмреЗрд▓рд╛ рддрдкрд╛рдИрдВрд▓реЗ рдЖрдЙрдЯрдкреБрдЯрдорд╛ рдорд╛рдЯреЛрдХреЛ рдЪрд┐рд╕реЛрдкрди рджреЗрдЦреНрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред

    > ЁЯТБ рддрдкрд╛рдИрдВ NTP рдХреЛ UNIX рд╕рдордпрд▓рд╛рдИ [unixtimestamp.com](https://www.unixtimestamp.com) рдЬрд╕реНрддрд╛ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ рдкрдвреНрди рдорд┐рд▓реНрдиреЗ рд╕рдВрд╕реНрдХрд░рдгрдорд╛ рд░реВрдкрд╛рдиреНрддрд░рдг рдЧрд░реНрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред

## рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрдард╛рдЙрдиреБрд╣реЛрд╕реН

рдЕрдм рддрдкрд╛рдИрдВрдХреЛ рдЙрдкрдХрд░рдг рдЬрдбрд╛рди рднрдПрдХреЛ рдЫ, рддрдкрд╛рдИрдВ MQTT рдмреНрд░реЛрдХрд░рдХреЛ рд╕рдЯреНрдЯрд╛ IoT Hub рдорд╛ рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрдард╛рдЙрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред

### рдХрд╛рд░реНрдп - рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрдард╛рдЙрдиреБрд╣реЛрд╕реН

1. `setup` рдлрдВрдХреНрд╢рдирдХреЛ рдорд╛рдерд┐ рдирд┐рдореНрди рдлрдВрдХреНрд╢рди рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    рдпреЛ рдХреЛрдбрд▓реЗ рдкрд╛рд╕ рдЧрд░рд┐рдПрдХреЛ рд╕реНрдЯреНрд░рд┐рдЩрдмрд╛рдЯ IoT Hub рд╕рдиреНрджреЗрд╢ рд╕рд┐рд░реНрдЬрдирд╛ рдЧрд░реНрджрдЫ, рдпрд╕рд▓рд╛рдИ рд╣рдмрдорд╛ рдкрдард╛рдЙрдБрдЫ, рддреНрдпрд╕рдкрдЫрд┐ рд╕рдиреНрджреЗрд╢ рд╡рд╕реНрддреБ рд╕рдлрд╛ рдЧрд░реНрджрдЫред

1. рд╕рд┐рд░рд┐рдпрд▓ рдкреЛрд░реНрдЯрдорд╛ рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрдард╛рдЙрдиреЗ рд▓рд╛рдЗрдирдХреЛ рдареАрдХ рдкрдЫрд┐ `loop` рдлрдВрдХреНрд╢рдирдорд╛ рдпреЛ рдХреЛрдб рдХрд▓ рдЧрд░реНрдиреБрд╣реЛрд╕реН:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## рдЖрджреЗрд╢рд╣рд░реВ рд╣реНрдпрд╛рдиреНрдбрд▓ рдЧрд░реНрдиреБрд╣реЛрд╕реН

рддрдкрд╛рдИрдВрдХреЛ рдЙрдкрдХрд░рдгрд▓реЗ рд░рд┐рд▓реЗ рдирд┐рдпрдиреНрддреНрд░рдг рдЧрд░реНрди рд╕рд░реНрд╡рд░ рдХреЛрдбрдмрд╛рдЯ рдЖрджреЗрд╢ рд╣реНрдпрд╛рдиреНрдбрд▓ рдЧрд░реНрди рдЖрд╡рд╢реНрдпрдХ рдЫред рдпреЛ рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдзрдХреЛ рд░реВрдкрдорд╛ рдкрдард╛рдЗрдиреНрдЫред

## рдХрд╛рд░реНрдп - рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдз рд╣реНрдпрд╛рдиреНрдбрд▓ рдЧрд░реНрдиреБрд╣реЛрд╕реН

1. `connectIoTHub` рдлрдВрдХреНрд╢рдирдХреЛ рдЕрдШрд┐ рдирд┐рдореНрди рдХреЛрдб рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    рдпреЛ рдХреЛрдбрд▓реЗ рдХреНрдпрд╛рд▓рдмреНрдпрд╛рдХ рдореЗрдердб рдкрд░рд┐рднрд╛рд╖рд┐рдд рдЧрд░реНрджрдЫ рдЬреБрди IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реАрд▓реЗ рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдз рдкреНрд░рд╛рдкреНрдд рдЧрд░реНрджрд╛ рдХрд▓ рдЧрд░реНрди рд╕рдХреНрдЫред рдЕрдиреБрд░реЛрдз рдЧрд░рд┐рдПрдХреЛ рд╡рд┐рдзрд┐ `method_name` рдкреНрдпрд╛рд░рд╛рдорд┐рдЯрд░рдорд╛ рдкрдард╛рдЗрдиреНрдЫред рдпреЛ рдлрдВрдХреНрд╢рдирд▓реЗ рд╕рд┐рд░рд┐рдпрд▓ рдкреЛрд░реНрдЯрдорд╛ рдХрд▓ рдЧрд░рд┐рдПрдХреЛ рд╡рд┐рдзрд┐ рдкреНрд░рд┐рдиреНрдЯ рдЧрд░реНрджрдЫ, рддреНрдпрд╕рдкрдЫрд┐ рд╡рд┐рдзрд┐ рдирд╛рдордХреЛ рдЖрдзрд╛рд░рдорд╛ рд░рд┐рд▓реЗ рдЕрди рд╡рд╛ рдЕрдл рдЧрд░реНрджрдЫред

    > ЁЯТБ рдпреЛ рдПрдХрд▓ рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдзрдорд╛ рдкрдирд┐ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЧрд░реНрди рд╕рдХрд┐рдиреНрдЫ, рд░рд┐рд▓реЗрдХреЛ рдЗрдЪреНрдЫрд┐рдд рдЕрд╡рд╕реНрдерд╛ рдЕрдиреБрд░реЛрдзрдХреЛ рд╕рд╛рде рдкрд╛рд╕ рдЧрд░реНрди рд╕рдХрд┐рдиреЗ рдкреЗрд▓реЛрдбрдорд╛ рдкрд╛рд╕ рдЧрд░реНрджреИ, рдЬреБрди `payload` рдкреНрдпрд╛рд░рд╛рдорд┐рдЯрд░рдмрд╛рдЯ рдЙрдкрд▓рдмреНрдз рд╣реБрдиреНрдЫред

1. `directMethodCallback` рдлрдВрдХреНрд╢рдирдХреЛ рдЕрдиреНрддреНрдпрдорд╛ рдирд┐рдореНрди рдХреЛрдб рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдзрд╣рд░реВрд▓рд╛рдИ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЖрд╡рд╢реНрдпрдХ рдЫ, рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреБрдИ рднрд╛рдЧрдорд╛ рд╣реБрдиреНрдЫ - рдкрд╛рдардХреЛ рд░реВрдкрдорд╛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛, рд░ рд░рд┐рдЯрд░реНрди рдХреЛрдбред рдпреЛ рдХреЛрдбрд▓реЗ рдирд┐рдореНрди JSON рдбрдХреБрдореЗрдиреНрдЯрдХреЛ рд░реВрдкрдорд╛ рдкрд░рд┐рдгрд╛рдо рд╕рд┐рд░реНрдЬрдирд╛ рдЧрд░реНрджрдЫ:

    ```JSON
    {
        "Result": ""
    }
    ```

    рдпреЛ рддреНрдпрд╕рдкрдЫрд┐ `response` рдкреНрдпрд╛рд░рд╛рдорд┐рдЯрд░рдорд╛ рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдЧрд░рд┐рдиреНрдЫ, рд░ рдпреЛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдХреЛ рдЖрдХрд╛рд░ `response_size` рдкреНрдпрд╛рд░рд╛рдорд┐рдЯрд░рдорд╛ рд╕реЗрдЯ рдЧрд░рд┐рдиреНрдЫред рдпреЛ рдХреЛрдбрд▓реЗ рд╡рд┐рдзрд┐ рд╕рд╣реА рд░реВрдкрдорд╛ рд╣реНрдпрд╛рдиреНрдбрд▓ рдЧрд░рд┐рдПрдХреЛ рджреЗрдЦрд╛рдЙрди `IOTHUB_CLIENT_OK` рдлрд░реНрдХрд╛рдЙрдБрдЫред

1. рдХреНрдпрд╛рд▓рдмреНрдпрд╛рдХрд▓рд╛рдИ рдЬрдбрд╛рди рдЧрд░реНрди `connectIoTHub` рдлрдВрдХреНрд╢рдирдХреЛ рдЕрдиреНрддреНрдпрдорд╛ рдирд┐рдореНрди рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. `loop` рдлрдВрдХреНрд╢рдирд▓реЗ IoT Hub рджреНрд╡рд╛рд░рд╛ рдкрдард╛рдЗрдПрдХрд╛ рдШрдЯрдирд╛рд╣рд░реВ рдкреНрд░рд╢реЛрдзрди рдЧрд░реНрди `IoTHubDeviceClient_LL_DoWork` рдлрдВрдХреНрд╢рди рдХрд▓ рдЧрд░реНрдиреЗрдЫред рдпреЛ рдХреЗрд╡рд▓ `delay` рдХреЛ рдХрд╛рд░рдгрд▓реЗ рдкреНрд░рддреНрдпреЗрдХ 10 рд╕реЗрдХреЗрдиреНрдбрдорд╛ рдХрд▓ рдЧрд░рд┐рдиреНрдЫ, рдЬрд╕рдХреЛ рдорддрд▓рдм рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐рд╣рд░реВ рдХреЗрд╡рд▓ рдкреНрд░рддреНрдпреЗрдХ 10 рд╕реЗрдХреЗрдиреНрдбрдорд╛ рдкреНрд░рд╢реЛрдзрд┐рдд рд╣реБрдиреНрдЫрдиреНред рдпрд╕рд▓рд╛рдИ рдЕрдЭ рдХреБрд╢рд▓ рдмрдирд╛рдЙрди, 10 рд╕реЗрдХреЗрдиреНрдбрдХреЛ рдврд┐рд▓рд╛рдЗрд▓рд╛рдИ рдзреЗрд░реИ рдЫреЛрдЯреЛ рдврд┐рд▓рд╛рдЗрдХреЛ рд░реВрдкрдорд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЧрд░реНрди рд╕рдХрд┐рдиреНрдЫ, рдкреНрд░рддреНрдпреЗрдХ рдкрдЯрдХ `IoTHubDeviceClient_LL_DoWork` рдХрд▓ рдЧрд░реНрджреИред рдпрд╕рд▓рд╛рдИ рдЧрд░реНрди `loop` рдлрдВрдХреНрд╢рдирдХреЛ рдорд╛рдерд┐ рдирд┐рдореНрди рдХреЛрдб рдердкреНрдиреБрд╣реЛрд╕реН:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    рдпреЛ рдХреЛрдбрд▓реЗ рдмрд╛рд░рдореНрдмрд╛рд░ рд▓реВрдк рдЧрд░реНрдиреЗрдЫ, `IoTHubDeviceClient_LL_DoWork` рдХрд▓ рдЧрд░реНрдиреЗрдЫ рд░ рдкреНрд░рддреНрдпреЗрдХ рдкрдЯрдХ 100ms рдХреЛ рд▓рд╛рдЧрд┐ рдврд┐рд▓рд╛рдЗ рдЧрд░реНрдиреЗрдЫред рдпреЛ `delay_time` рдкреНрдпрд╛рд░рд╛рдорд┐рдЯрд░рдорд╛ рджрд┐рдЗрдПрдХреЛ рд╕рдордпрдХреЛ рд▓рд╛рдЧрд┐ рдврд┐рд▓рд╛рдЗ рдЧрд░реНрди рдЖрд╡рд╢реНрдпрдХ рдЬрддрд┐ рдкрдЯрдХ рдпреЛ рдЧрд░реНрдиреЗрдЫред рдпрд╕рдХреЛ рдорддрд▓рдм рдЙрдкрдХрд░рдгрд▓реЗ рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдЕрдиреБрд░реЛрдз рдкреНрд░рд╢реЛрдзрди рдЧрд░реНрди 100ms рднрдиреНрджрд╛ рдмрдвреА рдХреБрд░реНрдиреБ рдкрд░реНрджреИрдиред

1. `loop` рдлрдВрдХреНрд╢рдирдорд╛, `IoTHubDeviceClient_LL_DoWork` рдХрд▓ рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН, рд░ `delay(10000)` рдХрд▓рд▓рд╛рдИ рдирд┐рдореНрдирд╕рдБрдЧ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдЧрд░реНрдиреБрд╣реЛрд╕реН:

    ```cpp
    work_delay(10000);
    ```

> ЁЯТБ рддрдкрд╛рдИрдВ рдпреЛ рдХреЛрдб [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) рдлреЛрд▓реНрдбрд░рдорд╛ рдлреЗрд▓рд╛ рдкрд╛рд░реНрди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред

ЁЯША рддрдкрд╛рдИрдВрдХреЛ рдорд╛рдЯреЛрдХреЛ рдЪрд┐рд╕реЛрдкрди рд╕реЗрдиреНрд╕рд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо IoT Hub рд╕рдБрдЧ рдЬрдбрд╛рди рднрдПрдХреЛ рдЫ!

---

**рдЕрд╕реНрд╡реАрдХрд░рдг**:  
рдпреЛ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ AI рдЕрдиреБрд╡рд╛рдж рд╕реЗрд╡рд╛ [Co-op Translator](https://github.com/Azure/co-op-translator) рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ рдЕрдиреБрд╡рд╛рдж рдЧрд░рд┐рдПрдХреЛ рдЫред рд╣рд╛рдореА рд╢реБрджреНрдзрддрд╛рдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдЫреМрдВ, рддрд░ рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджрд┐рдиреБрд╣реЛрд╕реН рдХрд┐ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЕрдиреБрд╡рд╛рджрдорд╛ рддреНрд░реБрдЯрд┐рд╣рд░реВ рд╡рд╛ рдЕрд╢реБрджреНрдзрддрд╛рд╣рд░реВ рд╣реБрди рд╕рдХреНрдЫред рдпрд╕рдХреЛ рдореВрд▓ рднрд╛рд╖рд╛ рдорд╛ рд░рд╣реЗрдХреЛ рдореВрд▓ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝рд▓рд╛рдИ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд╕реНрд░реЛрдд рдорд╛рдирд┐рдиреБрдкрд░реНрдЫред рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реАрдХреЛ рд▓рд╛рдЧрд┐, рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдорд╛рдирд╡ рдЕрдиреБрд╡рд╛рдж рд╕рд┐рдлрд╛рд░рд┐рд╕ рдЧрд░рд┐рдиреНрдЫред рдпрд╕ рдЕрдиреБрд╡рд╛рджрдХреЛ рдкреНрд░рдпреЛрдЧрдмрд╛рдЯ рдЙрддреНрдкрдиреНрди рд╣реБрдиреЗ рдХреБрдиреИ рдкрдирд┐ рдЧрд▓рддрдлрд╣рдореА рд╡рд╛ рдЧрд▓рдд рд╡реНрдпрд╛рдЦреНрдпрд╛рдХреЛ рд▓рд╛рдЧрд┐ рд╣рд╛рдореА рдЬрд┐рдореНрдореЗрд╡рд╛рд░ рд╣реБрдиреЗ рдЫреИрдиреМрдВред