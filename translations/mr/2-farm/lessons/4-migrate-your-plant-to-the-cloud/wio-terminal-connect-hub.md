<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-27T12:04:42+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "mr"
}
-->
# рддреБрдордЪрд╛ IoT рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдХреНрд▓рд╛рдЙрдбрд╢реА рдХрдиреЗрдХреНрдЯ рдХрд░рд╛ - Wio Terminal

рдпрд╛ рдзрдбреНрдпрд╛рдЪреНрдпрд╛ рдпрд╛ рднрд╛рдЧрд╛рдд, рддреБрдореНрд╣реА рддреБрдордЪрд╛ Wio Terminal IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рдХрд░рд╛рд▓, рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрд╛рдард╡рдгреНрдпрд╛рд╕рд╛рдареА рдЖрдгрд┐ рдХрдорд╛рдВрдбреНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА.

## рддреБрдордЪрд╛ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рдХрд░рд╛

рдкреБрдвреАрд▓ рдкрд╛рдпрд░реА рдореНрд╣рдгрдЬреЗ рддреБрдордЪрд╛ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рдХрд░рдгреЗ.

### рдХрд╛рд░реНрдп - IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рдХрд░рд╛

1. VS Code рдордзреНрдпреЗ `soil-moisture-sensor` рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЙрдШрдбрд╛.

1. `platformio.ini` рдлрд╛рдЗрд▓ рдЙрдШрдбрд╛. `knolleary/PubSubClient` рд▓рд╛рдпрдмреНрд░рд░реА рдбрд┐рдкреЗрдВрдбрдиреНрд╕реА рдХрд╛рдвреВрди рдЯрд╛рдХрд╛. рд╣реА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ MQTT рдмреНрд░реЛрдХрд░реНрд╕рд╢реА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕рд╛рдареА рд╡рд╛рдкрд░рд▓реА рдЬрд╛рдд рд╣реЛрддреА, рдкрдг IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕рд╛рдареА рдЧрд░рдЬреЗрдЪреА рдирд╛рд╣реА.

1. рдЦрд╛рд▓реАрд▓ рд▓рд╛рдпрдмреНрд░рд░реА рдбрд┐рдкреЗрдВрдбрдиреНрд╕реА рдЬреЛрдбрд╛:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    `Seeed Arduino RTC` рд▓рд╛рдпрдмреНрд░рд░реА Wio Terminal рдордзреАрд▓ рд░рд┐рдЕрд▓-рдЯрд╛рдЗрдо рдХреНрд▓реЙрдХрд╢реА рд╕рдВрд╡рд╛рдж рд╕рд╛рдзрдгреНрдпрд╛рд╕рд╛рдареА рдХреЛрдб рдкреБрд░рд╡рддреЗ, рдЬреЛ рд╡реЗрд│ рдЯреНрд░реЕрдХ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╡рд╛рдкрд░рд▓рд╛ рдЬрд╛рддреЛ. рдЙрд░реНрд╡рд░рд┐рдд рд▓рд╛рдпрдмреНрд░рд░реА рддреБрдордЪреНрдпрд╛ IoT рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рд▓рд╛ IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕ рдкрд░рд╡рд╛рдирдЧреА рджреЗрддрд╛рдд.

1. `platformio.ini` рдлрд╛рдЗрд▓рдЪреНрдпрд╛ рд╢реЗрд╡рдЯреА рдЦрд╛рд▓реАрд▓ рдЬреЛрдбрд╛:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    рд╣реЗ рдПрдХ рдХрдВрдкрд╛рдпрд▓рд░ рдлреНрд▓реЕрдЧ рд╕реЗрдЯ рдХрд░рддреЗ, рдЬреЗ Arduino IoT Hub рдХреЛрдб рдХреЙрдореНрдкрд╛рдЗрд▓ рдХрд░рддрд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рдЖрд╣реЗ.

1. `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓ рдЙрдШрдбрд╛. рд╕рд░реНрд╡ MQTT рд╕реЗрдЯрд┐рдВрдЧреНрдЬ рдХрд╛рдвреВрди рдЯрд╛рдХрд╛ рдЖрдгрд┐ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧрд╕рд╛рдареА рдЦрд╛рд▓реАрд▓ рд╕реНрдерд┐рд░рд╛рдВрдХ рдЬреЛрдбрд╛:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    `<connection string>` рдЪреНрдпрд╛ рдЬрд╛рдЧреА рддреБрдореНрд╣реА рдЖрдзреА рдХреЙрдкреА рдХреЗрд▓реЗрд▓рд╛ рддреБрдордЪреНрдпрд╛ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рдЪрд╛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рдЯрд╛рдХрд╛.

1. IoT Hub рд╢реА рдХрдиреЗрдХреНрд╢рдирд╕рд╛рдареА рд╡реЗрд│-рдЖрдзрд╛рд░рд┐рдд рдЯреЛрдХрди рд╡рд╛рдкрд░рд▓реЗ рдЬрд╛рддреЗ. рдпрд╛рдЪрд╛ рдЕрд░реНрде IoT рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рд▓рд╛ рд╡рд░реНрддрдорд╛рди рд╡реЗрд│ рдорд╛рд╣рд┐рдд рдЕрд╕рдгреЗ рдЖрд╡рд╢реНрдпрдХ рдЖрд╣реЗ. Windows, macOS рдХрд┐рдВрд╡рд╛ Linux рд╕рд╛рд░рдЦреНрдпрд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдореНрд╕рдкреНрд░рдорд╛рдгреЗ, рдорд╛рдпрдХреНрд░реЛрдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдЗрдВрдЯрд░рдиреЗрдЯрд╡рд░реВрди рдЖрдкреЛрдЖрдк рд╡рд░реНрддрдорд╛рди рд╡реЗрд│ рд╕рд┐рдВрдХреНрд░реЛрдирд╛рдЗрдЭ рдХрд░рдд рдирд╛рд╣реАрдд. рдпрд╛рдЪрд╛ рдЕрд░реНрде рддреБрдореНрд╣рд╛рд▓рд╛ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) рд╕рд░реНрд╡реНрд╣рд░рдХрдбреВрди рд╡рд░реНрддрдорд╛рди рд╡реЗрд│ рдорд┐рд│рд╡рдгреНрдпрд╛рд╕рд╛рдареА рдХреЛрдб рдЬреЛрдбрд╛рд╡рд╛ рд▓рд╛рдЧреЗрд▓. рд╡реЗрд│ рдорд┐рд│рд╛рд▓реНрдпрд╛рдирдВрддрд░, рддреЛ Wio Terminal рдордзреАрд▓ рд░рд┐рдЕрд▓-рдЯрд╛рдЗрдо рдХреНрд▓реЙрдХрдордзреНрдпреЗ рд╕рд╛рдард╡рд▓рд╛ рдЬрд╛рдК рд╢рдХрддреЛ, рдЬреНрдпрд╛рдореБрд│реЗ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рдиреЗ рдкреЙрд╡рд░ рдЧрдорд╛рд╡рд▓реА рдирд╛рд╣реА рдЕрд╕реЗ рдЧреГрд╣реАрдд рдзрд░реВрди рднрд╡рд┐рд╖реНрдпрд╛рдд рдпреЛрдЧреНрдп рд╡реЗрд│ рдорд┐рд│рд╡рддрд╛ рдпреЗрдИрд▓. `ntp.h` рдирд╛рд╡рд╛рдЪреА рдирд╡реАрди рдлрд╛рдЗрд▓ рддрдпрд╛рд░ рдХрд░рд╛ рдЖрдгрд┐ рддреНрдпрд╛рдд рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    рдпрд╛ рдХреЛрдбрдЪрд╛ рддрдкрд╢реАрд▓ рдпрд╛ рдзрдбреНрдпрд╛рдЪреНрдпрд╛ рдХрдХреНрд╖реЗрдмрд╛рд╣реЗрд░ рдЖрд╣реЗ. рд╣рд╛ `initTime` рдирд╛рд╡рд╛рдЪрд╛ рдлрдВрдХреНрд╢рди рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЛ, рдЬреЛ NTP рд╕рд░реНрд╡реНрд╣рд░рдХрдбреВрди рд╡рд░реНрддрдорд╛рди рд╡реЗрд│ рдорд┐рд│рд╡рддреЛ рдЖрдгрд┐ Wio Terminal рд╡рд░реАрд▓ рдХреНрд▓реЙрдХ рд╕реЗрдЯ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╡рд╛рдкрд░рддреЛ.

1. `main.cpp` рдлрд╛рдЗрд▓ рдЙрдШрдбрд╛ рдЖрдгрд┐ рд╕рд░реНрд╡ MQTT рдХреЛрдб рдХрд╛рдвреВрди рдЯрд╛рдХрд╛, рдЬреНрдпрд╛рдордзреНрдпреЗ `PubSubClient.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓, `PubSubClient` рд╡реНрд╣реЗрд░рд┐рдПрдмрд▓рдЪреА рдШреЛрд╖рдгрд╛, `reconnectMQTTClient` рдЖрдгрд┐ `createMQTTClient` рдкрджреНрдзрддреА, рддрд╕реЗрдЪ рдпрд╛ рд╡реНрд╣реЗрд░рд┐рдПрдмрд▓реНрд╕ рдЖрдгрд┐ рдкрджреНрдзрддреАрдВрдирд╛ рдХреЗрд▓реЗрд▓реЗ рдХреЙрд▓реНрд╕ рд╕рдорд╛рд╡рд┐рд╖реНрдЯ рдЖрд╣реЗрдд. рдпрд╛ рдлрд╛рдЗрд▓рдордзреНрдпреЗ рдлрдХреНрдд WiFi рд╢реА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕рд╛рдареА, рдорд╛рддреАрддреАрд▓ рдУрд▓рд╛рд╡рд╛ рдорд┐рд│рд╡рдгреНрдпрд╛рд╕рд╛рдареА рдЖрдгрд┐ рддреНрдпрд╛рд╕рд╣ JSON рдбреЙрдХреНрдпреБрдореЗрдВрдЯ рддрдпрд╛рд░ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдХреЛрдб рдЕрд╕рд╛рд╡рд╛.

1. IoT Hub рд▓рд╛рдпрдмреНрд░рд░реАрдВрд╕рд╛рдареА рдЖрдгрд┐ рд╡реЗрд│ рд╕реЗрдЯ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╣реЗрдбрд░ рдлрд╛рдЗрд▓реНрд╕ рд╕рдорд╛рд╡рд┐рд╖реНрдЯ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА `main.cpp` рдлрд╛рдЗрд▓рдЪреНрдпрд╛ рд╢реАрд░реНрд╖рд╕реНрдерд╛рдиреА рдЦрд╛рд▓реАрд▓ `#include` рдирд┐рд░реНрджреЗрд╢ рдЬреЛрдбрд╛:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. рд╡рд░реНрддрдорд╛рди рд╡реЗрд│ рд╕реЗрдЯ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА `setup` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╢реЗрд╡рдЯреА рдЦрд╛рд▓реАрд▓ рдХреЙрд▓ рдЬреЛрдбрд╛:

    ```cpp
    initTime();
    ```

1. рдлрд╛рдЗрд▓рдЪреНрдпрд╛ рд╢реАрд░реНрд╖рд╕реНрдерд╛рдиреА, `include` рдирд┐рд░реНрджреЗрд╢рд╛рдВрдЪреНрдпрд╛ рдЦрд╛рд▓реАрд▓ рд╡реНрд╣реЗрд░рд┐рдПрдмрд▓ рдШреЛрд╖рдгрд╛ рдЬреЛрдбрд╛:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    рд╣реЗ `IOTHUB_DEVICE_CLIENT_LL_HANDLE` рдШреЛрд╖рд┐рдд рдХрд░рддреЗ, рдЬреЗ IoT Hub рд╢реА рдХрдиреЗрдХреНрд╢рдирд╕рд╛рдареА рд╣рдБрдбрд▓ рдЖрд╣реЗ.

1. рдпрд╛рдЦрд╛рд▓реА, рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    рд╣реЗ рдПрдХ рдХреЙрд▓рдмреЕрдХ рдлрдВрдХреНрд╢рди рдШреЛрд╖рд┐рдд рдХрд░рддреЗ, рдЬреЗрд╡реНрд╣рд╛ IoT Hub рд╢реА рдХрдиреЗрдХреНрд╢рдирдЪреА рд╕реНрдерд┐рддреА рдмрджрд▓рддреЗ, рдЬрд╕реЗ рдХреА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреЗ рдХрд┐рдВрд╡рд╛ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рд╣реЛрдгреЗ, рддреЗрд╡реНрд╣рд╛ рдХреЙрд▓ рдХреЗрд▓реЗ рдЬрд╛рддреЗ. рд╕реНрдерд┐рддреА рд╕рд┐рд░реАрдпрд▓ рдкреЛрд░реНрдЯрд╡рд░ рдкрд╛рдард╡рд▓реА рдЬрд╛рддреЗ.

1. рдпрд╛рдЦрд╛рд▓реА, IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕рд╛рдареА рдПрдХ рдлрдВрдХреНрд╢рди рдЬреЛрдбрд╛:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    рд╣рд╛ рдХреЛрдб IoT Hub рд▓рд╛рдпрдмреНрд░рд░реА рдХреЛрдб рдкреНрд░рд╛рд░рдВрдн рдХрд░рддреЛ, рдирдВрддрд░ `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓рдордзреАрд▓ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╡рд╛рдкрд░реВрди рдХрдиреЗрдХреНрд╢рди рддрдпрд╛рд░ рдХрд░рддреЛ. рд╣реЗ рдХрдиреЗрдХреНрд╢рди MQTT рд╡рд░ рдЖрдзрд╛рд░рд┐рдд рдЖрд╣реЗ. рдЬрд░ рдХрдиреЗрдХреНрд╢рди рдЕрдпрд╢рд╕реНрд╡реА рдЭрд╛рд▓реЗ, рддрд░ рддреЗ рд╕рд┐рд░реАрдпрд▓ рдкреЛрд░реНрдЯрд╡рд░ рдкрд╛рдард╡рд▓реЗ рдЬрд╛рддреЗ - рдЬрд░ рддреБрдореНрд╣рд╛рд▓рд╛ рдЖрдЙрдЯрдкреБрдЯрдордзреНрдпреЗ рд╣реЗ рджрд┐рд╕рд▓реЗ, рддрд░ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рддрдкрд╛рд╕рд╛. рд╢реЗрд╡рдЯреА, рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд┐рддреА рдХреЙрд▓рдмреЕрдХ рд╕реЗрдЯ рдХреЗрд▓рд╛ рдЬрд╛рддреЛ.

1. `setup` рдлрдВрдХреНрд╢рдирдордзреНрдпреЗ `initTime` рдХреЙрд▓рдЪреНрдпрд╛ рдЦрд╛рд▓реА рд╣реЗ рдлрдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░рд╛:

    ```cpp
    connectIoTHub();
    ```

1. MQTT рдХреНрд▓рд╛рдпрдВрдЯрдкреНрд░рдорд╛рдгреЗрдЪ, рд╣рд╛ рдХреЛрдб рдПрдХрд╛ рд╕рд┐рдВрдЧрд▓ рдереНрд░реЗрдбрд╡рд░ рдЪрд╛рд▓рддреЛ, рддреНрдпрд╛рдореБрд│реЗ рд╣рдмрджреНрд╡рд╛рд░реЗ рдкрд╛рдард╡рд▓реЗрд▓реЗ рдЖрдгрд┐ рд╣рдмрд▓рд╛ рдкрд╛рдард╡рд▓реЗрд▓реЗ рд╕рдВрджреЗрд╢ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╡реЗрд│ рдЖрд╡рд╢реНрдпрдХ рдЖрд╣реЗ. `loop` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╢реАрд░реНрд╖рд╕реНрдерд╛рдиреА рдЦрд╛рд▓реАрд▓ рдЬреЛрдбрд╛:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. рд╣рд╛ рдХреЛрдб рдмрд┐рд▓реНрдб рдЖрдгрд┐ рдЕрдкрд▓реЛрдб рдХрд░рд╛. рддреБрдореНрд╣рд╛рд▓рд╛ рд╕рд┐рд░реАрдпрд▓ рдореЙрдирд┐рдЯрд░рдордзреНрдпреЗ рдХрдиреЗрдХреНрд╢рди рджрд┐рд╕реЗрд▓:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    рдЖрдЙрдЯрдкреБрдЯрдордзреНрдпреЗ рддреБрдореНрд╣реА NTP рд╡реЗрд│ рдорд┐рд│рд╡рддрд╛рдирд╛ рдкрд╛рд╣реВ рд╢рдХрддрд╛, рддреНрдпрд╛рдирдВрддрд░ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдХреНрд▓рд╛рдпрдВрдЯ рдХрдиреЗрдХреНрдЯ рд╣реЛрдд рдЖрд╣реЗ. рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рд╕рд╛рдареА рдХрд╛рд╣реА рд╕реЗрдХрдВрдж рд▓рд╛рдЧреВ рд╢рдХрддрд╛рдд, рддреНрдпрд╛рдореБрд│реЗ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдХрдиреЗрдХреНрдЯ рд╣реЛрдд рдЕрд╕рддрд╛рдирд╛ рддреБрдореНрд╣рд╛рд▓рд╛ рдЖрдЙрдЯрдкреБрдЯрдордзреНрдпреЗ рдорд╛рддреАрддреАрд▓ рдУрд▓рд╛рд╡рд╛ рджрд┐рд╕реВ рд╢рдХрддреЛ.

    > ЁЯТБ рддреБрдореНрд╣реА NTP рд╕рд╛рдареА UNIX рд╡реЗрд│ рдЕрдзрд┐рдХ рд╡рд╛рдЪрдиреАрдп рд╕реНрд╡рд░реВрдкрд╛рдд [unixtimestamp.com](https://www.unixtimestamp.com) рд╕рд╛рд░рдЦреНрдпрд╛ рд╡реЗрдмрд╕рд╛рдЗрдЯрдЪрд╛ рд╡рд╛рдкрд░ рдХрд░реВрди рд░реВрдкрд╛рдВрддрд░рд┐рдд рдХрд░реВ рд╢рдХрддрд╛.

## рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрд╛рдард╡рд╛

рдЖрддрд╛ рддреБрдордЪрд╛ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдХрдиреЗрдХреНрдЯ рдЭрд╛рд▓рд╛ рдЖрд╣реЗ, рддреБрдореНрд╣реА MQTT рдмреНрд░реЛрдХрд░реНрд╕рдРрд╡рдЬреА IoT Hub рд▓рд╛ рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрд╛рдард╡реВ рд╢рдХрддрд╛.

### рдХрд╛рд░реНрдп - рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рдкрд╛рдард╡рд╛

1. `setup` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╡рд░ рдЦрд╛рд▓реАрд▓ рдлрдВрдХреНрд╢рди рдЬреЛрдбрд╛:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    рд╣рд╛ рдХреЛрдб рдкрд╛рд╕ рдХреЗрд▓реЗрд▓реНрдпрд╛ рд╕реНрдЯреНрд░рд┐рдВрдЧрдордзреВрди IoT Hub рд╕рдВрджреЗрд╢ рддрдпрд╛рд░ рдХрд░рддреЛ, рддреЛ рд╣рдмрд▓рд╛ рдкрд╛рдард╡рддреЛ рдЖрдгрд┐ рдирдВрддрд░ рд╕рдВрджреЗрд╢ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕рд╛рдл рдХрд░рддреЛ.

1. `loop` рдлрдВрдХреНрд╢рдирдордзреНрдпреЗ, рдЯреЗрд▓рд┐рдореЗрдЯреНрд░реА рд╕рд┐рд░реАрдпрд▓ рдкреЛрд░реНрдЯрд╡рд░ рдкрд╛рдард╡рд▓реНрдпрд╛рдирдВрддрд░ рд▓рдЧреЗрдЪ рд╣рд╛ рдХреЛрдб рдХреЙрд▓ рдХрд░рд╛:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## рдХрдорд╛рдВрдбреНрд╕ рд╣рд╛рддрд╛рд│рд╛

рддреБрдордЪреНрдпрд╛ рдбрд┐рд╡реНрд╣рд╛рдЗрд╕рд▓рд╛ рд░рд┐рд▓реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рд╕рд░реНрд╡реНрд╣рд░ рдХреЛрдбрдордзреВрди рдЖрд▓реЗрд▓рд╛ рдХрдорд╛рдВрдб рд╣рд╛рддрд╛рд│рдгреЗ рдЖрд╡рд╢реНрдпрдХ рдЖрд╣реЗ. рд╣реЗ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдореНрд╣рдгреВрди рдкрд╛рдард╡рд▓реЗ рдЬрд╛рддреЗ.

### рдХрд╛рд░реНрдп - рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рд╣рд╛рддрд╛рд│рд╛

1. `connectIoTHub` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рдЖрдзреА рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    рд╣рд╛ рдХреЛрдб рдПрдХ рдХреЙрд▓рдмреЕрдХ рдкрджреНрдзрдд рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЛ, рдЬреА IoT Hub рд▓рд╛рдпрдмреНрд░рд░реАрд▓рд╛ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдкреНрд░рд╛рдкреНрдд рдЭрд╛рд▓реНрдпрд╛рд╡рд░ рдХреЙрд▓ рдХрд░реВ рджреЗрддреЗ. рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЗрд▓реЗрд▓реА рдкрджреНрдзрдд `method_name` рдкреЕрд░рд╛рдореАрдЯрд░рдордзреНрдпреЗ рдкрд╛рдард╡рд▓реА рдЬрд╛рддреЗ. рд╣реА рдлрдВрдХреНрд╢рди рд╕рд┐рд░реАрдпрд▓ рдкреЛрд░реНрдЯрд╡рд░ рдХреЙрд▓ рдХреЗрд▓реЗрд▓реА рдкрджреНрдзрдд рдкреНрд░рд┐рдВрдЯ рдХрд░рддреЗ, рдирдВрддрд░ рдкрджреНрдзрдд рдирд╛рд╡рд╛рдиреБрд╕рд╛рд░ рд░рд┐рд▓реЗ рдЪрд╛рд▓реВ рдХрд┐рдВрд╡рд╛ рдмрдВрдж рдХрд░рддреЗ.

    > ЁЯТБ рд╣реЗ рдПрдХрд╛ рд╕рд┐рдВрдЧрд▓ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯрдордзреНрдпреЗ рджреЗрдЦреАрд▓ рдЕрдВрдорд▓рд╛рдд рдЖрдгрд▓реЗ рдЬрд╛рдК рд╢рдХрддреЗ, рдЬреНрдпрд╛рдордзреНрдпреЗ рд░рд┐рд▓реЗрдЪреА рдЗрдЪреНрдЫрд┐рдд рд╕реНрдерд┐рддреА рд░рд┐рдХреНрд╡реЗрд╕реНрдЯрд╕рд╣ рдкрд╛рдард╡рд▓реА рдЬрд╛рдК рд╢рдХрддреЗ рдЖрдгрд┐ рддреА `payload` рдкреЕрд░рд╛рдореАрдЯрд░рдордзреВрди рдЙрдкрд▓рдмреНрдз рдЕрд╕рддреЗ.

1. `directMethodCallback` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╢реЗрд╡рдЯреА рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯрд▓рд╛ рдкреНрд░рддрд┐рд╕рд╛рдж рдЖрд╡рд╢реНрдпрдХ рдЕрд╕рддреЛ, рдЖрдгрд┐ рдкреНрд░рддрд┐рд╕рд╛рдж рджреЛрди рднрд╛рдЧрд╛рдВрдордзреНрдпреЗ рдЕрд╕рддреЛ - рдордЬрдХреВрд░ рд╕реНрд╡рд░реВрдкрд╛рдд рдкреНрд░рддрд┐рд╕рд╛рдж рдЖрдгрд┐ рд░рд┐рдЯрд░реНрди рдХреЛрдб. рд╣рд╛ рдХреЛрдб рдЦрд╛рд▓реАрд▓ JSON рдбреЙрдХреНрдпреБрдореЗрдВрдЯ рддрдпрд╛рд░ рдХрд░рддреЛ:

    ```JSON
    {
        "Result": ""
    }
    ```

    рдирдВрддрд░ рд╣рд╛ `response` рдкреЕрд░рд╛рдореАрдЯрд░рдордзреНрдпреЗ рдХреЙрдкреА рдХреЗрд▓рд╛ рдЬрд╛рддреЛ, рдЖрдгрд┐ рдпрд╛ рдкреНрд░рддрд┐рд╕рд╛рджрд╛рдЪрд╛ рдЖрдХрд╛рд░ `response_size` рдкреЕрд░рд╛рдореАрдЯрд░рдордзреНрдпреЗ рд╕реЗрдЯ рдХреЗрд▓рд╛ рдЬрд╛рддреЛ. рд╣рд╛ рдХреЛрдб рдирдВрддрд░ `IOTHUB_CLIENT_OK` рдкрд░рдд рдХрд░рддреЛ, рдЬреЗрдгреЗрдХрд░реВрди рдкрджреНрдзрдд рдпреЛрдЧреНрдпрд░рд┐рддреНрдпрд╛ рд╣рд╛рддрд╛рд│рд▓реА рдЧреЗрд▓реА рд╣реЗ рджрд╛рдЦрд╡рд▓реЗ рдЬрд╛рдИрд▓.

1. `connectIoTHub` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╢реЗрд╡рдЯреА рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. `loop` рдлрдВрдХреНрд╢рди `IoTHubDeviceClient_LL_DoWork` рдлрдВрдХреНрд╢рдирд▓рд╛ IoT Hub рдиреЗ рдкрд╛рдард╡рд▓реЗрд▓реНрдпрд╛ рдЗрд╡реНрд╣реЗрдВрдЯреНрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдХреЙрд▓ рдХрд░реЗрд▓. `delay` рдореБрд│реЗ рд╣реЗ рдлрдХреНрдд рдкреНрд░рддреНрдпреЗрдХ 10 рд╕реЗрдХрдВрджрд╛рдВрдиреА рдХреЙрд▓ рдХреЗрд▓реЗ рдЬрд╛рддреЗ, рдпрд╛рдЪрд╛ рдЕрд░реНрде рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердбреНрд╕ рдлрдХреНрдд рдкреНрд░рддреНрдпреЗрдХ 10 рд╕реЗрдХрдВрджрд╛рдВрдиреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗрд▓реНрдпрд╛ рдЬрд╛рддрд╛рдд. рд╣реЗ рдЕрдзрд┐рдХ рдХрд╛рд░реНрдпрдХреНрд╖рдо рдмрдирд╡рдгреНрдпрд╛рд╕рд╛рдареА, 10 рд╕реЗрдХрдВрджрд╛рдВрдЪрд╛ `delay` рдЕрдиреЗрдХ рд▓рд╣рд╛рди `delay` рдордзреНрдпреЗ рдЕрдВрдорд▓рд╛рдд рдЖрдгрд▓рд╛ рдЬрд╛рдК рд╢рдХрддреЛ, рдкреНрд░рддреНрдпреЗрдХ рд╡реЗрд│реА `IoTHubDeviceClient_LL_DoWork` рдХреЙрд▓ рдХрд░реВрди. рд╣реЗ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА, `loop` рдлрдВрдХреНрд╢рдирдЪреНрдпрд╛ рд╡рд░ рдЦрд╛рд▓реАрд▓ рдХреЛрдб рдЬреЛрдбрд╛:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    рд╣рд╛ рдХреЛрдб рд╡рд╛рд░рдВрд╡рд╛рд░ рд▓реВрдк рдХрд░рддреЛ, `IoTHubDeviceClient_LL_DoWork` рдХреЙрд▓ рдХрд░рддреЛ рдЖрдгрд┐ рдкреНрд░рддреНрдпреЗрдХ рд╡реЗрд│реА 100ms рд╕рд╛рдареА `delay` рдХрд░рддреЛ. рджрд┐рд▓реЗрд▓реНрдпрд╛ `delay_time` рдкреЕрд░рд╛рдореАрдЯрд░рд╕рд╛рдареА рд╡рд┐рд▓рдВрдм рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдЖрд╡рд╢реНрдпрдХ рддрд┐рддрдХреНрдпрд╛ рд╡реЗрд│рд╛ рд╣реЗ рдХрд░рддреЛ. рдпрд╛рдЪрд╛ рдЕрд░реНрде рдбрд┐рд╡реНрд╣рд╛рдЗрд╕ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдЬрд╛рд╕реНрддреАрдд рдЬрд╛рд╕реНрдд 100ms рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдд рдЖрд╣реЗ.

1. `loop` рдлрдВрдХреНрд╢рдирдордзреНрдпреЗ, `IoTHubDeviceClient_LL_DoWork` рдХреЙрд▓ рдХрд╛рдврд╛, рдЖрдгрд┐ `delay(10000)` рдХреЙрд▓ рдЦрд╛рд▓реАрд▓ рдХреЛрдбрдиреЗ рдмрджрд▓рд╛:

    ```cpp
    work_delay(10000);
    ```

> ЁЯТБ рддреБрдореНрд╣рд╛рд▓рд╛ рд╣рд╛ рдХреЛрдб [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) рдлреЛрд▓реНрдбрд░рдордзреНрдпреЗ рд╕рд╛рдкрдбреЗрд▓.

ЁЯША рддреБрдордЪрд╛ рдорд╛рддреАрддреАрд▓ рдУрд▓рд╛рд╡рд╛ рд╕реЗрдиреНрд╕рд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо IoT Hub рд╢реА рдХрдиреЗрдХреНрдЯ рдЭрд╛рд▓рд╛ рдЖрд╣реЗ!

---

**рдЕрд╕реНрд╡реАрдХрд░рдг**:  
рд╣рд╛ рджрд╕реНрддрдРрд╡рдЬ AI рднрд╛рд╖рд╛рдВрддрд░ рд╕реЗрд╡рд╛ [Co-op Translator](https://github.com/Azure/co-op-translator) рдЪрд╛ рд╡рд╛рдкрд░ рдХрд░реВрди рднрд╛рд╖рд╛рдВрддрд░рд┐рдд рдХрд░рдгреНрдпрд╛рдд рдЖрд▓рд╛ рдЖрд╣реЗ. рдЖрдореНрд╣реА рдЕрдЪреВрдХрддреЗрд╕рд╛рдареА рдкреНрд░рдпрддреНрдирд╢реАрд▓ рдЕрд╕рд▓реЛ рддрд░реА рдХреГрдкрдпрд╛ рд▓рдХреНрд╖рд╛рдд рдареЗрд╡рд╛ рдХреА рд╕реНрд╡рдпрдВрдЪрд▓рд┐рдд рднрд╛рд╖рд╛рдВрддрд░рд╛рдВрдордзреНрдпреЗ рддреНрд░реБрдЯреА рдХрд┐рдВрд╡рд╛ рдЕрдЪреВрдХрддреЗрдЪрд╛ рдЕрднрд╛рд╡ рдЕрд╕реВ рд╢рдХрддреЛ. рдореВрд│ рднрд╛рд╖реЗрддреАрд▓ рджрд╕реНрддрдРрд╡рдЬ рд╣рд╛ рдЕрдзрд┐рдХреГрдд рд╕реНрд░реЛрдд рдорд╛рдирд▓рд╛ рдЬрд╛рд╡рд╛. рдорд╣рддреНрддреНрд╡рд╛рдЪреНрдпрд╛ рдорд╛рд╣рд┐рддреАрд╕рд╛рдареА рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдорд╛рдирд╡реА рднрд╛рд╖рд╛рдВрддрд░рд╛рдЪреА рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реА рдЬрд╛рддреЗ. рдпрд╛ рднрд╛рд╖рд╛рдВрддрд░рд╛рдЪрд╛ рд╡рд╛рдкрд░ рдХрд░реВрди рдЙрджреНрднрд╡рд▓реЗрд▓реНрдпрд╛ рдХреЛрдгрддреНрдпрд╛рд╣реА рдЧреИрд░рд╕рдордЬ рдХрд┐рдВрд╡рд╛ рдЪреБрдХреАрдЪреНрдпрд╛ рдЕрд░реНрдерд╛рд╕рд╛рдареА рдЖрдореНрд╣реА рдЬрдмрд╛рдмрджрд╛рд░ рд░рд╛рд╣рдгрд╛рд░ рдирд╛рд╣реА.