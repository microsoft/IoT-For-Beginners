<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-28T11:26:36+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "bg"
}
-->
# –°–≤—ä—Ä–∂–µ—Ç–µ –≤–∞—à–µ—Ç–æ IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –æ–±–ª–∞–∫–∞ - Wio Terminal

–í —Ç–∞–∑–∏ —á–∞—Å—Ç –Ω–∞ —É—Ä–æ–∫–∞ —â–µ —Å–≤—ä—Ä–∂–µ—Ç–µ –≤–∞—à–∏—è Wio Terminal —Å –≤–∞—à–∏—è IoT Hub, –∑–∞ –¥–∞ –∏–∑–ø—Ä–∞—â–∞—Ç–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –∏ –¥–∞ –ø–æ–ª—É—á–∞–≤–∞—Ç–µ –∫–æ–º–∞–Ω–¥–∏.

## –°–≤—ä—Ä–∂–µ—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —Å–∏ —Å IoT Hub

–°–ª–µ–¥–≤–∞—â–∞—Ç–∞ —Å—Ç—ä–ø–∫–∞ –µ –¥–∞ —Å–≤—ä—Ä–∂–µ—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —Å–∏ —Å IoT Hub.

### –ó–∞–¥–∞—á–∞ - —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å IoT Hub

1. –û—Ç–≤–æ—Ä–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞ `soil-moisture-sensor` –≤—ä–≤ VS Code.

1. –û—Ç–≤–æ—Ä–µ—Ç–µ —Ñ–∞–π–ª–∞ `platformio.ini`. –ü—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—Ç–∞ –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ `knolleary/PubSubClient`. –¢—è —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞—à–µ –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å –ø—É–±–ª–∏—á–µ–Ω MQTT –±—Ä–æ–∫–µ—Ä –∏ –Ω–µ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å IoT Hub.

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫—ä–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ `Seeed Arduino RTC` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è –∫–æ–¥ –∑–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–µ–∞–ª–Ω–æ-–≤—Ä–µ–º–µ–≤–∏—è —á–∞—Å–æ–≤–Ω–∏–∫ –≤ Wio Terminal, –∫–æ–π—Ç–æ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ. –û—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–æ–∑–≤–æ–ª—è–≤–∞—Ç –≤–∞—à–µ—Ç–æ IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–∞ —Å–µ —Å–≤—ä—Ä–∂–µ —Å IoT Hub.

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–æ—Ç–æ –≤ –∫—Ä–∞—è –Ω–∞ —Ñ–∞–π–ª–∞ `platformio.ini`:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    –¢–æ–≤–∞ –∑–∞–¥–∞–≤–∞ —Ñ–ª–∞–≥ –∑–∞ –∫–æ–º–ø–∏–ª–∞—Ç–æ—Ä–∞, –∫–æ–π—Ç–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø—Ä–∏ –∫–æ–º–ø–∏–ª–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–¥–∞ –∑–∞ Arduino IoT Hub.

1. –û—Ç–≤–æ—Ä–µ—Ç–µ —Ö–µ–¥—ä—Ä —Ñ–∞–π–ª–∞ `config.h`. –ü—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ MQTT –∏ –¥–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∞—Ç–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –∑–∞ –≤—Ä—ä–∑–∫–æ–≤–∏—è –Ω–∏–∑ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    –ó–∞–º–µ–Ω–µ—Ç–µ `<connection string>` —Å –≤—Ä—ä–∑–∫–æ–≤–∏—è –Ω–∏–∑ –∑–∞ –≤–∞—à–µ—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∫–æ–π—Ç–æ –∫–æ–ø–∏—Ä–∞—Ö—Ç–µ –ø–æ-—Ä–∞–Ω–æ.

1. –°–≤—ä—Ä–∑–≤–∞–Ω–µ—Ç–æ —Å IoT Hub –∏–∑–ø–æ–ª–∑–≤–∞ —Ç–æ–∫–µ–Ω, –±–∞–∑–∏—Ä–∞–Ω –Ω–∞ –≤—Ä–µ–º–µ. –¢–æ–≤–∞ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –∑–Ω–∞–µ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ. –ó–∞ —Ä–∞–∑–ª–∏–∫–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –∫–∞—Ç–æ Windows, macOS –∏–ª–∏ Linux, –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏—Ç–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ –ø—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç. –¢–æ–≤–∞ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –∫–æ–¥ –∑–∞ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ –æ—Ç [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) —Å—ä—Ä–≤—ä—Ä. –°–ª–µ–¥ –∫–∞—Ç–æ –≤—Ä–µ–º–µ—Ç–æ –±—ä–¥–µ –ø–æ–ª—É—á–µ–Ω–æ, —Ç–æ –º–æ–∂–µ –¥–∞ —Å–µ —Å—ä—Ö—Ä–∞–Ω–∏ –≤ —Ä–µ–∞–ª–Ω–æ-–≤—Ä–µ–º–µ–≤–∏—è —á–∞—Å–æ–≤–Ω–∏–∫ –Ω–∞ Wio Terminal, –∫–æ–µ—Ç–æ –ø–æ–∑–≤–æ–ª—è–≤–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ—Ç–æ –≤—Ä–µ–º–µ –¥–∞ –±—ä–¥–µ –∑–∞—è–≤–µ–Ω–æ –ø–æ-–∫—ä—Å–Ω–æ, –ø—Ä–∏ —É—Å–ª–æ–≤–∏–µ —á–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ –Ω–µ –∑–∞–≥—É–±–∏ –∑–∞—Ö—Ä–∞–Ω–≤–∞–Ω–µ. –î–æ–±–∞–≤–µ—Ç–µ –Ω–æ–≤ —Ñ–∞–π–ª, –Ω–∞—Ä–µ—á–µ–Ω `ntp.h`, —Å—ä—Å —Å–ª–µ–¥–Ω–∏—è –∫–æ–¥:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏—Ç–µ –∑–∞ —Ç–æ–∑–∏ –∫–æ–¥ —Å–∞ –∏–∑–≤—ä–Ω –æ–±—Ö–≤–∞—Ç–∞ –Ω–∞ —Ç–æ–∑–∏ —É—Ä–æ–∫. –¢–æ–π –¥–µ—Ñ–∏–Ω–∏—Ä–∞ —Ñ—É–Ω–∫—Ü–∏—è, –Ω–∞—Ä–µ—á–µ–Ω–∞ `initTime`, –∫–æ—è—Ç–æ –ø–æ–ª—É—á–∞–≤–∞ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ –æ—Ç NTP —Å—ä—Ä–≤—ä—Ä –∏ –≥–æ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —á–∞—Å–æ–≤–Ω–∏–∫–∞ –Ω–∞ Wio Terminal.

1. –û—Ç–≤–æ—Ä–µ—Ç–µ —Ñ–∞–π–ª–∞ `main.cpp` –∏ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ —Ü–µ–ª–∏—è –∫–æ–¥ –∑–∞ MQTT, –≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ —Ö–µ–¥—ä—Ä —Ñ–∞–π–ª–∞ `PubSubClient.h`, –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞—Ç–∞ `PubSubClient`, –º–µ—Ç–æ–¥–∏—Ç–µ `reconnectMQTTClient` –∏ `createMQTTClient`, –∫–∞–∫—Ç–æ –∏ –≤—Å–∏—á–∫–∏ –∏–∑–≤–∏–∫–≤–∞–Ω–∏—è –∫—ä–º —Ç–µ–∑–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∏ –º–µ—Ç–æ–¥–∏. –¢–æ–∑–∏ —Ñ–∞–π–ª —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ —Å–∞–º–æ –∫–æ–¥ –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å WiFi, –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –ø–æ—á–≤–∞—Ç–∞ –∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ JSON –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç—è—Ö.

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏ `#include` –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–∞ `main.cpp`, –∑–∞ –¥–∞ –≤–∫–ª—é—á–∏—Ç–µ —Ö–µ–¥—ä—Ä —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏—Ç–µ –Ω–∞ IoT Hub –∏ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–æ—Ç–æ –∏–∑–≤–∏–∫–≤–∞–Ω–µ –≤ –∫—Ä–∞—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `setup`, –∑–∞ –¥–∞ –∑–∞–¥–∞–¥–µ—Ç–µ —Ç–µ–∫—É—â–æ—Ç–æ –≤—Ä–µ–º–µ:

    ```cpp
    initTime();
    ```

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∞—Ç–∞ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–∞, —Ç–æ—á–Ω–æ –ø–æ–¥ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏—Ç–µ –∑–∞ –≤–∫–ª—é—á–≤–∞–Ω–µ:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    –¢–æ–≤–∞ –¥–µ–∫–ª–∞—Ä–∏—Ä–∞ `IOTHUB_DEVICE_CLIENT_LL_HANDLE`, –º–∞–Ω–∏–ø—É–ª–∞—Ç–æ—Ä –∑–∞ –≤—Ä—ä–∑–∫–∞ —Å IoT Hub.

1. –ü–æ–¥ —Ç–æ–≤–∞ –¥–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—è –∫–æ–¥:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    –¢–æ–≤–∞ –¥–µ–∫–ª–∞—Ä–∏—Ä–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞—Ç–µ–Ω –ø–æ–≤–∏–∫, –∫–æ—è—Ç–æ —â–µ –±—ä–¥–µ –∏–∑–≤–∏–∫–∞–Ω–∞, –∫–æ–≥–∞—Ç–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å IoT Hub –ø—Ä–æ–º–µ–Ω–∏ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ —Å–∏, –∫–∞—Ç–æ –Ω–∞–ø—Ä–∏–º–µ—Ä —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∏–ª–∏ –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ. –°—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ —Å–µ –∏–∑–ø—Ä–∞—â–∞ –∫—ä–º —Å–µ—Ä–∏–π–Ω–∏—è –ø–æ—Ä—Ç.

1. –ü–æ–¥ —Ç–æ–≤–∞ –¥–æ–±–∞–≤–µ—Ç–µ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å IoT Hub:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    –¢–æ–∑–∏ –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–∏—è –∫–æ–¥ –Ω–∞ IoT Hub, —Å–ª–µ–¥ –∫–æ–µ—Ç–æ —Å—ä–∑–¥–∞–≤–∞ –≤—Ä—ä–∑–∫–∞, –∏–∑–ø–æ–ª–∑–≤–∞–π–∫–∏ –≤—Ä—ä–∑–∫–æ–≤–∏—è –Ω–∏–∑ –≤ —Ö–µ–¥—ä—Ä —Ñ–∞–π–ª–∞ `config.h`. –¢–∞–∑–∏ –≤—Ä—ä–∑–∫–∞ –µ –±–∞–∑–∏—Ä–∞–Ω–∞ –Ω–∞ MQTT. –ê–∫–æ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–µ –ø—Ä–æ–≤–∞–ª–∏, —Ç–æ–≤–∞ —Å–µ –∏–∑–ø—Ä–∞—â–∞ –∫—ä–º —Å–µ—Ä–∏–π–Ω–∏—è –ø–æ—Ä—Ç - –∞–∫–æ –≤–∏–¥–∏—Ç–µ —Ç–æ–≤–∞ –≤ –∏–∑—Ö–æ–¥–∞, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –≤—Ä—ä–∑–∫–æ–≤–∏—è –Ω–∏–∑. –ù–∞–∫—Ä–∞—è —Å–µ –Ω–∞—Å—Ç—Ä–æ–π–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ –∑–∞ –æ–±—Ä–∞—Ç–µ–Ω –ø–æ–≤–∏–∫ –∑–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞.

1. –ò–∑–≤–∏–∫–∞–π—Ç–µ —Ç–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ä–≤ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `setup` –ø–æ–¥ –∏–∑–≤–∏–∫–≤–∞–Ω–µ—Ç–æ –Ω–∞ `initTime`:

    ```cpp
    connectIoTHub();
    ```

1. –ü–æ–¥–æ–±–Ω–æ –Ω–∞ MQTT –∫–ª–∏–µ–Ω—Ç–∞, —Ç–æ–∑–∏ –∫–æ–¥ —Ä–∞–±–æ—Ç–∏ –Ω–∞ –µ–¥–∏–Ω –ø–æ—Ç–æ–∫, —Ç–∞–∫–∞ —á–µ —Å–µ –Ω—É–∂–¥–∞–µ –æ—Ç –≤—Ä–µ–º–µ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞, –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ –æ—Ç —Ö—ä–±–∞ –∏ –∫—ä–º —Ö—ä–±–∞. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–æ—Ç–æ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `loop`, –∑–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç–µ —Ç–æ–≤–∞:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. –ö–æ–º–ø–∏–ª–∏—Ä–∞–π—Ç–µ –∏ –∫–∞—á–µ—Ç–µ —Ç–æ–∑–∏ –∫–æ–¥. –©–µ –≤–∏–¥–∏—Ç–µ –≤—Ä—ä–∑–∫–∞—Ç–∞ –≤ —Å–µ—Ä–∏–π–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    –í –∏–∑—Ö–æ–¥–∞ –º–æ–∂–µ—Ç–µ –¥–∞ –≤–∏–¥–∏—Ç–µ –∫–∞–∫ —Å–µ –∏–∑–≤–ª–∏—á–∞ –≤—Ä–µ–º–µ—Ç–æ –æ—Ç NTP, –ø–æ—Å–ª–µ–¥–≤–∞–Ω–æ –æ—Ç —Å–≤—ä—Ä–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –ú–æ–∂–µ –¥–∞ –æ—Ç–Ω–µ–º–µ –Ω—è–∫–æ–ª–∫–æ —Å–µ–∫—É–Ω–¥–∏ –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ, —Ç–∞–∫–∞ —á–µ –º–æ–∂–µ –¥–∞ –≤–∏–¥–∏—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –ø–æ—á–≤–∞—Ç–∞ –≤ –∏–∑—Ö–æ–¥–∞, –¥–æ–∫–∞—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —Å–µ —Å–≤—ä—Ä–∑–≤–∞.

    > üíÅ –ú–æ–∂–µ—Ç–µ –¥–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞—Ç–µ UNIX –≤—Ä–µ–º–µ—Ç–æ –æ—Ç NTP –≤ –ø–æ-—á–µ—Ç–∏–º —Ñ–æ—Ä–º–∞—Ç, –∏–∑–ø–æ–ª–∑–≤–∞–π–∫–∏ —É–µ–±—Å–∞–π—Ç –∫–∞—Ç–æ [unixtimestamp.com](https://www.unixtimestamp.com)

## –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è

–°–µ–≥–∞, –∫–æ–≥–∞—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ –≤–∏ –µ —Å–≤—ä—Ä–∑–∞–Ω–æ, –º–æ–∂–µ—Ç–µ –¥–∞ –∏–∑–ø—Ä–∞—â–∞—Ç–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –∫—ä–º IoT Hub –≤–º–µ—Å—Ç–æ –∫—ä–º MQTT –±—Ä–æ–∫–µ—Ä–∞.

### –ó–∞–¥–∞—á–∞ - –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `setup`:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    –¢–æ–∑–∏ –∫–æ–¥ —Å—ä–∑–¥–∞–≤–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ IoT Hub –æ—Ç –Ω–∏–∑, –ø—Ä–µ–¥–∞–¥–µ–Ω –∫–∞—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—ä—Ä, –∏–∑–ø—Ä–∞—â–∞ –≥–æ –∫—ä–º —Ö—ä–±–∞ –∏ —Å–ª–µ–¥ —Ç–æ–≤–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞ –æ–±–µ–∫—Ç–∞ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ.

1. –ò–∑–≤–∏–∫–∞–π—Ç–µ —Ç–æ–∑–∏ –∫–æ–¥ –≤—ä–≤ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `loop`, —Ç–æ—á–Ω–æ —Å–ª–µ–¥ —Ä–µ–¥–∞, –∫—ä–¥–µ—Ç–æ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è—Ç–∞ —Å–µ –∏–∑–ø—Ä–∞—â–∞ –∫—ä–º —Å–µ—Ä–∏–π–Ω–∏—è –ø–æ—Ä—Ç:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥–∏

–í–∞—à–µ—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –æ–±—Ä–∞–±–æ—Ç–≤–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–Ω–∏—è –∫–æ–¥ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–µ–ª–µ—Ç–æ. –¢–æ–≤–∞ —Å–µ –∏–∑–ø—Ä–∞—â–∞ –∫–∞—Ç–æ –∑–∞—è–≤–∫–∞ –∑–∞ –¥–∏—Ä–µ–∫—Ç–µ–Ω –º–µ—Ç–æ–¥.

## –ó–∞–¥–∞—á–∞ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∑–∞—è–≤–∫–∞ –∑–∞ –¥–∏—Ä–µ–∫—Ç–µ–Ω –º–µ—Ç–æ–¥

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—è –∫–æ–¥ –ø—Ä–µ–¥–∏ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `connectIoTHub`:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    –¢–æ–∑–∏ –∫–æ–¥ –¥–µ—Ñ–∏–Ω–∏—Ä–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞—Ç–µ–Ω –ø–æ–≤–∏–∫, –∫–æ—è—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–∞ IoT Hub –º–æ–∂–µ –¥–∞ –∏–∑–≤–∏–∫–∞, –∫–æ–≥–∞—Ç–æ –ø–æ–ª—É—á–∏ –∑–∞—è–≤–∫–∞ –∑–∞ –¥–∏—Ä–µ–∫—Ç–µ–Ω –º–µ—Ç–æ–¥. –ú–µ—Ç–æ–¥—ä—Ç, –∫–æ–π—Ç–æ —Å–µ –∑–∞—è–≤—è–≤–∞, —Å–µ –∏–∑–ø—Ä–∞—â–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—ä—Ä–∞ `method_name`. –¢–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø–µ—á–∞—Ç–≤–∞ –∏–∑–≤–∏–∫–∞–Ω–∏—è –º–µ—Ç–æ–¥ –∫—ä–º —Å–µ—Ä–∏–π–Ω–∏—è –ø–æ—Ä—Ç, —Å–ª–µ–¥ –∫–æ–µ—Ç–æ –≤–∫–ª—é—á–≤–∞ –∏–ª–∏ –∏–∑–∫–ª—é—á–≤–∞ —Ä–µ–ª–µ—Ç–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç –æ—Ç –∏–º–µ—Ç–æ –Ω–∞ –º–µ—Ç–æ–¥–∞.

    > üíÅ –¢–æ–≤–∞ –º–æ–∂–µ —Å—ä—â–æ –¥–∞ –±—ä–¥–µ —Ä–µ–∞–ª–∏–∑–∏—Ä–∞–Ω–æ –≤ –µ–¥–∏–Ω –¥–∏—Ä–µ–∫—Ç–µ–Ω –º–µ—Ç–æ–¥, –∫–∞—Ç–æ —Å–µ –ø—Ä–µ–¥–∞–¥–µ –∂–µ–ª–∞–Ω–æ—Ç–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —Ä–µ–ª–µ—Ç–æ –≤ –ø–æ–ª–µ–∑–µ–Ω —Ç–æ–≤–∞—Ä, –∫–æ–π—Ç–æ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–µ–¥–∞–¥–µ–Ω —Å—ä—Å –∑–∞—è–≤–∫–∞—Ç–∞ –∑–∞ –º–µ—Ç–æ–¥ –∏ –¥–æ—Å—Ç—ä–ø–µ–Ω –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—ä—Ä–∞ `payload`.

1. –î–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—è –∫–æ–¥ –≤ –∫—Ä–∞—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `directMethodCallback`:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    –ó–∞—è–≤–∫–∏—Ç–µ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–∏ –º–µ—Ç–æ–¥–∏ –∏–∑–∏—Å–∫–≤–∞—Ç –æ—Ç–≥–æ–≤–æ—Ä, –∫–æ–π—Ç–æ —Å–µ —Å—ä—Å—Ç–æ–∏ –æ—Ç –¥–≤–µ —á–∞—Å—Ç–∏ - –æ—Ç–≥–æ–≤–æ—Ä –∫–∞—Ç–æ —Ç–µ–∫—Å—Ç –∏ –∫–æ–¥ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ. –¢–æ–∑–∏ –∫–æ–¥ —â–µ —Å—ä–∑–¥–∞–¥–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∫–∞—Ç–æ —Å–ª–µ–¥–Ω–∏—è JSON –¥–æ–∫—É–º–µ–Ω—Ç:

    ```JSON
    {
        "Result": ""
    }
    ```

    –¢–æ–≤–∞ —Å–ª–µ–¥ —Ç–æ–≤–∞ —Å–µ –∫–æ–ø–∏—Ä–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—ä—Ä–∞ `response`, –∞ —Ä–∞–∑–º–µ—Ä—ä—Ç –Ω–∞ —Ç–æ–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä —Å–µ –∑–∞–¥–∞–≤–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—ä—Ä–∞ `response_size`. –¢–æ–∑–∏ –∫–æ–¥ —Å–ª–µ–¥ —Ç–æ–≤–∞ –≤—Ä—ä—â–∞ `IOTHUB_CLIENT_OK`, –∑–∞ –¥–∞ –ø–æ–∫–∞–∂–µ, —á–µ –º–µ—Ç–æ–¥—ä—Ç –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –ø—Ä–∞–≤–∏–ª–Ω–æ.

1. –°–≤—ä—Ä–∂–µ—Ç–µ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ –∑–∞ –æ–±—Ä–∞—Ç–µ–Ω –ø–æ–≤–∏–∫, –∫–∞—Ç–æ –¥–æ–±–∞–≤–∏—Ç–µ —Å–ª–µ–¥–Ω–æ—Ç–æ –≤ –∫—Ä–∞—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `connectIoTHub`:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. –§—É–Ω–∫—Ü–∏—è—Ç–∞ `loop` —â–µ –∏–∑–≤–∏–∫–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `IoTHubDeviceClient_LL_DoWork`, –∑–∞ –¥–∞ –æ–±—Ä–∞–±–æ—Ç–≤–∞ —Å—ä–±–∏—Ç–∏—è, –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ –æ—Ç IoT Hub. –¢–æ–≤–∞ —Å–µ –∏–∑–≤–∏–∫–≤–∞ —Å–∞–º–æ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏ –∑–∞—Ä–∞–¥–∏ `delay`, –∫–æ–µ—Ç–æ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ –¥–∏—Ä–µ–∫—Ç–Ω–∏—Ç–µ –º–µ—Ç–æ–¥–∏ —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç —Å–∞–º–æ –Ω–∞ –≤—Å–µ–∫–∏ 10 —Å–µ–∫—É–Ω–¥–∏. –ó–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç–µ —Ç–æ–≤–∞ –ø–æ-–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, 10-—Å–µ–∫—É–Ω–¥–Ω–æ—Ç–æ –∑–∞–±–∞–≤—è–Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ —Ä–µ–∞–ª–∏–∑–∏—Ä–∞–Ω–æ –∫–∞—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ-–∫—Ä–∞—Ç–∫–∏ –∑–∞–±–∞–≤—è–Ω–∏—è, –∫–∞—Ç–æ —Å–µ –∏–∑–≤–∏–∫–≤–∞ `IoTHubDeviceClient_LL_DoWork` –≤—Å–µ–∫–∏ –ø—ä—Ç. –ó–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç–µ —Ç–æ–≤–∞, –¥–æ–±–∞–≤–µ—Ç–µ —Å–ª–µ–¥–Ω–∏—è –∫–æ–¥ –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `loop`:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    –¢–æ–∑–∏ –∫–æ–¥ —â–µ —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ, –∫–∞—Ç–æ –∏–∑–≤–∏–∫–≤–∞ `IoTHubDeviceClient_LL_DoWork` –∏ –∑–∞–±–∞–≤—è –∑–∞ 100ms –≤—Å–µ–∫–∏ –ø—ä—Ç. –¢–æ–≤–∞ —â–µ —Å–µ –ø—Ä–∞–≤–∏ —Ç–æ–ª–∫–æ–≤–∞ –ø—ä—Ç–∏, –∫–æ–ª–∫–æ—Ç–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –∑–∞ –¥–∞ —Å–µ –∑–∞–±–∞–≤–∏ –∑–∞ –≤—Ä–µ–º–µ—Ç–æ, –¥–∞–¥–µ–Ω–æ –≤ –ø–∞—Ä–∞–º–µ—Ç—ä—Ä–∞ `delay_time`. –¢–æ–≤–∞ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —á–∞–∫–∞ –Ω–∞–π-–º–Ω–æ–≥–æ 100ms, –∑–∞ –¥–∞ –æ–±—Ä–∞–±–æ—Ç–∏ –∑–∞—è–≤–∫–∏ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–∏ –º–µ—Ç–æ–¥–∏.

1. –í—ä–≤ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `loop` –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –∏–∑–≤–∏–∫–≤–∞–Ω–µ—Ç–æ –Ω–∞ `IoTHubDeviceClient_LL_DoWork` –∏ –∑–∞–º–µ–Ω–µ—Ç–µ –∏–∑–≤–∏–∫–≤–∞–Ω–µ—Ç–æ –Ω–∞ `delay(10000)` —Å—ä—Å —Å–ª–µ–¥–Ω–æ—Ç–æ, –∑–∞ –¥–∞ –∏–∑–≤–∏–∫–∞—Ç–µ —Ç–∞–∑–∏ –Ω–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è:

    ```cpp
    work_delay(10000);
    ```

> üíÅ –ú–æ–∂–µ—Ç–µ –¥–∞ –Ω–∞–º–µ—Ä–∏—Ç–µ —Ç–æ–∑–∏ –∫–æ–¥ –≤ –ø–∞–ø–∫–∞—Ç–∞ [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal).

üòÄ –í–∞—à–∞—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–∞ —Å–µ–Ω–∑–æ—Ä –∑–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç –Ω–∞ –ø–æ—á–≤–∞—Ç–∞ –µ —Å–≤—ä—Ä–∑–∞–Ω–∞ —Å –≤–∞—à–∏—è IoT Hub!

---

**–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç**:  
–¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –µ –ø—Ä–µ–≤–µ–¥–µ–Ω —Å –ø–æ–º–æ—â—Ç–∞ –Ω–∞ AI —É—Å–ª—É–≥–∞ –∑–∞ –ø—Ä–µ–≤–æ–¥ [Co-op Translator](https://github.com/Azure/co-op-translator). –í—ä–ø—Ä–µ–∫–∏ —á–µ —Å–µ —Å—Ç—Ä–µ–º–∏–º –∫—ä–º —Ç–æ—á–Ω–æ—Å—Ç, –º–æ–ª—è, –∏–º–∞–π—Ç–µ –ø—Ä–µ–¥–≤–∏–¥, —á–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∏—Ç–µ –ø—Ä–µ–≤–æ–¥–∏ –º–æ–∂–µ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞—Ç –≥—Ä–µ—à–∫–∏ –∏–ª–∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏. –û—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏—è—Ç –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –Ω–µ–≥–æ–≤–∏—è —Ä–æ–¥–µ–Ω –µ–∑–∏–∫ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Å—á–∏—Ç–∞ –∑–∞ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–µ–Ω –∏–∑—Ç–æ—á–Ω–∏–∫. –ó–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–µ –ø—Ä–µ–ø–æ—Ä—ä—á–≤–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω —á–æ–≤–µ—à–∫–∏ –ø—Ä–µ–≤–æ–¥. –ù–∏–µ –Ω–µ –Ω–æ—Å–∏–º –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç –∑–∞ –Ω–µ–¥–æ—Ä–∞–∑—É–º–µ–Ω–∏—è –∏–ª–∏ –ø–æ–≥—Ä–µ—à–Ω–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –ø—Ä–æ–∏–∑—Ç–∏—á–∞—â–∏ –æ—Ç –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ç–æ–∑–∏ –ø—Ä–µ–≤–æ–¥.