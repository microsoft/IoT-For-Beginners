<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-25T17:07:54+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "hi"
}
-->
# рдЕрдкрдиреЗ IoT рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рдХреНрд▓рд╛рдЙрдб рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ - Wio Terminal

рдЗрд╕ рдкрд╛рда рдХреЗ рдЗрд╕ рднрд╛рдЧ рдореЗрдВ, рдЖрдк рдЕрдкрдиреЗ Wio Terminal рдХреЛ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВрдЧреЗ, рддрд╛рдХрд┐ рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рднреЗрдЬ рд╕рдХреЗрдВ рдФрд░ рдХрдорд╛рдВрдб рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВред

## рдЕрдкрдиреЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ

рдЕрдЧрд▓рд╛ рдХрджрдо рд╣реИ рдЕрдкрдиреЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛ред

### рдХрд╛рд░реНрдп - IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ

1. VS Code рдореЗрдВ `soil-moisture-sensor` рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЦреЛрд▓реЗрдВред

1. `platformio.ini` рдлрд╛рдЗрд▓ рдЦреЛрд▓реЗрдВред `knolleary/PubSubClient` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдбрд┐рдкреЗрдВрдбреЗрдВрд╕реА рдХреЛ рд╣рдЯрд╛ рджреЗрдВред рдпрд╣ рдкрдмреНрд▓рд┐рдХ MQTT рдмреНрд░реЙрдХрд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рдереА, рдФрд░ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИред

1. рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдбрд┐рдкреЗрдВрдбреЗрдВрд╕реА рдЬреЛрдбрд╝реЗрдВ:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    `Seeed Arduino RTC` рд▓рд╛рдЗрдмреНрд░реЗрд░реА Wio Terminal рдореЗрдВ рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рдХреНрд▓реЙрдХ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдордп рдХреЛ рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдмрд╛рдХреА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЖрдкрдХреЗ IoT рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред

1. `platformio.ini` рдлрд╛рдЗрд▓ рдХреЗ рдЕрдВрдд рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреЛрдбрд╝реЗрдВ:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    рдпрд╣ рдПрдХ рдХрдВрдкрд╛рдЗрд▓рд░ рдлреНрд▓реИрдЧ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ Arduino IoT Hub рдХреЛрдб рдХреЛ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рддреЗ рд╕рдордп рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддрд╛ рд╣реИред

1. `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓ рдЦреЛрд▓реЗрдВред рд╕рднреА MQTT рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд╣рдЯрд╛ рджреЗрдВ рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЙрдиреНрд╕реНрдЯреЗрдВрдЯ рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    `<connection string>` рдХреЛ рдЙрд╕ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕реЗ рдмрджрд▓реЗрдВ рдЬрд┐рд╕реЗ рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдерд╛ред

1. IoT Hub рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдПрдХ рд╕рдордп-рдЖрдзрд╛рд░рд┐рдд рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ IoT рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рд╡рд░реНрддрдорд╛рди рд╕рдордп рдЬрд╛рдирдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред Windows, macOS рдпрд╛ Linux рдЬреИрд╕реЗ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╡рд┐рдкрд░реАрдд, рдорд╛рдЗрдХреНрд░реЛрдХрдВрдЯреНрд░реЛрд▓рд░ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╡рд░реНрддрдорд╛рди рд╕рдордп рдХреЛ рд╕рд┐рдВрдХреНрд░реЛрдирд╛рдЗрдЬрд╝ рдирд╣реАрдВ рдХрд░рддреЗред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдкрдХреЛ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) рд╕рд░реНрд╡рд░ рд╕реЗ рд╡рд░реНрддрдорд╛рди рд╕рдордп рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛ред рдПрдХ рдмрд╛рд░ рд╕рдордп рдкреНрд░рд╛рдкреНрдд рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕реЗ Wio Terminal рдореЗрдВ рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рдХреНрд▓реЙрдХ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рд╣реА рд╕рдордп рдХреЛ рдмрд╛рдж рдореЗрдВ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдмрд╢рд░реНрддреЗ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд╛рд╡рд░ рди рдЦреЛрдПред `ntp.h` рдирд╛рдордХ рдПрдХ рдирдИ рдлрд╛рдЗрд▓ рдмрдирд╛рдПрдВ рдФрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    рдЗрд╕ рдХреЛрдб рдХрд╛ рд╡рд┐рд╡рд░рдг рдЗрд╕ рдкрд╛рда рдХреЗ рджрд╛рдпрд░реЗ рд╕реЗ рдмрд╛рд╣рд░ рд╣реИред рдпрд╣ рдПрдХ `initTime` рдирд╛рдордХ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ NTP рд╕рд░реНрд╡рд░ рд╕реЗ рд╡рд░реНрддрдорд╛рди рд╕рдордп рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ Wio Terminal рдкрд░ рдХреНрд▓реЙрдХ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

1. `main.cpp` рдлрд╛рдЗрд▓ рдЦреЛрд▓реЗрдВ рдФрд░ рд╕рднреА MQTT рдХреЛрдб рдХреЛ рд╣рдЯрд╛ рджреЗрдВ, рдЬрд┐рд╕рдореЗрдВ `PubSubClient.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓, `PubSubClient` рд╡реЗрд░рд┐рдПрдмрд▓ рдХреА рдШреЛрд╖рдгрд╛, `reconnectMQTTClient` рдФрд░ `createMQTTClient` рдореЗрдердбреНрд╕, рдФрд░ рдЗрди рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдФрд░ рдореЗрдердбреНрд╕ рдХреЗ рдХрд┐рд╕реА рднреА рдХреЙрд▓ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдЗрд╕ рдлрд╛рдЗрд▓ рдореЗрдВ рдХреЗрд╡рд▓ WiFi рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ, рдорд┐рдЯреНрдЯреА рдХреА рдирдореА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдФрд░ рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдХ JSON рдбреЙрдХреНрдпреВрдореЗрдВрдЯ рдмрдирд╛рдиреЗ рдХрд╛ рдХреЛрдб рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

1. `main.cpp` рдлрд╛рдЗрд▓ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд `#include` рдирд┐рд░реНрджреЗрд╢ рдЬреЛрдбрд╝реЗрдВ рддрд╛рдХрд┐ IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдФрд░ рд╕рдордп рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЗрдбрд░ рдлрд╛рдЗрд▓реНрд╕ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. `setup` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрдд рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЙрд▓ рдЬреЛрдбрд╝реЗрдВ рддрд╛рдХрд┐ рд╡рд░реНрддрдорд╛рди рд╕рдордп рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ:

    ```cpp
    initTime();
    ```

1. рдлрд╛рдЗрд▓ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░, `include` рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рдареАрдХ рдиреАрдЪреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реЗрд░рд┐рдПрдмрд▓ рдШреЛрд╖рдгрд╛ рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    рдпрд╣ рдПрдХ `IOTHUB_DEVICE_CLIENT_LL_HANDLE` рдШреЛрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдПрдХ рд╣реИрдВрдбрд▓ рд╣реИред

1. рдЗрд╕рдХреЗ рдиреАрдЪреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    рдпрд╣ рдПрдХ рдХреЙрд▓рдмреИрдХ рдлрд╝рдВрдХреНрд╢рди рдШреЛрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдХреА рд╕реНрдерд┐рддрд┐ рдмрджрд▓рдиреЗ рдкрд░ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬреИрд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛ рдпрд╛ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛ред рд╕реНрдерд┐рддрд┐ рдХреЛ рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред

1. рдЗрд╕рдХреЗ рдиреАрдЪреЗ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    рдпрд╣ рдХреЛрдб IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ `config.h` рд╣реЗрдбрд░ рдлрд╛рдЗрд▓ рдореЗрдВ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдмрдирд╛рддрд╛ рд╣реИред рдпрд╣ рдХрдиреЗрдХреНрд╢рди MQTT рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред рдпрджрд┐ рдХрдиреЗрдХреНрд╢рди рд╡рд┐рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ - рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рджреЗрдЦрддреЗ рд╣реИрдВ, рддреЛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдЕрдВрдд рдореЗрдВ, рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд┐рддрд┐ рдХреЙрд▓рдмреИрдХ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

1. `setup` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ `initTime` рдХреЙрд▓ рдХреЗ рдиреАрдЪреЗ рдХреЙрд▓ рдХрд░реЗрдВ:

    ```cpp
    connectIoTHub();
    ```

1. рдареАрдХ рдЙрд╕реА рддрд░рд╣ рдЬреИрд╕реЗ MQTT рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╕рд╛рде, рдпрд╣ рдХреЛрдб рдПрдХ рд╕рд┐рдВрдЧрд▓ рдереНрд░реЗрдб рдкрд░ рдЪрд▓рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдм рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдЧрдП рдФрд░ рд╣рдм рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдордп рдЪрд╛рд╣рд┐рдПред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, `loop` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. рдЗрд╕ рдХреЛрдб рдХреЛ рдмрд┐рд▓реНрдб рдФрд░ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред рдЖрдк рд╕реАрд░рд┐рдпрд▓ рдореЙрдирд┐рдЯрд░ рдореЗрдВ рдХрдиреЗрдХреНрд╢рди рджреЗрдЦреЗрдВрдЧреЗ:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ NTP рд╕рдордп рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рдЙрд╕рдХреЗ рдмрд╛рдж рдбрд┐рд╡рд╛рдЗрд╕ рдХреНрд▓рд╛рдЗрдВрдЯ рдХрдиреЗрдХреНрдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИред рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдореЗрдВ рдХреБрдЫ рд╕реЗрдХрдВрдб рд▓рдЧ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдХреЗ рджреМрд░рд╛рди рдорд┐рдЯреНрдЯреА рдХреА рдирдореА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред

    > ЁЯТБ рдЖрдк NTP рдХреЗ UNIX рд╕рдордп рдХреЛ рдЕрдзрд┐рдХ рдкрдардиреАрдп рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП [unixtimestamp.com](https://www.unixtimestamp.com) рдЬреИрд╕реА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рднреЗрдЬреЗрдВ

рдЕрдм рдЬрдм рдЖрдкрдХрд╛ рдбрд┐рд╡рд╛рдЗрд╕ рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдк MQTT рдмреНрд░реЙрдХрд░ рдХреЗ рдмрдЬрд╛рдп IoT Hub рдХреЛ рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред

### рдХрд╛рд░реНрдп - рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рднреЗрдЬреЗрдВ

1. `setup` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдКрдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    рдпрд╣ рдХреЛрдб рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕реЗ IoT Hub рд╕рдВрджреЗрд╢ рдмрдирд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕реЗ рд╣рдм рдкрд░ рднреЗрдЬрддрд╛ рд╣реИ, рдлрд┐рд░ рд╕рдВрджреЗрд╢ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рд╕рд╛рдл рдХрд░рддрд╛ рд╣реИред

1. рдЗрд╕ рдХреЛрдб рдХреЛ `loop` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдХреЙрд▓ рдХрд░реЗрдВ, рдареАрдХ рдЙрд╕ рд▓рд╛рдЗрди рдХреЗ рдмрд╛рдж рдЬрд╣рд╛рдВ рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИ:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## рдХрдорд╛рдВрдб рд╣реИрдВрдбрд▓ рдХрд░реЗрдВ

рдЖрдкрдХреЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рд░рд┐рд▓реЗ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд░реНрд╡рд░ рдХреЛрдб рд╕реЗ рдПрдХ рдХрдорд╛рдВрдб рд╣реИрдВрдбрд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдЗрд╕реЗ рдПрдХ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред

## рдХрд╛рд░реНрдп - рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рд╣реИрдВрдбрд▓ рдХрд░реЗрдВ

1. `connectIoTHub` рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдкрд╣рд▓реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    рдпрд╣ рдХреЛрдб рдПрдХ рдХреЙрд▓рдмреИрдХ рдореЗрдердб рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ IoT Hub рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рдХреЙрд▓ рдХрд░ рд╕рдХрддреА рд╣реИред рдЕрдиреБрд░реЛрдзрд┐рдд рдореЗрдердб `method_name` рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдкрд░ рдХреЙрд▓ рдХрд┐рдП рдЧрдП рдореЗрдердб рдХреЛ рдкреНрд░рд┐рдВрдЯ рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ рдореЗрдердб рдирд╛рдо рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд░рд┐рд▓реЗ рдХреЛ рдЪрд╛рд▓реВ рдпрд╛ рдмрдВрдж рдХрд░рддрд╛ рд╣реИред

    > ЁЯТБ рдЗрд╕реЗ рдПрдХ рд╕рд┐рдВрдЧрд▓ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдореЗрдВ рднреА рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд░рд┐рд▓реЗ рдХреА рдЗрдЪреНрдЫрд┐рдд рд╕реНрдерд┐рддрд┐ рдХреЛ рдПрдХ рдкреЗрд▓реЛрдб рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЗ рд╕рд╛рде рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ `payload` рдкреИрд░рд╛рдореАрдЯрд░ рд╕реЗ рдЙрдкрд▓рдмреНрдз рдХрд░рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

1. `directMethodCallback` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрдд рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЛ рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЛ рднрд╛рдЧреЛрдВ рдореЗрдВ рд╣реЛрддреА рд╣реИ - рдПрдХ рдЯреЗрдХреНрд╕реНрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдФрд░ рдПрдХ рд░рд┐рдЯрд░реНрди рдХреЛрдбред рдпрд╣ рдХреЛрдб рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд JSON рдбреЙрдХреНрдпреВрдореЗрдВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдкрд░рд┐рдгрд╛рдо рдмрдирд╛рдПрдЧрд╛:

    ```JSON
    {
        "Result": ""
    }
    ```

    рдЗрд╕реЗ `response` рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдЖрдХрд╛рд░ `response_size` рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХреЛрдб рдлрд┐рд░ `IOTHUB_CLIENT_OK` рд▓реМрдЯрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдореЗрдердб рдХреЛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд╣реИрдВрдбрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ред

1. рдЗрд╕ рдХреЙрд▓рдмреИрдХ рдХреЛ `connectIoTHub` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрдд рдореЗрдВ рд╡рд╛рдпрд░ рдХрд░реЗрдВ:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. `loop` рдлрд╝рдВрдХреНрд╢рди `IoTHubDeviceClient_LL_DoWork` рдлрд╝рдВрдХреНрд╢рди рдХреЛ IoT Hub рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдЧрдП рдЗрд╡реЗрдВрдЯреНрд╕ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред рдЗрд╕реЗ `delay` рдХреЗ рдХрд╛рд░рдг рдХреЗрд╡рд▓ рд╣рд░ 10 рд╕реЗрдХрдВрдб рдореЗрдВ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рдХреЗрд╡рд▓ рд╣рд░ 10 рд╕реЗрдХрдВрдб рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдЗрд╕реЗ рдЕрдзрд┐рдХ рдХреБрд╢рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, 10 рд╕реЗрдХрдВрдб рдХреА рджреЗрд░реА рдХреЛ рдХрдИ рдЫреЛрдЯреА рджреЗрд░реА рдХреЗ рд░реВрдк рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╣рд░ рдмрд╛рд░ `IoTHubDeviceClient_LL_DoWork` рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реБрдПред рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, `loop` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдКрдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    рдпрд╣ рдХреЛрдб рдмрд╛рд░-рдмрд╛рд░ рд▓реВрдк рдХрд░реЗрдЧрд╛, `IoTHubDeviceClient_LL_DoWork` рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рд╣рд░ рдмрд╛рд░ 100ms рдХреЗ рд▓рд┐рдП рджреЗрд░реА рдХрд░реЗрдЧрд╛ред рдпрд╣ рдЬрд┐рддрдиреА рдмрд╛рд░ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рдЙрддрдиреА рдмрд╛рд░ рдРрд╕рд╛ рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ `delay_time` рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ рджрд┐рдП рдЧрдП рд╕рдордп рдХреЗ рд▓рд┐рдП рджреЗрд░реА рдХреА рдЬрд╛ рд╕рдХреЗред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдбрд┐рд╡рд╛рдЗрд╕ рдбрд╛рдпрд░реЗрдХреНрдЯ рдореЗрдердб рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрддрдо 100ms рддрдХ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИред

1. `loop` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ, `IoTHubDeviceClient_LL_DoWork` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЛ рд╣рдЯрд╛ рджреЗрдВ, рдФрд░ `delay(10000)` рдХреЙрд▓ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗ рдмрджрд▓реЗрдВ рддрд╛рдХрд┐ рдЗрд╕ рдирдП рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ:

    ```cpp
    work_delay(10000);
    ```

> ЁЯТБ рдЖрдк рдЗрд╕ рдХреЛрдб рдХреЛ [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) рдлреЛрд▓реНрдбрд░ рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

ЁЯША рдЖрдкрдХрд╛ рдорд┐рдЯреНрдЯреА рдХреА рдирдореА рд╕реЗрдВрд╕рд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЖрдкрдХреЗ IoT Hub рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИ!

**рдЕрд╕реНрд╡реАрдХрд░рдг**:  
рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ AI рдЕрдиреБрд╡рд╛рдж рд╕реЗрд╡рд╛ [Co-op Translator](https://github.com/Azure/co-op-translator) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдиреБрд╡рд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЬрдмрдХрд┐ рд╣рдо рд╕рдЯреАрдХрддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЕрдиреБрд╡рд╛рдж рдореЗрдВ рддреНрд░реБрдЯрд┐рдпрд╛рдВ рдпрд╛ рдЕрд╢реБрджреНрдзрд┐рдпрд╛рдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред рдореВрд▓ рднрд╛рд╖рд╛ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдореВрд▓ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЛ рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рд╕реНрд░реЛрдд рдорд╛рдирд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, рдкреЗрд╢реЗрд╡рд░ рдорд╛рдирд╡ рдЕрдиреБрд╡рд╛рдж рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред рдЗрд╕ рдЕрдиреБрд╡рд╛рдж рдХреЗ рдЙрдкрдпреЛрдЧ рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рд╕реА рднреА рдЧрд▓рддрдлрд╣рдореА рдпрд╛ рдЧрд▓рдд рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП рд╣рдо рдЙрддреНрддрд░рджрд╛рдпреА рдирд╣реАрдВ рд╣реИрдВред