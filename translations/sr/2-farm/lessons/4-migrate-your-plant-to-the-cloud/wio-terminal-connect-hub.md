<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-08-28T15:04:27+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "sr"
}
-->
# –ü–æ–≤–µ–∂–∏—Ç–µ –≤–∞—à IoT —É—Ä–µ—í–∞—ò —Å–∞ –æ–±–ª–∞–∫–æ–º - Wio Terminal

–£ –æ–≤–æ–º –¥–µ–ª—É –ª–µ–∫—Ü–∏—ò–µ, –ø–æ–≤–µ–∑–∞—õ–µ—Ç–µ –≤–∞—à Wio Terminal —Å–∞ IoT Hub-–æ–º, –∫–∞–∫–æ –±–∏—Å—Ç–µ —Å–ª–∞–ª–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—ò—É –∏ –ø—Ä–∏–º–∞–ª–∏ –∫–æ–º–∞–Ω–¥–µ.

## –ü–æ–≤–µ–∂–∏—Ç–µ –≤–∞—à —É—Ä–µ—í–∞—ò —Å–∞ IoT Hub-–æ–º

–°–ª–µ–¥–µ—õ–∏ –∫–æ—Ä–∞–∫ —ò–µ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ –≤–∞—à–µ–≥ —É—Ä–µ—í–∞—ò–∞ —Å–∞ IoT Hub-–æ–º.

### –ó–∞–¥–∞—Ç–∞–∫ - –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ IoT Hub-–æ–º

1. –û—Ç–≤–æ—Ä–∏—Ç–µ –ø—Ä–æ—ò–µ–∫–∞—Ç `soil-moisture-sensor` —É VS Code-—É.

1. –û—Ç–≤–æ—Ä–∏—Ç–µ –¥–∞—Ç–æ—Ç–µ–∫—É `platformio.ini`. –£–∫–ª–æ–Ω–∏—Ç–µ –∑–∞–≤–∏—Å–Ω–æ—Å—Ç –æ–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ `knolleary/PubSubClient`. –û–≤–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —ò–µ –∫–æ—Ä–∏—à—õ–µ–Ω–∞ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ —ò–∞–≤–Ω–∏–º MQTT –±—Ä–æ–∫–µ—Ä–æ–º, –∞–ª–∏ –Ω–∏—ò–µ –ø–æ—Ç—Ä–µ–±–Ω–∞ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ IoT Hub-–æ–º.

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–µ –∑–∞–≤–∏—Å–Ω–æ—Å—Ç–∏ –æ–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```

    –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `Seeed Arduino RTC` –ø—Ä—É–∂–∞ –∫–æ–¥ –∑–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ü–∏—ò—É —Å–∞ —Ä–µ–∞–ª–Ω–∏–º –≤—Ä–µ–º–µ–Ω—Å–∫–∏–º —Å–∞—Ç–æ–º —É Wio Terminal-—É, –∫–æ—ò–∏ —Å–µ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –ø—Ä–∞—õ–µ—ö–µ –≤—Ä–µ–º–µ–Ω–∞. –ü—Ä–µ–æ—Å—Ç–∞–ª–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –æ–º–æ–≥—É—õ–∞–≤–∞—ò—É –≤–∞—à–µ–º IoT —É—Ä–µ—í–∞—ò—É –¥–∞ —Å–µ –ø–æ–≤–µ–∂–µ —Å–∞ IoT Hub-–æ–º.

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–µ –Ω–∞ –∫—Ä–∞—ò –¥–∞—Ç–æ—Ç–µ–∫–µ `platformio.ini`:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```

    –û–≤–æ –ø–æ—Å—Ç–∞–≤—ô–∞ –∑–∞—Å—Ç–∞–≤–∏—Ü—É –∫–æ–º–ø–∞—ò–ª–µ—Ä–∞ –∫–æ—ò–∞ —ò–µ –ø–æ—Ç—Ä–µ–±–Ω–∞ –ø—Ä–∏–ª–∏–∫–æ–º –∫–æ–º–ø–∞—ò–ª–∏—Ä–∞—ö–∞ –∫–æ–¥–∞ –∑–∞ Arduino IoT Hub.

1. –û—Ç–≤–æ—Ä–∏—Ç–µ –∑–∞–≥–ª–∞–≤–Ω—É –¥–∞—Ç–æ—Ç–µ–∫—É `config.h`. –£–∫–ª–æ–Ω–∏—Ç–µ —Å–≤–∞ –ø–æ–¥–µ—à–∞–≤–∞—ö–∞ –∑–∞ MQTT –∏ –¥–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –∑–∞ —Å—Ç—Ä–∏–Ω–≥ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —É—Ä–µ—í–∞—ò–∞:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```

    –ó–∞–º–µ–Ω–∏—Ç–µ `<connection string>` —Å—Ç—Ä–∏–Ω–≥–æ–º –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ –≤–∞—à–µ–≥ —É—Ä–µ—í–∞—ò–∞ –∫–æ—ò–∏ —Å—Ç–µ —Ä–∞–Ω–∏—ò–µ –∫–æ–ø–∏—Ä–∞–ª–∏.

1. –ü–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ IoT Hub-–æ–º –∫–æ—Ä–∏—Å—Ç–∏ —Ç–æ–∫–µ–Ω –∑–∞—Å–Ω–æ–≤–∞–Ω –Ω–∞ –≤—Ä–µ–º–µ–Ω—É. –¢–æ –∑–Ω–∞—á–∏ –¥–∞ IoT —É—Ä–µ—í–∞—ò –º–æ—Ä–∞ –∑–Ω–∞—Ç–∏ —Ç—Ä–µ–Ω—É—Ç–Ω–æ –≤—Ä–µ–º–µ. –ó–∞ —Ä–∞–∑–ª–∏–∫—É –æ–¥ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞ –∫–∞–æ —à—Ç–æ —Å—É Windows, macOS –∏–ª–∏ Linux, –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑—É—ò—É –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ —Ç—Ä–µ–Ω—É—Ç–Ω–æ –≤—Ä–µ–º–µ –ø—Ä–µ–∫–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –¢–æ –∑–Ω–∞—á–∏ –¥–∞ –º–æ—Ä–∞—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥ –∑–∞ –¥–æ–±–∏—ò–∞—ö–µ —Ç—Ä–µ–Ω—É—Ç–Ω–æ–≥ –≤—Ä–µ–º–µ–Ω–∞ —Å–∞ [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) —Å–µ—Ä–≤–µ—Ä–∞. –ö–∞–¥–∞ —Å–µ –≤—Ä–µ–º–µ –ø—Ä–µ—É–∑–º–µ, –º–æ–∂–µ —Å–µ —á—É–≤–∞—Ç–∏ —É —Ä–µ–∞–ª–Ω–æ–º –≤—Ä–µ–º–µ–Ω—Å–∫–æ–º —Å–∞—Ç—É —É Wio Terminal-—É, –æ–º–æ–≥—É—õ–∞–≤–∞—ò—É—õ–∏ –¥–∞ —Å–µ –∏—Å–ø—Ä–∞–≤–Ω–æ –≤—Ä–µ–º–µ –∑–∞—Ç—Ä–∞–∂–∏ –∫–∞—Å–Ω–∏—ò–µ, –ø–æ–¥ —É—Å–ª–æ–≤–æ–º –¥–∞ —É—Ä–µ—í–∞—ò –Ω–µ –∏–∑–≥—É–±–∏ –Ω–∞–ø–∞—ò–∞—ö–µ. –î–æ–¥–∞—ò—Ç–µ –Ω–æ–≤—É –¥–∞—Ç–æ—Ç–µ–∫—É –ø–æ–¥ –Ω–∞–∑–∏–≤–æ–º `ntp.h` —Å–∞ —Å–ª–µ–¥–µ—õ–∏–º –∫–æ–¥–æ–º:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```

    –î–µ—Ç–∞—ô–∏ –æ–≤–æ–≥ –∫–æ–¥–∞ —Å—É –≤–∞–Ω –æ–∫–≤–∏—Ä–∞ –æ–≤–µ –ª–µ–∫—Ü–∏—ò–µ. –û–Ω –¥–µ—Ñ–∏–Ω–∏—à–µ —Ñ—É–Ω–∫—Ü–∏—ò—É `initTime` –∫–æ—ò–∞ –¥–æ–±–∏—ò–∞ —Ç—Ä–µ–Ω—É—Ç–Ω–æ –≤—Ä–µ–º–µ —Å–∞ NTP —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ—Ä–∏—Å—Ç–∏ –≥–∞ –∑–∞ –ø–æ–¥–µ—à–∞–≤–∞—ö–µ —Å–∞—Ç–∞ –Ω–∞ Wio Terminal-—É.

1. –û—Ç–≤–æ—Ä–∏—Ç–µ –¥–∞—Ç–æ—Ç–µ–∫—É `main.cpp` –∏ —É–∫–ª–æ–Ω–∏—Ç–µ —Å–∞–≤ MQTT –∫–æ–¥, —É–∫—ô—É—á—É—ò—É—õ–∏ –∑–∞–≥–ª–∞–≤–Ω—É –¥–∞—Ç–æ—Ç–µ–∫—É `PubSubClient.h`, –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—ò—É –ø—Ä–æ–º–µ–Ω—ô–∏–≤–µ `PubSubClient`, –º–µ—Ç–æ–¥–µ `reconnectMQTTClient` –∏ `createMQTTClient`, –∫–∞–æ –∏ —Å–≤–µ –ø–æ–∑–∏–≤–µ –æ–≤–∏—Ö –ø—Ä–æ–º–µ–Ω—ô–∏–≤–∏—Ö –∏ –º–µ—Ç–æ–¥–∞. –û–≤–∞ –¥–∞—Ç–æ—Ç–µ–∫–∞ —Ç—Ä–µ–±–∞ –¥–∞ —Å–∞–¥—Ä–∂–∏ —Å–∞–º–æ –∫–æ–¥ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ –Ω–∞ WiFi, –¥–æ–±–∏—ò–∞—ö–µ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –∑–µ–º—ô–∏—à—Ç–∞ –∏ –∫—Ä–µ–∏—Ä–∞—ö–µ JSON –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–∞ —Ç–∏–º –ø–æ–¥–∞—Ü–∏–º–∞.

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–µ `#include` –¥–∏—Ä–µ–∫—Ç–∏–≤–µ –Ω–∞ –≤—Ä—Ö –¥–∞—Ç–æ—Ç–µ–∫–µ `main.cpp` –∫–∞–∫–æ –±–∏—Å—Ç–µ —É–∫—ô—É—á–∏–ª–∏ –∑–∞–≥–ª–∞–≤–Ω–µ –¥–∞—Ç–æ—Ç–µ–∫–µ –∑–∞ IoT Hub –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∏ –∑–∞ –ø–æ–¥–µ—à–∞–≤–∞—ö–µ –≤—Ä–µ–º–µ–Ω–∞:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–∏ –ø–æ–∑–∏–≤ –Ω–∞ –∫—Ä–∞—ò —Ñ—É–Ω–∫—Ü–∏—ò–µ `setup` –∫–∞–∫–æ –±–∏—Å—Ç–µ –ø–æ–¥–µ—Å–∏–ª–∏ —Ç—Ä–µ–Ω—É—Ç–Ω–æ –≤—Ä–µ–º–µ:

    ```cpp
    initTime();
    ```

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ—É –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—ò—É –ø—Ä–æ–º–µ–Ω—ô–∏–≤–µ –Ω–∞ –≤—Ä—Ö –¥–∞—Ç–æ—Ç–µ–∫–µ, –æ–¥–º–∞—Ö –∏—Å–ø–æ–¥ –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –∑–∞ —É–∫—ô—É—á–∏–≤–∞—ö–µ:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```

    –û–≤–æ –¥–µ–∫–ª–∞—Ä–∏—à–µ `IOTHUB_DEVICE_CLIENT_LL_HANDLE`, —Ä—É—á–∏—Ü—É –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ IoT Hub-–æ–º.

1. –ò—Å–ø–æ–¥ –æ–≤–æ–≥–∞, –¥–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–∏ –∫–æ–¥:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```

    –û–≤–æ –¥–µ–∫–ª–∞—Ä–∏—à–µ —Ñ—É–Ω–∫—Ü–∏—ò—É –ø–æ–≤—Ä–∞—Ç–Ω–æ–≥ –ø–æ–∑–∏–≤–∞ –∫–æ—ò–∞ —õ–µ –±–∏—Ç–∏ –ø–æ–∑–≤–∞–Ω–∞ –∫–∞–¥–∞ —Å–µ —Å—Ç–∞—Ç—É—Å –ø–æ–≤–µ–∑–∏–≤–∞—ö–∞ —Å–∞ IoT Hub-–æ–º –ø—Ä–æ–º–µ–Ω–∏, –∫–∞–æ —à—Ç–æ —ò–µ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ –∏–ª–∏ –ø—Ä–µ–∫–∏–¥ –≤–µ–∑–µ. –°—Ç–∞—Ç—É—Å —Å–µ —à–∞—ô–µ –Ω–∞ —Å–µ—Ä–∏—ò—Å–∫–∏ –ø–æ—Ä—Ç.

1. –ò—Å–ø–æ–¥ –æ–≤–æ–≥–∞, –¥–æ–¥–∞—ò—Ç–µ —Ñ—É–Ω–∫—Ü–∏—ò—É –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —Å–∞ IoT Hub-–æ–º:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```

    –û–≤–∞—ò –∫–æ–¥ –∏–Ω–∏—Ü–∏—ò–∞–ª–∏–∑—É—ò–µ IoT Hub –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∞ –∑–∞—Ç–∏–º –∫—Ä–µ–∏—Ä–∞ –≤–µ–∑—É –∫–æ—Ä–∏—Å—Ç–µ—õ–∏ —Å—Ç—Ä–∏–Ω–≥ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —É –∑–∞–≥–ª–∞–≤–Ω–æ—ò –¥–∞—Ç–æ—Ç–µ—Ü–∏ `config.h`. –û–≤–∞ –≤–µ–∑–∞ —Å–µ –∑–∞—Å–Ω–∏–≤–∞ –Ω–∞ MQTT-—É. –ê–∫–æ –≤–µ–∑–∞ –Ω–µ —É—Å–ø–µ, —Ç–æ —Å–µ —à–∞—ô–µ –Ω–∞ —Å–µ—Ä–∏—ò—Å–∫–∏ –ø–æ—Ä—Ç - –∞–∫–æ —Ç–æ –≤–∏–¥–∏—Ç–µ —É –∏–∑–ª–∞–∑—É, –ø—Ä–æ–≤–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∏–Ω–≥ –∑–∞ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ. –ù–∞ –∫—Ä–∞—ò—É —Å–µ –ø–æ—Å—Ç–∞–≤—ô–∞ –ø–æ–≤—Ä–∞—Ç–Ω–∏ –ø–æ–∑–∏–≤ –∑–∞ —Å—Ç–∞—Ç—É—Å –≤–µ–∑–µ.

1. –ü–æ–∑–æ–≤–∏—Ç–µ –æ–≤—É —Ñ—É–Ω–∫—Ü–∏—ò—É —É —Ñ—É–Ω–∫—Ü–∏—ò–∏ `setup` –∏—Å–ø–æ–¥ –ø–æ–∑–∏–≤–∞ —Ñ—É–Ω–∫—Ü–∏—ò–µ `initTime`:

    ```cpp
    connectIoTHub();
    ```

1. –ö–∞–æ –∏ –∫–æ–¥ MQTT –∫–ª–∏—ò–µ–Ω—Ç–∞, –æ–≤–∞—ò –∫–æ–¥ —Ä–∞–¥–∏ –Ω–∞ —ò–µ–¥–Ω–æ–º –Ω–∏—Ç—É, –ø–∞ –º—É —ò–µ –ø–æ—Ç—Ä–µ–±–Ω–æ –≤—Ä–µ–º–µ –∑–∞ –æ–±—Ä–∞–¥—É –ø–æ—Ä—É–∫–∞ –∫–æ—ò–µ —à–∞—ô–µ —Ö–∞–±—É –∏ –∫–æ—ò–µ —Ö–∞–± —à–∞—ô–µ —ö–µ–º—É. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–µ –Ω–∞ –≤—Ä—Ö —Ñ—É–Ω–∫—Ü–∏—ò–µ `loop` –∫–∞–∫–æ –±–∏—Å—Ç–µ —Ç–æ –æ–º–æ–≥—É—õ–∏–ª–∏:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```

1. –ö–æ–º–ø–∏–ª–∏—Ä–∞—ò—Ç–µ –∏ –æ—Ç–ø—Ä–µ–º–∏—Ç–µ –æ–≤–∞—ò –∫–æ–¥. –í–∏–¥–µ—õ–µ—Ç–µ –ø–æ–≤–µ–∑–∏–≤–∞—ö–µ —É —Å–µ—Ä–∏—ò—Å–∫–æ–º –º–æ–Ω–∏—Ç–æ—Ä—É:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```

    –£ –∏–∑–ª–∞–∑—É –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç–∏ –∫–∞–∫–æ —Å–µ –ø—Ä–µ—É–∑–∏–º–∞ NTP –≤—Ä–µ–º–µ, –∞ –∑–∞—Ç–∏–º –∫–∞–∫–æ —Å–µ –∫–ª–∏—ò–µ–Ω—Ç —É—Ä–µ—í–∞—ò–∞ –ø–æ–≤–µ–∑—É—ò–µ. –ú–æ–∂–µ –ø–æ—Ç—Ä–∞—ò–∞—Ç–∏ –Ω–µ–∫–æ–ª–∏–∫–æ —Å–µ–∫—É–Ω–¥–∏ –¥–∞ —Å–µ –ø–æ–≤–µ–∂–µ—Ç–µ, –ø–∞ –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç–∏ –≤–ª–∞–∂–Ω–æ—Å—Ç –∑–µ–º—ô–∏—à—Ç–∞ —É –∏–∑–ª–∞–∑—É –¥–æ–∫ —Å–µ —É—Ä–µ—í–∞—ò –ø–æ–≤–µ–∑—É—ò–µ.

    > üíÅ –ú–æ–∂–µ—Ç–µ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞—Ç–∏ UNIX –≤—Ä–µ–º–µ –∑–∞ NTP —É —á–∏—Ç—ô–∏–≤–∏—ò—É –≤–µ—Ä–∑–∏—ò—É –∫–æ—Ä–∏—Å—Ç–µ—õ–∏ –≤–µ–± —Å–∞—ò—Ç –∫–∞–æ —à—Ç–æ —ò–µ [unixtimestamp.com](https://www.unixtimestamp.com)

## –°–ª–∞—ö–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—ò–µ

–°–∞–¥–∞ –∫–∞–¥–∞ —ò–µ –≤–∞—à —É—Ä–µ—í–∞—ò –ø–æ–≤–µ–∑–∞–Ω, –º–æ–∂–µ—Ç–µ —Å–ª–∞—Ç–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—ò—É IoT Hub-—É —É–º–µ—Å—Ç–æ MQTT –±—Ä–æ–∫–µ—Ä—É.

### –ó–∞–¥–∞—Ç–∞–∫ - —Å–ª–∞—ö–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—ò–µ

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ—É —Ñ—É–Ω–∫—Ü–∏—ò—É –∏–∑–Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏—ò–µ `setup`:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```

    –û–≤–∞—ò –∫–æ–¥ –∫—Ä–µ–∏—Ä–∞ IoT Hub –ø–æ—Ä—É–∫—É –∏–∑ —Å—Ç—Ä–∏–Ω–≥–∞ –∫–æ—ò–∏ —Å–µ –ø—Ä–æ—Å–ª–µ—í—É—ò–µ –∫–∞–æ –ø–∞—Ä–∞–º–µ—Ç–∞—Ä, —à–∞—ô–µ —ò–µ —Ö–∞–±—É, –∞ –∑–∞—Ç–∏–º —á–∏—Å—Ç–∏ –æ–±—ò–µ–∫–∞—Ç –ø–æ—Ä—É–∫–µ.

1. –ü–æ–∑–æ–≤–∏—Ç–µ –æ–≤–∞—ò –∫–æ–¥ —É —Ñ—É–Ω–∫—Ü–∏—ò–∏ `loop`, –æ–¥–º–∞—Ö –Ω–∞–∫–æ–Ω –ª–∏–Ω–∏—ò–µ –≥–¥–µ —Å–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—ò–∞ —à–∞—ô–µ –Ω–∞ —Å–µ—Ä–∏—ò—Å–∫–∏ –ø–æ—Ä—Ç:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```

## –û–±—Ä–∞–¥–∞ –∫–æ–º–∞–Ω–¥–∏

–í–∞—à —É—Ä–µ—í–∞—ò —Ç—Ä–µ–±–∞ –¥–∞ –æ–±—Ä–∞–¥–∏ –∫–æ–º–∞–Ω–¥—É —Å–∞ —Å–µ—Ä–≤–µ—Ä—Å–∫–æ–≥ –∫–æ–¥–∞ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—É —Ä–µ–ª–µ—ò–∞. –û–≤–æ —Å–µ —à–∞—ô–µ –∫–∞–æ –∑–∞—Ö—Ç–µ–≤ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω—É –º–µ—Ç–æ–¥—É.

## –ó–∞–¥–∞—Ç–∞–∫ - –æ–±—Ä–∞–¥–∞ –∑–∞—Ö—Ç–µ–≤–∞ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω—É –º–µ—Ç–æ–¥—É

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–∏ –∫–æ–¥ –ø—Ä–µ —Ñ—É–Ω–∫—Ü–∏—ò–µ `connectIoTHub`:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```

    –û–≤–∞—ò –∫–æ–¥ –¥–µ—Ñ–∏–Ω–∏—à–µ —Ñ—É–Ω–∫—Ü–∏—ò—É –ø–æ–≤—Ä–∞—Ç–Ω–æ–≥ –ø–æ–∑–∏–≤–∞ –∫–æ—ò—É IoT Hub –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–æ–∂–µ –ø–æ–∑–≤–∞—Ç–∏ –∫–∞–¥–∞ –ø—Ä–∏–º–∏ –∑–∞—Ö—Ç–µ–≤ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω—É –º–µ—Ç–æ–¥—É. –ú–µ—Ç–æ–¥–∞ –∫–æ—ò–∞ —Å–µ –∑–∞—Ö—Ç–µ–≤–∞ —à–∞—ô–µ —Å–µ —É –ø–∞—Ä–∞–º–µ—Ç—Ä—É `method_name`. –û–≤–∞ —Ñ—É–Ω–∫—Ü–∏—ò–∞ –∏—Å–ø–∏—Å—É—ò–µ –ø–æ–∑–≤–∞–Ω—É –º–µ—Ç–æ–¥—É –Ω–∞ —Å–µ—Ä–∏—ò—Å–∫–∏ –ø–æ—Ä—Ç, –∞ –∑–∞—Ç–∏–º —É–∫—ô—É—á—É—ò–µ –∏–ª–∏ –∏—Å–∫—ô—É—á—É—ò–µ —Ä–µ–ª–µ—ò —É –∑–∞–≤–∏—Å–Ω–æ—Å—Ç–∏ –æ–¥ –∏–º–µ–Ω–∞ –º–µ—Ç–æ–¥–µ.

    > üíÅ –û–≤–æ –±–∏ –º–æ–≥–ª–æ –±–∏—Ç–∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–æ –∏ —É —ò–µ–¥–Ω–æ—ò –¥–∏—Ä–µ–∫—Ç–Ω–æ—ò –º–µ—Ç–æ–¥–∏, –ø—Ä–æ—Å–ª–µ—í—É—ò—É—õ–∏ –∂–µ—ô–µ–Ω–æ —Å—Ç–∞—ö–µ —Ä–µ–ª–µ—ò–∞ —É payload –∫–æ—ò–∏ —Å–µ –º–æ–∂–µ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç–∏ —Å–∞ –∑–∞—Ö—Ç–µ–≤–æ–º –∑–∞ –º–µ—Ç–æ–¥—É –∏ –¥–æ—Å—Ç—É–ø–∞–Ω —ò–µ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `payload`.

1. –î–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–∏ –∫–æ–¥ –Ω–∞ –∫—Ä–∞—ò —Ñ—É–Ω–∫—Ü–∏—ò–µ `directMethodCallback`:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```

    –ó–∞—Ö—Ç–µ–≤–∏ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–µ –º–µ—Ç–æ–¥–µ –∑–∞—Ö—Ç–µ–≤–∞—ò—É –æ–¥–≥–æ–≤–æ—Ä, –∞ –æ–¥–≥–æ–≤–æ—Ä —ò–µ —É –¥–≤–∞ –¥–µ–ª–∞ - –æ–¥–≥–æ–≤–æ—Ä –∫–∞–æ —Ç–µ–∫—Å—Ç –∏ –∫–æ–¥ –ø–æ–≤—Ä–∞—Ç–∫–∞. –û–≤–∞—ò –∫–æ–¥ —õ–µ –∫—Ä–µ–∏—Ä–∞—Ç–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç –∫–∞–æ —Å–ª–µ–¥–µ—õ–∏ JSON –¥–æ–∫—É–º–µ–Ω—Ç:

    ```JSON
    {
        "Result": ""
    }
    ```

    –û–≤–æ —Å–µ –∑–∞—Ç–∏–º –∫–æ–ø–∏—Ä–∞ —É –ø–∞—Ä–∞–º–µ—Ç–∞—Ä `response`, –∞ –≤–µ–ª–∏—á–∏–Ω–∞ –æ–≤–æ–≥ –æ–¥–≥–æ–≤–æ—Ä–∞ —Å–µ –ø–æ—Å—Ç–∞–≤—ô–∞ —É –ø–∞—Ä–∞–º–µ—Ç–∞—Ä `response_size`. –û–≤–∞—ò –∫–æ–¥ –∑–∞—Ç–∏–º –≤—Ä–∞—õ–∞ `IOTHUB_CLIENT_OK` –∫–∞–∫–æ –±–∏ –ø–æ–∫–∞–∑–∞–æ –¥–∞ —ò–µ –º–µ—Ç–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞—í–µ–Ω–∞.

1. –ü–æ–≤–µ–∂–∏—Ç–µ –ø–æ–≤—Ä–∞—Ç–Ω–∏ –ø–æ–∑–∏–≤ –¥–æ–¥–∞–≤–∞—ö–µ–º —Å–ª–µ–¥–µ—õ–µ–≥ –Ω–∞ –∫—Ä–∞—ò —Ñ—É–Ω–∫—Ü–∏—ò–µ `connectIoTHub`:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```

1. –§—É–Ω–∫—Ü–∏—ò–∞ `loop` —õ–µ –ø–æ–∑–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—ò—É `IoTHubDeviceClient_LL_DoWork` –∫–∞–∫–æ –±–∏ –æ–±—Ä–∞–¥–∏–ª–∞ –¥–æ–≥–∞—í–∞—ò–µ –∫–æ—ò–µ —à–∞—ô–µ IoT Hub. –û–≤–æ —Å–µ –ø–æ–∑–∏–≤–∞ —Å–∞–º–æ —Å–≤–∞–∫–∏—Ö 10 —Å–µ–∫—É–Ω–¥–∏ –∑–±–æ–≥ `delay`, —à—Ç–æ –∑–Ω–∞—á–∏ –¥–∞ —Å–µ –¥–∏—Ä–µ–∫—Ç–Ω–µ –º–µ—Ç–æ–¥–µ –æ–±—Ä–∞—í—É—ò—É —Å–∞–º–æ —Å–≤–∞–∫–∏—Ö 10 —Å–µ–∫—É–Ω–¥–∏. –î–∞ –±–∏ –æ–≤–æ –±–∏–ª–æ –µ—Ñ–∏–∫–∞—Å–Ω–∏—ò–µ, 10-—Å–µ–∫—É–Ω–¥–Ω–æ –∫–∞—à—ö–µ—ö–µ –º–æ–∂–µ –±–∏—Ç–∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–æ –∫–∞–æ –º–Ω–æ–≥–æ –∫—Ä–∞—õ–∏—Ö –∫–∞—à—ö–µ—ö–∞, –ø–æ–∑–∏–≤–∞—ò—É—õ–∏ `IoTHubDeviceClient_LL_DoWork` —Å–≤–∞–∫–∏ –ø—É—Ç. –î–∞ –±–∏—Å—Ç–µ —Ç–æ —É—Ä–∞–¥–∏–ª–∏, –¥–æ–¥–∞—ò—Ç–µ —Å–ª–µ–¥–µ—õ–∏ –∫–æ–¥ –∏–∑–Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏—ò–µ `loop`:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```

    –û–≤–∞—ò –∫–æ–¥ —õ–µ —Å–µ –ø–æ–Ω–∞–≤—ô–∞—Ç–∏, –ø–æ–∑–∏–≤–∞—ò—É—õ–∏ `IoTHubDeviceClient_LL_DoWork` –∏ –æ–¥–ª–∞–∂—É—õ–∏ –∑–∞ 100ms —Å–≤–∞–∫–∏ –ø—É—Ç. –¢–æ —õ–µ —Ä–∞–¥–∏—Ç–∏ –æ–Ω–æ–ª–∏–∫–æ –ø—É—Ç–∞ –∫–æ–ª–∏–∫–æ —ò–µ –ø–æ—Ç—Ä–µ–±–Ω–æ –¥–∞ —Å–µ –æ–¥–ª–æ–∂–∏ –∑–∞ –≤—Ä–µ–º–µ –¥–∞—Ç–æ —É –ø–∞—Ä–∞–º–µ—Ç—Ä—É `delay_time`. –¢–æ –∑–Ω–∞—á–∏ –¥–∞ —É—Ä–µ—í–∞—ò —á–µ–∫–∞ –Ω–∞—ò–≤–∏—à–µ 100ms –¥–∞ –æ–±—Ä–∞–¥–∏ –∑–∞—Ö—Ç–µ–≤–µ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–µ –º–µ—Ç–æ–¥–µ.

1. –£ —Ñ—É–Ω–∫—Ü–∏—ò–∏ `loop`, —É–∫–ª–æ–Ω–∏—Ç–µ –ø–æ–∑–∏–≤ —Ñ—É–Ω–∫—Ü–∏—ò–µ `IoTHubDeviceClient_LL_DoWork`, –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –ø–æ–∑–∏–≤ `delay(10000)` —Å–ª–µ–¥–µ—õ–∏–º –∫–∞–∫–æ –±–∏—Å—Ç–µ –ø–æ–∑–≤–∞–ª–∏ –æ–≤—É –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü–∏—ò—É:

    ```cpp
    work_delay(10000);
    ```

> üíÅ –û–≤–∞—ò –∫–æ–¥ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∞—õ–∏ —É —Ñ–æ–ª–¥–µ—Ä—É [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal).

üòÄ –í–∞—à –ø—Ä–æ–≥—Ä–∞–º –∑–∞ —Å–µ–Ω–∑–æ—Ä –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –∑–µ–º—ô–∏—à—Ç–∞ —ò–µ –ø–æ–≤–µ–∑–∞–Ω —Å–∞ –≤–∞—à–∏–º IoT Hub-–æ–º!

---

**–û–¥—Ä–∏—Ü–∞—ö–µ –æ–¥ –æ–¥–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç–∏**:  
–û–≤–∞—ò –¥–æ–∫—É–º–µ–Ω—Ç —ò–µ –ø—Ä–µ–≤–µ–¥–µ–Ω –∫–æ—Ä–∏—à—õ–µ—ö–µ–º —É—Å–ª—É–≥–µ –∑–∞ –ø—Ä–µ–≤–æ—í–µ—ö–µ –ø–æ–º–æ—õ—É –≤–µ—à—Ç–∞—á–∫–µ –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ü–∏—ò–µ [Co-op Translator](https://github.com/Azure/co-op-translator). –ò–∞–∫–æ —Å–µ —Ç—Ä—É–¥–∏–º–æ –¥–∞ –æ–±–µ–∑–±–µ–¥–∏–º–æ —Ç–∞—á–Ω–æ—Å—Ç, –º–æ–ª–∏–º–æ –≤–∞—Å –¥–∞ –∏–º–∞—Ç–µ —É –≤–∏–¥—É –¥–∞ –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ –ø—Ä–µ–≤–æ–¥–∏ –º–æ–≥—É —Å–∞–¥—Ä–∂–∞—Ç–∏ –≥—Ä–µ—à–∫–µ –∏–ª–∏ –Ω–µ—Ç–∞—á–Ω–æ—Å—Ç–∏. –û—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —ö–µ–≥–æ–≤–æ–º –∏–∑–≤–æ—Ä–Ω–æ–º —ò–µ–∑–∏–∫—É —Ç—Ä–µ–±–∞ —Å–º–∞—Ç—Ä–∞—Ç–∏ –∞—É—Ç–æ—Ä–∏—Ç–∞—Ç–∏–≤–Ω–∏–º –∏–∑–≤–æ—Ä–æ–º. –ó–∞ –∫—Ä–∏—Ç–∏—á–Ω–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—ò–µ –ø—Ä–µ–ø–æ—Ä—É—á—É—ò–µ —Å–µ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏ –ø—Ä–µ–≤–æ–¥ –æ–¥ —Å—Ç—Ä–∞–Ω–µ —ô—É–¥–∏. –ù–µ –ø—Ä–µ—É–∑–∏–º–∞–º–æ –æ–¥–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç –∑–∞ –±–∏–ª–æ –∫–∞–∫–≤–∞ –ø–æ–≥—Ä–µ—à–Ω–∞ —Ç—É–º–∞—á–µ—ö–∞ –∏–ª–∏ –Ω–µ—Å–ø–æ—Ä–∞–∑—É–º–µ –∫–æ—ò–∏ –º–æ–≥—É –Ω–∞—Å—Ç–∞—Ç–∏ —É—Å–ª–µ–¥ –∫–æ—Ä–∏—à—õ–µ—ö–∞ –æ–≤–æ–≥ –ø—Ä–µ–≤–æ–¥–∞.