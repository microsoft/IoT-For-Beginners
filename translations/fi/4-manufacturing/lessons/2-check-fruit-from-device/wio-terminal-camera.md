<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "160be8c0f558687f6686dca64f10f739",
  "translation_date": "2025-08-27T20:44:38+00:00",
  "source_file": "4-manufacturing/lessons/2-check-fruit-from-device/wio-terminal-camera.md",
  "language_code": "fi"
}
-->
# Tallenna kuva - Wio Terminal

T√§ss√§ oppitunnin osassa lis√§√§t kameran Wio Terminaliin ja otat kuvia sill√§.

## Laitteisto

Wio Terminal tarvitsee kameran.

Kamera, jota k√§yt√§t, on [ArduCam Mini 2MP Plus](https://www.arducam.com/product/arducam-2mp-spi-camera-b0067-arduino/). T√§m√§ on 2 megapikselin kamera, joka perustuu OV2640-kuvakennoon. Se kommunikoi SPI-liit√§nn√§n kautta kuvien ottamiseksi ja k√§ytt√§√§ I2C:t√§ anturin konfigurointiin.

## Yhdist√§ kamera

ArduCam ei sis√§ll√§ Grove-liitint√§, vaan se yhdistet√§√§n sek√§ SPI- ett√§ I2C-v√§yl√§√§n GPIO-pinnien kautta Wio Terminalissa.

### Teht√§v√§ - yhdist√§ kamera

Yhdist√§ kamera.

![ArduCam-anturi](../../../../../translated_images/arducam.20e4e4cbb268296570b5914e20d6c349fc42ddac9ed4e1b9deba2188204eebae.fi.png)

1. ArduCamin pohjassa olevat pinnit t√§ytyy yhdist√§√§ Wio Terminalin GPIO-pinneihin. Jotta oikeat pinnit l√∂ytyv√§t helpommin, kiinnit√§ Wio Terminalin mukana tuleva GPIO-tarralappu pinneihin:

    ![Wio Terminal GPIO-tarralapulla](../../../../../translated_images/wio-terminal-pin-sticker.b90b1535937b84bd00d853f0004aea74fac2aec04b43f14b887796b2633f855e.fi.png)

1. K√§yt√§ hyppylankoja ja tee seuraavat liit√§nn√§t:

    | ArduCAM-pinni | Wio Terminal -pinni | Kuvaus                                 |
    | ------------- | -------------------- | -------------------------------------- |
    | CS            | 24 (SPI_CS)          | SPI Chip Select                        |
    | MOSI          | 19 (SPI_MOSI)        | SPI-ohjaimen ulostulo, laitteen sis√§√§ntulo |
    | MISO          | 21 (SPI_MISO)        | SPI-ohjaimen sis√§√§ntulo, laitteen ulostulo |
    | SCK           | 23 (SPI_SCLK)        | SPI-sarjakello                         |
    | GND           | 6 (GND)              | Maa - 0V                               |
    | VCC           | 4 (5V)               | 5V virtal√§hde                          |
    | SDA           | 3 (I2C1_SDA)         | I2C-sarjadata                          |
    | SCL           | 5 (I2C1_SCL)         | I2C-sarjakello                         |

    ![Wio Terminal yhdistetty ArduCamiin hyppylangoilla](../../../../../translated_images/arducam-wio-terminal-connections.a4d5a4049bdb5ab800a2877389fc6ecf5e4ff307e6451ff56c517e6786467d0a.fi.png)

    GND- ja VCC-liit√§nn√§t tarjoavat 5V virtal√§hteen ArduCamille. Se toimii 5V:lla, toisin kuin Grove-anturit, jotka toimivat 3V:lla. T√§m√§ virta tulee suoraan USB-C-liit√§nn√§st√§, joka sy√∂tt√§√§ virtaa laitteelle.

    > üíÅ SPI-liit√§nn√§ss√§ ArduCamin pinni-merkinn√§t ja Wio Terminalin pinni-nimet, joita k√§ytet√§√§n koodissa, k√§ytt√§v√§t edelleen vanhaa nime√§misk√§yt√§nt√∂√§. T√§m√§n oppitunnin ohjeet k√§ytt√§v√§t uutta nime√§misk√§yt√§nt√∂√§, paitsi silloin kun pinni-nimi√§ k√§ytet√§√§n koodissa.

1. Voit nyt yhdist√§√§ Wio Terminalin tietokoneeseesi.

## Ohjelmoi laite yhdist√§m√§√§n kameraan

Wio Terminal voidaan nyt ohjelmoida k√§ytt√§m√§√§n liitetty√§ ArduCAM-kameraa.

### Teht√§v√§ - ohjelmoi laite yhdist√§m√§√§n kameraan

1. Luo uusi Wio Terminal -projekti PlatformIO:ssa. Nime√§ projekti `fruit-quality-detector`. Lis√§√§ koodia `setup`-funktioon sarjaportin konfiguroimiseksi.

1. Lis√§√§ koodia yhdist√§√§ksesi WiFiin, ja tallenna WiFi-tunnistetiedot tiedostoon nimelt√§ `config.h`. √Ñl√§ unohda lis√§t√§ tarvittavia kirjastoja `platformio.ini`-tiedostoon.

1. ArduCam-kirjasto ei ole saatavilla Arduino-kirjastona, joka voidaan asentaa `platformio.ini`-tiedostosta. Sen sijaan se t√§ytyy asentaa l√§hdekoodista heid√§n GitHub-sivultaan. Voit tehd√§ t√§m√§n joko:

    * Kloonaamalla repositorion osoitteesta [https://github.com/ArduCAM/Arduino.git](https://github.com/ArduCAM/Arduino.git)
    * Siirtym√§ll√§ GitHub-repositorioon osoitteessa [github.com/ArduCAM/Arduino](https://github.com/ArduCAM/Arduino) ja lataamalla koodin zip-tiedostona **Code**-painikkeesta

1. Tarvitset vain `ArduCAM`-kansion t√§st√§ koodista. Kopioi koko kansio projektisi `lib`-kansioon.

    > ‚ö†Ô∏è Koko kansio t√§ytyy kopioida, jotta koodi on `lib/ArduCam`. √Ñl√§ kopioi vain `ArduCam`-kansion sis√§lt√∂√§ `lib`-kansioon, vaan kopioi koko kansio.

1. ArduCam-kirjastokoodi toimii useille kameratyypeille. K√§ytett√§v√§ kameratyyppi konfiguroidaan k√§√§nt√§j√§n lipuilla - t√§m√§ pit√§√§ rakennetun kirjaston mahdollisimman pienen√§ poistamalla koodin kameroille, joita et k√§yt√§. Konfiguroidaksesi kirjaston OV2640-kameralle, lis√§√§ seuraava `platformio.ini`-tiedoston loppuun:

    ```ini
    build_flags =
        -DARDUCAM_SHIELD_V2
        -DOV2640_CAM
    ```

    T√§m√§ asettaa kaksi k√§√§nt√§j√§n lippua:

      * `ARDUCAM_SHIELD_V2` kertoo kirjastolle, ett√§ kamera on Arduino-laudalla, joka tunnetaan nimell√§ shield.
      * `OV2640_CAM` kertoo kirjastolle, ett√§ mukaan otetaan vain OV2640-kameran koodi.

1. Lis√§√§ otsikkotiedosto `src`-kansioon nimelt√§ `camera.h`. T√§m√§ sis√§lt√§√§ koodin kameran kanssa kommunikointiin. Lis√§√§ seuraava koodi t√§h√§n tiedostoon:

    ```cpp
    #pragma once
    
    #include <ArduCAM.h>
    #include <Wire.h>
    
    class Camera
    {
    public:
        Camera(int format, int image_size) : _arducam(OV2640, PIN_SPI_SS)
        {
            _format = format;
            _image_size = image_size;
        }
    
        bool init()
        {
            // Reset the CPLD
            _arducam.write_reg(0x07, 0x80);
            delay(100);
    
            _arducam.write_reg(0x07, 0x00);
            delay(100);
    
            // Check if the ArduCAM SPI bus is OK
            _arducam.write_reg(ARDUCHIP_TEST1, 0x55);
            if (_arducam.read_reg(ARDUCHIP_TEST1) != 0x55)
            {
                return false;
            }
                
            // Change MCU mode
            _arducam.set_mode(MCU2LCD_MODE);
    
            uint8_t vid, pid;
    
            // Check if the camera module type is OV2640
            _arducam.wrSensorReg8_8(0xff, 0x01);
            _arducam.rdSensorReg8_8(OV2640_CHIPID_HIGH, &vid);
            _arducam.rdSensorReg8_8(OV2640_CHIPID_LOW, &pid);
            if ((vid != 0x26) && ((pid != 0x41) || (pid != 0x42)))
            {
                return false;
            }
            
            _arducam.set_format(_format);
            _arducam.InitCAM();
            _arducam.OV2640_set_JPEG_size(_image_size);
            _arducam.OV2640_set_Light_Mode(Auto);
            _arducam.OV2640_set_Special_effects(Normal);
            delay(1000);
    
            return true;
        }
    
        void startCapture()
        {
            _arducam.flush_fifo();
            _arducam.clear_fifo_flag();
            _arducam.start_capture();
        }
    
        bool captureReady()
        {
            return _arducam.get_bit(ARDUCHIP_TRIG, CAP_DONE_MASK);
        }
    
        bool readImageToBuffer(byte **buffer, uint32_t &buffer_length)
        {
            if (!captureReady()) return false;
    
            // Get the image file length
            uint32_t length = _arducam.read_fifo_length();
            buffer_length = length;
    
            if (length >= MAX_FIFO_SIZE)
            {
                return false;
            }
            if (length == 0)
            {
                return false;
            }
    
            // create the buffer
            byte *buf = new byte[length];
    
            uint8_t temp = 0, temp_last = 0;
            int i = 0;
            uint32_t buffer_pos = 0;
            bool is_header = false;
    
            _arducam.CS_LOW();
            _arducam.set_fifo_burst();
            
            while (length--)
            {
                temp_last = temp;
                temp = SPI.transfer(0x00);
                //Read JPEG data from FIFO
                if ((temp == 0xD9) && (temp_last == 0xFF)) //If find the end ,break while,
                {
                    buf[buffer_pos] = temp;
    
                    buffer_pos++;
                    i++;
                    
                    _arducam.CS_HIGH();
                }
                if (is_header == true)
                {
                    //Write image data to buffer if not full
                    if (i < 256)
                    {
                        buf[buffer_pos] = temp;
                        buffer_pos++;
                        i++;
                    }
                    else
                    {
                        _arducam.CS_HIGH();
    
                        i = 0;
                        buf[buffer_pos] = temp;
    
                        buffer_pos++;
                        i++;
    
                        _arducam.CS_LOW();
                        _arducam.set_fifo_burst();
                    }
                }
                else if ((temp == 0xD8) & (temp_last == 0xFF))
                {
                    is_header = true;
    
                    buf[buffer_pos] = temp_last;
                    buffer_pos++;
                    i++;
    
                    buf[buffer_pos] = temp;
                    buffer_pos++;
                    i++;
                }
            }
            
            _arducam.clear_fifo_flag();
    
            _arducam.set_format(_format);
            _arducam.InitCAM();
            _arducam.OV2640_set_JPEG_size(_image_size);
    
            // return the buffer
            *buffer = buf;
        }
    
    private:
        ArduCAM _arducam;
        int _format;
        int _image_size;
    };
    ```

    T√§m√§ on matalan tason koodi, joka konfiguroi kameran ArduCam-kirjastojen avulla ja hakee kuvat tarvittaessa SPI-v√§yl√§n kautta. T√§m√§ koodi on hyvin spesifinen ArduCamille, joten sinun ei tarvitse huolehtia sen toiminnasta t√§ss√§ vaiheessa.

1. Lis√§√§ `main.cpp`-tiedostoon seuraava koodi muiden `include`-lausuntojen alle sis√§llytt√§√§ksesi uuden tiedoston ja luodaksesi kameraluokan instanssin:

    ```cpp
    #include "camera.h"

    Camera camera = Camera(JPEG, OV2640_640x480);
    ```

    T√§m√§ luo `Camera`-instanssin, joka tallentaa kuvat JPEG-muodossa resoluutiolla 640x480. Vaikka suurempia resoluutioita tuetaan (jopa 3280x2464), kuvien luokittelu toimii paljon pienemmill√§ kuvilla (227x227), joten ei ole tarpeen ottaa ja l√§hett√§√§ suurempia kuvia.

1. Lis√§√§ seuraava koodi t√§m√§n alle m√§√§ritt√§√§ksesi funktion kameran asettamiseen:

    ```cpp
    void setupCamera()
    {
        pinMode(PIN_SPI_SS, OUTPUT);
        digitalWrite(PIN_SPI_SS, HIGH);
    
        Wire.begin();
        SPI.begin();
    
        if (!camera.init())
        {
            Serial.println("Error setting up the camera!");
        }
    }
    ```

    T√§m√§ `setupCamera`-funktio aloittaa konfiguroimalla SPI Chip Select -pinnin (`PIN_SPI_SS`) korkeaksi, tehden Wio Terminalista SPI-ohjaimen. Se k√§ynnist√§√§ sitten I2C- ja SPI-v√§yl√§t. Lopuksi se alustaa kameraluokan, joka konfiguroi kameran anturiasetukset ja varmistaa, ett√§ kaikki on kytketty oikein.

1. Kutsu t√§t√§ funktiota `setup`-funktion lopussa:

    ```cpp
    setupCamera();
    ```

1. Rakenna ja lataa t√§m√§ koodi ja tarkista sarjaportin monitorin tuloste. Jos n√§et `Error setting up the camera!`, tarkista johdotukset varmistaaksesi, ett√§ kaikki kaapelit yhdist√§v√§t oikeat ArduCamin pinnit oikeisiin GPIO-pinneihin Wio Terminalissa ja ett√§ kaikki hyppylangat ovat kunnolla kiinni.

## Ota kuva

Wio Terminal voidaan nyt ohjelmoida ottamaan kuva, kun painiketta painetaan.

### Teht√§v√§ - ota kuva

1. Mikro-ohjaimet suorittavat koodiasi jatkuvasti, joten ei ole helppoa k√§ynnist√§√§ jotain, kuten valokuvan ottamista, ilman reaktiota anturiin. Wio Terminalissa on painikkeita, joten kamera voidaan asettaa k√§ynnistym√§√§n yhdell√§ painikkeista. Lis√§√§ seuraava koodi `setup`-funktion loppuun konfiguroidaksesi C-painikkeen (yksi kolmesta yl√§painikkeesta, l√§himp√§n√§ virtakytkint√§).

    ![C-painike yl√§osassa, l√§himp√§n√§ virtakytkint√§](../../../../../translated_images/wio-terminal-c-button.73df3cb1c1445ea07ee98316af0e7925fcb43135df0abed58d3d4822b2589c3b.fi.png)

    ```cpp
    pinMode(WIO_KEY_C, INPUT_PULLUP);
    ```

    `INPUT_PULLUP`-tila k√§√§nt√§√§ sy√∂tteen. Esimerkiksi normaalisti painike l√§hett√§isi matalan signaalin, kun sit√§ ei paineta, ja korkean signaalin, kun sit√§ painetaan. Kun tila on `INPUT_PULLUP`, se l√§hett√§√§ korkean signaalin, kun sit√§ ei paineta, ja matalan signaalin, kun sit√§ painetaan.

1. Lis√§√§ tyhj√§ funktio reagoimaan painikkeen painallukseen ennen `loop`-funktiota:

    ```cpp
    void buttonPressed()
    {
        
    }
    ```

1. Kutsu t√§t√§ funktiota `loop`-metodissa, kun painiketta painetaan:

    ```cpp
    void loop()
    {
        if (digitalRead(WIO_KEY_C) == LOW)
        {
            buttonPressed();
            delay(2000);
        }
    
        delay(200);
    }
    ```

    T√§m√§ tarkistaa, onko painiketta painettu. Jos painiketta painetaan, kutsutaan `buttonPressed`-funktiota, ja silmukka viiv√§styy 2 sekuntia. T√§m√§ antaa aikaa painikkeen vapauttamiselle, jotta pitk√§ painallus ei rekister√∂idy kahdesti.

    > üíÅ Wio Terminalin painike on asetettu `INPUT_PULLUP`-tilaan, joten se l√§hett√§√§ korkean signaalin, kun sit√§ ei paineta, ja matalan signaalin, kun sit√§ painetaan.

1. Lis√§√§ seuraava koodi `buttonPressed`-funktioon:

    ```cpp
    camera.startCapture();
 
    while (!camera.captureReady())
        delay(100);

    Serial.println("Image captured");

    byte *buffer;
    uint32_t length;

    if (camera.readImageToBuffer(&buffer, length))
    {
        Serial.print("Image read to buffer with length ");
        Serial.println(length);

        delete(buffer);
    }
    ```

    T√§m√§ koodi aloittaa kameran kuvauksen kutsumalla `startCapture`. Kameran laitteisto ei toimi palauttamalla dataa pyynn√∂n yhteydess√§, vaan l√§het√§t k√§skyn aloittaa kuvaus, ja kamera ty√∂skentelee taustalla kuvan ottamiseksi, sen muuntamiseksi JPEG-muotoon ja sen tallentamiseksi kameran paikalliseen puskuriin. `captureReady`-kutsu tarkistaa, onko kuvan ottaminen valmis.

    Kun kuvaus on valmis, kuvatiedot kopioidaan kameran puskurista paikalliseen puskuriin (tavujen taulukkoon) `readImageToBuffer`-kutsulla. Puskurin pituus l√§hetet√§√§n sitten sarjaportin monitoriin.

1. Rakenna ja lataa t√§m√§ koodi ja tarkista sarjaportin monitorin tuloste. Joka kerta, kun painat C-painiketta, kuva otetaan ja n√§et kuvan koon sarjaportin monitorissa.

    ```output
    Connecting to WiFi..
    Connected!
    Image captured
    Image read to buffer with length 9224
    Image captured
    Image read to buffer with length 11272
    ```

    Eri kuvat ovat eri kokoisia. Ne pakataan JPEG-muotoon, ja JPEG-tiedoston koko tietylle resoluutiolle riippuu siit√§, mit√§ kuvassa on.

> üíÅ L√∂yd√§t t√§m√§n koodin [code-camera/wio-terminal](../../../../../4-manufacturing/lessons/2-check-fruit-from-device/code-camera/wio-terminal) -kansiosta.

üòÄ Olet onnistuneesti ottanut kuvia Wio Terminalilla.

## Valinnainen - varmista kameran kuvat SD-kortilla

Helpoin tapa n√§hd√§ kameran ottamat kuvat on kirjoittaa ne SD-kortille Wio Terminalissa ja tarkastella niit√§ tietokoneellasi. Tee t√§m√§ vaihe, jos sinulla on ylim√§√§r√§inen microSD-kortti ja microSD-korttipaikka tietokoneessasi tai adapteri.

Wio Terminal tukee vain enint√§√§n 16GB:n microSD-kortteja. Jos sinulla on suurempi SD-kortti, se ei toimi.

### Teht√§v√§ - varmista kameran kuvat SD-kortilla

1. Alusta microSD-kortti FAT32- tai exFAT-muotoon k√§ytt√§m√§ll√§ tietokoneesi sovelluksia (Disk Utility macOS:ss√§, File Explorer Windowsissa tai komentorivity√∂kaluja Linuxissa).

1. Aseta microSD-kortti virtakytkimen alapuolella olevaan korttipaikkaan. Varmista, ett√§ se menee kokonaan sis√§√§n, kunnes se napsahtaa ja pysyy paikallaan. Saatat joutua ty√∂nt√§m√§√§n sit√§ kynnen tai ohuen ty√∂kalun avulla.

1. Lis√§√§ seuraavat `include`-lausunnot `main.cpp`-tiedoston alkuun:

    ```cpp
    #include "SD/Seeed_SD.h"
    #include <Seeed_FS.h>
    ```

1. Lis√§√§ seuraava funktio ennen `setup`-funktiota:

    ```cpp
    void setupSDCard()
    {
        while (!SD.begin(SDCARD_SS_PIN, SDCARD_SPI))
        {
            Serial.println("SD Card Error");
        }
    }
    ```

    T√§m√§ konfiguroi SD-kortin k√§ytt√§m√§ll√§ SPI-v√§yl√§√§.

1. Kutsu t√§t√§ `setup`-funktiosta:

    ```cpp
    setupSDCard();
    ```

1. Lis√§√§ seuraava koodi `buttonPressed`-funktion yl√§puolelle:

    ```cpp
    int fileNum = 1;

    void saveToSDCard(byte *buffer, uint32_t length)
    {
        char buff[16];
        sprintf(buff, "%d.jpg", fileNum);
        fileNum++;
    
        File outFile = SD.open(buff, FILE_WRITE );
        outFile.write(buffer, length);
        outFile.close();

        Serial.print("Image written to file ");
        Serial.println(buff);
    }
    ```

    T√§m√§ m√§√§ritt√§√§ globaalin muuttujan tiedostojen laskemiseen. T√§t√§ k√§ytet√§√§n kuvatiedoston nimiss√§, jotta useita kuvia voidaan tallentaa kasvavilla tiedostonimill√§ - `1.jpg`, `2.jpg` ja niin edelleen.

    Se m√§√§ritt√§√§ my√∂s `saveToSDCard`-funktion, joka ottaa tavupuskurin ja puskurin pituuden. Tiedostonimi luodaan tiedostolaskurin avulla, ja laskuria kasvatetaan seuraavaa tiedostoa varten. Puskurin bin√§√§ridata kirjoitetaan tiedostoon.

1. Kutsu `saveToSDCard`-funktiota `buttonPressed`-funktiosta. Kutsun tulisi olla **ennen** puskurin poistamista:

    ```cpp
    Serial.print("Image read to buffer with length ");
    Serial.println(length);

    saveToSDCard(buffer, length);
    
    delete(buffer);
    ```

1. Rakenna ja lataa t√§m√§ koodi ja tarkista sarjaportin monitorin tuloste. Joka kerta, kun painat C-painiketta, kuva otetaan ja tallennetaan SD-kortille.

    ```output
    Connecting to WiFi..
    Connected!
    Image captured
    Image read to buffer with length 16392
    Image written to file 1.jpg
    Image captured
    Image read to buffer with length 14344
    Image written to file 2.jpg
    ```

1. Sammuta microSD-kortti ja poista se painamalla sit√§ hieman sis√§√§n ja vapauttamalla, jolloin se ponnahtaa ulos. Saatat joutua k√§ytt√§m√§√§n ohutta ty√∂kalua t√§h√§n. Liit√§ microSD-kortti tietokoneeseesi n√§hd√§ksesi kuvat.

    ![Kuva banaanista, otettu ArduCamilla](../../../../../translated_images/banana-arducam.be1b32d4267a8194b0fd042362e56faa431da9cd4af172051b37243ea9be0256.fi.jpg)
üíÅ Kameran valkotasapainon s√§√§t√§miseen voi kulua muutama kuva. Huomaat t√§m√§n kuvien v√§rin perusteella, ensimm√§iset kuvat voivat n√§ytt√§√§ v√§rilt√§√§n poikkeavilta. Voit aina kiert√§√§ t√§m√§n muuttamalla koodia siten, ett√§ `setup`-funktiossa otetaan muutama kuva, jotka j√§tet√§√§n huomiotta.


---

**Vastuuvapauslauseke**:  
T√§m√§ asiakirja on k√§√§nnetty k√§ytt√§m√§ll√§ teko√§lypohjaista k√§√§nn√∂spalvelua [Co-op Translator](https://github.com/Azure/co-op-translator). Vaikka pyrimme tarkkuuteen, huomioithan, ett√§ automaattiset k√§√§nn√∂kset voivat sis√§lt√§√§ virheit√§ tai ep√§tarkkuuksia. Alkuper√§inen asiakirja sen alkuper√§isell√§ kielell√§ tulisi pit√§√§ ensisijaisena l√§hteen√§. Kriittisen tiedon osalta suositellaan ammattimaista ihmisk√§√§nn√∂st√§. Emme ole vastuussa v√§√§rink√§sityksist√§ tai virhetulkinnoista, jotka johtuvat t√§m√§n k√§√§nn√∂ksen k√§yt√∂st√§.