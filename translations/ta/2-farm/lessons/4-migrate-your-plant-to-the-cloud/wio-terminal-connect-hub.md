<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "28320305a35ea3bc59c41fe146a2e6ed",
  "translation_date": "2025-10-11T12:28:57+00:00",
  "source_file": "2-farm/lessons/4-migrate-your-plant-to-the-cloud/wio-terminal-connect-hub.md",
  "language_code": "ta"
}
-->
# роЙроЩрпНроХро│рпН IoT роЪро╛родройродрпНродрпИ роорпЗроХродрпНродрпБроЯройрпН роЗрогрпИроХрпНроХро╡рпБроорпН - Wio Terminal

роЗроирпНрод рокро╛роЯродрпНродро┐ройрпН роЗроирпНрод рокроХрпБродро┐ропро┐ро▓рпН, роЙроЩрпНроХро│рпН Wio Terminal роР роЙроЩрпНроХро│рпН IoT Hub роЙроЯройрпН роЗрогрпИродрпНродрпБ, роЯрпЖро▓ро┐роорпЖроЯрпНро░ро┐ роЕройрпБрокрпНрокро╡рпБроорпН роХроЯрпНроЯро│рпИроХро│рпИрокрпН рокрпЖро▒ро╡рпБроорпН роЪрпЖропрпНропро▓ро╛роорпН.

## роЙроЩрпНроХро│рпН роЪро╛родройродрпНродрпИ IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХро╡рпБроорпН

роЕроЯрпБродрпНрод рокроЯро┐ропро╛роХ, роЙроЩрпНроХро│рпН роЪро╛родройродрпНродрпИ IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.

### рокрогро┐роХро│рпН - IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХро╡рпБроорпН

1. `soil-moisture-sensor` родро┐роЯрпНроЯродрпНродрпИ VS Code роЗро▓рпН родро┐ро▒роХрпНроХро╡рпБроорпН.

2. `platformio.ini` роХрпЛрокрпНрокрпИ родро┐ро▒роХрпНроХро╡рпБроорпН. `knolleary/PubSubClient` роирпВро▓роХ роЪро╛ро░рпНрокрпИ роЕроХро▒рпНро▒ро╡рпБроорпН. роЗродрпБ рокрпКродрпБ MQTT рокрпНро░рпЛроХрпНроХро░рпБроЯройрпН роЗрогрпИроХрпНроХ рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпНроЯродрпБ, роЖройро╛ро▓рпН IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХ роЗродрпБ родрпЗро╡рпИропро┐ро▓рпНро▓рпИ.

3. рокро┐ройрпНро╡ро░рпБроорпН роирпВро▓роХ роЪро╛ро░рпНрокрпБроХро│рпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```ini
    seeed-studio/Seeed Arduino RTC @ 2.0.0
    arduino-libraries/AzureIoTHub @ 1.6.0
    azure/AzureIoTUtility @ 1.6.1
    azure/AzureIoTProtocol_MQTT @ 1.6.0
    azure/AzureIoTProtocol_HTTP @ 1.6.0
    azure/AzureIoTSocket_WiFi @ 1.0.2
    ```
  
   `Seeed Arduino RTC` роирпВро▓роХроорпН Wio Terminal роЗро▓рпН роирпЗро░родрпНродрпИ роХрогрпНроХро╛рогро┐роХрпНроХ рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпБроорпН роТро░рпБ роирпЗро░роорпН роЪро╛ро░рпНроирпНрод роХроЯро┐роХро╛ро░родрпНродрпБроЯройрпН родрпКроЯро░рпНрокрпБ роХрпКро│рпНро│ роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ ро╡ро┤роЩрпНроХрпБроХро┐ро▒родрпБ. роорпАродроорпБро│рпНро│ роирпВро▓роХроЩрпНроХро│рпН роЙроЩрпНроХро│рпН IoT роЪро╛родройродрпНродрпИ IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХ роЕройрпБроородро┐роХрпНроХро┐ройрпНро▒рой.

4. `platformio.ini` роХрпЛрокрпНрокро┐ройрпН роХрпАро┤рпЗ рокро┐ройрпНро╡ро░рпБроорпН ро╡ро░ро┐роХро│рпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```ini
    build_flags =
        -DDONT_USE_UPLOADTOBLOB
    ```
  
   роЗродрпБ Arduino IoT Hub роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ родрпКроХрпБроХрпНроХрпБроорпНрокрпЛродрпБ родрпЗро╡рпИрокрпНрокроЯрпБроорпН родрпКроХрпБрокрпНрокро╛ро│ро░рпН роХрпКроЯро┐ропрпИ роЕроорпИроХрпНроХро┐ро▒родрпБ.

5. `config.h` родро▓рпИрокрпНрокрпБ роХрпЛрокрпНрокрпИ родро┐ро▒роХрпНроХро╡рпБроорпН. роЕройрпИродрпНродрпБ MQTT роЕроорпИрокрпНрокрпБроХро│рпИропрпБроорпН роЕроХро▒рпНро▒ро┐, роЪро╛родрой роЗрогрпИрокрпНрокрпБ роЪро░родрпНродро┐ройрпН рокро┐ройрпНро╡ро░рпБроорпН рооро╛ро▒ро┐ропрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    // IoT Hub settings
    const char *CONNECTION_STRING = "<connection string>";
    ```
  
   `<connection string>` роР роорпБройрпНрокрпБ роирпАроЩрпНроХро│рпН роироХро▓рпЖроЯрпБродрпНрод роЙроЩрпНроХро│рпН роЪро╛родройродрпНродро┐ройрпН роЗрогрпИрокрпНрокрпБ роЪро░родрпНродрпБроЯройрпН рооро╛ро▒рпНро▒ро╡рпБроорпН.

6. IoT Hub роЙроЯройрпН роЗрогрпИрокрпНрокрпБ роирпЗро░ роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓ро╛рой роЯрпЛроХрпНроХройрпИрокрпН рокропройрпНрокроЯрпБродрпНродрпБроХро┐ро▒родрпБ. роЗродройрпН рокрпКро░рпБро│рпН IoT роЪро╛родройроорпН родро▒рпНрокрпЛродрпИроп роирпЗро░родрпНродрпИ роЕро▒ро┐роирпНродро┐ро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН. Windows, macOS роЕро▓рпНро▓родрпБ Linux рокрпЛройрпНро▒ роЗропроХрпНроХ роорпБро▒рпИроорпИроХро│рпБроХрпНроХрпБ рооро╛ро▒ро╛роХ, роорпИроХрпНро░рпЛроХрогрпНроЯрпНро░рпЛро▓ро░рпНроХро│рпН родро╛ройро╛роХро╡рпЗ роЗрогрпИропродрпНродро┐ройрпН роорпВро▓роорпН родро▒рпНрокрпЛродрпИроп роирпЗро░родрпНродрпИ роТродрпНродро┐роЪрпИроХрпНроХро╛родрпБ. роОройро╡рпЗ, [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) роЪро░рпНро╡ро░ро┐ро▓рпН роЗро░рпБроирпНродрпБ родро▒рпНрокрпЛродрпИроп роирпЗро░родрпНродрпИрокрпН рокрпЖро▒ роХрпБро▒ро┐ропрпАроЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН. роирпЗро░родрпНродрпИрокрпН рокрпЖро▒рпНро▒ рокро┐ро▒роХрпБ, Wio Terminal роЗро▓рпН роТро░рпБ роирпЗро░роорпН роЪро╛ро░рпНроирпНрод роХроЯро┐роХро╛ро░родрпНродро┐ро▓рпН роЪрпЗрооро┐роХрпНроХро▓ро╛роорпН, роЪро╛родройроорпН рооро┐ройрпНроЪро╛ро░роорпН роЗро┤роХрпНроХро╛род ро╡ро░рпИ рокро┐ройрпНройро░рпН роЪро░ро┐ропро╛рой роирпЗро░родрпНродрпИ роХрпЛро░ роЕройрпБроородро┐роХрпНроХро┐ро▒родрпБ. `ntp.h` роОройрпНро▒ рокрпБродро┐роп роХрпЛрокрпНрокрпИ рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпБроЯройрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    #pragma once
    
    #include "DateTime.h"
    #include <time.h>
    #include "samd/NTPClientAz.h"
    #include <sys/time.h>

    static void initTime()
    {
        WiFiUDP _udp;
        time_t epochTime = (time_t)-1;
        NTPClientAz ntpClient;

        ntpClient.begin();

        while (true)
        {
            epochTime = ntpClient.getEpochTime("0.pool.ntp.org");

            if (epochTime == (time_t)-1)
            {
                Serial.println("Fetching NTP epoch time failed! Waiting 2 seconds to retry.");
                delay(2000);
            }
            else
            {
                Serial.print("Fetched NTP epoch time is: ");

                char buff[32];
                sprintf(buff, "%.f", difftime(epochTime, (time_t)0));
                Serial.println(buff);
                break;
            }
        }

        ntpClient.end();

        struct timeval tv;
        tv.tv_sec = epochTime;
        tv.tv_usec = 0;

        settimeofday(&tv, NULL);
    }
    ```
  
   роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпНроЯро┐ройрпН ро╡ро┐ро╡ро░роЩрпНроХро│рпН роЗроирпНрод рокро╛роЯродрпНродро┐ройрпН ро╡ро░роорпНрокрпБроХрпНроХрпБ ро╡рпЖро│ро┐ропрпЗ роЙро│рпНро│родрпБ. роЗродрпБ `initTime` роОройрпНро▒ роТро░рпБ роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИ ро╡ро░рпИропро▒рпБроХрпНроХро┐ро▒родрпБ, роЗродрпБ NTP роЪро░рпНро╡ро░ро┐ро▓рпН роЗро░рпБроирпНродрпБ родро▒рпНрокрпЛродрпИроп роирпЗро░родрпНродрпИрокрпН рокрпЖро▒рпБроХро┐ро▒родрпБ рооро▒рпНро▒рпБроорпН Wio Terminal роЗро▓рпН роХроЯро┐роХро╛ро░родрпНродрпИ роЕроорпИроХрпНроХро┐ро▒родрпБ.

7. `main.cpp` роХрпЛрокрпНрокрпИ родро┐ро▒роирпНродрпБ роЕройрпИродрпНродрпБ MQTT роХрпБро▒ро┐ропрпАроЯрпНроЯрпИропрпБроорпН роЕроХро▒рпНро▒ро╡рпБроорпН, роЕродро┐ро▓рпН `PubSubClient.h` родро▓рпИрокрпНрокрпБ роХрпЛрокрпНрокрпБ, `PubSubClient` рооро╛ро▒ро┐ропро┐ройрпН роЕро▒ро┐ро╡ро┐рокрпНрокрпБ, `reconnectMQTTClient` рооро▒рпНро▒рпБроорпН `createMQTTClient` роорпБро▒рпИроХро│рпН рооро▒рпНро▒рпБроорпН роЗроирпНрод рооро╛ро▒ро┐роХро│рпН рооро▒рпНро▒рпБроорпН роорпБро▒рпИроХро│рпБроХрпНроХрпБ роОроирпНрод роЕро┤рпИрокрпНрокрпБроХро│рпБроорпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│рой. роЗроирпНрод роХрпЛрокрпНрокро┐ро▓рпН WiFi роЙроЯройрпН роЗрогрпИроХрпНроХ, роорогрпН роИро░рокрпНрокродроорпН рокрпЖро▒ рооро▒рпНро▒рпБроорпН роЕродро┐ро▓рпН JSON роЖро╡рогродрпНродрпИ роЙро░рпБро╡ро╛роХрпНроХ роороЯрпНроЯрпБроорпЗ роХрпБро▒ро┐ропрпАроЯрпБ роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.

8. IoT Hub роирпВро▓роХ родро▓рпИрокрпНрокрпБ роХрпЛрокрпНрокрпБроХро│рпИропрпБроорпН роирпЗро░родрпНродрпИ роЕроорпИроХрпНроХро╡рпБроорпН рокро┐ройрпНро╡ро░рпБроорпН `#include` роЗропроХрпНроХроЩрпНроХро│рпИ `main.cpp` роХрпЛрокрпНрокро┐ройрпН роорпЗро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    #include <AzureIoTHub.h>
    #include <AzureIoTProtocol_MQTT.h>
    #include <iothubtransportmqtt.h>
    #include "ntp.h"
    ```
  
9. родро▒рпНрокрпЛродрпИроп роирпЗро░родрпНродрпИ роЕроорпИроХрпНроХ `setup` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ройрпН роЗро▒рпБродро┐ропро┐ро▓рпН рокро┐ройрпНро╡ро░рпБроорпН роЕро┤рпИрокрпНрокрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    initTime();
    ```
  
10. роХрпЛрокрпНрокро┐ройрпН роорпЗро▓рпН, `include` роЗропроХрпНроХроЩрпНроХро│ро┐ройрпН роХрпАро┤рпЗ рокро┐ройрпНро╡ро░рпБроорпН рооро╛ро▒ро┐ роЕро▒ро┐ро╡ро┐рокрпНрокрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    IOTHUB_DEVICE_CLIENT_LL_HANDLE _device_ll_handle;
    ```
  
   роЗродрпБ `IOTHUB_DEVICE_CLIENT_LL_HANDLE` роР роЕро▒ро┐ро╡ро┐роХрпНроХро┐ро▒родрпБ, роЗродрпБ IoT Hub роЙроЯройрпН роТро░рпБ роЗрогрпИрокрпНрокрпБроХрпНроХро╛рой роХрпИрокрпНрокро┐роЯро┐ роЖроХрпБроорпН.

11. роЗродройрпН роХрпАро┤рпЗ рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    static void connectionStatusCallback(IOTHUB_CLIENT_CONNECTION_STATUS result, IOTHUB_CLIENT_CONNECTION_STATUS_REASON reason, void *user_context)
    {
        if (result == IOTHUB_CLIENT_CONNECTION_AUTHENTICATED)
        {
            Serial.println("The device client is connected to iothub");
        }
        else
        {
            Serial.println("The device client has been disconnected");
        }
    }
    ```
  
   роЗродрпБ IoT Hub роЙроЯройрпН роЗрогрпИрокрпНрокро┐ройрпН роиро┐ро▓рпИ рооро╛ро▒рпБроорпНрокрпЛродрпБ роЕро┤рпИроХрпНроХрокрпНрокроЯрпБроорпН роТро░рпБ callback роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИ роЕро▒ро┐ро╡ро┐роХрпНроХро┐ро▒родрпБ, роЙродро╛ро░рогрооро╛роХ роЗрогрпИрокрпНрокродрпБ роЕро▓рпНро▓родрпБ родрпБрогрпНроЯро┐роХрпНроХрокрпНрокроЯрпБро╡родрпБ рокрпЛройрпНро▒ро╡рпИ. роиро┐ро▓рпИ родрпКроЯро░рпНроЪрпНроЪро┐ роЪрпАро░ро┐ропро▓рпН рокрпЛро░рпНроЯрпБроХрпНроХрпБ роЕройрпБрокрпНрокрокрпНрокроЯрпБроорпН.

12. роЗродройрпН роХрпАро┤рпЗ, IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХ роТро░рпБ роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    void connectIoTHub()
    {
        IoTHub_Init();
    
        _device_ll_handle = IoTHubDeviceClient_LL_CreateFromConnectionString(CONNECTION_STRING, MQTT_Protocol);
        
        if (_device_ll_handle == NULL)
        {
            Serial.println("Failure creating Iothub device. Hint: Check your connection string.");
            return;
        }
    
        IoTHubDeviceClient_LL_SetConnectionStatusCallback(_device_ll_handle, connectionStatusCallback, NULL);
    }
    ```
  
   роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ IoT Hub роирпВро▓роХ роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ роЖро░роорпНрокро┐роХрпНроХро┐ро▒родрпБ, рокро┐ройрпНройро░рпН `config.h` родро▓рпИрокрпНрокрпБ роХрпЛрокрпНрокро┐ро▓рпН роЙро│рпНро│ роЗрогрпИрокрпНрокрпБ роЪро░родрпНродрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роТро░рпБ роЗрогрпИрокрпНрокрпИ роЙро░рпБро╡ро╛роХрпНроХрпБроХро┐ро▒родрпБ. роЗроирпНрод роЗрогрпИрокрпНрокрпБ MQTT роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН роЙро│рпНро│родрпБ. роЗрогрпИрокрпНрокрпБ родрпЛро▓рпНро╡ро┐ропроЯрпИроирпНродро╛ро▓рпН, роЗродрпБ роЪрпАро░ро┐ропро▓рпН рокрпЛро░рпНроЯрпБроХрпНроХрпБ роЕройрпБрокрпНрокрокрпНрокроЯрпБроорпН - роирпАроЩрпНроХро│рпН ро╡рпЖро│ро┐ропрпАроЯрпНроЯро┐ро▓рпН роЗродрпИрокрпН рокро╛ро░рпНродрпНродро╛ро▓рпН, роЗрогрпИрокрпНрокрпБ роЪро░родрпНродрпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН. роЗро▒рпБродро┐ропро╛роХ, роЗрогрпИрокрпНрокрпБ роиро┐ро▓рпИ callback роЕроорпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.

13. роЗроирпНрод роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИ `setup` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ро▓рпН `initTime` роЕро┤рпИрокрпНрокро┐ройрпН роХрпАро┤рпЗ роЕро┤рпИроХрпНроХро╡рпБроорпН:

    ```cpp
    connectIoTHub();
    ```
  
14. MQTT роХро┐ро│рпИропрогрпНроЯрпН рокрпЛро▓ро╡рпЗ, роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБроорпН роТро▒рпНро▒рпИ родро┐ро░рпИропро┐ро▓рпН роЗропроЩрпНроХрпБроХро┐ро▒родрпБ, роОройро╡рпЗ ро╣рокрпН роЕройрпБрокрпНрокрпБроорпН рооро▒рпНро▒рпБроорпН ро╣рокрпНрокро┐ро▒рпНроХрпБ роЕройрпБрокрпНрокрокрпНрокроЯрпБроорпН роЪрпЖропрпНродро┐роХро│рпИ роЪрпЖропро▓ро╛роХрпНроХ роирпЗро░роорпН родрпЗро╡рпИ. роЗродрпИроЪрпН роЪрпЖропрпНроп, рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ `loop` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ройрпН роорпЗро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
    ```
  
15. роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ роЙро░рпБро╡ро╛роХрпНроХро┐ рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН. роирпАроЩрпНроХро│рпН роЪрпАро░ро┐ропро▓рпН рооро╛ройро┐роЯрпНроЯро░ро┐ро▓рпН роЗрогрпИрокрпНрокрпИроХрпН роХро╛рогро▓ро╛роорпН:

    ```output
    Connecting to WiFi..
    Connected!
    Fetched NTP epoch time is: 1619983687
    Sending telemetry {"soil_moisture":391}
    The device client is connected to iothub
    ```
  
   ро╡рпЖро│ро┐ропрпАроЯрпНроЯро┐ро▓рпН, NTP роирпЗро░роорпН рокрпЖро▒рокрпНрокроЯрпБро╡родрпИрокрпН рокро┐ройрпНрокро▒рпНро▒ро┐ропро╡рпБроЯройрпН роЪро╛родрой роХро┐ро│рпИропрогрпНроЯрпН роЗрогрпИроХрпНроХрокрпНрокроЯрпБро╡родрпИ роирпАроЩрпНроХро│рпН роХро╛рогро▓ро╛роорпН. роЗрогрпИроХрпНроХ роЪро┐ро▓ ро╡ро┐роиро╛роЯро┐роХро│рпН роЖроХро▓ро╛роорпН, роОройро╡рпЗ роЪро╛родройроорпН роЗрогрпИроХрпНроХрпБроорпНрокрпЛродрпБ ро╡рпЖро│ро┐ропрпАроЯрпНроЯро┐ро▓рпН роорогрпН роИро░рокрпНрокродроорпН роХро╛рогро▓ро╛роорпН.

   > ЁЯТБ NTP роХрпНроХро╛рой ропрпБройро┐роХрпНро╕рпН роирпЗро░родрпНродрпИ [unixtimestamp.com](https://www.unixtimestamp.com) рокрпЛройрпНро▒ роТро░рпБ роЗрогрпИропродро│родрпНродрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роорпЗро▓рпБроорпН ро╡ро╛роЪро┐роХрпНроХроХрпНроХрпВроЯро┐роп ро╡роЯро┐ро╡рооро╛роХ рооро╛ро▒рпНро▒ро▓ро╛роорпН.

## роЯрпЖро▓ро┐роорпЖроЯрпНро░ро┐ роЕройрпБрокрпНрокро╡рпБроорпН

роЗрокрпНрокрпЛродрпБ роЙроЩрпНроХро│рпН роЪро╛родройроорпН роЗрогрпИроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ, роирпАроЩрпНроХро│рпН MQTT рокрпНро░рпЛроХрпНроХро░рпБроХрпНроХрпБ рокродро┐ро▓ро╛роХ IoT Hub роХрпНроХрпБ роЯрпЖро▓ро┐роорпЖроЯрпНро░ро┐ роЕройрпБрокрпНрокро▓ро╛роорпН.

### рокрогро┐роХро│рпН - роЯрпЖро▓ро┐роорпЖроЯрпНро░ро┐ роЕройрпБрокрпНрокро╡рпБроорпН

1. `setup` роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпБроХрпНроХрпБ роорпЗро▓рпЗ рокро┐ройрпНро╡ро░рпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    void sendTelemetry(const char *telemetry)
    {
        IOTHUB_MESSAGE_HANDLE message_handle = IoTHubMessage_CreateFromString(telemetry);
        IoTHubDeviceClient_LL_SendEventAsync(_device_ll_handle, message_handle, NULL, NULL);
        IoTHubMessage_Destroy(message_handle);
    }
    ```
  
   роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ роТро░рпБ роЪро░роорпН роорпВро▓роорпН IoT Hub роЪрпЖропрпНродро┐ропрпИ роЙро░рпБро╡ро╛роХрпНроХро┐, роЕродрпИ ро╣рокрпНрокро┐ро▒рпНроХрпБ роЕройрпБрокрпНрокро┐, рокро┐ройрпНройро░рпН роЪрпЖропрпНродро┐ рокрпКро░рпБро│рпИ роЪрпБродрпНродроорпН роЪрпЖропрпНроХро┐ро▒родрпБ.

2. роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ `loop` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ро▓рпН, роЯрпЖро▓ро┐роорпЖроЯрпНро░ро┐ роЪрпАро░ро┐ропро▓рпН рокрпЛро░рпНроЯрпБроХрпНроХрпБ роЕройрпБрокрпНрокрокрпНрокроЯрпБроорпН ро╡ро░ро┐ропро┐ройрпН рокро┐ро▒роХрпБ роЕро┤рпИроХрпНроХро╡рпБроорпН:

    ```cpp
    sendTelemetry(telemetry.c_str());
    ```
  

## роХроЯрпНроЯро│рпИроХро│рпИ роХрпИропро╛ро│ро╡рпБроорпН

роЙроЩрпНроХро│рпН роЪро╛родройроорпН ро░ро┐ро▓рпЗро╡рпИ роХроЯрпНроЯрпБрокрпНрокроЯрпБродрпНрод роЪро░рпНро╡ро░рпН роХрпБро▒ро┐ропрпАроЯрпНроЯро┐ро▓ро┐ро░рпБроирпНродрпБ роТро░рпБ роХроЯрпНроЯро│рпИропрпИ роХрпИропро╛ро│ ро╡рпЗрогрпНроЯрпБроорпН. роЗродрпБ роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИропро╛роХ роЕройрпБрокрпНрокрокрпНрокроЯрпБроХро┐ро▒родрпБ.

### рокрогро┐роХро│рпН - роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИропрпИ роХрпИропро╛ро│ро╡рпБроорпН

1. `connectIoTHub` роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпБроХрпНроХрпБ роорпБройрпН рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    int directMethodCallback(const char *method_name, const unsigned char *payload, size_t size, unsigned char **response, size_t *response_size, void *userContextCallback)
    {
        Serial.printf("Direct method received %s\r\n", method_name);
    
        if (strcmp(method_name, "relay_on") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, HIGH);
        }
        else if (strcmp(method_name, "relay_off") == 0)
        {
            digitalWrite(PIN_WIRE_SCL, LOW);
        }
    }
    ```
  
   роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ IoT Hub роирпВро▓роХроорпН роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИропрпИрокрпН рокрпЖро▒рпБроорпН рокрпЛродрпБ роЕро┤рпИроХрпНроХроХрпНроХрпВроЯро┐роп роТро░рпБ callback роорпБро▒рпИропрпИ ро╡ро░рпИропро▒рпБроХрпНроХро┐ро▒родрпБ. роХрпЛро░рокрпНрокроЯрпБроорпН роорпБро▒рпИ `method_name` роЕро│ро╡рпБро░рпБро╡ро┐ро▓рпН роЕройрпБрокрпНрокрокрпНрокроЯрпБроорпН. роЗроирпНрод роЪрпЖропро▓рпНрокро╛роЯрпБ роЪрпАро░ро┐ропро▓рпН рокрпЛро░рпНроЯрпБроХрпНроХрпБ роЕро┤рпИроХрпНроХрокрпНрокроЯрпНроЯ роорпБро▒рпИропрпИ роЕроЪрпНроЪро┐роЯрпБроХро┐ро▒родрпБ, рокро┐ройрпНройро░рпН роорпБро▒рпИ рокрпЖропро░ро┐ройрпН роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН ро░ро┐ро▓рпЗро╡рпИ роЖройрпН роЕро▓рпНро▓родрпБ роЖроГрокрпН роЪрпЖропрпНроХро┐ро▒родрпБ.

   > ЁЯТБ роЗродрпИ роТро░рпБ родройро┐ роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИропро╛роХро╡рпБроорпН роЪрпЖропро▓рпНрокроЯрпБродрпНродро▓ро╛роорпН, ро░ро┐ро▓рпЗро╡ро┐ройрпН ро╡ро┐ро░рпБроорпНрокро┐роп роиро┐ро▓рпИропрпИ роТро░рпБ payload роЗро▓рпН роЕройрпБрокрпНрокро┐, роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИропрпБроЯройрпН роЕройрпБрокрпНрокро┐, `payload` роЕро│ро╡рпБро░рпБро╡ро┐ро▓ро┐ро░рпБроирпНродрпБ роХро┐роЯрпИроХрпНроХроХрпНроХрпВроЯро┐ропродро╛роХро╡рпБроорпН роЪрпЖропрпНропро▓ро╛роорпН.

2. `directMethodCallback` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ройрпН роЗро▒рпБродро┐ропро┐ро▓рпН рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    char resultBuff[16];
    sprintf(resultBuff, "{\"Result\":\"\"}");
    *response_size = strlen(resultBuff);
    *response = (unsigned char *)malloc(*response_size);
    memcpy(*response, resultBuff, *response_size);

    return IOTHUB_CLIENT_OK;
    ```
  
   роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИроХро│рпБроХрпНроХрпБ роТро░рпБ рокродро┐ро▓рпН родрпЗро╡рпИ, роорпЗро▓рпБроорпН рокродро┐ро▓рпН роЗро░рогрпНроЯрпБ рокроХрпБродро┐роХро│ро╛роХ роЗро░рпБроХрпНроХрпБроорпН - роЙро░рпИропро╛роХро╡рпБроорпН, родро┐ро░рпБроорпНрокрпБроорпН роХрпБро▒ро┐ропрпАроЯро╛роХро╡рпБроорпН. роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ рокро┐ройрпНро╡ро░рпБроорпН JSON роЖро╡рогрооро╛роХ роТро░рпБ роорпБроЯро┐ро╡рпИ роЙро░рпБро╡ро╛роХрпНроХрпБроорпН:

    ```JSON
    {
        "Result": ""
    }
    ```
  
   роЗродрпБ рокро┐ройрпНройро░рпН `response` роЕро│ро╡рпБро░рпБро╡ро┐ро▓рпН роироХро▓рпЖроЯрпБроХрпНроХрокрпНрокроЯрпБроорпН, роорпЗро▓рпБроорпН роЗроирпНрод рокродро┐ро▓ро┐ройрпН роЕро│ро╡рпБ `response_size` роЕро│ро╡рпБро░рпБро╡ро┐ро▓рпН роЕроорпИроХрпНроХрокрпНрокроЯрпБроорпН. роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ роорпБро▒рпИ роЪро░ро┐ропро╛роХ роХрпИропро╛ро│рокрпНрокроЯрпНроЯродрпБ роОройрпНрокродрпИ роХро╛роЯрпНроЯ `IOTHUB_CLIENT_OK` роР родро┐ро░рпБрокрпНрокрпБроорпН.

3. роЗроирпНрод callback роР роЗрогрпИроХрпНроХ, `connectIoTHub` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ройрпН роЗро▒рпБродро┐ропро┐ро▓рпН рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИроЪрпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    IoTHubClient_LL_SetDeviceMethodCallback(_device_ll_handle, directMethodCallback, NULL);
    ```
  
4. `loop` роЪрпЖропро▓рпНрокро╛роЯрпБ IoT Hub роЕройрпБрокрпНрокрпБроорпН роиро┐роХро┤рпНро╡рпБроХро│рпИ роЪрпЖропро▓ро╛роХрпНроХ `IoTHubDeviceClient_LL_DoWork` роЪрпЖропро▓рпНрокро╛роЯрпНроЯрпИ роЕро┤рпИроХрпНроХрпБроорпН. роЗродрпБ `delay` роХро╛ро░рогрооро╛роХ роТро╡рпНро╡рпКро░рпБ 10 ро╡ро┐роиро╛роЯро┐роХро│рпБроХрпНроХрпБроорпН роороЯрпНроЯрпБроорпЗ роЕро┤рпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ, роЕродро╛ро╡родрпБ роирпЗро░роЯро┐ роорпБро▒рпИроХро│рпН роТро╡рпНро╡рпКро░рпБ 10 ро╡ро┐роиро╛роЯро┐роХро│рпБроХрпНроХрпБроорпН роороЯрпНроЯрпБроорпЗ роЪрпЖропро▓ро╛роХрпНроХрокрпНрокроЯрпБроорпН. роЗродрпИ роорпЗро▓рпБроорпН родро┐ро▒роорпИропро╛роХроЪрпН роЪрпЖропрпНроп, 10 ро╡ро┐роиро╛роЯро┐ родро╛роородродрпНродрпИ рокро▓ роХрпБро▒рпБроХро┐роп родро╛роородроЩрпНроХро│ро╛роХ роЪрпЖропро▓рпНрокроЯрпБродрпНродро▓ро╛роорпН, роТро╡рпНро╡рпКро░рпБ роорпБро▒рпИропрпБроорпН `IoTHubDeviceClient_LL_DoWork` роР роЕро┤рпИроХрпНроХро▓ро╛роорпН. роЗродрпИроЪрпН роЪрпЖропрпНроп, рокро┐ройрпНро╡ро░рпБроорпН роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ `loop` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ройрпН роорпЗро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН:

    ```cpp
    void work_delay(int delay_time)
    {
        int current = 0;
        do
        {
            IoTHubDeviceClient_LL_DoWork(_device_ll_handle);
            delay(100);
            current += 100;
        } while (current < delay_time);
    }
    ```
  
   роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпБ роорпАрогрпНроЯрпБроорпН роорпАрогрпНроЯрпБроорпН роороЯроЩрпНроХро╛рооро▓рпН роЪрпЖропро▓рпНрокроЯрпБроХро┐ро▒родрпБ, роТро╡рпНро╡рпКро░рпБ роорпБро▒рпИропрпБроорпН `IoTHubDeviceClient_LL_DoWork` роР роЕро┤рпИродрпНродрпБ, роТро╡рпНро╡рпКро░рпБ роорпБро▒рпИропрпБроорпН 100ms родро╛роородрооро╛роХро┐ро▒родрпБ. роЗродрпБ `delay_time` роЕро│ро╡рпБро░рпБро╡ро┐ро▓рпН роХрпКроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роирпЗро░ роЕро│ро╡рпБроХрпНроХрпБ родро╛роородро┐роХрпНроХ родрпЗро╡рпИропро╛рой роЕро│ро╡рпБроХрпНроХрпБ роЗродрпИроЪрпН роЪрпЖропрпНроХро┐ро▒родрпБ. роЗродройрпН рокрпКро░рпБро│рпН, роЪро╛родройроорпН роирпЗро░роЯро┐ роорпБро▒рпИ роХрпЛро░ро┐роХрпНроХрпИроХро│рпИ роЪрпЖропро▓ро╛роХрпНроХ роЕродро┐роХрокроЯрпНроЪроорпН 100ms роХро╛родрпНродро┐ро░рпБроХрпНроХро┐ро▒родрпБ.

5. `loop` роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ро▓рпН, `IoTHubDeviceClient_LL_DoWork` роЕро┤рпИрокрпНрокрпИ роЕроХро▒рпНро▒ро┐, `delay(10000)` роЕро┤рпИрокрпНрокрпИ рокро┐ройрпНро╡ро░рпБрооро╛ро▒рпБ рооро╛ро▒рпНро▒ро╡рпБроорпН:

    ```cpp
    work_delay(10000);
    ```
  
> ЁЯТБ роЗроирпНрод роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ [code/wio-terminal](../../../../../2-farm/lessons/4-migrate-your-plant-to-the-cloud/code/wio-terminal) роХрпЛрокрпНрокрпБро▒рпИропро┐ро▓рпН роХро╛рогро▓ро╛роорпН.

ЁЯША роЙроЩрпНроХро│рпН роорогрпН роИро░рокрпНрокродроорпН роЪрпЖройрпНроЪро╛ро░рпН родро┐роЯрпНроЯроорпН роЙроЩрпНроХро│рпН IoT Hub роЙроЯройрпН роЗрогрпИроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ!

---

**роХрпБро▒ро┐рокрпНрокрпБ**:  
роЗроирпНрод роЖро╡рогроорпН [Co-op Translator](https://github.com/Azure/co-op-translator) роОройрпНро▒ AI роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБ роЪрпЗро╡рпИропрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роорпКро┤ро┐рокрпЖропро░рпНроХрпНроХрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ. роиро╛роЩрпНроХро│рпН родрпБро▓рпНро▓ро┐ропродрпНродро┐ро▒рпНроХро╛роХ роорпБропро▒рпНроЪро┐роХрпНроХро┐ройрпНро▒рпЛроорпН, роЖройро╛ро▓рпН родро╛ройро┐ропроЩрпНроХро┐ роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБроХро│ро┐ро▓рпН рокро┐ро┤рпИроХро│рпН роЕро▓рпНро▓родрпБ родро╡ро▒ро╛рой родроХро╡ро▓рпНроХро│рпН роЗро░рпБроХрпНроХроХрпНроХрпВроЯрпБроорпН роОройрпНрокродрпИ роХро╡ройродрпНродро┐ро▓рпН роХрпКро│рпНро│ро╡рпБроорпН. роЕродройрпН родро╛ропрпНроорпКро┤ро┐ропро┐ро▓рпН роЙро│рпНро│ роорпВро▓ роЖро╡рогроорпН роЕродро┐роХро╛ро░рокрпНрокрпВро░рпНро╡ роЖродро╛ро░рооро╛роХ роХро░рпБродрокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН. роорпБроХрпНроХро┐ропрооро╛рой родроХро╡ро▓рпНроХро│рпБроХрпНроХрпБ, родрпКро┤ро┐ро▓рпНроорпБро▒рпИ рооройро┐род роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБ рокро░ро┐роирпНродрпБро░рпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ. роЗроирпНрод роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпИрокрпН рокропройрпНрокроЯрпБродрпНродрпБро╡родро╛ро▓рпН роПро▒рпНрокроЯрпБроорпН роОроирпНрод родро╡ро▒ро╛рой рокрпБро░ро┐родро▓рпНроХро│рпН роЕро▓рпНро▓родрпБ родро╡ро▒ро╛рой ро╡ро┐ро│роХрпНроХроЩрпНроХро│рпБроХрпНроХрпБ роиро╛роЩрпНроХро│рпН рокрпКро▒рпБрокрпНрокро▓рпНро▓.